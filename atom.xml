<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>某人</title>
  
  <subtitle>此前素未谋面、此后遥遥无期</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://nightme.github.io/"/>
  <updated>2025-09-19T06:32:58.275Z</updated>
  <id>https://nightme.github.io/</id>
  
  <author>
    <name>某人</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>IOS支付</title>
    <link href="https://nightme.github.io/2025/09/19/IOS%E6%94%AF%E4%BB%98/"/>
    <id>https://nightme.github.io/2025/09/19/IOS支付/</id>
    <published>2025-09-19T06:32:13.000Z</published>
    <updated>2025-09-19T06:32:58.275Z</updated>
    
    <content type="html"><![CDATA[<h2 id="IOS支付"><a href="#IOS支付" class="headerlink" title="IOS支付"></a>IOS支付</h2><blockquote><p>使用苹果开发者账号登录 <a href="https://appstoreconnect.apple.com/">App Store Connect</a>，在应用的功能选项卡页面，添加 App 内购项目。注意：</p></blockquote><ul><li>内购项目的各信息需要填写完整，然后保存，此时内购项目的状态应该是准备提交，当提交应用通过审核后，状态则变为已批准</li><li>测试时，建议使用测试证书打一个自定义的 iOS 基座进行测试</li><li>在应用 <code>TestFight</code> 的选项卡添加 <code>App Store Connect</code> 用户，测试支付时可以使用此用户帐号进行测试</li></ul><span id="more"></span><h2 id="开通-并签署协议"><a href="#开通-并签署协议" class="headerlink" title="开通, 并签署协议"></a>开通, 并签署协议</h2><ol><li>登录<code>App Store Connect</code>签署《付费应用程序协议》, 点击【商务】，签署该页面的所有协议，不能有警告<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918175129_25_148.png" alt="image"></li><li>添加银行账户，CNAPS12位数字(大额支付行号&#x2F;银行识别代码)<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918175913_26_148.png" alt="image"><br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918180108_27_148.png" alt="image"></li><li>添加报税表<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918180800_28_148.png" alt="image"><br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918181023_29_148.png" alt="image"></li></ol><p>&#x3D;&#x3D;<strong>（提示：这一步做完需要等待大概1个小时左右，苹果测试时才会生效）</strong>&#x3D;&#x3D;</p><h2 id="添加沙盒用户"><a href="#添加沙盒用户" class="headerlink" title="添加沙盒用户"></a>添加沙盒用户</h2><ol><li>用户访问，添加沙盒用户，邮箱可以不存在。<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918181344_30_148.png" alt="image"></li><li>手机<code>ios</code> 设备登录沙盒用户，设置-&gt;开发者-》沙盒APPLE账户<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918182956_657.jpg" alt="image"></li></ol><h2 id="添加内购项目"><a href="#添加内购项目" class="headerlink" title="添加内购项目"></a>添加内购项目</h2><ol><li>添加内购项目<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/2025091816522118148.png" alt="image"></li><li>选择销售范围<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/2025091816550119148.png" alt="image"></li><li><code>App</code> 内购买项目定价<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918165627_20_148.png" alt="image"><br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918165810_21_148.png" alt="image"></li><li>添加 <code>App Store</code> 本地化版本<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918165955_22_148.png" alt="image"></li><li>图像（可选）<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918170344_23_148.png" alt="image"></li><li>填写审核信息<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918170600_327.jpg" alt="image"></li><li>点击存储，状态为准备提交</li></ol><h2 id="证书配置"><a href="#证书配置" class="headerlink" title="证书配置"></a>证书配置</h2><p>如果您的应用只接入内购（<code>IAP</code>），那么请您忽略手动创建 <code>Merchant ID</code> 的步骤。您只需要在 <code>Xcode</code> 中开启 <code>In-App Purchase</code> 能力，并在 <code>App Store Connect</code> 中配置商品和银行信息即可。</p><p>证书配置完成记得重新生成</p><p><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250919113251_39_148.png" alt="image"></p><h2 id="配置SDK"><a href="#配置SDK" class="headerlink" title="配置SDK"></a>配置SDK</h2><p><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250919113515_40_148.png" alt="image"></p><h2 id="支付流程"><a href="#支付流程" class="headerlink" title="支付流程"></a>支付流程</h2><ol><li>获取支付通道 (<code>uni.getProvider</code>)</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; applePayCallback &#125; <span class="keyword">from</span> <span class="string">&#x27;@/api&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">RECHARGE_ENV</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@/constant&#x27;</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable constant_">IAP</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// plus.runtime.openURL(&quot;https://apps.apple.com/account/billing&quot;);</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CODE_MAP</span> = <span class="keyword">new</span> <span class="title class_">Map</span>([</span><br><span class="line">[<span class="number">2</span>, <span class="string">&#x27;支付流程结束&#x27;</span>],</span><br><span class="line">[-<span class="number">1</span>, <span class="string">&#x27;参数错误&#x27;</span>],</span><br><span class="line">[-<span class="number">2</span>, <span class="string">&#x27;用户取消&#x27;</span>],</span><br><span class="line">[-<span class="number">3</span>, <span class="string">&#x27;此功能不支持&#x27;</span>],</span><br><span class="line">[-<span class="number">4</span>, <span class="string">&#x27;文件不存在&#x27;</span>],</span><br><span class="line">[-<span class="number">5</span>, <span class="string">&#x27;IO错误&#x27;</span>],</span><br><span class="line">[-<span class="number">6</span>, <span class="string">&#x27;网络错误&#x27;</span>],</span><br><span class="line">[-<span class="number">7</span>, <span class="string">&#x27;业务参数配置缺失&#x27;</span>],</span><br><span class="line">[-<span class="number">8</span>, <span class="string">&#x27;客户端未安装&#x27;</span>],</span><br><span class="line">[-<span class="number">9</span>, <span class="string">&#x27;快捷方式已存在&#x27;</span>],</span><br><span class="line">[-<span class="number">10</span>, <span class="string">&#x27;授权失败&#x27;</span>],</span><br><span class="line">[-<span class="number">100</span>, <span class="string">&#x27;业务内部错误&#x27;</span>]</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取iap支付</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getIpaChannels</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable constant_">IAP</span>)&#123;</span><br><span class="line"><span class="title function_">restoreOrder</span>();</span><br><span class="line"><span class="keyword">return</span> <span class="variable constant_">IAP</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">uni.<span class="title function_">getProvider</span>(&#123;</span><br><span class="line">  <span class="attr">service</span>: <span class="string">&#x27;payment&#x27;</span>,</span><br><span class="line">  <span class="attr">success</span>: <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> iapChannel = res.<span class="property">providers</span>.<span class="title function_">find</span>(<span class="function">(<span class="params">channel</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> (channel.<span class="property">id</span> === <span class="string">&#x27;appleiap&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"><span class="keyword">if</span>(iapChannel)&#123;</span><br><span class="line"><span class="variable constant_">IAP</span> = iapChannel;</span><br><span class="line"><span class="comment">// console.log(&#x27;IAP&#x27;, IAP)</span></span><br><span class="line"><span class="title function_">resolve</span>(iapChannel)</span><br><span class="line"><span class="title function_">restoreOrder</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="title function_">reject</span>(<span class="string">&#x27;未找到苹果IAP支付通道&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">  &#125;,</span><br><span class="line"><span class="attr">fail</span>: <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">reject</span>(e)</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>通过支付通道获取产品列表 (<code>iapChannel.requestProduct</code>)</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取产品列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getProducts</span>(<span class="params">productIds = []</span>) &#123;</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable constant_">IAP</span>)&#123;</span><br><span class="line">uni.<span class="title function_">showToast</span>(&#123;<span class="attr">title</span>: <span class="string">&#x27;IPA通道不存在&#x27;</span>,<span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable constant_">IAP</span>.<span class="title function_">requestProduct</span>(productIds,<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">resolve</span>(res)</span><br><span class="line">&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">reject</span>(err)</span><br><span class="line">&#125;)</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>检查是否存在未关闭的订单 (<code>iapChannel.restoreCompletedTransactions</code>, 可选在合适的时机检查)</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 检查上次用户已支付且未关闭的订单，可能出现原因：首次绑卡，网络中断等异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">restoreOrder</span> () &#123;</span><br><span class="line"><span class="keyword">if</span>(!<span class="variable constant_">IAP</span>)&#123;</span><br><span class="line">uni.<span class="title function_">showToast</span>(&#123;<span class="attr">title</span>: <span class="string">&#x27;IPA通道不存在&#x27;</span>,<span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable constant_">IAP</span>.<span class="title function_">restoreCompletedTransactions</span>(&#123;</span><br><span class="line"><span class="attr">manualFinishTransaction</span>: <span class="literal">true</span>, <span class="comment">// true时不关闭订单</span></span><br><span class="line"><span class="attr">username</span>: <span class="string">&#x27;&#x27;</span> <span class="comment">// 支付商户的名称 可不填</span></span><br><span class="line">&#125;, <span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// console.log(res, &quot;未关闭的订单&quot;);</span></span><br><span class="line"><span class="keyword">if</span> (res?.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="variable constant_">IAP</span>.<span class="title function_">finishTransaction</span>(res[<span class="number">0</span>], <span class="function">(<span class="params">reslut</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(reslut, <span class="string">&#x27;关闭成功&#x27;</span>);</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(err);</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>请求支付，传递产品信息 (<code>uni.requestPayment</code>)</li><li>客户端接收苹果返回的支付票据发送到服务器，在服务器请求苹果服务器验证支付是否有效</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 苹果支付</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">applePay</span>(<span class="params">parameter = &#123;</span></span><br><span class="line"><span class="params">orderInfo,</span></span><br><span class="line"><span class="params">rechargeOrder,</span></span><br><span class="line"><span class="params">successCall,</span></span><br><span class="line"><span class="params">failCall,</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> &#123; orderInfo, successCall, failCall, rechargeOrder &#125; = parameter</span><br><span class="line">uni.<span class="title function_">showLoading</span>(&#123;<span class="attr">title</span>: <span class="string">&#x27;支付中...&#x27;</span>, <span class="attr">mask</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">uni.<span class="title function_">requestPayment</span>(&#123;</span><br><span class="line"><span class="attr">provider</span>: <span class="string">&#x27;appleiap&#x27;</span>,</span><br><span class="line">orderInfo,</span><br><span class="line"><span class="attr">success</span>: <span class="keyword">async</span> (res) =&gt; &#123;</span><br><span class="line"><span class="comment">// console.log(&#x27;@applePay&#x27;, res)</span></span><br><span class="line"><span class="comment">// console.log(&#x27;parameter&#x27;, parameter)</span></span><br><span class="line">uni.<span class="title function_">hideLoading</span>()</span><br><span class="line"><span class="keyword">const</span> transactionId = res.<span class="property">transactionIdentifier</span> <span class="comment">//交易id</span></span><br><span class="line"><span class="keyword">const</span> receiptData = res.<span class="property">transactionReceipt</span> <span class="comment">//校验体</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="title function_">applePayCallback</span>(&#123;</span><br><span class="line"><span class="attr">userId</span>: rechargeOrder?.<span class="property">userId</span>,</span><br><span class="line">transactionId,</span><br><span class="line">receiptData,</span><br><span class="line"><span class="attr">iosOrderId</span>: rechargeOrder?.<span class="property">id</span>,</span><br><span class="line"><span class="attr">environment</span>: <span class="variable constant_">RECHARGE_ENV</span>.<span class="property">sandbox</span></span><br><span class="line">&#125;)</span><br><span class="line">successCall &amp;&amp; <span class="title function_">successCall</span>(res)</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line"><span class="comment">// console.log(&#x27;@applePay@error&#x27;, error)</span></span><br><span class="line">failCall &amp;&amp; <span class="title function_">failCall</span>(error)</span><br><span class="line"><span class="comment">//TODO handle the exception</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">fail</span>: <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// console.log(&#x27;@applePay&#x27;, err)</span></span><br><span class="line">uni.<span class="title function_">hideLoading</span>()</span><br><span class="line"><span class="keyword">let</span> errRes = err</span><br><span class="line"><span class="keyword">if</span>(<span class="variable constant_">CODE_MAP</span>.<span class="title function_">get</span>(err?.<span class="property">code</span>))&#123;</span><br><span class="line">errRes = &#123;</span><br><span class="line">...err,</span><br><span class="line"><span class="attr">message</span>: <span class="variable constant_">CODE_MAP</span>.<span class="title function_">get</span>(err?.<span class="property">code</span>)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">failCall &amp;&amp; <span class="title function_">failCall</span>(errRes)</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ol start="6"><li>服务器验证票据有效后在客户端关闭订单 (<code>iapChannel.finishTransaction</code>)</li></ol><p><code>HBuilder 3.5.1</code> 之前因自动关闭订单导致某些情况下丢单的问题</p><p><code>HBuilder 3.5.1 +</code> 增加了手动关闭订单参数 <code>manualFinishTransaction</code>, 在合适的时机调用<br><code>HBuilder 3.5.1+ </code>开始支持通过 <code>uni.getProvider</code> 获取IAP支付通道的方法</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ol><li>相同订单，重复调用 <code>restoreCompletedTransactions</code> 后 <code>transactionReceipt</code> 会发生变化，并非唯一值</li><li>调用 <code>finishTransaction</code> 关闭订单可能不会立即生效，取决于苹果的服务器</li><li>沙盒环境：一个测试账号相同产品仅能购买一次，重复测试需要清除购买记录或重新添加沙盒测试账号</li><li>沙盒环境：调用 <code>restoreCompletedTransactions</code> 长时间无反应，检查设备登陆的沙箱账号是否正常</li><li>提交<code>App Store</code> 的 <code>App</code> 才能开通应用内支付，使用苹果企业账号发布的 App 不能开通使用</li><li>根据 <code>App Store</code> 审核指南条款 <code>3.1.1</code> 要求，虚拟物品交易必须使用应用内支付，实物交易才可使用第三方支付(支付宝、微信等)</li><li>创建 <code>App</code>内购买项目的各项信息需要填写完整，保存后内购项目的状态是准备提交，当提交应用通过审核后，状态则变为已批准</li><li>正式上线前可在 <code>Test Flight</code> 平台添加 <code>App Store Connect</code> 用户，测试支付时可以使用此用户帐号</li></ol><h2 id="订单丢失场景"><a href="#订单丢失场景" class="headerlink" title="订单丢失场景"></a>订单丢失场景</h2><p>用户没有绑定 <code>AppStore</code> 支付方式，调用 <code>uni.requestPayment()</code> 准备支付，触发失败 fail 回调，<code>errCode=2</code>，用户未绑定支付方式，<code>app</code>内支付流程结束。 系统弹出框引导用户绑定支付方式，此过程将跳转到系统应用 <code>AppStore</code> 进行绑定支付方式，绑定成功同步支付成功，用户成功付款</p><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ol><li>使用开发证书打包，可以借助<code>App Uploader</code>生成证书、和测试、和安装</li></ol><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://developer.apple.com/cn/help/app-store-connect/configure-in-app-purchase-settings/overview-for-configuring-in-app-purchases/">配置 App 内购买项目概述</a></li><li><a href="https://uniapp.dcloud.net.cn/api/plugins/payment.html#iap">苹果应用内支付</a></li><li><a href="https://ask.dcloud.net.cn/article/282">5+API错误代码</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;IOS支付&quot;&gt;&lt;a href=&quot;#IOS支付&quot; class=&quot;headerlink&quot; title=&quot;IOS支付&quot;&gt;&lt;/a&gt;IOS支付&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;使用苹果开发者账号登录 &lt;a href=&quot;https://appstoreconnect.apple.com/&quot;&gt;App Store Connect&lt;/a&gt;，在应用的功能选项卡页面，添加 App 内购项目。注意：&lt;/p&gt;
&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;内购项目的各信息需要填写完整，然后保存，此时内购项目的状态应该是准备提交，当提交应用通过审核后，状态则变为已批准&lt;/li&gt;
&lt;li&gt;测试时，建议使用测试证书打一个自定义的 iOS 基座进行测试&lt;/li&gt;
&lt;li&gt;在应用 &lt;code&gt;TestFight&lt;/code&gt; 的选项卡添加 &lt;code&gt;App Store Connect&lt;/code&gt; 用户，测试支付时可以使用此用户帐号进行测试&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="uniapp" scheme="https://nightme.github.io/categories/uniapp/"/>
    
    
      <category term="uniapp" scheme="https://nightme.github.io/tags/uniapp/"/>
    
  </entry>
  
  <entry>
    <title>注册苹果开发者</title>
    <link href="https://nightme.github.io/2025/09/19/%E6%B3%A8%E5%86%8C%E8%8B%B9%E6%9E%9C%E5%BC%80%E5%8F%91%E8%80%85/"/>
    <id>https://nightme.github.io/2025/09/19/注册苹果开发者/</id>
    <published>2025-09-19T06:23:57.000Z</published>
    <updated>2025-09-19T06:31:41.890Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Apple-Developer-Program"><a href="#Apple-Developer-Program" class="headerlink" title="Apple Developer Program"></a><code>Apple Developer Program</code></h2><h3 id="个人"><a href="#个人" class="headerlink" title="个人"></a>个人</h3><p>如果你是个人或独资企业&#x2F;一人公司，那么你个人的法定姓名将作为供应商列示在 <code>App Store</code> 上。请勿输入别名、昵称或公司名称作为你的姓氏或名字，因为错误地输入你的法定姓名将导致注册审批延误。</p><h3 id="组织"><a href="#组织" class="headerlink" title="组织"></a>组织</h3><p>如果你是公司、非营利组织、合资企业、合伙企业或政府组织的员工，那么法人实体名称将作为供应商列示在 <code>App Store</code> 上。在验证过程中，我们会要求你提供法人实体名称和 <code>D‑U‑N‑S®</code> 编号。成为会员后，你可以选择将更多成员添加到自己的团队中。</p><span id="more"></span><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><ol><li>注册一个邮箱账号（推荐<code>163</code>邮箱，注册过程中基本都是英文，163邮箱自带翻译会节省很多时间）</li><li>再准备一个企业邮箱带域名的，后边会用到</li><li>一部苹果手机以及一个手机号（用于绑定<code>AppleID</code>和填写注册信息）</li><li>注册地址：<a href="https://account.apple.com/account">https://account.apple.com/account</a></li><li>填写信息<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/202509181134.png" alt="注册"></li><li>登录注册账号<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918142754.png" alt="加入苹果开发者"><br>6.手机下载<code>Apple Developer App</code>进行注册<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918143135.png" alt="手机下载Apple Developer App进行注册"></li></ol><h2 id="申请公司邓白氏码-D-U-N-S"><a href="#申请公司邓白氏码-D-U-N-S" class="headerlink" title="申请公司邓白氏码(D-U-N-S)"></a>申请公司邓白氏码(D-U-N-S)</h2><ol><li><a href="https://developer.apple.com/cn/help/account/membership/D-U-N-S/">查看文档DUNS</a></li><li>查找你的 D-U-N-S 编号，填写组织信息，注意需使用英文（工作电子邮件填写以域名为后缀的邮箱）<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918183254_32_148.png" alt="image"></li><li>如果组织有编号则可以查询到，没有的话会提示未找到你的组织，按提示填写信息正常提交申请流程即可，注册时平台如果报错，提示如下，和支持团队反馈了情况以后他们给我发送了一封邮件，让我提交材料，他们帮我提交给邓白氏。<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918183837_33_148.png" alt="image"></li><li>需要提供以下信息，通过邮件发送给苹果技术支持（有问题就联系技术平台，不要乱填）<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918184059_34_148.png" alt="image"></li><li>提交信息以后，邓白氏会给你的邮箱发送一封邮件，按照提示操作，时间比较短，最好提前准备好相关材料<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918184322_35_148.png" alt="image"></li><li>登录邓白氏网<a href="https://sso.dnbportal.cn/">https://sso.dnbportal.cn/</a><br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918184522_36_148.png" alt="image"></li><li>登录后完成实名认证和企业核验，按照指引填就好了，需要什么材料会给你发邮件，多看自己邮箱，官网核验不通过，去微信小程序上操作。<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918184925_37_148.png" alt="image"></li><li>待企业核验通过后点击首页-申请邓白氏编码-选择苹果开发者-下一步-填写订单号和验证码，提交申请。</li><li>提交申请以后等待邓白氏官方给你发邮件就可以。<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918185543_38_148.png" alt="image"></li></ol><h2 id="申请加入开发者"><a href="#申请加入开发者" class="headerlink" title="申请加入开发者"></a>申请加入开发者</h2><blockquote><p>以下过程需要<code>DUNS</code>编码</p></blockquote><ol><li><p>在苹果商店下载 <code>Apple Developer</code><br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/202509181436409148.jpg" alt="image"></p></li><li><p>登录<code>Apple ID</code>账号, 点击立即注册，我同意<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918144943492.png" alt="image"></p></li><li><p>点击同意，按照要求填写身份证信息<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/2025091814454711148.jpg" alt="同意"><br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/2025091814454712148.jpg" alt="填写"></p></li><li><p>进行人脸核验</p></li><li><p>选择对应的实体类型<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20250918150411931.jpg" alt="image"></p></li><li><p>填写<code>DUNS</code>编号，法人实体名称 （如果没有的话需要去申请）<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/2025091815012415148.png" alt="image"></p></li><li><p>按照提示填写企业信息</p></li></ol><blockquote><p>电子邮件必须填企业邮箱，邮箱必须是以域名为后缀的；否则会提示：无效的电子邮箱；<br>填写的网站必须能打开，且域名必须与组织相关联，否则会审核不通过</p></blockquote><p><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/2025091814595514148.png" alt="image"><br>8. 提交信息以后会收到一个注册ID，等待审核，审核通过后就会收到申请成功的邮件<br><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/2025091814584413148.png" alt="image"></p><ol start="9"><li>登录<code>Apple Developer</code>，成功付款以后账号就申请成功啦。</li></ol><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ol><li><a href="https://zhuanlan.zhihu.com/p/4591209458">2024年注册苹果开发者（公司）账号流程 图文教程</a></li><li><a href="https://zhuanlan.zhihu.com/p/4617165705">公司邓白氏码（D-U-N-S 编号）申请流程</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Apple-Developer-Program&quot;&gt;&lt;a href=&quot;#Apple-Developer-Program&quot; class=&quot;headerlink&quot; title=&quot;Apple Developer Program&quot;&gt;&lt;/a&gt;&lt;code&gt;Apple Developer Program&lt;/code&gt;&lt;/h2&gt;&lt;h3 id=&quot;个人&quot;&gt;&lt;a href=&quot;#个人&quot; class=&quot;headerlink&quot; title=&quot;个人&quot;&gt;&lt;/a&gt;个人&lt;/h3&gt;&lt;p&gt;如果你是个人或独资企业&amp;#x2F;一人公司，那么你个人的法定姓名将作为供应商列示在 &lt;code&gt;App Store&lt;/code&gt; 上。请勿输入别名、昵称或公司名称作为你的姓氏或名字，因为错误地输入你的法定姓名将导致注册审批延误。&lt;/p&gt;
&lt;h3 id=&quot;组织&quot;&gt;&lt;a href=&quot;#组织&quot; class=&quot;headerlink&quot; title=&quot;组织&quot;&gt;&lt;/a&gt;组织&lt;/h3&gt;&lt;p&gt;如果你是公司、非营利组织、合资企业、合伙企业或政府组织的员工，那么法人实体名称将作为供应商列示在 &lt;code&gt;App Store&lt;/code&gt; 上。在验证过程中，我们会要求你提供法人实体名称和 &lt;code&gt;D‑U‑N‑S®&lt;/code&gt; 编号。成为会员后，你可以选择将更多成员添加到自己的团队中。&lt;/p&gt;
    
    </summary>
    
      <category term="ios" scheme="https://nightme.github.io/categories/ios/"/>
    
    
      <category term="ios" scheme="https://nightme.github.io/tags/ios/"/>
    
  </entry>
  
  <entry>
    <title>turborepo</title>
    <link href="https://nightme.github.io/2022/12/08/turborepo/"/>
    <id>https://nightme.github.io/2022/12/08/turborepo/</id>
    <published>2022-12-08T13:51:19.000Z</published>
    <updated>2025-09-19T04:25:12.108Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Turborepo-高性能构建系统"><a href="#Turborepo-高性能构建系统" class="headerlink" title="Turborepo 高性能构建系统"></a>Turborepo 高性能构建系统</h2><p><code>Turborepo</code> 是一个用于 <code>JavaScript</code> 和 <code>TypeScript monorepos</code> 的高性能构建系统。<code>Turborepo</code> 重新设计了 <code>Facebook</code> 和谷歌使用的构建系统技术，以消除维护负担和开销。</p><span id="more"></span><p><strong>特性：</strong></p><ul><li>增量构建: 构建一次已经足够痛苦了，<code>Turborepo</code>会记住您构建的内容，并跳过已经计算过的内容。</li><li>内容<code>hash</code>：<code>Turborepo</code>查看您的文件内容，而不是时间戳来找出需要构建的内容。</li><li>远程缓存：与您的团队和<code>CI/CD</code>共享远程构建缓存以获得更快的构建。</li><li>并行执行：在不浪费空闲<code>cpu</code>的情况下，以最大的并行度使用每个核执行构建。</li><li>零运行时开销：<code>Turborepo</code>不会干扰您的运行时代码或触及您的源代码映射。</li><li>删减子集：通过生成一个只需要构建特定目标的 <code>monorepo</code> 的子集来加快 <code>PaaS</code> 的部署速度</li><li>任务管道：定义任务之间的关系，然后让<code>Turborepo</code>优化要构建的内容和时间。</li><li>基于约定的配置：通过约定来降低配置的复杂度，只需要几行简单的 <code>JSON</code> 就能完成配置</li><li>浏览器中的配置文件：生成构建配置文件并在 <code>Chrome</code> 或 <code>Edge</code> 中导入，以了解哪些任务花费的时间最长</li></ul><h2 id="缓存任务"><a href="#缓存任务" class="headerlink" title="缓存任务"></a>缓存任务</h2><p>每个<code>JavaScript</code>或<code>TypeScript</code>代码库都需要运行<code>package.json</code>脚本，如<code>build</code>, <code>test</code>和<code>lint</code>。在<code>Turborepo</code>中，我们称之为任务。</p><p><code>Turborepo</code>可以缓存任务的结果和日志-对于慢速任务可以极大地加速。</p><h3 id="丢失缓存"><a href="#丢失缓存" class="headerlink" title="丢失缓存"></a>丢失缓存</h3><p>假设你在<code>Turborepo</code>中使用<code>turbo run build</code>运行一个构建任务:</p><p><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/202212091726.png" alt="image"></p><ol><li><code>Turborepo</code>将计算任务的输入(默认是工作区文件夹中的所有非<code>git</code>忽略文件)并将它们转换为哈希值(例如<code>78awdk123</code>)。</li><li>检查本地文件系统缓存中以散列命名的文件夹(例如<code>../node_modules/.cache/turbo/78awdk123</code>)。</li><li>如果<code>Turborepo</code>没有为计算的散列找到任何匹配的工件，那么<code>Turborepo</code>将执行该任务。</li><li>任务结束后，<code>Turborepo</code>将所有输出(包括文件和日志)保存到哈希下的缓存中。</li></ol><h3 id="命中缓存"><a href="#命中缓存" class="headerlink" title="命中缓存"></a>命中缓存</h3><p>假设你在不改变任何输入的情况下再次运行任务:</p><ol><li>散列将是相同的，因为输入没有改变(例如<code>78awdk123</code>)</li><li><code>Turborepo</code>将在其缓存中找到带有计算散列的文件夹(例如:<code>/node_modules/.cache/turbo/78awdk123</code>)</li><li><code>Turborepo</code>不运行任务，而是重播输出——将保存的日志打印到标准输出，并将保存的输出文件恢复到文件系统中各自的位置。</li></ol><p>从缓存中恢复文件和日志几乎是瞬间发生的。这可以将构建时间从几分钟或几小时缩短到几秒或几毫秒。尽管具体的结果会根据代码库依赖关系图的形状和粒度而有所不同，但大多数团队发现，使用<code>Turborepo</code>的缓存，他们可以将每月的总体构建时间缩短约<code>40-85%</code>。</p><h3 id="配置缓存输出"><a href="#配置缓存输出" class="headerlink" title="配置缓存输出"></a>配置缓存输出</h3><p>使用管道，您可以在<code>Turborepo</code>中配置缓存约定。</p><p>要覆盖默认的缓存输出行为，将一个<code>glob</code>数组传递给管道。输出数组。任何满足任务<code>glob</code>模式的文件都将被视为工件。</p><p>如果你的任务不产生任何文件(例如使用<code>jest</code>进行单元测试)，将输出设置为空数组(即<code>[]</code>)，<code>Turborepo</code>将为你缓存日志。</p><p>当您运行<code>turbo</code>运行构建测试时，<code>Turborepo</code>将执行您的构建和测试脚本，并将其输出缓存到<code>./node_modules/.cache/turbo</code>中。</p><h3 id="配置缓存输入"><a href="#配置缓存输入" class="headerlink" title="配置缓存输入"></a>配置缓存输入</h3><p>当工作空间中的任何文件发生更改时，就认为该工作空间已经更新。但是，对于某些任务，我们只希望在相关文件发生更改时重新运行该任务。指定输入可以让我们定义哪些文件与特定任务相关。例如，下面的测试配置声明，测试任务只需要<br>在<code>src/</code>和<code>test/</code>子目录中的<code>.tsx</code>或<code>.ts</code>文件自上次执行以来发生更改时才需要执行。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ... omitted for brevity</span></span><br><span class="line"> </span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// A workspace&#x27;s `test` task depends on that workspace&#x27;s</span></span><br><span class="line">      <span class="comment">// own `build` task being completed first.</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="comment">// A workspace&#x27;s `test` task should only be rerun when</span></span><br><span class="line">      <span class="comment">// either a `.tsx` or `.ts` file has changed.</span></span><br><span class="line">      <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src/**/*.tsx&quot;</span><span class="punctuation">,</span> <span class="string">&quot;src/**/*.ts&quot;</span><span class="punctuation">,</span> <span class="string">&quot;test/**/*.ts&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="关闭高速缓存"><a href="#关闭高速缓存" class="headerlink" title="关闭高速缓存"></a>关闭高速缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">turbo run dev --parallel --no-cache</span><br><span class="line"><span class="comment"># 注意`--no-cache`禁用缓存写，但不禁用缓存读。如果你想禁用缓存读取，使用`--force`标志。</span></span><br><span class="line"><span class="comment"># 在所有工作区中并行运行“dev”npm脚本</span></span><br><span class="line"><span class="comment"># 但不缓存输出</span></span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="基于文件更改缓存"><a href="#基于文件更改缓存" class="headerlink" title="基于文件更改缓存"></a>基于文件更改缓存</h3><p>对于某些任务，如果不相关的文件发生更改，您可能不希望缓存丢失。例如，更新<code>README.md</code>可能不需要为测试任务触发缓存缺失。您可以使用输入来限制<code>turbo</code>为特定任务考虑的文件集。</p><p>在这种情况下，只考虑与确定测试任务上的缓存命中相关的<code>.ts</code>和<code>.tsx</code>文件:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ...other tasks</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">// leave empty to only cache logs</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src/**/*.tsx&quot;</span><span class="punctuation">,</span> <span class="string">&quot;src/**/*.ts&quot;</span><span class="punctuation">,</span> <span class="string">&quot;test/**/*.ts&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="基于环境变量修改缓存"><a href="#基于环境变量修改缓存" class="headerlink" title="基于环境变量修改缓存"></a>基于环境变量修改缓存</h3><p>你可以根据环境变量的值来控制<code>turbo</code>的缓存行为:</p><p>在管道定义中的<code>env</code>键中包含环境变量将影响每个任务或每个工作空间任务的缓存指纹。</p><p>任何在其名称中包含<code>THASH</code>的环境变量的值都会影响所有任务的缓存指纹。</p><h3 id="强制覆盖缓存"><a href="#强制覆盖缓存" class="headerlink" title="强制覆盖缓存"></a>强制覆盖缓存</h3><p>相反，如果你想禁止读取缓存并强制<code>turbo</code>重新执行之前缓存的任务，添加<code>--force</code>标志:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Run `build` npm script in all workspaces,</span></span><br><span class="line"><span class="comment"># ignoring cache hits.</span></span><br><span class="line">turbo run build --force</span><br></pre></td></tr></table></figure><h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p><code>turbo</code>不仅缓存任务的输出，它还记录终端输出(即结合<code>stdout</code>和<code>stderr</code>)到(<code>&lt;package&gt;/.turbo/run-&lt;command&gt;.log</code>)。当<code>turbo</code>遇到一个缓存的任务时，它会重新播放输出，就像它再次发生一样，但是是即时的，包的名称略微暗淡。</p><h3 id="哈希"><a href="#哈希" class="headerlink" title="哈希"></a>哈希</h3><p>您可能想知道<code>turbo</code>如何决定给定任务的缓存命中和未命中。</p><ol><li>首先，<code>turbo</code>构造了代码库当前全局状态的哈希值</li><li>然后它添加了更多与给定工作空间任务相关的因素</li></ol><p>一旦<code>turbo</code>在执行过程中遇到给定工作区的任务，它就会检查缓存(本地和远程)以查找匹配的散列。如果匹配，则跳过执行该任务，将缓存的输出移动或下载到合适的位置，并立即重放先前记录的日志。如果缓存(本地或远程)中没有任何与计算的哈希匹配的内容，<code>turbo</code>将在本地执行任务，然后使用哈希作为索引缓存指定的输出。</p><p>给定任务的哈希值在执行时作为环境变量<code>TURBO_HASH</code>注入。这个值在打印输出或标记<code>Dockerfile</code>等方面很有用。</p><h2 id="远程缓存"><a href="#远程缓存" class="headerlink" title="远程缓存"></a>远程缓存</h2><p><code>Turborepo</code>的任务缓存可以节省大量时间，因为它不会重复同样的工作。</p><p>但是有一个问题-缓存是本地的。当您使用<code>CI</code>时，这可能会导致大量重复工作</p><p>因为默认情况下<code>Turborepo</code>只缓存到本地文件系统，所以相同的任务(<code>Turbo</code>运行构建)必须在每台机器上(由您、您的队友、您的<code>CI</code>、您的<code>PaaS</code>等)重新执行，即使所有的任务输入都是相同的–这浪费了时间和资源。</p><blockquote><p>远程缓存是<code>Turborepo</code>的一个强大特性，但是能力越大责任越大。首先要确保缓存正确，并仔细检查环境变量的处理情况。还请记住，<code>Turborepo</code>将日志视为工件，因此要注意打印到控制台的内容。</p></blockquote><h3 id="一个单一的共享缓存"><a href="#一个单一的共享缓存" class="headerlink" title="一个单一的共享缓存"></a>一个单一的共享缓存</h3><p>通过与<code>Vercel</code>等提供商合作，<code>Turborepo</code>可以安全地与远程缓存(存储任务结果的云服务器)通信。</p><p>这可以通过防止整个组织中的重复工作来节省大量的时间。</p><h3 id="Vercel"><a href="#Vercel" class="headerlink" title="Vercel"></a>Vercel</h3><p>本地开发，如果您想将本地<code>turborepo</code>链接到远程缓存，请先使用您的<code>Vercel</code>帐户验证<code>turborepo CLI</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx turbo login</span><br></pre></td></tr></table></figure><p>启用后，对当前正在缓存的工作空间进行一些更改，并使用<code>turbo run</code>对其运行任务。您的缓存工件现在将存储在本地和远程缓存中。</p><p>为了验证，删除您的本地<code>Turborepo</code>缓存:</p><p>然后再次运行相同的构建。如果一切正常，<code>turbo</code>不应该在本地执行任务，而是从远程缓存下载日志和工件，并将它们重放给您。</p><h3 id="自定义远程缓存"><a href="#自定义远程缓存" class="headerlink" title="自定义远程缓存"></a>自定义远程缓存</h3><p>您可以自行托管自己的远程缓存或使用其他远程缓存服务提供商，只要他们符合<code>Turborepo</code>的远程缓存服务器<code>API</code>。</p><p>您可以通过指定<code>--api</code>和<code>--token</code>标志来设置远程缓存域，其中<code>--api</code>是主机名，<code>--token</code>是承载令牌。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">turbo run build --api=<span class="string">&quot;https://my-server.example.com&quot;</span> --token=<span class="string">&quot;xxxxxxxxxxxxxxxxx&quot;</span></span><br></pre></td></tr></table></figure><p>您可以在这里看到所需的端点&#x2F;请求<a href="https://github.com/vercel/turbo/blob/main/cli/internal/client/client.go">在一个新选项卡中打开</a>。</p><h2 id="拓扑"><a href="#拓扑" class="headerlink" title="拓扑"></a>拓扑</h2><p>拓扑排序通常用来“排序”具有依赖关系的任务， 如果 <code>A</code> 依赖于 <code>B</code>，<code>B</code> 依赖于 <code>C</code>，则拓扑顺序为 <code>C、B、A</code>。</p><h2 id="配置文件turbo-json"><a href="#配置文件turbo-json" class="headerlink" title="配置文件turbo.json"></a>配置文件<code>turbo.json</code></h2><p>在<code>monorepo</code>的根目录中，创建一个名为<code>turbo.json</code>的空文件。这将保持<code>Turborepo</code>的配置。</p><p>要定义<code>monorepo</code>的任务依赖关系图，请使用<code>turbo</code>中的<code>pipeline</code>键。<code>Turbo</code>解释这个配置，以优化调度、执行和缓存每个包的输出。在工作空间中定义的<code>Json</code>脚本。</p><p><code>./turbo.json：</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// A package&#x27;s `build` script depends on that package&#x27;s</span></span><br><span class="line">      <span class="comment">// dependencies and devDependencies</span></span><br><span class="line">      <span class="comment">// `build` tasks  being completed first</span></span><br><span class="line">      <span class="comment">// (the `^` symbol signifies `upstream`).</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^build&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="comment">// note: output globs are relative to each package&#x27;s `package.json`</span></span><br><span class="line">      <span class="comment">// (and not the monorepo root)</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;.next/**&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// A package&#x27;s `test` script depends on that package&#x27;s</span></span><br><span class="line">      <span class="comment">// own `build` script being completed first.</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="comment">// A package&#x27;s `test` script should only be rerun when</span></span><br><span class="line">      <span class="comment">// either a `.tsx` or `.ts` file has changed in `src` or `test` folders.</span></span><br><span class="line">      <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src/**/*.tsx&quot;</span><span class="punctuation">,</span> <span class="string">&quot;src/**/*.ts&quot;</span><span class="punctuation">,</span> <span class="string">&quot;test/**/*.ts&quot;</span><span class="punctuation">,</span> <span class="string">&quot;test/**/*.tsx&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;lint&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// A package&#x27;s `lint` script has no dependencies and</span></span><br><span class="line">      <span class="comment">// can be run whenever. It also has no filesystem outputs.</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deploy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// A package&#x27;s `deploy` script depends on the `build`,</span></span><br><span class="line">      <span class="comment">// `test`, and `lint` scripts of the same package</span></span><br><span class="line">      <span class="comment">// being completed. It also has no filesystem outputs.</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">,</span> <span class="string">&quot;test&quot;</span><span class="punctuation">,</span> <span class="string">&quot;lint&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="全局依赖-globalDependencies"><a href="#全局依赖-globalDependencies" class="headerlink" title="全局依赖(globalDependencies)"></a>全局依赖(<code>globalDependencies</code>)</h3><p>用于隐式全局哈希依赖的文件<code>glob</code>列表。这些文件的内容将包含在全局哈希算法中，并影响所有任务的哈希。</p><p>这对于基于<code>.env</code>文件(不在<code>Git</code>中)或任何影响工作空间任务的根级文件(但在传统的依赖关系图中没有表示)破坏缓存非常有用(例如根<code>tsconfig</code>)。<code>Json, jest.config.js， .eslintrc</code>等))。</p><p>例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ... omitted for brevity</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">&quot;globalDependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;.env&quot;</span><span class="punctuation">,</span> <span class="comment">// contents will impact hashes of all tasks</span></span><br><span class="line">    <span class="string">&quot;tsconfig.json&quot;</span> <span class="comment">// contents will impact hashes of all tasks</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="全局环境-globalEnv"><a href="#全局环境-globalEnv" class="headerlink" title="全局环境(globalEnv)"></a>全局环境(<code>globalEnv</code>)</h3><p>用于隐式全局哈希依赖关系的环境变量列表。这些环境变量的内容将包含在全局哈希算法中，并影响所有任务的哈希值。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ... omitted for brevity</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">&quot;globalEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;GITHUB_TOKEN&quot;</span><span class="punctuation">]</span> <span class="comment">// value will impact the hashes of all tasks</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="管道-pipeline"><a href="#管道-pipeline" class="headerlink" title="管道(pipeline)"></a>管道(<code>pipeline</code>)</h3><p>表示项目的任务依赖关系图的对象。<code>Turbo</code>解释这些约定，以正确地调度、执行和缓存项目中任务的输出。</p><p>管道对象中的每个键都是<code>turbo</code>运行可以执行的任务的名称。如果<code>turbo</code>找到一个带有包的工作空间。对象，它将在执行期间将管道任务配置应用到该NPM脚本。这允许您使用管道在整个<code>Turborepo</code>中设置约定。</p><h4 id="依赖于-DependsOn"><a href="#依赖于-DependsOn" class="headerlink" title="依赖于(DependsOn)"></a>依赖于(<code>DependsOn</code>)</h4><p>在<code>dependsOn</code>中的一个项目前面加上<code>^</code>，告诉<code>turbo</code>这个管道任务依赖于工作空间的拓扑依赖关系，首先用<code>^</code>前缀完成任务(例如:“一个工作空间的构建任务应该只在它的所有依赖项和<code>devDependencies</code>完成了它们自己的构建命令后运行”)。</p><p><code>dependsOn</code>中没有<code>^</code>前缀的项表示工作空间级别任务之间的关系(例如:“工作区的<code>test</code>和<code>lint</code>命令依赖于<code>build</code>首先完成”)。</p><p>在<code>dependsOn</code>中的项前面加上<code>$</code>可以告诉<code>turbo</code>这个管道任务依赖于该环境变量的值。</p><blockquote><p>不建议在<code>dependsOn</code>配置中使用<code>$</code>声明环境变量。请使用<code>env</code>键。</p></blockquote><p>例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// &quot;A workspace&#x27;s `build` command depends on its dependencies&#x27;</span></span><br><span class="line">      <span class="comment">// or devDependencies&#x27; `build` command being completed first&quot;</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^build&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// &quot;A workspace&#x27;s `test` command depends on its own `lint` and</span></span><br><span class="line">      <span class="comment">// `build` commands first being completed&quot;</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;lint&quot;</span><span class="punctuation">,</span> <span class="string">&quot;build&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deploy&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// &quot;A workspace&#x27;s `deploy` command, depends on its own `build`</span></span><br><span class="line">      <span class="comment">// and `test` commands first being completed&quot;</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">,</span> <span class="string">&quot;test&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="comment">// A workspace&#x27;s `lint` command has no dependencies</span></span><br><span class="line">    <span class="attr">&quot;lint&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><ul><li>空依赖: 如果一个任务的<code>dependsOn</code>为<code>[]</code> 或者不声明这个属性，那么表明这个任务可以在任意时间被执行</li></ul><h4 id="env"><a href="#env" class="headerlink" title="env"></a>env</h4><p>类型：<code>string []</code></p><p>任务所依赖的环境变量列表。</p><p>例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^build&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;SOMETHING_ELSE&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">// value will impact the hashes of all build tasks</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;dist/**&quot;</span><span class="punctuation">,</span> <span class="string">&quot;.next/**&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;web#build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^build&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;env&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;STRIPE_SECRET_KEY&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span> <span class="comment">// value will impact hash of only web&#x27;s build task</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;.next/**&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;globalEnv&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;GITHUB_TOKEN&quot;</span> <span class="comment">// value will impact the hashes of all tasks</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="outputs"><a href="#outputs" class="headerlink" title="outputs"></a>outputs</h4><p>类型：<code>string []</code></p><p>默认为<code>[&quot;dist/**&quot;， &quot;build/**&quot;]</code>。任务的可缓存文件系统输出的<code>glob</code>模式集。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// &quot;Cache all files emitted to workspace&#x27;s dist/** or .next</span></span><br><span class="line">      <span class="comment">// directories by a `build` task&quot;</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;dist/**&quot;</span><span class="punctuation">,</span> <span class="string">&quot;.next/**&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^build&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// &quot;Don&#x27;t cache any artifacts of `test` tasks (aside from</span></span><br><span class="line">      <span class="comment">// logs)&quot;</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test:ci&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// &quot;Cache the coverage report of a `test:ci` command&quot;</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;coverage/**&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// Never cache anything (including logs) emitted by a</span></span><br><span class="line">      <span class="comment">// `dev` task</span></span><br><span class="line">      <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h4><p>默认为<code>true</code>。是否缓存任务输出。将缓存设置为<code>false</code>对于不希望缓存的守护进程或长时间运行的“监视”或开发模式任务非常有用。</p><p>例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^build&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;dev&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;cache&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="inputs"><a href="#inputs" class="headerlink" title="inputs"></a>inputs</h4><p>默认为<code>[]</code>。告诉<code>turbo</code>在确定工作空间是否为特定任务更改时要考虑的文件集。将此设置为一个<code>glob</code>列表将导致仅当匹配这些<code>glob</code>的文件发生更改时才重新运行任务。例如，如果您希望跳过运行测试，除非源文件发生了更改，那么这将很有帮助。</p><p>指定<code>[]</code>将导致在工作区中的任何文件更改时重新运行任务</p><p>例子：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">// ... omitted for brevity</span></span><br><span class="line"> </span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="comment">// A workspace&#x27;s `test` task depends on that workspace&#x27;s</span></span><br><span class="line">      <span class="comment">// own `build` task being completed first.</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="comment">// A workspace&#x27;s `test` task should only be rerun when</span></span><br><span class="line">      <span class="comment">// either a `.tsx` or `.ts` file has changed.</span></span><br><span class="line">      <span class="attr">&quot;inputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;src/**/*.tsx&quot;</span><span class="punctuation">,</span> <span class="string">&quot;src/**/*.ts&quot;</span><span class="punctuation">,</span> <span class="string">&quot;test/**/*.ts&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="outputMode"><a href="#outputMode" class="headerlink" title="outputMode"></a>outputMode</h4><p><code>outputMode</code>代表输出的模式类型是字符串</p><ul><li><code>full：</code>默认值。显示所有输出</li><li><code>hash-only：</code>只显示任务的哈希值</li><li><code>new-only：</code>只显示缓存未命中的输出</li><li><code>none：</code>隐藏所有任务输出</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;^build&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;outputMode&quot;</span><span class="punctuation">:</span> <span class="string">&quot;new-only&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;test&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;outputs&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;dependsOn&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;build&quot;</span><span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="命令行"><a href="#命令行" class="headerlink" title="命令行"></a>命令行</h2><p>在安装<code>turbo</code>包(或克隆一个启动器)之后，您可以开始使用<code>Turborepo</code>的命令行界面(CLI) <code>turbo</code>在您的<code>monorepo</code>中做各种事情。</p><h3 id="全局参数"><a href="#全局参数" class="headerlink" title="全局参数"></a>全局参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">turbo run build --color</span><br><span class="line"><span class="comment"># 为CI运行器启用turbo的颜色输出，这些运行器支持在日志输出中呈现颜色。</span></span><br><span class="line"></span><br><span class="line">turbo run build --no-color</span><br><span class="line"><span class="comment"># 禁止在输出中使用颜色</span></span><br></pre></td></tr></table></figure><h3 id="任务参数"><a href="#任务参数" class="headerlink" title="任务参数"></a>任务参数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">turbo run build --cache-dir=<span class="string">&quot;./my-cache&quot;</span></span><br><span class="line"><span class="comment"># 默认为。/node_modules/.cache/turbo。指定本地文件系统缓存目录。如果更改默认值，请确保将此文件夹添加到.gitignore中</span></span><br><span class="line"></span><br><span class="line">turbo run build --concurrency=50%</span><br><span class="line"><span class="comment"># 默认值为10。设置/限制任务执行的最大并发数。这必须是大于等于1的整数或百分比值，如50%,如果还传递了--parallel标志，则忽略此选项。</span></span><br><span class="line"></span><br><span class="line">turbo run build --<span class="built_in">continue</span></span><br><span class="line"><span class="comment"># 默认为false。这个标志告诉turbo在出现错误(即任务的非零退出码)时是否继续执行。默认情况下，指定--parallel标志将自动设置--continue为true，除非显式设置为false。当--continue为true时，turbo将以执行期间遇到的最高退出码值退出。</span></span><br><span class="line"></span><br><span class="line">turbo run build --cwd=./somewhere/else</span><br><span class="line"><span class="comment"># 设置命令的工作目录。</span></span><br><span class="line"></span><br><span class="line">turbo run build --filter=my-pkg --filter=my-app</span><br><span class="line"><span class="comment"># 你可以通过给命令传递多个--filter标志来指定多个过滤器</span></span><br><span class="line"></span><br><span class="line">turbo run build --filter=admin-*</span><br><span class="line"><span class="comment"># 构建所有以“admin-”开头的工作区，让turbo推断任务</span></span><br><span class="line"></span><br><span class="line">turbo run <span class="built_in">test</span> --filter=...my-lib</span><br><span class="line"><span class="comment"># 测试&#x27;my-lib&#x27;和所有依赖于&#x27;my-lib&#x27;的东西</span></span><br><span class="line"></span><br><span class="line">turbo run <span class="built_in">test</span> --filter=...^my-lib</span><br><span class="line"><span class="comment"># 测试所有依赖于&#x27;my-lib&#x27;的东西，而不是&#x27;my-lib&#x27;本身</span></span><br><span class="line"></span><br><span class="line">turbo run build --filter=./apps/*</span><br><span class="line"><span class="comment"># 在&quot;apps&quot;目录下构建所有的工作空间</span></span><br><span class="line"></span><br><span class="line">turbo run build --graph</span><br><span class="line"><span class="comment"># 该命令将生成当前任务图的svg、png、jpg、pdf、json、html或其他支持的输出格式(在新选项卡中打开)。输出文件格式默认为jpg，但可以通过指定文件名的扩展名来控制。</span></span><br><span class="line"></span><br><span class="line">turbo run build --force</span><br><span class="line"><span class="comment"># 忽略现有的缓存工件并强制重新执行所有任务</span></span><br><span class="line"></span><br><span class="line">turbo run build --global-deps=<span class="string">&quot;.env.*&quot;</span> --global-deps=<span class="string">&quot;.eslintrc&quot;</span> --global-deps=<span class="string">&quot;jest.config.js&quot;</span></span><br><span class="line"><span class="comment"># 指定要散列的全局文件系统依赖项的`glob`。适用于`.env`和根目录下影响多个包/应用程序的文件。可以多次指定。</span></span><br><span class="line"></span><br><span class="line">turbo run build --ignore=<span class="string">&quot;apps/**/*&quot;</span></span><br><span class="line"><span class="comment"># 忽略影响作用域的文件或目录。在盖下使用glob模式</span></span><br><span class="line"></span><br><span class="line">turbo run build --no-cache</span><br><span class="line"><span class="comment"># 默认的错误。不要缓存任务的结果。这对于监视命令(如next dev或react-scripts start)非常有用。</span></span><br><span class="line"></span><br><span class="line">turbo run build --output-logs=full</span><br><span class="line"><span class="comment"># full默认值。显示所有输出；hash-only只显示任务的哈希值；new-only只显示缓存未命中的输出；none隐藏所有任务输出</span></span><br><span class="line"></span><br><span class="line">turbo run <span class="built_in">test</span> --only</span><br><span class="line"><span class="comment"># 默认的错误。限制执行只包括指定的任务。这与lerna和pnpm默认运行任务的方式非常相似。</span></span><br><span class="line"></span><br><span class="line">turbo run lint --parallel --no-cache</span><br><span class="line"><span class="comment"># 默认的错误。跨工作空间并行运行命令并忽略依赖关系图。这对于实时重载开发非常有用。</span></span><br><span class="line"></span><br><span class="line">turbo run build --remote-only</span><br><span class="line"><span class="comment"># 默认的错误。忽略所有任务的本地文件系统缓存。只允许读取和缓存使用远程缓存的工件。</span></span><br><span class="line"></span><br><span class="line">turbo run build --team=my-team --token=xxxxxxxxxxxxxxxxx</span><br><span class="line"><span class="comment"># 用于远程缓存的承载令牌。用于在非交互式shell(例如CI/CD)中结合——team标志运行。</span></span><br><span class="line"></span><br><span class="line">turbo run build --team=my-team</span><br><span class="line"><span class="comment"># 远程缓存团队的蛞蝓。与--token和--team标志结合在非交互式shell中运行时非常有用。</span></span><br><span class="line"></span><br><span class="line">turbo run build --preflight</span><br><span class="line"><span class="comment"># 仅适用于配置远程工件缓存时。允许在每个缓存工件和分析请求之前发送预飞行请求。后续的上传和下载将遵循重定向。</span></span><br><span class="line"></span><br><span class="line">turbo run build --trace=<span class="string">&quot;&lt;trace-file-name&gt;&quot;</span></span><br><span class="line"><span class="comment"># 要查看CPU跟踪，输出跟踪到给定的文件，使用go工具trace [file]。</span></span><br><span class="line"></span><br><span class="line">turbo run build --heap=<span class="string">&quot;&lt;heap-file-name&gt;&quot;</span></span><br><span class="line"><span class="comment"># 要查看堆跟踪，将跟踪输出到给定文件，使用go工具pprof [file]并输入top。你也可以将它放入speedscope(在一个新选项卡中打开)，并使用左重视图或三明治视图模式。</span></span><br><span class="line"></span><br><span class="line">turbo run build --cpuprofile=<span class="string">&quot;&lt;cpu-profile-file-name&gt;&quot;</span></span><br><span class="line"><span class="comment"># 要查看CPU配置文件，将配置文件输出到给定文件中，将文件放入speedscope</span></span><br><span class="line"></span><br><span class="line">turbo run build -v</span><br><span class="line">turbo run build -vv</span><br><span class="line">turbo run build -vvv</span><br><span class="line"><span class="comment"># 要指定日志级别，使用-v表示信息，-vv表示调试，-vvv表示跟踪标志</span></span><br></pre></td></tr></table></figure><h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><h3 id="创建新的monorepo"><a href="#创建新的monorepo" class="headerlink" title="创建新的monorepo"></a>创建新的<code>monorepo</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ npx create-turbo@latest</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; TURBOREPO</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; Welcome to Turborepo! Let<span class="string">&#x27;s get you set up with a new codebase.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">? Where would you like to create your turborepo? ./my-turborepo</span></span><br><span class="line"><span class="string">? Which package manager do you want to use? pnpm</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt;&gt; Created a new turborepo with the following:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> - apps/web: Next.js with TypeScript</span></span><br><span class="line"><span class="string"> - apps/docs: Next.js with TypeScript</span></span><br><span class="line"><span class="string"> - packages/ui: Shared React component library</span></span><br><span class="line"><span class="string"> - packages/eslint-config-custom: Shared configuration (ESLint)</span></span><br><span class="line"><span class="string"> - packages/tsconfig: Shared TypeScript `tsconfig.json`</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&gt;&gt;&gt; Success! Created a new Turborepo at &quot;my-turborepo&quot;.</span></span><br><span class="line"><span class="string">Inside that directory, you can run several commands:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  pnpm run build</span></span><br><span class="line"><span class="string">     Build all apps and packages</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  pnpm run dev</span></span><br><span class="line"><span class="string">     Develop all apps and packages</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Turborepo will cache locally by default. For an additional</span></span><br><span class="line"><span class="string">speed boost, enable Remote Caching with Vercel by</span></span><br><span class="line"><span class="string">entering the following command:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  pnpm dlx turbo login</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">We suggest that you begin by typing:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  cd my-turborepo</span></span><br><span class="line"><span class="string">  pnpm dlx turbo login</span></span><br></pre></td></tr></table></figure><ul><li>创建我们的工程名</li><li>推荐使用<code>pnpm</code> 构建</li></ul><p><code>turbo</code> 会自动根据我们选择的包管理器为我们创建相对应的项目 然后我们进入项目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pnpm run dev</span><br><span class="line"><span class="comment"># 只会执行两个脚本——docs:dev和web:dev。这是仅有的两个指定dev的工作空间。</span></span><br><span class="line"><span class="comment"># 两个开发脚本同时运行，在端口3000和3001上启动Next.js应用程序。</span></span><br><span class="line"><span class="comment"># 在终端中，您将看到缓存绕过，强制执行。</span></span><br><span class="line"></span><br><span class="line">pnpm run dev --filter docs</span><br><span class="line"><span class="comment"># 你会注意到它现在只运行docs:dev</span></span><br></pre></td></tr></table></figure><h3 id="添加到现有的monorepo"><a href="#添加到现有的monorepo" class="headerlink" title="添加到现有的monorepo"></a>添加到现有的<code>monorepo</code></h3><p>安装<code>turbo</code>，添加<code>turbo</code>作为<code>monorepo</code>根目录的开发依赖项。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pnpm add turbo -Dw</span><br></pre></td></tr></table></figure><h3 id="创建-turbo-json"><a href="#创建-turbo-json" class="headerlink" title="创建 turbo.json"></a>创建 <code>turbo.json</code></h3><p>在<code>monorepo</code>的根目录中，创建一个名为<code>turbo.json</code>的空文件。这将保存<code>Turborepo</code>的配置。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://turbo.build/schema.json&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul><li>创建管道</li><li>编辑<code>.gitignore</code></li><li>创建<code>package. json</code>脚本</li><li>构建 <code>monorepo</code></li><li>配置远程缓存</li></ul><p>按照以上的步骤，你的项目基本已经配置完成。</p><h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>您现在已经启动并运行<code>Turborepo</code>，但仍有几件事要做:</p><ul><li>了解<code>Turborepo</code>缓存的工作原理</li><li>正确处理环境变量</li><li>学会用管道编排任务运行</li><li>高效筛选包任务</li><li>使用<code>CI</code>提供商配置<code>Turborepo</code></li></ul><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://turbo.build/">turbo官网</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Turborepo-高性能构建系统&quot;&gt;&lt;a href=&quot;#Turborepo-高性能构建系统&quot; class=&quot;headerlink&quot; title=&quot;Turborepo 高性能构建系统&quot;&gt;&lt;/a&gt;Turborepo 高性能构建系统&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Turborepo&lt;/code&gt; 是一个用于 &lt;code&gt;JavaScript&lt;/code&gt; 和 &lt;code&gt;TypeScript monorepos&lt;/code&gt; 的高性能构建系统。&lt;code&gt;Turborepo&lt;/code&gt; 重新设计了 &lt;code&gt;Facebook&lt;/code&gt; 和谷歌使用的构建系统技术，以消除维护负担和开销。&lt;/p&gt;
    
    </summary>
    
      <category term="工具" scheme="https://nightme.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="工具" scheme="https://nightme.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>vue之keepAlive</title>
    <link href="https://nightme.github.io/2019/12/19/vue%E4%B9%8BkeepAlive/"/>
    <id>https://nightme.github.io/2019/12/19/vue之keepAlive/</id>
    <published>2019-12-18T17:00:10.000Z</published>
    <updated>2025-09-19T04:25:12.109Z</updated>
    
    <content type="html"><![CDATA[<h2 id="keep-alive语法"><a href="#keep-alive语法" class="headerlink" title="keep-alive语法"></a><code>keep-alive</code>语法</h2><h6 id="props"><a href="#props" class="headerlink" title="props"></a><code>props</code></h6><ul><li><code>include</code> - 字符串或正则表达式。只有名称匹配的组件会被缓存。</li><li><code>exclude</code> - 字符串或正则表达式。任何名称匹配的组件都不会被缓存。</li><li><code>max</code> - 数字。最多可以缓存多少组件实例。</li></ul><p><code>include</code> 和 <code>exclude prop</code> 允许组件有条件地缓存。二者都可以用逗号分隔字符串、正则表达式或一个数组来表示：</p><span id="more"></span><h6 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h6><ul><li><code>&lt;keep-alive&gt;</code> 包裹动态组件时，会缓存不活动的组件实例，而不是销毁它们。和 <code>&lt;transition&gt;</code> 相似</li><li><code>&lt;keep-alive&gt;</code> 是一个抽象组件：它自身不会渲染一个 <code>DOM</code> 元素，也不会出现在组件的父组件链中。</li><li>当组件在 <code>&lt;keep-alive&gt;</code> 内被切换，它的 <code>activated</code> 和 <code>deactivated</code> 这两个生命周期钩子函数将会被对应执行。</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 基本 --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;view&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;!-- 多个条件判断的子组件 --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">comp-a</span> <span class="attr">v-if</span>=<span class="string">&quot;a &gt; 1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">comp-a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">comp-b</span> <span class="attr">v-else</span>&gt;</span><span class="tag">&lt;/<span class="name">comp-b</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">&lt;!-- 和 <span class="string">`&lt;transition&gt;`</span> 一起使用 --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">transition</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;view&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">  <span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>匹配首先检查组件自身的 <code>name</code> 选项，如果 <code>name</code> 选项不可用，则匹配它的局部注册名称 (父组件 <code>components</code> 选项的键值)。匿名组件不能被匹配。</p><p><strong><keep-alive> 不会在函数式组件中正常工作，因为它们没有缓存实例。</strong></p><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><h6 id="get-first-component-child-js"><a href="#get-first-component-child-js" class="headerlink" title="get-first-component-child.js "></a><code>get-first-component-child.js </code></h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; isDef &#125; <span class="keyword">from</span> <span class="string">&#x27;shared/util&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; isAsyncPlaceholder &#125; <span class="keyword">from</span> <span class="string">&#x27;./is-async-placeholder&#x27;</span></span><br><span class="line"><span class="comment">// 获取第一个子组件(d带componentOptions)</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getFirstComponentChild</span> (<span class="attr">children</span>: ?<span class="title class_">Array</span>&lt;<span class="title class_">VNode</span>&gt;): ?<span class="title class_">VNode</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(children)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; children.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> c = children[i]</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">isDef</span>(c) &amp;&amp; (<span class="title function_">isDef</span>(c.<span class="property">componentOptions</span>) || <span class="title function_">isAsyncPlaceholder</span>(c))) &#123;</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="v2-6-12-src-core-components-keep-alive-js"><a href="#v2-6-12-src-core-components-keep-alive-js" class="headerlink" title="v2.6.12/src/core/components/keep-alive.js"></a><code>v2.6.12/src/core/components/keep-alive.js</code></h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一般都在代码档案的最上面一行加入类型检查的注释，没加Flow工具是不会进行检查的</span></span><br><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; isRegExp, remove &#125; <span class="keyword">from</span> <span class="string">&#x27;shared/util&#x27;</span></span><br><span class="line"><span class="comment">// 获取第一个子组件</span></span><br><span class="line"><span class="keyword">import</span> &#123; getFirstComponentChild &#125; <span class="keyword">from</span> <span class="string">&#x27;core/vdom/helpers/index&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ?VNode代表的是类型可自定义，也就是值的部份除了定义的类型，也可以是null或undefined，不过这属性是需要的</span></span><br><span class="line">type <span class="title class_">VNodeCache</span> = &#123; [<span class="attr">key</span>: string]: ?<span class="title class_">VNode</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取组件名/标签名</span></span><br><span class="line"><span class="comment">// 匹配首先检查组件自身的 name 选项，如果 name 选项不可用，则匹配它的局部注册名称 (父组件 components 选项的键值)</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getComponentName</span> (<span class="attr">opts</span>: ?<span class="title class_">VNodeComponentOptions</span>): ?string &#123;</span><br><span class="line">  <span class="keyword">return</span> opts &amp;&amp; (opts.<span class="property">Ctor</span>.<span class="property">options</span>.<span class="property">name</span> || opts.<span class="property">tag</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否匹配</span></span><br><span class="line"><span class="comment">// pattern可以用逗号分隔字符串、正则表达式或一个数组</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">matches</span> (<span class="attr">pattern</span>: string | <span class="title class_">RegExp</span> | <span class="title class_">Array</span>&lt;string&gt;, <span class="attr">name</span>: string): boolean &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(pattern)) &#123;</span><br><span class="line">    <span class="keyword">return</span> pattern.<span class="title function_">indexOf</span>(name) &gt; -<span class="number">1</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> pattern === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> pattern.<span class="title function_">split</span>(<span class="string">&#x27;,&#x27;</span>).<span class="title function_">indexOf</span>(name) &gt; -<span class="number">1</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="title function_">isRegExp</span>(pattern)) &#123;</span><br><span class="line">    <span class="keyword">return</span> pattern.<span class="title function_">test</span>(name)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 不计入覆盖率</span></span><br><span class="line">  <span class="comment">/* istanbul ignore next */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//更新（删除）缓存</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pruneCache</span> (<span class="attr">keepAliveInstance</span>: any, <span class="attr">filter</span>: <span class="title class_">Function</span>) &#123;</span><br><span class="line">  <span class="comment">// 当前keepAlive示例 _vnode 已渲染的虚拟dom</span></span><br><span class="line">  <span class="keyword">const</span> &#123; cache, keys, _vnode &#125; = keepAliveInstance</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> cache) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">cachedNode</span>: ?<span class="title class_">VNode</span> = cache[key]</span><br><span class="line">    <span class="comment">// 已缓存</span></span><br><span class="line">    <span class="keyword">if</span> (cachedNode) &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">name</span>: ?string = <span class="title function_">getComponentName</span>(cachedNode.<span class="property">componentOptions</span>)</span><br><span class="line">      <span class="comment">// 排除已缓存的组件</span></span><br><span class="line">      <span class="keyword">if</span> (name &amp;&amp; !<span class="title function_">filter</span>(name)) &#123;</span><br><span class="line">        <span class="title function_">pruneCacheEntry</span>(cache, key, keys, _vnode)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除或销毁缓存的组件</span></span><br><span class="line"><span class="comment">// current属性是可选的</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">pruneCacheEntry</span> (</span><br><span class="line">  <span class="attr">cache</span>: <span class="title class_">VNodeCache</span>,</span><br><span class="line">  <span class="attr">key</span>: string,</span><br><span class="line">  <span class="attr">keys</span>: <span class="title class_">Array</span>&lt;string&gt;,</span><br><span class="line">  current?: <span class="title class_">VNode</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">const</span> cached = cache[key]</span><br><span class="line">  <span class="keyword">if</span> (cached &amp;&amp; (!current || cached.<span class="property">tag</span> !== current.<span class="property">tag</span>)) &#123;</span><br><span class="line">    <span class="comment">// 执行组件的destory钩子函数 销毁组件</span></span><br><span class="line">    cached.<span class="property">componentInstance</span>.$destroy()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 清空缓存的虚拟dom</span></span><br><span class="line">  cache[key] = <span class="literal">null</span></span><br><span class="line">  <span class="comment">// 从数组中移除该项key</span></span><br><span class="line">  <span class="title function_">remove</span>(keys, key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// patternTypes 数组</span></span><br><span class="line"><span class="comment">// 类型 可以用逗号分隔字符串、正则表达式或一个数组</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">patternTypes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Function</span>&gt; = [<span class="title class_">String</span>, <span class="title class_">RegExp</span>, <span class="title class_">Array</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: <span class="string">&#x27;keep-alive&#x27;</span>,</span><br><span class="line">  <span class="comment">//抽象组件：它自身不会渲染一个 DOM 元素，也不会出现在组件的父组件链中。</span></span><br><span class="line">  <span class="attr">abstract</span>: <span class="literal">true</span>,</span><br><span class="line"></span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="comment">// 字符串或正则表达式。只有名称匹配的组件会被缓存。</span></span><br><span class="line">    <span class="attr">include</span>: patternTypes,</span><br><span class="line">    <span class="comment">// 字符串或正则表达式。任何名称匹配的组件都不会被缓存。</span></span><br><span class="line">    <span class="attr">exclude</span>: patternTypes,</span><br><span class="line">    <span class="comment">// 最多可以缓存多少组件实例。</span></span><br><span class="line">    <span class="attr">max</span>: [<span class="title class_">String</span>, <span class="title class_">Number</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  created () &#123;</span><br><span class="line">    <span class="comment">// 缓存虚拟dom</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cache</span> = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line">    <span class="comment">// 缓存的虚拟dom的健集合</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">keys</span> = []</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  destroyed () &#123;</span><br><span class="line">    <span class="comment">// 删除所有的缓存组件</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">cache</span>) &#123;</span><br><span class="line">      <span class="title function_">pruneCacheEntry</span>(<span class="variable language_">this</span>.<span class="property">cache</span>, key, <span class="variable language_">this</span>.<span class="property">keys</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  mounted () &#123;</span><br><span class="line">    <span class="comment">// 对include和exclude参数进行监听，然后实时地更新（删除）</span></span><br><span class="line">    <span class="variable language_">this</span>.$watch(<span class="string">&#x27;include&#x27;</span>, <span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">pruneCache</span>(<span class="variable language_">this</span>, <span class="function"><span class="params">name</span> =&gt;</span> <span class="title function_">matches</span>(val, name))</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.$watch(<span class="string">&#x27;exclude&#x27;</span>, <span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">pruneCache</span>(<span class="variable language_">this</span>, <span class="function"><span class="params">name</span> =&gt;</span> !<span class="title function_">matches</span>(val, name))</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  render () &#123;</span><br><span class="line">    <span class="comment">// 获取默认分发的虚拟dom(可能多个)</span></span><br><span class="line">    <span class="keyword">const</span> slot = <span class="variable language_">this</span>.<span class="property">$slots</span>.<span class="property">default</span></span><br><span class="line">    <span class="comment">//获取第一个子组件的虚拟dom</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">vnode</span>: <span class="title class_">VNode</span> = <span class="title function_">getFirstComponentChild</span>(slot)</span><br><span class="line">    <span class="comment">// 获取虚拟dom组件参数</span></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">componentOptions</span>: ?<span class="title class_">VNodeComponentOptions</span> = vnode &amp;&amp; vnode.<span class="property">componentOptions</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (componentOptions) &#123;</span><br><span class="line">      <span class="comment">// ?string代表的是类型可自定义string，也就是值的部份除了定义的类型，</span></span><br><span class="line">      <span class="comment">// 也可以是null或undefined，不过这属性是需要的</span></span><br><span class="line">      <span class="comment">//获取到组件的name，存在组件名则直接使用组件名，否则会使用标签(tag)</span></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">name</span>: ?string = <span class="title function_">getComponentName</span>(componentOptions)</span><br><span class="line">      <span class="keyword">const</span> &#123; include, exclude &#125; = <span class="variable language_">this</span></span><br><span class="line">      <span class="comment">// include 只有名称匹配的组件会被缓存</span></span><br><span class="line">      <span class="comment">// exclude 匹配的组件都不会被缓存</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// 不包含</span></span><br><span class="line">        (include &amp;&amp; (!name || !<span class="title function_">matches</span>(include, name))) ||</span><br><span class="line">        <span class="comment">// 排除在外</span></span><br><span class="line">        (exclude &amp;&amp; name &amp;&amp; <span class="title function_">matches</span>(exclude, name))</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span> vnode</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> &#123; cache, keys &#125; = <span class="variable language_">this</span></span><br><span class="line">      <span class="comment">// 获取/生成代表组件的唯一标识key</span></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">key</span>: ?string = vnode.<span class="property">key</span> == <span class="literal">null</span></span><br><span class="line">        <span class="comment">// 同一构造函数可能会注册为不同的本地组件</span></span><br><span class="line">        <span class="comment">// 因此仅凭cid是不够的（＃3269）</span></span><br><span class="line">        ? componentOptions.<span class="property">Ctor</span>.<span class="property">cid</span> + (componentOptions.<span class="property">tag</span> ? <span class="string">`::<span class="subst">$&#123;componentOptions.tag&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        : vnode.<span class="property">key</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (cache[key]) &#123;</span><br><span class="line">        <span class="comment">// 已缓存虚拟dom</span></span><br><span class="line">        <span class="comment">// 将缓存的vnode的componentInstance（组件实例）赋值到目前的vnode上面</span></span><br><span class="line">        vnode.<span class="property">componentInstance</span> = cache[key].<span class="property">componentInstance</span></span><br><span class="line">        <span class="comment">// 移除缓存的key</span></span><br><span class="line">        <span class="title function_">remove</span>(keys, key)</span><br><span class="line">        <span class="comment">// 重新插入新的key，相当于修改了key的顺序</span></span><br><span class="line">        keys.<span class="title function_">push</span>(key)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 未缓存虚拟dom,则进行缓存虚拟dom</span></span><br><span class="line">        cache[key] = vnode</span><br><span class="line">        <span class="comment">//缓存key</span></span><br><span class="line">        keys.<span class="title function_">push</span>(key)</span><br><span class="line">        <span class="comment">// 如果缓存的组件数量大于max时，销毁最早缓存的那个组件</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">max</span> &amp;&amp; keys.<span class="property">length</span> &gt; <span class="built_in">parseInt</span>(<span class="variable language_">this</span>.<span class="property">max</span>)) &#123;</span><br><span class="line">          <span class="comment">//_vnode 是经过 render处理过的</span></span><br><span class="line">          <span class="title function_">pruneCacheEntry</span>(cache, keys[<span class="number">0</span>], keys, <span class="variable language_">this</span>.<span class="property">_vnode</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//标记已缓存</span></span><br><span class="line">      vnode.<span class="property">data</span>.<span class="property">keepAlive</span> = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// keepalive组件只能渲染一个子元素</span></span><br><span class="line">    <span class="keyword">return</span> vnode || (slot &amp;&amp; slot[<span class="number">0</span>])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;keep-alive语法&quot;&gt;&lt;a href=&quot;#keep-alive语法&quot; class=&quot;headerlink&quot; title=&quot;keep-alive语法&quot;&gt;&lt;/a&gt;&lt;code&gt;keep-alive&lt;/code&gt;语法&lt;/h2&gt;&lt;h6 id=&quot;props&quot;&gt;&lt;a href=&quot;#props&quot; class=&quot;headerlink&quot; title=&quot;props&quot;&gt;&lt;/a&gt;&lt;code&gt;props&lt;/code&gt;&lt;/h6&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;include&lt;/code&gt; - 字符串或正则表达式。只有名称匹配的组件会被缓存。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;exclude&lt;/code&gt; - 字符串或正则表达式。任何名称匹配的组件都不会被缓存。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;max&lt;/code&gt; - 数字。最多可以缓存多少组件实例。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;include&lt;/code&gt; 和 &lt;code&gt;exclude prop&lt;/code&gt; 允许组件有条件地缓存。二者都可以用逗号分隔字符串、正则表达式或一个数组来表示：&lt;/p&gt;
    
    </summary>
    
      <category term="javascript" scheme="https://nightme.github.io/categories/javascript/"/>
    
    
      <category term="vue" scheme="https://nightme.github.io/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>vue之NextTick实现</title>
    <link href="https://nightme.github.io/2019/10/19/vue%E4%B9%8BNextTick%E5%AE%9E%E7%8E%B0/"/>
    <id>https://nightme.github.io/2019/10/19/vue之NextTick实现/</id>
    <published>2019-10-18T17:54:10.000Z</published>
    <updated>2025-09-19T04:25:12.109Z</updated>
    
    <content type="html"><![CDATA[<h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><p><code>Vue.nextTick( [callback, context] )</code></p><ul><li><strong>参数：</strong><ul><li><code>&#123;Function&#125; [callback]</code></li><li><code>&#123;Object&#125; [context]</code></li></ul></li><li>用法：<ul><li>在下次 <code>DOM</code> 更新循环结束之后执行延迟回调。在修改数据之后立即使用这个方法，获取更新后的 <code>DOM</code></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 修改数据</span><br><span class="line">vm.msg = <span class="string">&#x27;Hello&#x27;</span></span><br><span class="line">// DOM 还没有更新</span><br><span class="line">Vue.nextTick(<span class="function"><span class="title">function</span></span> () &#123;</span><br><span class="line">  // DOM 更新了</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><strong>2.1.0起新增</strong>：如果没有提供回调且在支持 <code>Promise</code> 的环境中，则返回一个 <code>Promise</code>。请注意 <code>Vue</code> 不自带 <code>Promise</code> 的 <code>polyfill</code>，所以如果你的目标浏览器不原生支持 <code>Promise</code> (<code>IE</code>：你们都看我干嘛)，你得自己提供 <code>polyfill</code>。</p><span id="more"></span><h2 id="异步更新队列"><a href="#异步更新队列" class="headerlink" title="异步更新队列"></a>异步更新队列</h2><ol><li><code>Vue</code> 在更新 <code>DOM</code> 时是异步执行的</li><li>只要侦听到数据变化，<code>Vue</code> 将开启一个队列，并缓冲在同一事件循环中发生的所有数据变更</li><li>在缓冲时去除重复数据对于避免不必要的计算和 <code>DOM</code> 操作是非常重要的。然后，在下一个的事件循环<code>tick</code>中更新</li><li>如果同一个 <code>watcher</code> 被多次触发，只会被推入到队列中一次</li><li><code>Vue</code> 在内部对异步队列尝试使用原生的 <code>Promise.then</code>、<code>MutationObserver</code> 和  <code>setImmediate</code>，如果执行环境不支持，则会采用 <code>setTimeout(fn, 0)</code> 代替</li></ol><h2 id="v2-6-12之next-tick源码"><a href="#v2-6-12之next-tick源码" class="headerlink" title="v2.6.12之next-tick源码"></a><code>v2.6.12</code>之<code>next-tick</code>源码</h2><h6 id="辅助方法"><a href="#辅助方法" class="headerlink" title="辅助方法"></a>辅助方法</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//是否IE</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isIE = <span class="variable constant_">UA</span> &amp;&amp; <span class="regexp">/msie|trident/</span>.<span class="title function_">test</span>(<span class="variable constant_">UA</span>)</span><br><span class="line"><span class="comment">//空函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">noop</span> (a?: any, b?: any, c?: any) &#123;&#125;</span><br><span class="line"><span class="comment">/* istanbul ignore next */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">isNative</span> (<span class="title class_">Ctor</span>: any): boolean &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> <span class="title class_">Ctor</span> === <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="regexp">/native code/</span>.<span class="title function_">test</span>(<span class="title class_">Ctor</span>.<span class="title function_">toString</span>())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//是否ios</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isIOS = (<span class="variable constant_">UA</span> &amp;&amp; <span class="regexp">/iphone|ipad|ipod|ios/</span>.<span class="title function_">test</span>(<span class="variable constant_">UA</span>)) || (weexPlatform === <span class="string">&#x27;ios&#x27;</span>)</span><br></pre></td></tr></table></figure><h6 id="next-tick-js"><a href="#next-tick-js" class="headerlink" title="next-tick.js"></a><code>next-tick.js</code></h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"><span class="comment">/* globals MutationObserver */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">&#x27;shared/util&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; handleError &#125; <span class="keyword">from</span> <span class="string">&#x27;./error&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; isIE, isIOS, isNative &#125; <span class="keyword">from</span> <span class="string">&#x27;./env&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否正在使用微任务</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> isUsingMicroTask = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用来存储所有需要执行的回调函数</span></span><br><span class="line"><span class="keyword">const</span> callbacks = []</span><br><span class="line"><span class="comment">// 该变量的作用是表示状态，判断是否有正在执行的回调函数。</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行缓冲回调</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span> () &#123;</span><br><span class="line">  pending = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.<span class="title function_">slice</span>(<span class="number">0</span>)</span><br><span class="line">  callbacks.<span class="property">length</span> = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里，我们使用微任务异步延迟包装器。</span></span><br><span class="line"><span class="comment">// 在2.5中，我们使用了（宏）任务（与微任务结合使用）。</span></span><br><span class="line"><span class="comment">// 但是，当在重新绘制之前更改状态时，它存在一些细微的问题</span></span><br><span class="line"><span class="comment">// （例如＃6813，由外向内的过渡）。</span></span><br><span class="line"><span class="comment">// 此外，在事件处理程序中使用（宏）任务会导致一些奇怪的行为</span></span><br><span class="line"><span class="comment">// 无法规避的代码（例如＃7109，＃7153，＃7546，＃7834，＃8109）。</span></span><br><span class="line"><span class="comment">// 因此，我们现在再次在各处使用微任务。</span></span><br><span class="line"><span class="comment">// 这种折衷的主要缺点是存在一些场景</span></span><br><span class="line"><span class="comment">// 微任务的优先级过高，并且在两者之间触发</span></span><br><span class="line"><span class="comment">// 顺序事件（例如，具有解决方法的＃4521，＃6690）</span></span><br><span class="line"><span class="comment">// 甚至在同一事件冒泡之间（＃6566）。</span></span><br><span class="line"><span class="keyword">let</span> timerFunc</span><br><span class="line"></span><br><span class="line"><span class="comment">// nextTick行为利用了微任务队列，可以访问它</span></span><br><span class="line"><span class="comment">// 通过本地Promise.then或MutationObserver。</span></span><br><span class="line"><span class="comment">// MutationObserver拥有更广泛的支持，但是在此方面存在严重错误</span></span><br><span class="line"><span class="comment">// 在触摸事件处理程序中触发时，iOS&gt; = 9.3.3中的UIWebView。 它</span></span><br><span class="line"><span class="comment">// 触发几次后完全停止工作...因此，如果是原生的</span></span><br><span class="line"><span class="comment">// Promise可用，我们将使用它：</span></span><br><span class="line"><span class="comment">/* istanbul 忽略下一个, $flow-disable-line */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(<span class="title class_">Promise</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    p.<span class="title function_">then</span>(flushCallbacks)</span><br><span class="line">    <span class="comment">// 在有问题的UIWebViews中，Promise.then不会完全中断，但是</span></span><br><span class="line">    <span class="comment">// 它可能会陷入怪异的状态，在这种状态下，回调被推入微任务队列，</span></span><br><span class="line">    <span class="comment">// 但是直到浏览器才刷新队列，需要做其他一些工作</span></span><br><span class="line">    <span class="comment">// 例如 处理一个计时器。 因此，我们可以</span></span><br><span class="line">    <span class="comment">// 通过添加空计时器来“强制”刷新微任务队列。</span></span><br><span class="line">    <span class="keyword">if</span> (isIOS) <span class="built_in">setTimeout</span>(noop)</span><br><span class="line">  &#125;</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isIE &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">MutationObserver</span> !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; (</span><br><span class="line">  <span class="title function_">isNative</span>(<span class="title class_">MutationObserver</span>) ||</span><br><span class="line">  <span class="comment">// PhantomJS and iOS 7.x</span></span><br><span class="line">  <span class="title class_">MutationObserver</span>.<span class="title function_">toString</span>() === <span class="string">&#x27;[object MutationObserverConstructor]&#x27;</span></span><br><span class="line">)) &#123;</span><br><span class="line">  <span class="comment">// timerFunc函数执行时会导致文本节点textNode的数据发生改变，因为MutationObserver对象在监听文本节点，</span></span><br><span class="line">  <span class="comment">// 所以进而也就会触发flushCallbacks回调函数</span></span><br><span class="line">  <span class="comment">// 如果本地Promise不可用，请使用MutationObserver，</span></span><br><span class="line">  <span class="comment">// 例如 PhantomJS，iOS7，Android 4.4</span></span><br><span class="line">  <span class="comment">//（＃6466 MutationObserver在IE11中不可靠）</span></span><br><span class="line">  <span class="keyword">let</span> counter = <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">MutationObserver</span>(flushCallbacks)</span><br><span class="line">  <span class="keyword">const</span> textNode = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="title class_">String</span>(counter))</span><br><span class="line">  observer.<span class="title function_">observe</span>(textNode, &#123;</span><br><span class="line">    <span class="attr">characterData</span>: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    counter = (counter + <span class="number">1</span>) % <span class="number">2</span></span><br><span class="line">    textNode.<span class="property">data</span> = <span class="title class_">String</span>(counter)</span><br><span class="line">  &#125;</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; <span class="title function_">isNative</span>(setImmediate)) &#123;</span><br><span class="line">  <span class="comment">// 回退到setImmediate。</span></span><br><span class="line">  <span class="comment">// 从技术上讲，它利用了（宏）任务队列，</span></span><br><span class="line">  <span class="comment">// 但它仍然是比setTimeout更好的选择。</span></span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setImmediate</span>(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 回退到setTimeout。</span></span><br><span class="line">  timerFunc = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">nextTick</span> (cb?: <span class="title class_">Function</span>, ctx?: <span class="title class_">Object</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line">  callbacks.<span class="title function_">push</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cb.<span class="title function_">call</span>(ctx)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="title function_">handleError</span>(e, ctx, <span class="string">&#x27;nextTick&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123;</span><br><span class="line">      <span class="title function_">_resolve</span>(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">timerFunc</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 如果没有提供回调且在支持 `Promise` 的环境中，则返回一个 `Promise`</span></span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="title class_">Promise</span> !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="MutationObserver"><a href="#MutationObserver" class="headerlink" title="MutationObserver"></a><code>MutationObserver</code></h2><ul><li><code>MutationObserver</code>接口提供了监视对<code>DOM</code>树所做更改的能力。</li><li>它被设计为旧的<code>Mutation Events</code>功能的替代品，该功能是<code>DOM3 Events</code>规范的一部分。</li></ul><ol><li><code>childList：</code>子节点的变动（指新增，删除或者更改）。</li><li><code>attributes：</code>属性的变动。</li><li><code>characterData：</code>节点内容或节点文本的变动。</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">flushCallbacks</span> (mutationsList, observer) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;flushCallbacks&quot;</span>,&#123;</span><br><span class="line">        mutationsList,</span><br><span class="line">        observer</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> counter = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> observer = <span class="keyword">new</span> <span class="title class_">MutationObserver</span>(flushCallbacks)</span><br><span class="line"><span class="keyword">const</span> textNode = <span class="variable language_">document</span>.<span class="title function_">createTextNode</span>(<span class="title class_">String</span>(counter))</span><br><span class="line">observer.<span class="title function_">observe</span>(textNode, &#123;</span><br><span class="line">    <span class="comment">//节点内容或节点文本的变动。</span></span><br><span class="line">    <span class="attr">characterData</span>: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">textNode.<span class="property">data</span> = <span class="title class_">String</span>(counter);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 停止监控</span></span><br><span class="line">observer.<span class="title function_">disconnect</span>();</span><br></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://cn.vuejs.org/v2/api/#Vue-nextTick">Vue-nextTick</a></li><li><a href="https://cn.vuejs.org/v2/guide/reactivity.html#%E5%BC%82%E6%AD%A5%E6%9B%B4%E6%96%B0%E9%98%9F%E5%88%97">异步更新队列</a></li><li><a href="https://github.com/vuejs/vue/blob/v2.6.12/src/core/util/next-tick.js">v2.6.12&#x2F;src&#x2F;core&#x2F;util&#x2F;next-tick</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;语法&quot;&gt;&lt;a href=&quot;#语法&quot; class=&quot;headerlink&quot; title=&quot;语法&quot;&gt;&lt;/a&gt;语法&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Vue.nextTick( [callback, context] )&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;参数：&lt;/strong&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;&amp;#123;Function&amp;#125; [callback]&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;#123;Object&amp;#125; [context]&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;用法：&lt;ul&gt;
&lt;li&gt;在下次 &lt;code&gt;DOM&lt;/code&gt; 更新循环结束之后执行延迟回调。在修改数据之后立即使用这个方法，获取更新后的 &lt;code&gt;DOM&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;// 修改数据&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;vm.msg = &lt;span class=&quot;string&quot;&gt;&amp;#x27;Hello&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;// DOM 还没有更新&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;Vue.nextTick(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;title&quot;&gt;function&lt;/span&gt;&lt;/span&gt; () &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  // DOM 更新了&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;strong&gt;2.1.0起新增&lt;/strong&gt;：如果没有提供回调且在支持 &lt;code&gt;Promise&lt;/code&gt; 的环境中，则返回一个 &lt;code&gt;Promise&lt;/code&gt;。请注意 &lt;code&gt;Vue&lt;/code&gt; 不自带 &lt;code&gt;Promise&lt;/code&gt; 的 &lt;code&gt;polyfill&lt;/code&gt;，所以如果你的目标浏览器不原生支持 &lt;code&gt;Promise&lt;/code&gt; (&lt;code&gt;IE&lt;/code&gt;：你们都看我干嘛)，你得自己提供 &lt;code&gt;polyfill&lt;/code&gt;。&lt;/p&gt;
    
    </summary>
    
      <category term="javascript" scheme="https://nightme.github.io/categories/javascript/"/>
    
    
      <category term="vue" scheme="https://nightme.github.io/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>React Hooks</title>
    <link href="https://nightme.github.io/2019/05/19/react-hooks/"/>
    <id>https://nightme.github.io/2019/05/19/react-hooks/</id>
    <published>2019-05-18T17:54:10.000Z</published>
    <updated>2025-09-19T04:25:12.102Z</updated>
    
    <content type="html"><![CDATA[<h2 id="React-Hooks"><a href="#React-Hooks" class="headerlink" title="React Hooks"></a>React Hooks</h2><p><code>Hook</code> 是 <code>React 16.8</code> 的新增特性。它可以让你在不编写 <code>class</code> 的情况下使用 <code>state</code> 以及其他的 <code>React</code> 特性。</p><ol><li>只在最顶层使用 <code>Hook</code></li><li>只在 <code>React</code> 函数中调用 <code>Hook</code></li></ol><span id="more"></span><h4 id="基础-Hook"><a href="#基础-Hook" class="headerlink" title="基础 Hook"></a>基础 Hook</h4><ol><li><code>useState</code></li><li><code>useEffect</code></li><li><code>useContext</code></li></ol><h4 id="额外的-Hook"><a href="#额外的-Hook" class="headerlink" title="额外的 Hook"></a>额外的 Hook</h4><ol><li><code>useReducer</code></li><li><code>useCallback</code></li><li><code>useMemo</code></li><li><code>useRef</code></li><li><code>useImperativeHandle</code></li><li><code>useLayoutEffect</code></li><li><code>useDebugValue</code></li></ol><p><strong>注意</strong></p><p><code>React 16.8.0</code> 是第一个支持 <code>Hook</code> 的版本。升级时，请注意更新所有的 <code>package</code>，包括 <code>React DOM</code> <code>React Native</code> 从 <code>0.59</code> 版本开始支持 <code>Hook</code>。</p><h2 id="ESLint-插件"><a href="#ESLint-插件" class="headerlink" title="ESLint 插件"></a>ESLint 插件</h2><p>一个名为 <code>eslint-plugin-react-hooks</code> 的 <code>ESLint</code> 插件来强制执行这两条规则。如果你想尝试一下，可以将此插件添加到你的项目中：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install eslint-plugin-react-hooks --save-dev</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 你的 ESLint 配置</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;plugins&quot;</span>: [</span><br><span class="line">    // ...</span><br><span class="line">    <span class="string">&quot;react-hooks&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;rules&quot;</span>: &#123;</span><br><span class="line">    // ...</span><br><span class="line">    <span class="string">&quot;react-hooks/rules-of-hooks&quot;</span>: <span class="string">&quot;error&quot;</span>, // 检查 Hook 的规则</span><br><span class="line">    <span class="string">&quot;react-hooks/exhaustive-deps&quot;</span>: <span class="string">&quot;warn&quot;</span> // 检查 effect 的依赖</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>后续版本默认添加此插件到 <code>Create React App</code> 及其他类似的工具包中。</p><h2 id="useState"><a href="#useState" class="headerlink" title="useState"></a><code>useState</code></h2><p><code>useState</code> 是最基本的 <code>API</code>，它传入一个初始值，每次函数执行都能拿到新值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./index.module.scss&#x27;</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">PageCount</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.PageMain&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count - 1)&#125;&gt;-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">PageCount</span>;</span><br></pre></td></tr></table></figure><h2 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a><code>useReducer</code></h2><p><code>useReducer</code> 和 <code>useState</code> 几乎是一样的，需要外置外置 <code>reducer</code> (全局)，通过这种方式可以对多个状态同时进行控制。仔细端详起来，其实跟 <code>redux</code> 中的数据流的概念非常接近。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useReducer &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./index.module.scss&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line"><span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;up&#x27;</span>:</span><br><span class="line"><span class="keyword">return</span> &#123; <span class="attr">count</span>: state.<span class="property">count</span> + <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;down&#x27;</span>:</span><br><span class="line"><span class="keyword">return</span> &#123; <span class="attr">count</span>: state.<span class="property">count</span> - <span class="number">1</span> &#125;;</span><br><span class="line"><span class="attr">default</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">PageCount</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [state, dispatch] = <span class="title function_">useReducer</span>(reducer, &#123; <span class="attr">count</span>: <span class="number">1</span> &#125;)</span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.PageMain&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(&#123; type: &#x27;up&#x27; &#125;)&#125;&gt;+<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;state.count&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> dispatch(&#123; type: &#x27;down&#x27; &#125;)&#125;&gt;-<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">PageCount</span>;</span><br></pre></td></tr></table></figure><h2 id="useEffect"><a href="#useEffect" class="headerlink" title="useEffect"></a><code>useEffect</code></h2><p>在 <code>React hook</code> 中，<code>useEffect</code> 用来取代 <code>componentDidMount</code> 和 <code>componentDidUpdate</code>。主要作用是当页面渲染后，进行一些副作用操作（比如访问 <code>DOM</code>，请求数据）。</p><p>数据获取，设置订阅或者手动直接更改 <code>React</code> 组件中的 <code>DOM</code> 都属于副作用。有的人习惯成这种行为为 <code>effect</code></p><p><code>Effect Hook</code> 可以让你能够在 <code>Function</code> 组件中执行副作用</p><p><code>React</code> 组件中有两种常见的副作用：</p><ol><li>需要清理的副作用</li><li>不需要清理的副作用。</li></ol><p>如果在重新渲染之间没有更新某些值，则可以告诉 <code>React</code> 跳过 <code>effect</code> ，为了实现这种方式，需要将数组作为可选的第二个参数传递给 <code>useEffect</code></p><p>从 <code>effect</code> 中返回一个 <code>function</code> ,这是 <code>effect</code> 可选的清理机制。每个 <code>effect</code> 都可以返回一个在它之后清理的 <code>function</code></p><ul><li><code>useEffect</code>最后，不加<code>[]</code>就表示每一次渲染都执行</li><li><code>useEffect</code>最后，加了<code>[]</code>就表示只第一次执行</li><li><code>useEffect</code>最后，加<code>[]</code>，并且<code>[]</code>里面加的字段就表示，这个字段更改了，我这个<code>effect</code>才执行</li><li><code>useEffect</code>不能被判断包裹</li><li><code>useEffect</code>不能被打断</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./index.module.scss&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">PageCount</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// =&gt; componentDidMount/componentDidUpdate</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="comment">// update</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">`You clicked <span class="subst">$&#123;count&#125;</span> times`</span>;</span><br><span class="line"><span class="comment">// =&gt; componentWillUnMount</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">cleanup</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">&#x27;app&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;, [count]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.PageMain&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>You clicked &#123;count&#125; times<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;Click me <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">PageCount</span>;</span><br></pre></td></tr></table></figure><h3 id="React-何时清除-effect？"><a href="#React-何时清除-effect？" class="headerlink" title="React 何时清除 effect？"></a><code>React</code> 何时清除 <code>effect？</code></h3><p><code>React</code> 会在组件卸载的时候执行清除操作。正如之前学到的，<code>effect</code> 在每次渲染的时候都会执行。这就是为什么 <code>React</code> 会在执行当前 <code>effect</code> 之前对上一个 <code>effect</code> 进行清除。</p><p>这将助于避免 <code>bug</code>以及如何在遇到性能问题时跳过此行为。</p><h2 id="useMemo"><a href="#useMemo" class="headerlink" title="useMemo"></a><code>useMemo</code></h2><p><code>useMemo</code>缓存计算数据的值</p><p><code>useMemo</code> 主要用于渲染过程优化，两个参数依次是计算函数（通常是组件函数）和依赖状态列表，当依赖的状态发生改变时，才会触发计算函数的执行。如果没有指定依赖，则每一次渲染过程都会执行该计算函数。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useMemo &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> styles <span class="keyword">from</span> <span class="string">&#x27;./index.module.scss&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">WithMemo</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> [val, setValue] = <span class="title function_">useState</span>(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> expensive = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count * <span class="number">100</span>; i++) &#123;</span><br><span class="line">sum += i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> sum;</span><br><span class="line">&#125;, [count]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">className</span>=<span class="string">&#123;styles.PageMain&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">h4</span>&gt;</span>&#123;count&#125;-&#123;expensive&#125;<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;val&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(count + 1)&#125;&gt;click me +1<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;val&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;event</span> =&gt;</span> setValue(event.target.value)&#125; /&gt;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="useContext"><a href="#useContext" class="headerlink" title="useContext"></a><code>useContext</code></h2><p><code>useContext</code>与<code>useReducer</code>的使用</p><p>调用<code>useContext</code>，传入从<code>React.createContext</code>获取的上下文对象。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; createContext, useContext, useReducer &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="comment">//默认状态</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> defaultState = &#123;</span><br><span class="line"><span class="attr">value</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//reducer</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">reducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line"><span class="keyword">switch</span> (action.<span class="property">type</span>) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;ADD_NUM&#x27;</span>:</span><br><span class="line"><span class="keyword">return</span> &#123; ...state, <span class="attr">value</span>: state.<span class="property">value</span> + <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;REDUCE_NUM&#x27;</span>:</span><br><span class="line"><span class="keyword">return</span> &#123; ...state, <span class="attr">value</span>: state.<span class="property">value</span> - <span class="number">1</span> &#125;;</span><br><span class="line"><span class="attr">default</span>:</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//存储</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">StoreContext</span> = <span class="title function_">createContext</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//子组件一</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ChildFirst</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AppContext</span> = <span class="title function_">useContext</span>(<span class="title class_">StoreContext</span>)</span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">AppContext.dispatch(&#123;</span></span><br><span class="line"><span class="language-xml">type: &quot;ADD_NUM&quot;,</span></span><br><span class="line"><span class="language-xml">payload: &#123;&#125;</span></span><br><span class="line"><span class="language-xml">&#125;)</span></span><br><span class="line"><span class="language-xml">&#125;&#125;&gt;增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">AppContext.dispatch(&#123;</span></span><br><span class="line"><span class="language-xml">type: &quot;REDUCE_NUM&quot;,</span></span><br><span class="line"><span class="language-xml">payload: &#123;&#125;</span></span><br><span class="line"><span class="language-xml">&#125;)</span></span><br><span class="line"><span class="language-xml">&#125;&#125;&gt;递减<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//子组件二</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">ChildSecond</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AppContext</span> = <span class="title function_">useContext</span>(<span class="title class_">StoreContext</span>)</span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">&#123;AppContext.state.value + &#x27;s&#x27;&#125;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//其他页面只需要引入根组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [state, dispatch] = <span class="title function_">useReducer</span>(reducer, defaultState)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">StoreContext.Provider</span> <span class="attr">value</span>=<span class="string">&#123;&#123;</span> <span class="attr">state</span>, <span class="attr">dispatch:</span> <span class="attr">dispatch</span> &#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">ChildFirst</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">ChildSecond</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">StoreContext.Provider</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="useRef"><a href="#useRef" class="headerlink" title="useRef"></a><code>useRef</code></h2><p>在函数式组件里没有了 <code>this</code> 来存放一些实例的变量，所以 <code>React</code> 建议使用 <code>useRef</code> 来存放一些会发生变化的值，<code>useRef</code> 并不再单单是为了 <code>DOM</code> 的 <code>ref</code> 准备的，同时也会用来存放组件实例的属性。</p><p><code>useRef</code> 主要有两个使用场景：</p><ol><li>获取子组件或者 <code>DOM</code> 节点的句柄</li><li>渲染周期之间的共享数据的存储</li></ol><h4 id="createRef与useRef"><a href="#createRef与useRef" class="headerlink" title="createRef与useRef"></a><code>createRef</code>与<code>useRef</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, createRef, useRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [renderIndex, setRenderIndex] = <span class="title function_">useState</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">const</span> fromUseRef = <span class="title function_">useRef</span>();</span><br><span class="line"><span class="keyword">const</span> fromCreateRef = <span class="title function_">createRef</span>();</span><br><span class="line"><span class="keyword">if</span> (!fromUseRef.<span class="property">current</span>) &#123;</span><br><span class="line">fromUseRef.<span class="property">current</span> = renderIndex;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!fromCreateRef.<span class="property">current</span>) &#123;</span><br><span class="line">fromCreateRef.<span class="property">current</span> = renderIndex;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>当前渲染index : &#123;renderIndex&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>fromUseRef : &#123;fromUseRef.current&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>fromCreateRef &#123;fromCreateRef.current&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">setRenderIndex(prev =&gt; prev + 1);</span></span><br><span class="line"><span class="language-xml">&#125;&#125;&gt;</span></span><br><span class="line"><span class="language-xml">点击</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="useRef经典例子"><a href="#useRef经典例子" class="headerlink" title="useRef经典例子"></a><code>useRef</code>经典例子</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">const</span> lastCount = <span class="title function_">useRef</span>(count)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleClick</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;你点击了&quot;</span> + count + <span class="string">&quot;次&quot;</span>);</span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;你点击了&quot;</span> + lastCount.<span class="property">current</span> + <span class="string">&quot;次&quot;</span>);</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">lastCount.<span class="property">current</span> = count;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>你点击了 : &#123;count&#125;次<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123; setCount(count + 1) &#125;&#125;&gt;点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123; handleClick() &#125;&#125;&gt;显示提示<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>useRef</code> 每次都会返回同一个引用, 所以在 <code>useEffect</code> 中修改的时候 ,在 <code>alert</code> 中也会同时被修改. 这样子, 点击的时候就可以弹出实时的 <code>count</code> 了.</p><h4 id="useRef获取上一次的值"><a href="#useRef获取上一次的值" class="headerlink" title="useRef获取上一次的值"></a><code>useRef</code>获取上一次的值</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; useState, useRef &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">const</span> prevtCount = <span class="title function_">useRef</span>()</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">prevtCount.<span class="property">current</span> = count;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>prevtCount : &#123;prevtCount.current&#125;次<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>你点击了 : &#123;count&#125;次<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123; setCount(count + 1) &#125;&#125;&gt;点击<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="将获取上一次的值封装成自定义钩子"><a href="#将获取上一次的值封装成自定义钩子" class="headerlink" title="将获取上一次的值封装成自定义钩子"></a>将获取上一次的值封装成自定义钩子</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取以前的状态</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">usePrevious</span>(<span class="params">state</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> ref = <span class="title function_">useRef</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">ref.<span class="property">current</span> = state;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> ref.<span class="property">current</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//其他页面只需要引入功能根组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">const</span> prevtCount = <span class="title function_">usePrevious</span>(count)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>prevtCount : &#123;prevtCount&#125;次<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>你点击了 : &#123;count&#125;次<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123; setCount(count + 1) &#125;&#125;&gt;点击加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> &#123; setCount(count - 1) &#125;&#125;&gt;点击减<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="useCallback"><a href="#useCallback" class="headerlink" title="useCallback"></a><code>useCallback</code></h2><p><code>useCallback</code>缓存函数的引用</p><p>使用<code>useCallback</code>去缓存我们的 <code>handleClick</code></p><p><code>setCount</code>方法支持接收一个函数，通过这个函数可以获取最新的<code>state</code>值</p><p><code>useCallback</code>是基于<code>useMemo</code>的封装。只有当依赖数组产生变化时，<code>useCallback</code>才会返回一个新的函数，否则始终返回第一次的传入<code>callback</code>。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//子组件</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Child</span> = <span class="title class_">React</span>.<span class="title function_">memo</span>(<span class="function">(<span class="params">&#123; onClick &#125;</span>) =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;onClick&#125;</span>&gt;</span>click<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//其他页面只需要引入功能根组件</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//在setCount 这样操作的时候，不用闭包中的变量，而是使用函数，获取最新的值。</span></span><br><span class="line"><span class="keyword">const</span> handleClick = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">&#125;, [])</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">Child</span> <span class="attr">onClick</span>=<span class="string">&#123;handleClick&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">Child</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">``</span></span><br><span class="line"></span><br><span class="line"><span class="string">`useCallback`</span> 的真正目的还是在于缓存了每次渲染时 <span class="string">`inline callback`</span> 的实例，这样方便配合上子组件的 <span class="string">`shouldComponentUpdate`</span> 或者 <span class="string">`React.memo`</span> 起到减少不必要的渲染的作用。</span><br><span class="line"></span><br><span class="line">需要不断提醒自己注意的是，在大部分 <span class="string">`callback`</span> 都会是 <span class="string">`inline callback`</span> 的未来，<span class="string">`React.memo`</span>和 <span class="string">`React.useCallback`</span> 一定记得需要配对使用，缺了一个都可能导致性能不升反“降”，毕竟无意义的浅比较也是要消耗那么一点点点的性能。</span><br><span class="line"></span><br><span class="line">只有对于大计算量的函数来说，利用<span class="string">`useCallback`</span>才能起到良好的优化效果</span><br><span class="line"></span><br><span class="line">## <span class="string">`useLayoutEffect`</span></span><br><span class="line"></span><br><span class="line">其函数签名与 <span class="string">`useEffect`</span> 相同，但它会在所有的 <span class="string">`DOM`</span> 变更之后同步调用 <span class="string">`effect`</span>。可以使用它来读取 <span class="string">`DOM`</span> 布局并同步触发重渲染。</span><br><span class="line"></span><br><span class="line">在浏览器执行绘制之前，<span class="string">`useLayoutEffect`</span> 内部的更新计划将被同步刷新。</span><br><span class="line"></span><br><span class="line">### 提示</span><br><span class="line"></span><br><span class="line">* <span class="string">`useLayoutEffect`</span> 与 <span class="string">`componentDidMount、componentDidUpdate`</span> 的调用阶段是一样的。但是，我们推荐你一开始先用 <span class="string">`useEffect`</span>，只有当它出问题的时候再尝试使用 <span class="string">`useLayoutEffect`</span></span><br><span class="line"></span><br><span class="line"><span class="string">``</span><span class="string">`javascript</span></span><br><span class="line"><span class="string">//当你每次点击 div， count 会更新为 0， 之后 useEffect 内又把 count 改为一串随机数。</span></span><br><span class="line"><span class="string">//所以页面会先渲染成0，然后再渲染成随机数，由于更新很快，所以出现了闪烁</span></span><br><span class="line"><span class="string">function RootCompent() &#123;</span></span><br><span class="line"><span class="string">const [count, setCount] = useState(0);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">useEffect(() =&gt; &#123;</span></span><br><span class="line"><span class="string">if (count === 0) &#123;</span></span><br><span class="line"><span class="string">const randomNum = 10 + Math.random() * 200</span></span><br><span class="line"><span class="string">setCount(10 + Math.random() * 200);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;, [count]);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">return (</span></span><br><span class="line"><span class="string">&lt;div&gt;</span></span><br><span class="line"><span class="string">&lt;p&gt;&#123;count&#125;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;div onClick=&#123;() =&gt; setCount(0)&#125;&gt;点击&lt;/div&gt;</span></span><br><span class="line"><span class="string">&lt;/div&gt;</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//使用useLayoutEffect之后</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">useLayoutEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (count === <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> randomNum = <span class="number">10</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">200</span></span><br><span class="line"><span class="title function_">setCount</span>(<span class="number">10</span> + <span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">200</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;, [count]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setCount(0)&#125;&gt;点击<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="useDebugValue"><a href="#useDebugValue" class="headerlink" title="useDebugValue"></a><code>useDebugValue</code></h2><p><code>useDebugValue</code> 可用于在 <code>React</code> 开发者工具中显示自定义 <code>hook</code> 的标签。</p><h3 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h3><p>不推荐你向每个自定义 <code>Hook</code> 添加 <code>debug</code> 值。当它作为共享库的一部分时才最有价值。</p><p><code>useDebugValue</code>接受一个格式化函数作为可选的第二个参数。该函数只有在 <code>Hook</code> 被检查时才会被调用。它接受 <code>debug</code> 值作为参数，并且会返回一个格式化的显示值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useDebugValue</span>(date, <span class="function"><span class="params">date</span> =&gt;</span> date.<span class="title function_">toDateString</span>());</span><br></pre></td></tr></table></figure><h2 id="useImperativeHandle"><a href="#useImperativeHandle" class="headerlink" title="useImperativeHandle"></a><code>useImperativeHandle</code></h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useImperativeHandle</span>(ref, createHandle, [deps])</span><br></pre></td></tr></table></figure><p><code>useImperativeHandle</code> 可以让你在使用 <code>ref</code> 时自定义暴露给父组件的实例值。在大多数情况下，应当避免使用 <code>ref</code> 这样的命令式代码。<code>useImperativeHandle</code> 应当与 <code>forwardRef</code> 一起使用</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Child</span>(<span class="params">props, ref</span>) &#123;</span><br><span class="line"><span class="keyword">const</span> kun = <span class="title function_">useRef</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> introduce = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;i can sing, jump, rap, play basketball&#x27;</span>)</span><br><span class="line">&#125;, [])</span><br><span class="line"></span><br><span class="line"><span class="title function_">useImperativeHandle</span>(ref, <span class="function">() =&gt;</span> (&#123;</span><br><span class="line"><span class="attr">introduce</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">introduce</span>()</span><br><span class="line">&#125;</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ref</span>=<span class="string">&#123;kun&#125;</span>&gt;</span> &#123;props.count&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FChild</span> = <span class="title function_">forwardRef</span>(<span class="title class_">Child</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">const</span> fcRef = <span class="title function_">useRef</span>(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> onClick = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"><span class="title function_">setCount</span>(<span class="function"><span class="params">count</span> =&gt;</span> count + <span class="number">1</span>)</span><br><span class="line">fcRef.<span class="property">current</span>.<span class="title function_">introduce</span>()</span><br><span class="line">&#125;, [])</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">点击次数: &#123;count&#125;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">FChild</span> <span class="attr">ref</span>=<span class="string">&#123;fcRef&#125;</span> <span class="attr">count</span>=<span class="string">&#123;count&#125;</span>&gt;</span><span class="tag">&lt;/<span class="name">FChild</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;onClick&#125;</span>&gt;</span>点我<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="自定义钩子"><a href="#自定义钩子" class="headerlink" title="自定义钩子"></a>自定义钩子</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编写我们自己的hook，名字以use开头</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useCounter</span>(<span class="params">initialValue</span>) &#123;</span><br><span class="line"><span class="comment">// 接受初始化的值生成state</span></span><br><span class="line"><span class="keyword">const</span> [count, changeCount] = <span class="title function_">useState</span>(initialValue);</span><br><span class="line"><span class="comment">// 声明减少的方法</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">decrease</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"><span class="title function_">changeCount</span>(count - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 声明增加的方法</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">increase</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"><span class="title function_">changeCount</span>(count + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 声明重置计数器方法</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">resetCounter</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line"><span class="title function_">changeCount</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 将count数字与方法返回回去</span></span><br><span class="line"><span class="keyword">return</span> [count, &#123; decrease, increase, resetCounter &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">RootCompent</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="comment">// 在函数组件中使用我们自己编写的hook生成一个计数器，并拿到所有操作方法的对象</span></span><br><span class="line"><span class="keyword">const</span> [count, controlCount] = <span class="title function_">useCounter</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">当前数量：&#123;count&#125;</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;controlCount.decrease&#125;</span>&gt;</span>减少<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;controlCount.increase&#125;</span>&gt;</span>增加<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;controlCount.resetCounter&#125;</span>&gt;</span>重置<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://juejin.im/post/5de11deb5188256eaa0ebd5e">React-Hooks</a></li><li><a href="https://zh-hans.reactjs.org/docs/hooks-intro.html">官方文档</a></li><li><a href="https://www.sitixi.com/useHooks%20%E7%AC%AC%E4%B8%80%E6%9C%9F/">聊聊 useCallback</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;React-Hooks&quot;&gt;&lt;a href=&quot;#React-Hooks&quot; class=&quot;headerlink&quot; title=&quot;React Hooks&quot;&gt;&lt;/a&gt;React Hooks&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Hook&lt;/code&gt; 是 &lt;code&gt;React 16.8&lt;/code&gt; 的新增特性。它可以让你在不编写 &lt;code&gt;class&lt;/code&gt; 的情况下使用 &lt;code&gt;state&lt;/code&gt; 以及其他的 &lt;code&gt;React&lt;/code&gt; 特性。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;只在最顶层使用 &lt;code&gt;Hook&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;只在 &lt;code&gt;React&lt;/code&gt; 函数中调用 &lt;code&gt;Hook&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="javascript" scheme="https://nightme.github.io/categories/javascript/"/>
    
    
      <category term="react" scheme="https://nightme.github.io/tags/react/"/>
    
  </entry>
  
  <entry>
    <title>浏览器滚动条样式</title>
    <link href="https://nightme.github.io/2019/03/02/%E6%B5%8F%E8%A7%88%E5%99%A8%E6%BB%9A%E5%8A%A8%E6%9D%A1%E6%A0%B7%E5%BC%8F/"/>
    <id>https://nightme.github.io/2019/03/02/浏览器滚动条样式/</id>
    <published>2019-03-01T18:02:30.000Z</published>
    <updated>2025-09-19T04:25:12.112Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Chrome滚动条样式"><a href="#Chrome滚动条样式" class="headerlink" title="Chrome滚动条样式"></a><code>Chrome</code>滚动条样式</h2><h5 id="CSS滚动条选择器"><a href="#CSS滚动条选择器" class="headerlink" title="CSS滚动条选择器"></a><code>CSS</code>滚动条选择器</h5><ul><li><code>::-webkit-scrollbar</code> — 整个滚动条.</li><li><code>::-webkit-scrollbar-button</code> — 滚动条上的按钮 (上下箭头).</li><li><code>::-webkit-scrollbar-thumb</code> — 滚动条上的滚动滑块.</li><li><code>::-webkit-scrollbar-track</code> — 滚动条轨道.</li><li><code>::-webkit-scrollbar-track-piece</code> — 滚动条没有滑块的轨道部分.</li><li><code>::-webkit-scrollbar-corner</code> — 当同时有垂直滚动条和水平滚动条时交汇的部分.</li><li><code>::-webkit-resizer</code> — 某些元素的<code>corner</code>部分的部分样式(例:<code>textarea</code>的可拖动按钮).</li></ul><span id="more"></span><h6 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h6><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 整个滚动条 */</span></span><br><span class="line">::-webkit-scrollbar &#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 滚动条上的按钮 (上下箭头) */</span></span><br><span class="line">::-webkit-scrollbar-button    &#123;</span><br><span class="line">    <span class="attribute">background-color</span>:blue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 滚动条轨道 */</span></span><br><span class="line">::-webkit-scrollbar-track     &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 滚动条没有滑块的轨道部分 */</span></span><br><span class="line">::-webkit-scrollbar-track-piece &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#ff0000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 滚动条上的滚动滑块 */</span></span><br><span class="line">::-webkit-scrollbar-thumb&#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#FFA711</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>:<span class="number">4px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 当同时有垂直滚动条和水平滚动条时交汇的部分 */</span></span><br><span class="line">::-webkit-scrollbar-corner &#123;</span><br><span class="line">    <span class="attribute">background</span>:green;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 某些元素的`corner`部分的部分样式(例:`textarea`的可拖动按钮). */</span></span><br><span class="line">::-webkit-scrollbar-resizer  &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#bf7326</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="demo"><a href="#demo" class="headerlink" title="demo"></a><code>demo</code></h6><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 整个滚动条 */</span></span><br><span class="line">::-webkit-scrollbar &#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 滚动条上的按钮 (上下箭头) */</span></span><br><span class="line">::-webkit-scrollbar-button    &#123;</span><br><span class="line">    <span class="comment">/* background-color:blue; */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 滚动条轨道 */</span></span><br><span class="line">::-webkit-scrollbar-track     &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#ccc</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 滚动条没有滑块的轨道部分 */</span></span><br><span class="line">::-webkit-scrollbar-track-piece &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#ccc</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 滚动条上的滚动滑块 */</span></span><br><span class="line">::-webkit-scrollbar-thumb&#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">80px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">80px</span>;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#999</span>;</span><br><span class="line">    <span class="attribute">border-radius</span>:<span class="number">10px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 当同时有垂直滚动条和水平滚动条时交汇的部分 */</span></span><br><span class="line">::-webkit-scrollbar-corner &#123;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#ccc</span>;</span><br><span class="line">    <span class="attribute">border-bottom-right-radius</span>: <span class="number">4px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* 某些元素的`corner`部分的部分样式(例:`textarea`的可拖动按钮). */</span></span><br><span class="line">::-webkit-scrollbar-resizer  &#123;</span><br><span class="line">    <span class="comment">/* background:#bf7326; */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="FireFox滚动条样式"><a href="#FireFox滚动条样式" class="headerlink" title="FireFox滚动条样式"></a><code>FireFox</code>滚动条样式</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Only FireFox */</span></span><br><span class="line">* &#123;   </span><br><span class="line">    <span class="attribute">scrollbar-color</span>: transparent  transparent <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">scrollbar-width</span>: thin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="IE滚动条样式"><a href="#IE滚动条样式" class="headerlink" title="IE滚动条样式"></a><code>IE</code>滚动条样式</h2><table><thead><tr><th>Scrollbar Properties 属性</th><th>CSS Version 版本</th><th>Compatibility 兼容性</th><th>Inherit From Parent 继承性</th><th>Description 简介</th></tr></thead><tbody><tr><td>scrollbar-3d-light-color</td><td>IE专有属性</td><td>IE5.5+</td><td>有</td><td>设置或检索滚动条亮边框颜色</td></tr><tr><td>scrollbar-highlight-color</td><td>IE专有属性</td><td>IE5.5+</td><td>有</td><td>设置或检索滚动条3D界面的亮边（ThreedHighlight）颜色</td></tr><tr><td>scrollbar-face-color</td><td>IE专有属性</td><td>IE5.5+</td><td>有</td><td>设置或检索滚动条3D表面（ThreedFace）的颜色</td></tr><tr><td>scrollbar-arrow-color</td><td>IE专有属性</td><td>IE5.5+</td><td>有</td><td>设置或检索滚动条方向箭头的颜色</td></tr><tr><td>scrollbar-shadow-color</td><td>IE专有属性</td><td>IE5.5+</td><td>有</td><td>设置或检索滚动条3D界面的暗边（ThreedShadow）颜色</td></tr><tr><td>scrollbar-dark-shadow-color</td><td>IE专有属性</td><td>IE5.5+</td><td>有</td><td>设置或检索滚动条暗边框（ThreedDarkShadow）颜色</td></tr><tr><td>scrollbar-base-color</td><td>IE专有属性</td><td>IE5.5+</td><td>有</td><td>设置或检索滚动条基准颜色。其它界面颜色将据此自动调整</td></tr></tbody></table><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">scrollbar-arrow-<span class="attribute">color</span>: color; <span class="comment">/*三角箭头的颜色*/</span></span><br><span class="line">scrollbar-face-<span class="attribute">color</span>: color; <span class="comment">/*立体滚动条的颜色（包括箭头部分的背景色）*/</span></span><br><span class="line">scrollbar-<span class="number">3</span>dlight-<span class="attribute">color</span>: color; <span class="comment">/*立体滚动条亮边的颜色*/</span></span><br><span class="line">scrollbar-highlight-<span class="attribute">color</span>: color; <span class="comment">/*滚动条的高亮颜色（左阴影？）*/</span></span><br><span class="line">scrollbar-shadow-<span class="attribute">color</span>: color; <span class="comment">/*立体滚动条阴影的颜色*/</span></span><br><span class="line">scrollbar-darkshadow-<span class="attribute">color</span>: color; <span class="comment">/*立体滚动条外阴影的颜色*/</span></span><br><span class="line">scrollbar-track-<span class="attribute">color</span>: color; <span class="comment">/*立体滚动条背景颜色*/</span></span><br><span class="line">scrollbar-base-<span class="attribute">color</span>:color; <span class="comment">/*滚动条的基色*/</span></span><br></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/::-webkit-scrollbar"><code>::-webkit-scrollbar</code></a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/CSS/scrollbar-width"><code>scrollbar-width firefox</code></a></li><li><a href="https://github.com/Aris-t2/CustomCSSforFx/blob/master/classic/config/custom_scrollbar_appearance.css"><code>CustomCSSforFx</code></a></li><li><a href="https://www.php.cn/manual/view/14677.html"><code>CSS Scrollbar Properties</code>滚动条属性IE</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Chrome滚动条样式&quot;&gt;&lt;a href=&quot;#Chrome滚动条样式&quot; class=&quot;headerlink&quot; title=&quot;Chrome滚动条样式&quot;&gt;&lt;/a&gt;&lt;code&gt;Chrome&lt;/code&gt;滚动条样式&lt;/h2&gt;&lt;h5 id=&quot;CSS滚动条选择器&quot;&gt;&lt;a href=&quot;#CSS滚动条选择器&quot; class=&quot;headerlink&quot; title=&quot;CSS滚动条选择器&quot;&gt;&lt;/a&gt;&lt;code&gt;CSS&lt;/code&gt;滚动条选择器&lt;/h5&gt;&lt;ul&gt;
&lt;li&gt;&lt;code&gt;::-webkit-scrollbar&lt;/code&gt; — 整个滚动条.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;::-webkit-scrollbar-button&lt;/code&gt; — 滚动条上的按钮 (上下箭头).&lt;/li&gt;
&lt;li&gt;&lt;code&gt;::-webkit-scrollbar-thumb&lt;/code&gt; — 滚动条上的滚动滑块.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;::-webkit-scrollbar-track&lt;/code&gt; — 滚动条轨道.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;::-webkit-scrollbar-track-piece&lt;/code&gt; — 滚动条没有滑块的轨道部分.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;::-webkit-scrollbar-corner&lt;/code&gt; — 当同时有垂直滚动条和水平滚动条时交汇的部分.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;::-webkit-resizer&lt;/code&gt; — 某些元素的&lt;code&gt;corner&lt;/code&gt;部分的部分样式(例:&lt;code&gt;textarea&lt;/code&gt;的可拖动按钮).&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="css" scheme="https://nightme.github.io/categories/css/"/>
    
    
      <category term="css" scheme="https://nightme.github.io/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>rn蓝牙打印2</title>
    <link href="https://nightme.github.io/2018/12/27/rn%E8%93%9D%E7%89%99%E6%89%93%E5%8D%B02/"/>
    <id>https://nightme.github.io/2018/12/27/rn蓝牙打印2/</id>
    <published>2018-12-27T14:14:44.000Z</published>
    <updated>2025-09-19T04:25:12.102Z</updated>
    
    <content type="html"><![CDATA[<h2 id="rn蓝牙打印2"><a href="#rn蓝牙打印2" class="headerlink" title="rn蓝牙打印2"></a>rn蓝牙打印2</h2><p>本文是 <strong>rn蓝牙打印</strong> 的补充</p><p>上一篇文章里面主要说了蓝牙打印用<code>ESC</code>指令，这一篇补充一下<code>TSC</code>指令</p><p>以下大部分代码来源于佳博<code>SDK</code></p><span id="more"></span><h2 id="测试代码执行入口"><a href="#测试代码执行入口" class="headerlink" title="测试代码执行入口"></a>测试代码执行入口</h2><ul><li>测试发送<code>TSC</code>数据</li><li>测试发送<code>ESC</code>数据</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xx.yy.gpbt;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.app.MainActivity;</span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.app.R;</span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.utils.BaseUtil;</span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.utils.PictureUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/12/14.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GpPrint</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试发送TSC数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] sendTSCData() &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Str</span> <span class="operator">=</span> <span class="string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQQAAAEECAIAAABBat1dAAAD+UlEQVR4nO3dwY7TMBRA0Rbx/788bK5GiAUOsmWc9Jw1omk6V948Pb+/vr5ewOv1438/AJxCDBAxQMQAEQNEDBAxQMQAEQNEDJCfw3/xfr83PMch9gynDF/pIY/xJFdeqZMBIgaIGCBigIgBIgaIGCBigIgBIgbIeBxj6Eb7Ne4ygHDIvMan/bJOBogYIGKAiAEiBogYIGKAiAEiBogYIAvGMYb2DEGcMzswP0wx/B+uvNInrdjY812cDBAxQMQAEQNEDBAxQMQAEQNEDBAxQMQA2TGb9GnmR4/4L5wMEDFAxAARA0QMEDFAxAARA0QMEDFAjGP8myU7Ws7ZasPvnAwQMUDEABEDRAwQMUDEABEDRAwQMUB2jGM8afrgkOtwznml5zzJPCcDRAwQMUDEABEDRAwQMUDEABEDRAwQMUAWzCZ91D00S1bFzI8eLXmMoY/6ZV9OBvgmBogYIGKAiAEiBogYIGKAiAEiBsh4HONJu0D2uMsUg1/2D04GiBggYoCIASIGiBggYoCIASIGiBggO27uWTKesGR24C6DEkNX3sb8l13yKTca+nAyQMQAEQNEDBAxQMQAEQNEDBAxQMQAEQPkveSSmL87Z6xow506VzxmROq16JKhDa78cE4GiBggYoCIASIGiBggYoCIASIGiBggC8YxDtkFcs5CmnmHfJdDHmMbJwNEDBAxQMQAEQNEDBAxQMQAEQNEDJDb3NyzxI1GA+bNz9HseV17/jxsx4B/IAaIGCBigIgBIgaIGCBigIgBIgbIeBxjz20Uez5lfkLh0xZGDB2yPGXJpzgZIGKAiAEiBogYIGKAiAEiBogYIGKAiAEyvrmH312ZTTrklc6PUS35Ijea5nIyQMQAEQNEDBAxQMQAEQNEDBAxQMQAGa+KOefenQ0OuavmRhtrDvnzWLKxxskAEQNEDBAxQMQAEQNEDBAxQMQAEQNkPI4xdMgyiCv2LIzYMG2xZ5Liyqcc8l2WcDJAxAARA0QMEDFAxAARA0QMEDFAxAARA2TBbNLQnm0i54y4HPIkexbSzH/ZQ5bNvJwM8E0MEDFAxAARA0QMEDFAxAARA0QMkB3jGE+yZEJhfgDhnBGGJ91C5GSAiAEiBogYIGKAiAEiBogYIGKAiAFiHONEe/ZrnDPTMbTnhTgZIGKAiAEiBogYIGKAiAEiBogYIGKAiAGyYzbpkJtslljyXQ7ZnrLnMfZMQM1vrHk5GeCbGCBigIgBIgaIGCBigIgBIgaIGCALxjFutHFkjyWjAXd5jPn/xM09cBwxQMQAEQNEDBAxQMQAEQNEDBAxQN5PWl0BM5wMEDFAxAARA0QMEDFAxAARA0QMEDFAxAD5BVn2+wfjFK/cAAAAAElFTkSuQmCC&quot;</span>;</span><br><span class="line">        <span class="type">LabelCommand</span> <span class="variable">tsc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LabelCommand</span>();</span><br><span class="line">        <span class="comment">// 设置标签尺寸，按照实际尺寸设置</span></span><br><span class="line">        tsc.addSize(<span class="number">60</span>, <span class="number">60</span>);</span><br><span class="line">        <span class="comment">// 设置标签间隙，按照实际尺寸设置，如果为无间隙纸则设置为0</span></span><br><span class="line">        tsc.addGap(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 设置打印方向</span></span><br><span class="line">        tsc.addDirection(LabelCommand.DIRECTION.BACKWARD, LabelCommand.MIRROR.NORMAL);</span><br><span class="line">        <span class="comment">// 开启带Response的打印，用于连续打印</span></span><br><span class="line">        tsc.addQueryPrinterStatus(LabelCommand.RESPONSE_MODE.ON);</span><br><span class="line">        <span class="comment">// 设置原点坐标</span></span><br><span class="line">        tsc.addReference(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 撕纸模式开启</span></span><br><span class="line">        tsc.addTear(EscCommand.ENABLE.ON);</span><br><span class="line">        <span class="comment">// 清除打印缓冲区</span></span><br><span class="line">        tsc.addCls();</span><br><span class="line">        <span class="comment">// 绘制简体中文</span></span><br><span class="line">        tsc.addText(<span class="number">20</span>, <span class="number">20</span>, LabelCommand.FONTTYPE.SIMPLIFIED_CHINESE, LabelCommand.ROTATION.ROTATION_0, LabelCommand.FONTMUL.MUL_1, LabelCommand.FONTMUL.MUL_1,</span><br><span class="line">                <span class="string">&quot;Welcome to use SMARNET printer!&quot;</span>);</span><br><span class="line">        <span class="comment">// 绘制图片</span></span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">b</span> <span class="operator">=</span> PictureUtils.base64StringToBitmap(base64Str);</span><br><span class="line"><span class="comment">//        Bitmap b = BitmapFactory.decodeResource(MainActivity.getMainActivity().getResources(), R.mipmap.ic_launcher);</span></span><br><span class="line">        tsc.addBitmap(<span class="number">20</span>, <span class="number">50</span>, LabelCommand.BITMAP_MODE.OVERWRITE, b.getWidth(), b);</span><br><span class="line"></span><br><span class="line">        tsc.addQRCode(<span class="number">250</span>, <span class="number">80</span>, LabelCommand.EEC.LEVEL_L, <span class="number">5</span>, LabelCommand.ROTATION.ROTATION_0, <span class="string">&quot; www.smarnet.cc&quot;</span>);</span><br><span class="line">        <span class="comment">// 绘制一维条码</span></span><br><span class="line">        tsc.add1DBarcode(<span class="number">20</span>, <span class="number">250</span>, LabelCommand.BARCODETYPE.CODE128, <span class="number">100</span>, LabelCommand.READABEL.EANBEL, LabelCommand.ROTATION.ROTATION_0, <span class="string">&quot;SMARNET&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印标签</span></span><br><span class="line">        tsc.addPrint(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 打印标签后 蜂鸣器响</span></span><br><span class="line"></span><br><span class="line">        tsc.addSound(<span class="number">2</span>, <span class="number">100</span>);</span><br><span class="line">        tsc.addCashdrwer(LabelCommand.FOOT.F5, <span class="number">255</span>, <span class="number">255</span>);</span><br><span class="line">        Vector&lt;Byte&gt; datas = tsc.getCommand();</span><br><span class="line">        <span class="comment">// 发送数据</span></span><br><span class="line">        <span class="type">byte</span>[] byteData = BaseUtil.convertVectorByteTobytes(datas);</span><br><span class="line">        <span class="keyword">return</span> byteData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 测试发送ESC数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] sendESCData() &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Str</span> <span class="operator">=</span> <span class="string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQQAAAEECAIAAABBat1dAAAD+UlEQVR4nO3dwY7TMBRA0Rbx/788bK5GiAUOsmWc9Jw1omk6V948Pb+/vr5ewOv1438/AJxCDBAxQMQAEQNEDBAxQMQAEQNEDJCfw3/xfr83PMch9gynDF/pIY/xJFdeqZMBIgaIGCBigIgBIgaIGCBigIgBIgbIeBxj6Eb7Ne4ygHDIvMan/bJOBogYIGKAiAEiBogYIGKAiAEiBogYIAvGMYb2DEGcMzswP0wx/B+uvNInrdjY812cDBAxQMQAEQNEDBAxQMQAEQNEDBAxQMQA2TGb9GnmR4/4L5wMEDFAxAARA0QMEDFAxAARA0QMEDFAjGP8myU7Ws7ZasPvnAwQMUDEABEDRAwQMUDEABEDRAwQMUB2jGM8afrgkOtwznml5zzJPCcDRAwQMUDEABEDRAwQMUDEABEDRAwQMUAWzCZ91D00S1bFzI8eLXmMoY/6ZV9OBvgmBogYIGKAiAEiBogYIGKAiAEiBsh4HONJu0D2uMsUg1/2D04GiBggYoCIASIGiBggYoCIASIGiBggO27uWTKesGR24C6DEkNX3sb8l13yKTca+nAyQMQAEQNEDBAxQMQAEQNEDBAxQMQAEQPkveSSmL87Z6xow506VzxmROq16JKhDa78cE4GiBggYoCIASIGiBggYoCIASIGiBggC8YxDtkFcs5CmnmHfJdDHmMbJwNEDBAxQMQAEQNEDBAxQMQAEQNEDJDb3NyzxI1GA+bNz9HseV17/jxsx4B/IAaIGCBigIgBIgaIGCBigIgBIgbIeBxjz20Uez5lfkLh0xZGDB2yPGXJpzgZIGKAiAEiBogYIGKAiAEiBogYIGKAiAEyvrmH312ZTTrklc6PUS35Ijea5nIyQMQAEQNEDBAxQMQAEQNEDBAxQMQAGa+KOefenQ0OuavmRhtrDvnzWLKxxskAEQNEDBAxQMQAEQNEDBAxQMQAEQNkPI4xdMgyiCv2LIzYMG2xZ5Liyqcc8l2WcDJAxAARA0QMEDFAxAARA0QMEDFAxAARA2TBbNLQnm0i54y4HPIkexbSzH/ZQ5bNvJwM8E0MEDFAxAARA0QMEDFAxAARA0QMkB3jGE+yZEJhfgDhnBGGJ91C5GSAiAEiBogYIGKAiAEiBogYIGKAiAFiHONEe/ZrnDPTMbTnhTgZIGKAiAEiBogYIGKAiAEiBogYIGKAiAGyYzbpkJtslljyXQ7ZnrLnMfZMQM1vrHk5GeCbGCBigIgBIgaIGCBigIgBIgaIGCALxjFutHFkjyWjAXd5jPn/xM09cBwxQMQAEQNEDBAxQMQAEQNEDBAxQN5PWl0BM5wMEDFAxAARA0QMEDFAxAARA0QMEDFAxAD5BVn2+wfjFK/cAAAAAElFTkSuQmCC&quot;</span>;</span><br><span class="line">        <span class="type">EscCommand</span> <span class="variable">esc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EscCommand</span>();</span><br><span class="line">        esc.addInitializePrinter();</span><br><span class="line">        esc.addPrintAndFeedLines((<span class="type">byte</span>) <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 设置打印居中</span></span><br><span class="line">        esc.addSelectJustification(EscCommand.JUSTIFICATION.CENTER);</span><br><span class="line">        <span class="comment">// 设置为倍高倍宽</span></span><br><span class="line">        esc.addSelectPrintModes(EscCommand.FONT.FONTA, EscCommand.ENABLE.OFF, EscCommand.ENABLE.ON, EscCommand.ENABLE.ON, EscCommand.ENABLE.OFF);</span><br><span class="line">        <span class="comment">// 打印文字</span></span><br><span class="line">        esc.addText(<span class="string">&quot;Sample\n&quot;</span>);</span><br><span class="line">        esc.addPrintAndLineFeed();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 打印文字 */</span></span><br><span class="line">        <span class="comment">// 取消倍高倍宽</span></span><br><span class="line">        esc.addSelectPrintModes(EscCommand.FONT.FONTA, EscCommand.ENABLE.OFF, EscCommand.ENABLE.OFF, EscCommand.ENABLE.OFF, EscCommand.ENABLE.OFF);</span><br><span class="line">        <span class="comment">// 设置打印左对齐</span></span><br><span class="line">        esc.addSelectJustification(EscCommand.JUSTIFICATION.LEFT);</span><br><span class="line">        <span class="comment">// 打印文字</span></span><br><span class="line">        esc.addText(<span class="string">&quot;Print text\n&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印文字</span></span><br><span class="line">        esc.addText(<span class="string">&quot;Welcome to use SMARNET printer!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 打印繁体中文 需要打印机支持繁体字库 */</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;佳博智匯票據打印機\n&quot;</span>;</span><br><span class="line">        esc.addText(message, <span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">        esc.addPrintAndLineFeed();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 绝对位置 具体详细信息请查看GP58编程手册 */</span></span><br><span class="line">        esc.addText(<span class="string">&quot;智汇&quot;</span>);</span><br><span class="line">        esc.addSetHorAndVerMotionUnits((<span class="type">byte</span>) <span class="number">7</span>, (<span class="type">byte</span>) <span class="number">0</span>);</span><br><span class="line">        esc.addSetAbsolutePrintPosition((<span class="type">short</span>) <span class="number">6</span>);</span><br><span class="line">        esc.addText(<span class="string">&quot;网络&quot;</span>);</span><br><span class="line">        esc.addSetAbsolutePrintPosition((<span class="type">short</span>) <span class="number">10</span>);</span><br><span class="line">        esc.addText(<span class="string">&quot;设备&quot;</span>);</span><br><span class="line">        esc.addPrintAndLineFeed();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 打印图片 */</span></span><br><span class="line">        <span class="comment">// 打印文字</span></span><br><span class="line">        esc.addText(<span class="string">&quot;Print bitmap!\n&quot;</span>);</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">b</span> <span class="operator">=</span> PictureUtils.base64StringToBitmap(base64Str);</span><br><span class="line">        <span class="comment">//Bitmap b = BitmapFactory.decodeResource(MainActivity.getMainActivity().getResources(), R.mipmap.ic_launcher);</span></span><br><span class="line">        <span class="comment">// 打印图片</span></span><br><span class="line">        esc.addOriginRastBitImage(b, b.getWidth(), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 打印一维条码 */</span></span><br><span class="line">        <span class="comment">// 打印文字</span></span><br><span class="line">        esc.addText(<span class="string">&quot;Print code128\n&quot;</span>);</span><br><span class="line">        esc.addSelectPrintingPositionForHRICharacters(EscCommand.HRI_POSITION.BELOW);</span><br><span class="line">        <span class="comment">// 设置条码可识别字符位置在条码下方</span></span><br><span class="line">        <span class="comment">// 设置条码高度为60点</span></span><br><span class="line">        esc.addSetBarcodeHeight((<span class="type">byte</span>) <span class="number">60</span>);</span><br><span class="line">        <span class="comment">// 设置条码单元宽度为1</span></span><br><span class="line">        esc.addSetBarcodeWidth((<span class="type">byte</span>) <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 打印Code128码</span></span><br><span class="line">        esc.addCODE128(esc.genCodeB(<span class="string">&quot;SMARNET&quot;</span>));</span><br><span class="line">        esc.addPrintAndLineFeed();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">         * QRCode命令打印 此命令只在支持QRCode命令打印的机型才能使用。 在不支持二维码指令打印的机型上，则需要发送二维条码图片</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">        <span class="comment">// 打印文字</span></span><br><span class="line">        esc.addText(<span class="string">&quot;Print QRcode\n&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置纠错等级</span></span><br><span class="line">        esc.addSelectErrorCorrectionLevelForQRCode((<span class="type">byte</span>) <span class="number">0x31</span>);</span><br><span class="line">        <span class="comment">// 设置qrcode模块大小</span></span><br><span class="line">        esc.addSelectSizeOfModuleForQRCode((<span class="type">byte</span>) <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// 设置qrcode内容</span></span><br><span class="line">        esc.addStoreQRCodeData(<span class="string">&quot;www.smarnet.cc&quot;</span>);</span><br><span class="line">        esc.addPrintQRCode();<span class="comment">// 打印QRCode</span></span><br><span class="line">        esc.addPrintAndLineFeed();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置打印左对齐</span></span><br><span class="line">        esc.addSelectJustification(EscCommand.JUSTIFICATION.CENTER);</span><br><span class="line">        <span class="comment">//打印文字</span></span><br><span class="line">        esc.addText(<span class="string">&quot;Completed!\r\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 开钱箱</span></span><br><span class="line">        esc.addGeneratePlus(LabelCommand.FOOT.F5, (<span class="type">byte</span>) <span class="number">255</span>, (<span class="type">byte</span>) <span class="number">255</span>);</span><br><span class="line">        esc.addPrintAndFeedLines((<span class="type">byte</span>) <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// 加入查询打印机状态，打印完成后，此时会接收到GpCom.ACTION_DEVICE_STATUS广播</span></span><br><span class="line">        esc.addQueryPrinterStatus();</span><br><span class="line">        Vector&lt;Byte&gt; datas = esc.getCommand();</span><br><span class="line">        <span class="comment">// 发送数据</span></span><br><span class="line">        <span class="type">byte</span>[] byteData = BaseUtil.convertVectorByteTobytes(datas);</span><br><span class="line">        <span class="keyword">return</span> byteData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] printLabel() &#123;</span><br><span class="line">        <span class="type">byte</span>[] byteData = &#123;&#125;;</span><br><span class="line">        <span class="keyword">return</span> byteData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换图片TSC</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] convertTSCImgToBase64(String base64Str) &#123;</span><br><span class="line">        <span class="type">LabelCommand</span> <span class="variable">tsc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LabelCommand</span>();</span><br><span class="line">        <span class="comment">// 设置原点坐标</span></span><br><span class="line"><span class="comment">//        tsc.addReference(0, 0);</span></span><br><span class="line">        <span class="comment">// 清除打印缓冲区</span></span><br><span class="line"><span class="comment">//        tsc.addCls();</span></span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">b</span> <span class="operator">=</span> PictureUtils.base64StringToBitmap(base64Str);</span><br><span class="line">        tsc.addBitmap(<span class="number">50</span>, <span class="number">55</span>, LabelCommand.BITMAP_MODE.OVERWRITE, b.getWidth(), b);</span><br><span class="line">        <span class="comment">// 打印标签</span></span><br><span class="line"><span class="comment">//        tsc.addPrint(1, 1);</span></span><br><span class="line">        Vector&lt;Byte&gt; datas = tsc.getCommand();</span><br><span class="line">        <span class="comment">// 发送数据</span></span><br><span class="line">        <span class="type">byte</span>[] byteData = BaseUtil.convertVectorByteTobytes(datas);</span><br><span class="line">        <span class="keyword">return</span> byteData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换图片ESC</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] convertESCImgToBase64(String base64Str) &#123;</span><br><span class="line">        <span class="type">EscCommand</span> <span class="variable">esc</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EscCommand</span>();</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">b</span> <span class="operator">=</span> PictureUtils.base64StringToBitmap(base64Str);</span><br><span class="line">        <span class="comment">// 打印图片</span></span><br><span class="line">        esc.addOriginRastBitImage(b, b.getWidth(), <span class="number">0</span>);</span><br><span class="line">        Vector&lt;Byte&gt; datas = esc.getCommand();</span><br><span class="line">        <span class="comment">// 发送数据</span></span><br><span class="line">        <span class="type">byte</span>[] byteData = BaseUtil.convertVectorByteTobytes(datas);</span><br><span class="line">        <span class="keyword">return</span> byteData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ESC命令方法封装类"><a href="#ESC命令方法封装类" class="headerlink" title="ESC命令方法封装类"></a>ESC命令方法封装类</h2><p>关于<code>ESC</code>命令具体请参考<code>ESC命令文档</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.xx.yy.gpbt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.annotation.SuppressLint;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.gpbt.LabelCommand.FOOT;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EscCommand</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEBUG_TAG</span> <span class="operator">=</span> <span class="string">&quot;EscCommand&quot;</span>;</span><br><span class="line">    Vector&lt;Byte&gt; Command = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EscCommand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.Command = <span class="keyword">new</span> <span class="title class_">Vector</span>(<span class="number">4096</span>, <span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addArrayToCommand</span><span class="params">(<span class="type">byte</span>[] array)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; array.length; ++i) &#123;</span><br><span class="line">            <span class="built_in">this</span>.Command.add(Byte.valueOf(array[i]));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addStrToCommand</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bs = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bs = str.getBytes(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var4) &#123;</span><br><span class="line">                var4.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bs.length; ++i) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(bs[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addStrToCommand</span><span class="params">(String str, String charset)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bs = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bs = str.getBytes(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var5) &#123;</span><br><span class="line">                var5.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bs.length; ++i) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(bs[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addStrToCommandUTF8Encoding</span><span class="params">(String str, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bs = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bs = str.getBytes(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var5) &#123;</span><br><span class="line">                var5.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.d(<span class="string">&quot;EscCommand&quot;</span>, <span class="string">&quot;bs.length&quot;</span> + bs.length);</span><br><span class="line">            <span class="keyword">if</span>(length &gt; bs.length) &#123;</span><br><span class="line">                length = bs.length;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.d(<span class="string">&quot;EscCommand&quot;</span>, <span class="string">&quot;length&quot;</span> + length);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(bs[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addStrToCommand</span><span class="params">(String str, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bs = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bs = str.getBytes(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var5) &#123;</span><br><span class="line">                var5.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.d(<span class="string">&quot;EscCommand&quot;</span>, <span class="string">&quot;bs.length&quot;</span> + bs.length);</span><br><span class="line">            <span class="keyword">if</span>(length &gt; bs.length) &#123;</span><br><span class="line">                length = bs.length;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.d(<span class="string">&quot;EscCommand&quot;</span>, <span class="string">&quot;length&quot;</span> + length);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(bs[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addHorTab</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">9</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(text);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addText</span><span class="params">(String text, String charsetName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(text, charsetName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addArabicText</span><span class="params">(String text)</span> &#123;</span><br><span class="line">        text = GpUtils.reverseLetterAndNumber(text);</span><br><span class="line">        text = GpUtils.splitArabic(text);</span><br><span class="line">        String[] fooInput = text.split(<span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">        String[] var3 = fooInput;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> fooInput.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">in</span> <span class="operator">=</span> var3[var5];</span><br><span class="line">            <span class="type">byte</span>[] output = GpUtils.string2Cp864(in);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; output.length; ++i) &#123;</span><br><span class="line">                <span class="keyword">if</span>(output[i] == -<span class="number">16</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.addArrayToCommand(<span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">116</span>, <span class="number">29</span>, -<span class="number">124</span>, <span class="number">27</span>, <span class="number">116</span>, <span class="number">22</span>&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(output[i] == <span class="number">127</span>) &#123;</span><br><span class="line">                    <span class="type">byte</span> <span class="variable">a</span> <span class="operator">=</span> -<span class="number">41</span>;</span><br><span class="line">                    <span class="built_in">this</span>.Command.add(Byte.valueOf(a));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">this</span>.Command.add(Byte.valueOf(output[i]));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrintAndLineFeed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">10</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">RealtimeStatusTransmission</span><span class="params">(EscCommand.STATUS status)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">16</span>, <span class="number">4</span>, status.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addGeneratePluseAtRealtime</span><span class="params">(FOOT foot, <span class="type">byte</span> t)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">16</span>, <span class="number">20</span>, <span class="number">1</span>, (<span class="type">byte</span>)foot.getValue(), <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(t &gt; <span class="number">8</span>) &#123;</span><br><span class="line">            t = <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        command[<span class="number">4</span>] = t;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSound</span><span class="params">(<span class="type">byte</span> n, <span class="type">byte</span> t)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            n = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(n &gt; <span class="number">9</span>) &#123;</span><br><span class="line">            n = <span class="number">9</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(t &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            t = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(t &gt; <span class="number">9</span>) &#123;</span><br><span class="line">            t = <span class="number">9</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        command[<span class="number">2</span>] = n;</span><br><span class="line">        command[<span class="number">3</span>] = t;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetRightSideCharacterSpacing</span><span class="params">(<span class="type">byte</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">32</span>, n&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector&lt;Byte&gt; <span class="title function_">getCommand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.Command;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectPrintModes</span><span class="params">(EscCommand.FONT font, EscCommand.ENABLE emphasized, EscCommand.ENABLE doubleheight, EscCommand.ENABLE doublewidth, EscCommand.ENABLE underline)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(font == EscCommand.FONT.FONTB) &#123;</span><br><span class="line">            temp = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(emphasized == EscCommand.ENABLE.ON) &#123;</span><br><span class="line">            temp = (<span class="type">byte</span>)(temp | <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(doubleheight == EscCommand.ENABLE.ON) &#123;</span><br><span class="line">            temp = (<span class="type">byte</span>)(temp | <span class="number">16</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(doublewidth == EscCommand.ENABLE.ON) &#123;</span><br><span class="line">            temp = (<span class="type">byte</span>)(temp | <span class="number">32</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(underline == EscCommand.ENABLE.ON) &#123;</span><br><span class="line">            temp = (<span class="type">byte</span>)(temp | <span class="number">128</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">33</span>, temp&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetAbsolutePrintPosition</span><span class="params">(<span class="type">short</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">nl</span> <span class="operator">=</span> (<span class="type">byte</span>)(n % <span class="number">256</span>);</span><br><span class="line">        <span class="type">byte</span> <span class="variable">nh</span> <span class="operator">=</span> (<span class="type">byte</span>)(n / <span class="number">256</span>);</span><br><span class="line">        command[<span class="number">2</span>] = nl;</span><br><span class="line">        command[<span class="number">3</span>] = nh;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectOrCancelUserDefineCharacter</span><span class="params">(EscCommand.ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">37</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(enable == EscCommand.ENABLE.ON) &#123;</span><br><span class="line">            command[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            command[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTurnUnderlineModeOnOrOff</span><span class="params">(EscCommand.UNDERLINE_MODE underline)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">45</span>, underline.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectDefualtLineSpacing</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">50</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetLineSpacing</span><span class="params">(<span class="type">byte</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">51</span>, n&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCancelUserDefinedCharacters</span><span class="params">(<span class="type">byte</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">63</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(n &gt;= <span class="number">32</span> &amp;&amp; n &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">            command[<span class="number">2</span>] = n;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            command[<span class="number">2</span>] = <span class="number">32</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInitializePrinter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">64</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTurnEmphasizedModeOnOrOff</span><span class="params">(EscCommand.ENABLE enabel)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">69</span>, enabel.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTurnDoubleStrikeOnOrOff</span><span class="params">(EscCommand.ENABLE enabel)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">71</span>, enabel.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrintAndFeedPaper</span><span class="params">(<span class="type">byte</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">74</span>, n&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectCharacterFont</span><span class="params">(EscCommand.FONT font)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">77</span>, font.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectInternationalCharacterSet</span><span class="params">(EscCommand.CHARACTER_SET set)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">82</span>, set.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTurn90ClockWiseRotatin</span><span class="params">(EscCommand.ENABLE enabel)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">86</span>, enabel.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetRelativePrintPositon</span><span class="params">(<span class="type">short</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">92</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">nl</span> <span class="operator">=</span> (<span class="type">byte</span>)(n % <span class="number">256</span>);</span><br><span class="line">        <span class="type">byte</span> <span class="variable">nh</span> <span class="operator">=</span> (<span class="type">byte</span>)(n / <span class="number">256</span>);</span><br><span class="line">        command[<span class="number">2</span>] = nl;</span><br><span class="line">        command[<span class="number">3</span>] = nh;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectJustification</span><span class="params">(EscCommand.JUSTIFICATION just)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">97</span>, just.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrintAndFeedLines</span><span class="params">(<span class="type">byte</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">100</span>, n&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addGeneratePlus</span><span class="params">(FOOT foot, <span class="type">byte</span> t1, <span class="type">byte</span> t2)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">112</span>, (<span class="type">byte</span>)foot.getValue(), t1, t2&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectCodePage</span><span class="params">(EscCommand.CODEPAGE page)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">116</span>, page.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTurnUpsideDownModeOnOrOff</span><span class="params">(EscCommand.ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">27</span>, <span class="number">123</span>, enable.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetCharcterSize</span><span class="params">(EscCommand.WIDTH_ZOOM width, EscCommand.HEIGHT_ZOOM height)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">33</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">temp1</span> <span class="operator">=</span> (<span class="type">byte</span>)(temp | width.getValue());</span><br><span class="line">        temp1 |= height.getValue();</span><br><span class="line">        command[<span class="number">2</span>] = temp1;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTurnReverseModeOnOrOff</span><span class="params">(EscCommand.ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">66</span>, enable.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectPrintingPositionForHRICharacters</span><span class="params">(EscCommand.HRI_POSITION position)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">72</span>, position.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetLeftMargin</span><span class="params">(<span class="type">short</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">76</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">nl</span> <span class="operator">=</span> (<span class="type">byte</span>)(n % <span class="number">256</span>);</span><br><span class="line">        <span class="type">byte</span> <span class="variable">nh</span> <span class="operator">=</span> (<span class="type">byte</span>)(n / <span class="number">256</span>);</span><br><span class="line">        command[<span class="number">2</span>] = nl;</span><br><span class="line">        command[<span class="number">3</span>] = nh;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetHorAndVerMotionUnits</span><span class="params">(<span class="type">byte</span> x, <span class="type">byte</span> y)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">80</span>, x, y&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCutAndFeedPaper</span><span class="params">(<span class="type">byte</span> length)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">86</span>, <span class="number">66</span>, length&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCutPaper</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">86</span>, <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetPrintingAreaWidth</span><span class="params">(<span class="type">short</span> width)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">nl</span> <span class="operator">=</span> (<span class="type">byte</span>)(width % <span class="number">256</span>);</span><br><span class="line">        <span class="type">byte</span> <span class="variable">nh</span> <span class="operator">=</span> (<span class="type">byte</span>)(width / <span class="number">256</span>);</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">87</span>, nl, nh&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetAutoSatusBack</span><span class="params">(EscCommand.ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">97</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(enable == EscCommand.ENABLE.OFF) &#123;</span><br><span class="line">            command[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            command[<span class="number">2</span>] = -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetFontForHRICharacter</span><span class="params">(EscCommand.FONT font)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">102</span>, font.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetBarcodeHeight</span><span class="params">(<span class="type">byte</span> height)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">104</span>, height&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetBarcodeWidth</span><span class="params">(<span class="type">byte</span> width)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">119</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(width &gt; <span class="number">6</span>) &#123;</span><br><span class="line">            width = <span class="number">6</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(width &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            width = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        command[<span class="number">2</span>] = width;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetKanjiFontMode</span><span class="params">(EscCommand.ENABLE DoubleWidth, EscCommand.ENABLE DoubleHeight, EscCommand.ENABLE Underline)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">28</span>, <span class="number">33</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(DoubleWidth == EscCommand.ENABLE.ON) &#123;</span><br><span class="line">            temp = (<span class="type">byte</span>)(temp | <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(DoubleHeight == EscCommand.ENABLE.ON) &#123;</span><br><span class="line">            temp = (<span class="type">byte</span>)(temp | <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(Underline == EscCommand.ENABLE.ON) &#123;</span><br><span class="line">            temp = (<span class="type">byte</span>)(temp | <span class="number">128</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        command[<span class="number">2</span>] = temp;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectKanjiMode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">28</span>, <span class="number">38</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetKanjiUnderLine</span><span class="params">(EscCommand.UNDERLINE_MODE underline)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">28</span>, <span class="number">45</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        command[<span class="number">3</span>] = underline.getValue();</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCancelKanjiMode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">28</span>, <span class="number">46</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetKanjiLefttandRightSpace</span><span class="params">(<span class="type">byte</span> left, <span class="type">byte</span> right)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">28</span>, <span class="number">83</span>, left, right&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSetQuadrupleModeForKanji</span><span class="params">(EscCommand.ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">28</span>, <span class="number">87</span>, enable.getValue()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addRastBitImage</span><span class="params">(Bitmap bitmap, <span class="type">int</span> nWidth, <span class="type">int</span> nMode)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> (nWidth + <span class="number">7</span>) / <span class="number">8</span> * <span class="number">8</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bitmap.getHeight() * width / bitmap.getWidth();</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">grayBitmap</span> <span class="operator">=</span> GpUtils.toGrayscale(bitmap);</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">rszBitmap</span> <span class="operator">=</span> GpUtils.resizeImage(grayBitmap, width, height);</span><br><span class="line">            <span class="type">byte</span>[] src = GpUtils.bitmapToBWPix(rszBitmap);</span><br><span class="line">            <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8</span>];</span><br><span class="line">            height = src.length / width;</span><br><span class="line">            command[<span class="number">0</span>] = <span class="number">29</span>;</span><br><span class="line">            command[<span class="number">1</span>] = <span class="number">118</span>;</span><br><span class="line">            command[<span class="number">2</span>] = <span class="number">48</span>;</span><br><span class="line">            command[<span class="number">3</span>] = (<span class="type">byte</span>)(nMode &amp; <span class="number">1</span>);</span><br><span class="line">            command[<span class="number">4</span>] = (<span class="type">byte</span>)(width / <span class="number">8</span> % <span class="number">256</span>);</span><br><span class="line">            command[<span class="number">5</span>] = (<span class="type">byte</span>)(width / <span class="number">8</span> / <span class="number">256</span>);</span><br><span class="line">            command[<span class="number">6</span>] = (<span class="type">byte</span>)(height % <span class="number">256</span>);</span><br><span class="line">            command[<span class="number">7</span>] = (<span class="type">byte</span>)(height / <span class="number">256</span>);</span><br><span class="line">            <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">            <span class="type">byte</span>[] codecontent = GpUtils.pixToEscRastBitImageCmd(src);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; codecontent.length; ++k) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(codecontent[k]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp.  null &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOriginRastBitImage</span><span class="params">(Bitmap bitmap, <span class="type">int</span> nWidth, <span class="type">int</span> nMode)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> (nWidth + <span class="number">7</span>) / <span class="number">8</span> * <span class="number">8</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bitmap.getHeight() * width / bitmap.getWidth();</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">rszBitmap</span> <span class="operator">=</span> GpUtils.resizeImage(bitmap, width, height);</span><br><span class="line">            <span class="type">byte</span>[] data = GpUtils.printEscDraw(rszBitmap);</span><br><span class="line">            <span class="built_in">this</span>.addArrayToCommand(data);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp.  null &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addRastBitImageWithMethod</span><span class="params">(Bitmap bitmap, <span class="type">int</span> nWidth, <span class="type">int</span> nMode, <span class="type">int</span> method)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> (nWidth + <span class="number">7</span>) / <span class="number">8</span> * <span class="number">8</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bitmap.getHeight() * width / bitmap.getWidth();</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">resizeImage</span> <span class="operator">=</span> GpUtils.resizeImage(bitmap, width, height);</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">rszBitmap</span> <span class="operator">=</span> GpUtils.filter(resizeImage, resizeImage.getWidth(), resizeImage.getHeight());</span><br><span class="line">            <span class="type">byte</span>[] src = GpUtils.bitmapToBWPix(rszBitmap);</span><br><span class="line">            <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8</span>];</span><br><span class="line">            height = src.length / width;</span><br><span class="line">            command[<span class="number">0</span>] = <span class="number">29</span>;</span><br><span class="line">            command[<span class="number">1</span>] = <span class="number">118</span>;</span><br><span class="line">            command[<span class="number">2</span>] = <span class="number">48</span>;</span><br><span class="line">            command[<span class="number">3</span>] = (<span class="type">byte</span>)(nMode &amp; <span class="number">1</span>);</span><br><span class="line">            command[<span class="number">4</span>] = (<span class="type">byte</span>)(width / <span class="number">8</span> % <span class="number">256</span>);</span><br><span class="line">            command[<span class="number">5</span>] = (<span class="type">byte</span>)(width / <span class="number">8</span> / <span class="number">256</span>);</span><br><span class="line">            command[<span class="number">6</span>] = (<span class="type">byte</span>)(height % <span class="number">256</span>);</span><br><span class="line">            command[<span class="number">7</span>] = (<span class="type">byte</span>)(height / <span class="number">256</span>);</span><br><span class="line">            <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">            <span class="type">byte</span>[] codecontent = GpUtils.pixToEscRastBitImageCmd(src);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; codecontent.length; ++k) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(codecontent[k]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp.  null &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDownloadNvBitImage</span><span class="params">(Bitmap[] bitmap)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(bitmap == <span class="literal">null</span>) &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp.  null &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bitmap.length &quot;</span> + bitmap.length);</span><br><span class="line">            <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> bitmap.length;</span><br><span class="line">            <span class="keyword">if</span>(n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">28</span>, <span class="number">113</span>, (<span class="type">byte</span>)n&#125;;</span><br><span class="line">                <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> (bitmap[i].getHeight() + <span class="number">7</span>) / <span class="number">8</span> * <span class="number">8</span>;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> bitmap[i].getWidth() * height / bitmap[i].getHeight();</span><br><span class="line">                    <span class="type">Bitmap</span> <span class="variable">grayBitmap</span> <span class="operator">=</span> GpUtils.toGrayscale(bitmap[i]);</span><br><span class="line">                    <span class="type">Bitmap</span> <span class="variable">rszBitmap</span> <span class="operator">=</span> GpUtils.resizeImage(grayBitmap, width, height);</span><br><span class="line">                    <span class="type">byte</span>[] src = GpUtils.bitmapToBWPix(rszBitmap);</span><br><span class="line">                    height = src.length / width;</span><br><span class="line">                    Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp  Width &quot;</span> + width);</span><br><span class="line">                    Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp  height &quot;</span> + height);</span><br><span class="line">                    <span class="type">byte</span>[] codecontent = GpUtils.pixToEscNvBitImageCmd(src, width, height);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; codecontent.length; ++k) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.Command.add(Byte.valueOf(codecontent[k]));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrintNvBitmap</span><span class="params">(<span class="type">byte</span> n, <span class="type">byte</span> mode)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">28</span>, <span class="number">112</span>, n, mode&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUPCA</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">65</span>, <span class="number">11</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(content.length() &gt;= command[<span class="number">3</span>]) &#123;</span><br><span class="line">            <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">            <span class="built_in">this</span>.addStrToCommand(content, <span class="number">11</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUPCE</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">66</span>, <span class="number">11</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(content.length() &gt;= command[<span class="number">3</span>]) &#123;</span><br><span class="line">            <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">            <span class="built_in">this</span>.addStrToCommand(content, command[<span class="number">3</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addEAN13</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">67</span>, <span class="number">12</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(content.length() &gt;= command[<span class="number">3</span>]) &#123;</span><br><span class="line">            <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">            Log.d(<span class="string">&quot;EscCommand&quot;</span>, <span class="string">&quot;content.length&quot;</span> + content.length());</span><br><span class="line">            <span class="built_in">this</span>.addStrToCommand(content, command[<span class="number">3</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addEAN8</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">68</span>, <span class="number">7</span>&#125;;</span><br><span class="line">        <span class="keyword">if</span>(content.length() &gt;= command[<span class="number">3</span>]) &#123;</span><br><span class="line">            <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">            <span class="built_in">this</span>.addStrToCommand(content, command[<span class="number">3</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressLint(&#123;&quot;DefaultLocale&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCODE39</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">69</span>, (<span class="type">byte</span>)content.length()&#125;;</span><br><span class="line">        content = content.toUpperCase();</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(content, command[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addITF</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">70</span>, (<span class="type">byte</span>)content.length()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(content, command[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCODABAR</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">71</span>, (<span class="type">byte</span>)content.length()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(content, command[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCODE93</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">72</span>, (<span class="type">byte</span>)content.length()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(content, command[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCODE128</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">107</span>, <span class="number">73</span>, (<span class="type">byte</span>)content.length()&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(content, command[<span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">genCodeC</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        List&lt;Byte&gt; bytes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(<span class="number">20</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> content.length();</span><br><span class="line">        <span class="type">byte</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">123</span>;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">67</span>;</span><br><span class="line">        bytes.add(Byte.valueOf(a));</span><br><span class="line">        bytes.add(Byte.valueOf(b));</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; len; i += <span class="number">2</span>) &#123;</span><br><span class="line">            i = (content.charAt(i) - <span class="number">48</span>) * <span class="number">10</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">bits</span> <span class="operator">=</span> content.charAt(i + <span class="number">1</span>) - <span class="number">48</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> i + bits;</span><br><span class="line">            bytes.add(Byte.valueOf((<span class="type">byte</span>)current));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] bb = <span class="keyword">new</span> <span class="title class_">byte</span>[bytes.size()];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; bb.length; ++i) &#123;</span><br><span class="line">            bb[i] = ((Byte)bytes.get(i)).byteValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(bb, <span class="number">0</span>, bb.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">genCodeB</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">&quot;&#123;B%s&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;content&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">genCode128</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">regex</span> <span class="operator">=</span> <span class="string">&quot;([^0-9])&quot;</span>;</span><br><span class="line">        String[] str = content.split(regex);</span><br><span class="line">        <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(regex);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(content);</span><br><span class="line">        <span class="type">String</span> <span class="variable">splitString</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">strlen</span> <span class="operator">=</span> str.length;</span><br><span class="line">        <span class="keyword">if</span>(strlen &gt; <span class="number">0</span> &amp;&amp; matcher.find()) &#123;</span><br><span class="line">            splitString = matcher.group(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; strlen; ++i) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">first</span> <span class="operator">=</span> str[i];</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> first.length();</span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> len % <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span>(result == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">codeC</span> <span class="operator">=</span> <span class="built_in">this</span>.genCodeC(first);</span><br><span class="line">                sb.append(codeC);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sb.append(<span class="built_in">this</span>.genCodeB(String.valueOf(first.charAt(<span class="number">0</span>))));</span><br><span class="line">                sb.append(<span class="built_in">this</span>.genCodeC(first.substring(<span class="number">1</span>, first.length())));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(splitString != <span class="literal">null</span>) &#123;</span><br><span class="line">                sb.append(<span class="built_in">this</span>.genCodeB(splitString));</span><br><span class="line">                splitString = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectSizeOfModuleForQRCode</span><span class="params">(<span class="type">byte</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">40</span>, <span class="number">107</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">67</span>, <span class="number">3</span>&#125;;</span><br><span class="line">        command[<span class="number">7</span>] = n;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelectErrorCorrectionLevelForQRCode</span><span class="params">(<span class="type">byte</span> n)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">40</span>, <span class="number">107</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">69</span>, n&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addStoreQRCodeData</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">40</span>, <span class="number">107</span>, (<span class="type">byte</span>)((content.getBytes().length + <span class="number">3</span>) % <span class="number">256</span>), (<span class="type">byte</span>)((content.getBytes().length + <span class="number">3</span>) / <span class="number">256</span>), <span class="number">49</span>, <span class="number">80</span>, <span class="number">48</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">        <span class="type">byte</span>[] bs = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!content.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bs = content.getBytes(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var5) &#123;</span><br><span class="line">                var5.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bs.length; ++i) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(bs[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrintQRCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">40</span>, <span class="number">107</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">81</span>, <span class="number">48</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQueryPrinterStatus</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] command = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;<span class="number">29</span>, <span class="number">114</span>, <span class="number">1</span>&#125;;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUserCommand</span><span class="params">(<span class="type">byte</span>[] command)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.addArrayToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">HRI_POSITION</span> &#123;</span><br><span class="line">        NO_PRINT(<span class="number">0</span>),</span><br><span class="line">        ABOVE(<span class="number">1</span>),</span><br><span class="line">        BELOW(<span class="number">2</span>),</span><br><span class="line">        ABOVE_AND_BELOW(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">HRI_POSITION</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">HEIGHT_ZOOM</span> &#123;</span><br><span class="line">        MUL_1(<span class="number">0</span>),</span><br><span class="line">        MUL_2(<span class="number">1</span>),</span><br><span class="line">        MUL_3(<span class="number">2</span>),</span><br><span class="line">        MUL_4(<span class="number">3</span>),</span><br><span class="line">        MUL_5(<span class="number">4</span>),</span><br><span class="line">        MUL_6(<span class="number">5</span>),</span><br><span class="line">        MUL_7(<span class="number">6</span>),</span><br><span class="line">        MUL_8(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">HEIGHT_ZOOM</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">WIDTH_ZOOM</span> &#123;</span><br><span class="line">        MUL_1(<span class="number">0</span>),</span><br><span class="line">        MUL_2(<span class="number">16</span>),</span><br><span class="line">        MUL_3(<span class="number">32</span>),</span><br><span class="line">        MUL_4(<span class="number">48</span>),</span><br><span class="line">        MUL_5(<span class="number">64</span>),</span><br><span class="line">        MUL_6(<span class="number">80</span>),</span><br><span class="line">        MUL_7(<span class="number">96</span>),</span><br><span class="line">        MUL_8(<span class="number">112</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">WIDTH_ZOOM</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">CODEPAGE</span> &#123;</span><br><span class="line">        PC437(<span class="number">0</span>),</span><br><span class="line">        KATAKANA(<span class="number">1</span>),</span><br><span class="line">        PC850(<span class="number">2</span>),</span><br><span class="line">        PC860(<span class="number">3</span>),</span><br><span class="line">        PC863(<span class="number">4</span>),</span><br><span class="line">        PC865(<span class="number">5</span>),</span><br><span class="line">        WEST_EUROPE(<span class="number">6</span>),</span><br><span class="line">        GREEK(<span class="number">7</span>),</span><br><span class="line">        HEBREW(<span class="number">8</span>),</span><br><span class="line">        EAST_EUROPE(<span class="number">9</span>),</span><br><span class="line">        IRAN(<span class="number">10</span>),</span><br><span class="line">        WPC1252(<span class="number">16</span>),</span><br><span class="line">        PC866(<span class="number">17</span>),</span><br><span class="line">        PC852(<span class="number">18</span>),</span><br><span class="line">        PC858(<span class="number">19</span>),</span><br><span class="line">        IRANII(<span class="number">20</span>),</span><br><span class="line">        LATVIAN(<span class="number">21</span>),</span><br><span class="line">        ARABIC(<span class="number">22</span>),</span><br><span class="line">        PT151(<span class="number">23</span>),</span><br><span class="line">        PC747(<span class="number">24</span>),</span><br><span class="line">        WPC1257(<span class="number">25</span>),</span><br><span class="line">        VIETNAM(<span class="number">27</span>),</span><br><span class="line">        PC864(<span class="number">28</span>),</span><br><span class="line">        PC1001(<span class="number">29</span>),</span><br><span class="line">        UYGUR(<span class="number">30</span>),</span><br><span class="line">        THAI(<span class="number">255</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">CODEPAGE</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">JUSTIFICATION</span> &#123;</span><br><span class="line">        LEFT(<span class="number">0</span>),</span><br><span class="line">        CENTER(<span class="number">1</span>),</span><br><span class="line">        RIGHT(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">JUSTIFICATION</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">CHARACTER_SET</span> &#123;</span><br><span class="line">        USA(<span class="number">0</span>),</span><br><span class="line">        FRANCE(<span class="number">1</span>),</span><br><span class="line">        GERMANY(<span class="number">2</span>),</span><br><span class="line">        UK(<span class="number">3</span>),</span><br><span class="line">        DENMARK_I(<span class="number">4</span>),</span><br><span class="line">        SWEDEN(<span class="number">5</span>),</span><br><span class="line">        ITALY(<span class="number">6</span>),</span><br><span class="line">        SPAIN_I(<span class="number">7</span>),</span><br><span class="line">        JAPAN(<span class="number">8</span>),</span><br><span class="line">        NORWAY(<span class="number">9</span>),</span><br><span class="line">        DENMARK_II(<span class="number">10</span>),</span><br><span class="line">        SPAIN_II(<span class="number">11</span>),</span><br><span class="line">        LATIN_AMERCIA(<span class="number">12</span>),</span><br><span class="line">        KOREAN(<span class="number">13</span>),</span><br><span class="line">        SLOVENIA(<span class="number">14</span>),</span><br><span class="line">        CHINA(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">CHARACTER_SET</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">FONT</span> &#123;</span><br><span class="line">        FONTA(<span class="number">0</span>),</span><br><span class="line">        FONTB(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">FONT</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">UNDERLINE_MODE</span> &#123;</span><br><span class="line">        OFF(<span class="number">0</span>),</span><br><span class="line">        UNDERLINE_1DOT(<span class="number">1</span>),</span><br><span class="line">        UNDERLINE_2DOT(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">UNDERLINE_MODE</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">ENABLE</span> &#123;</span><br><span class="line">        OFF(<span class="number">0</span>),</span><br><span class="line">        ON(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ENABLE</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">STATUS</span> &#123;</span><br><span class="line">        PRINTER_STATUS(<span class="number">1</span>),</span><br><span class="line">        PRINTER_OFFLINE(<span class="number">2</span>),</span><br><span class="line">        PRINTER_ERROR(<span class="number">3</span>),</span><br><span class="line">        PRINTER_PAPER(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">STATUS</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">byte</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="type">byte</span>)<span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="TSC命令封装类"><a href="#TSC命令封装类" class="headerlink" title="TSC命令封装类"></a>TSC命令封装类</h2><p>命令具体参考<code>TSC命令文档</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.xx.yy.gpbt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.gpbt.EscCommand.ENABLE;</span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.gpbt.LabelCommand;</span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.gpbt.GpUtils;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LabelCommand</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEBUG_TAG</span> <span class="operator">=</span> <span class="string">&quot;LabelCommand&quot;</span>;</span><br><span class="line">    Vector&lt;Byte&gt; Command = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LabelCommand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.Command = <span class="keyword">new</span> <span class="title class_">Vector</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LabelCommand</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> gap)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.Command = <span class="keyword">new</span> <span class="title class_">Vector</span>(<span class="number">4096</span>, <span class="number">1024</span>);</span><br><span class="line">        <span class="built_in">this</span>.addSize(width, height);</span><br><span class="line">        <span class="built_in">this</span>.addGap(gap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clrCommand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.Command.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addStrToCommand</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] bs = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!str.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                bs = str.getBytes(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var4) &#123;</span><br><span class="line">                var4.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bs.length; ++i) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(bs[i]));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addGap</span><span class="params">(<span class="type">int</span> gap)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;GAP &quot;</span> + gap + <span class="string">&quot; mm,&quot;</span> + <span class="number">0</span> + <span class="string">&quot; mm&quot;</span> + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSize</span><span class="params">(<span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SIZE &quot;</span> + width + <span class="string">&quot; mm,&quot;</span> + height + <span class="string">&quot; mm&quot;</span> + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCashdrwer</span><span class="params">(LabelCommand.FOOT m, <span class="type">int</span> t1, <span class="type">int</span> t2)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;CASHDRAWER &quot;</span> + m.getValue() + <span class="string">&quot;,&quot;</span> + t1 + <span class="string">&quot;,&quot;</span> + t2 + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addOffset</span><span class="params">(<span class="type">int</span> offset)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;OFFSET &quot;</span> + offset + <span class="string">&quot; mm&quot;</span> + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSpeed</span><span class="params">(LabelCommand.SPEED speed)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SPEED &quot;</span> + speed.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDensity</span><span class="params">(LabelCommand.DENSITY density)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;DENSITY &quot;</span> + density.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addDirection</span><span class="params">(LabelCommand.DIRECTION direction, LabelCommand.MIRROR mirror)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;DIRECTION &quot;</span> + direction.getValue() + <span class="string">&#x27;,&#x27;</span> + mirror.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addReference</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;REFERENCE &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addShif</span><span class="params">(<span class="type">int</span> shift)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SHIFT &quot;</span> + shift + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCls</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;CLS\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFeed</span><span class="params">(<span class="type">int</span> dot)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;FEED &quot;</span> + dot + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBackFeed</span><span class="params">(<span class="type">int</span> dot)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BACKFEED &quot;</span> + dot + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFormFeed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;FORMFEED\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addHome</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;HOME\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrint</span><span class="params">(<span class="type">int</span> m, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;PRINT &quot;</span> + m + <span class="string">&quot;,&quot;</span> + n + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrint</span><span class="params">(<span class="type">int</span> m)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;PRINT &quot;</span> + m + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCodePage</span><span class="params">(LabelCommand.CODEPAGE page)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;CODEPAGE &quot;</span> + page.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSound</span><span class="params">(<span class="type">int</span> level, <span class="type">int</span> interval)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SOUND &quot;</span> + level + <span class="string">&quot;,&quot;</span> + interval + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addLimitFeed</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;LIMITFEED &quot;</span> + n + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addSelfTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SELFTEST\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBar</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BAR &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + width + <span class="string">&quot;,&quot;</span> + height + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addText</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, LabelCommand.FONTTYPE font, LabelCommand.ROTATION rotation, LabelCommand.FONTMUL Xscal, LabelCommand.FONTMUL Yscal, String text)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;TEXT &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> + font.getValue() + <span class="string">&quot;\&quot;&quot;</span> + <span class="string">&quot;,&quot;</span> + rotation.getValue() + <span class="string">&quot;,&quot;</span> + Xscal.getValue() + <span class="string">&quot;,&quot;</span> + Yscal.getValue() + <span class="string">&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> + text + <span class="string">&quot;\&quot;&quot;</span> + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add1DBarcode</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, LabelCommand.BARCODETYPE type, <span class="type">int</span> height, LabelCommand.READABEL readable, LabelCommand.ROTATION rotation, String content)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">narrow</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BARCODE &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> + type.getValue() + <span class="string">&quot;\&quot;&quot;</span> + <span class="string">&quot;,&quot;</span> + height + <span class="string">&quot;,&quot;</span> + readable.getValue() + <span class="string">&quot;,&quot;</span> + rotation.getValue() + <span class="string">&quot;,&quot;</span> + narrow + <span class="string">&quot;,&quot;</span> + width + <span class="string">&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> + content + <span class="string">&quot;\&quot;&quot;</span> + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add1DBarcode</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, LabelCommand.BARCODETYPE type, <span class="type">int</span> height, LabelCommand.READABEL readable, LabelCommand.ROTATION rotation, <span class="type">int</span> narrow, <span class="type">int</span> width, String content)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BARCODE &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> + type.getValue() + <span class="string">&quot;\&quot;&quot;</span> + <span class="string">&quot;,&quot;</span> + height + <span class="string">&quot;,&quot;</span> + readable.getValue() + <span class="string">&quot;,&quot;</span> + rotation.getValue() + <span class="string">&quot;,&quot;</span> + narrow + <span class="string">&quot;,&quot;</span> + width + <span class="string">&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> + content + <span class="string">&quot;\&quot;&quot;</span> + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBox</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> xend, <span class="type">int</span> yend, <span class="type">int</span> thickness)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BOX &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + xend + <span class="string">&quot;,&quot;</span> + yend + <span class="string">&quot;,&quot;</span> + thickness + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBitmap</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, LabelCommand.BITMAP_MODE mode, <span class="type">int</span> nWidth, Bitmap b)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(b != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> (nWidth + <span class="number">7</span>) / <span class="number">8</span> * <span class="number">8</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> b.getHeight() * width / b.getWidth();</span><br><span class="line">            Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp.getWidth() &quot;</span> + b.getWidth());</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">grayBitmap</span> <span class="operator">=</span> GpUtils.toGrayscale(b);</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">rszBitmap</span> <span class="operator">=</span> GpUtils.resizeImage(grayBitmap, width, height);</span><br><span class="line">            <span class="type">byte</span>[] src = GpUtils.bitmapToBWPix(rszBitmap);</span><br><span class="line">            height = src.length / width;</span><br><span class="line">            width /= <span class="number">8</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BITMAP &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + width + <span class="string">&quot;,&quot;</span> + height + <span class="string">&quot;,&quot;</span> + mode.getValue() + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">            <span class="type">byte</span>[] codecontent = GpUtils.pixToLabelCmd(src);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; codecontent.length; ++k) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(codecontent[k]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.d(<span class="string">&quot;LabelCommand&quot;</span>, <span class="string">&quot;codecontent&quot;</span> + codecontent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBitmapByMethod</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, LabelCommand.BITMAP_MODE mode, <span class="type">int</span> nWidth, Bitmap b)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(b != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> (nWidth + <span class="number">7</span>) / <span class="number">8</span> * <span class="number">8</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> b.getHeight() * width / b.getWidth();</span><br><span class="line">            Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp.getWidth() &quot;</span> + b.getWidth());</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">rszBitmap</span> <span class="operator">=</span> GpUtils.resizeImage(b, width, height);</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">grayBitmap</span> <span class="operator">=</span> GpUtils.filter(rszBitmap, width, height);</span><br><span class="line">            <span class="type">byte</span>[] src = GpUtils.bitmapToBWPix(grayBitmap);</span><br><span class="line">            height = src.length / width;</span><br><span class="line">            width /= <span class="number">8</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BITMAP &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + width + <span class="string">&quot;,&quot;</span> + height + <span class="string">&quot;,&quot;</span> + mode.getValue() + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">            <span class="type">byte</span>[] codecontent = GpUtils.pixToLabelCmd(src);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; codecontent.length; ++k) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(codecontent[k]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Log.d(<span class="string">&quot;LabelCommand&quot;</span>, <span class="string">&quot;codecontent&quot;</span> + codecontent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addBitmap</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> nWidth, Bitmap bmp)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(bmp != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> (nWidth + <span class="number">7</span>) / <span class="number">8</span> * <span class="number">8</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bmp.getHeight() * width / bmp.getWidth();</span><br><span class="line">            Log.d(<span class="string">&quot;BMP&quot;</span>, <span class="string">&quot;bmp.getWidth() &quot;</span> + bmp.getWidth());</span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">rszBitmap</span> <span class="operator">=</span> GpUtils.resizeImage(bmp, width, height);</span><br><span class="line">            <span class="type">byte</span>[] bytes = GpUtils.printTscDraw(x, y, LabelCommand.BITMAP_MODE.OVERWRITE, rszBitmap);</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bytes.length; ++i) &#123;</span><br><span class="line">                <span class="built_in">this</span>.Command.add(Byte.valueOf(bytes[i]));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.addStrToCommand(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addErase</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> xwidth, <span class="type">int</span> yheight)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;ERASE &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + xwidth + <span class="string">&quot;,&quot;</span> + yheight + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addReverse</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> xwidth, <span class="type">int</span> yheight)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;REVERSE &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + xwidth + <span class="string">&quot;,&quot;</span> + yheight + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQRCode</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, LabelCommand.EEC level, <span class="type">int</span> cellwidth, LabelCommand.ROTATION rotation, String data)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;QRCODE &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + level.getValue() + <span class="string">&quot;,&quot;</span> + cellwidth + <span class="string">&quot;,&quot;</span> + <span class="string">&#x27;A&#x27;</span> + <span class="string">&quot;,&quot;</span> + rotation.getValue() + <span class="string">&quot;,&quot;</span> + <span class="string">&quot;\&quot;&quot;</span> + data + <span class="string">&quot;\&quot;&quot;</span> + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Vector&lt;Byte&gt; <span class="title function_">getCommand</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.Command;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQueryPrinterType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">String</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;~!T\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQueryPrinterStatus</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">27</span>;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">33</span>;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">63</span>;</span><br><span class="line">        <span class="built_in">this</span>.Command.add(Byte.valueOf(a));</span><br><span class="line">        <span class="built_in">this</span>.Command.add(Byte.valueOf(b));</span><br><span class="line">        <span class="built_in">this</span>.Command.add(Byte.valueOf(c));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResetPrinter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">27</span>;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">33</span>;</span><br><span class="line">        <span class="type">byte</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">82</span>;</span><br><span class="line">        <span class="built_in">this</span>.Command.add(Byte.valueOf(a));</span><br><span class="line">        <span class="built_in">this</span>.Command.add(Byte.valueOf(b));</span><br><span class="line">        <span class="built_in">this</span>.Command.add(Byte.valueOf(c));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQueryPrinterLife</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;~!@\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQueryPrinterMemory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;~!A\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQueryPrinterFile</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;~!F\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQueryPrinterCodePage</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;~!I\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPeel</span><span class="params">(ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(enable.getValue() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET PEEL &quot;</span> + enable.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addTear</span><span class="params">(ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET TEAR &quot;</span> + enable.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCutter</span><span class="params">(ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET CUTTER &quot;</span> + enable.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCutterBatch</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET CUTTER BATCH\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCutterPieces</span><span class="params">(<span class="type">short</span> number)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET CUTTER &quot;</span> + number + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addReprint</span><span class="params">(ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET REPRINT &quot;</span> + enable.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrintKey</span><span class="params">(ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET PRINTKEY &quot;</span> + enable.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPrintKey</span><span class="params">(<span class="type">int</span> m)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET PRINTKEY &quot;</span> + m + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addPartialCutter</span><span class="params">(ENABLE enable)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET PARTIAL_CUTTER &quot;</span> + enable.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addQueryPrinterStatus</span><span class="params">(LabelCommand.RESPONSE_MODE mode)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;SET RESPONSE &quot;</span> + mode.getValue() + <span class="string">&quot;\r\n&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(str);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUserCommand</span><span class="params">(String command)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.addStrToCommand(command);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">RESPONSE_MODE</span> &#123;</span><br><span class="line">        ON(<span class="string">&quot;ON&quot;</span>),</span><br><span class="line">        OFF(<span class="string">&quot;OFF&quot;</span>),</span><br><span class="line">        BATCH(<span class="string">&quot;BATCH&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">RESPONSE_MODE</span><span class="params">(String value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">BARCODETYPE</span> &#123;</span><br><span class="line">        CODE128(<span class="string">&quot;128&quot;</span>),</span><br><span class="line">        CODE128M(<span class="string">&quot;128M&quot;</span>),</span><br><span class="line">        EAN128(<span class="string">&quot;EAN128&quot;</span>),</span><br><span class="line">        ITF25(<span class="string">&quot;25&quot;</span>),</span><br><span class="line">        ITF25C(<span class="string">&quot;25C&quot;</span>),</span><br><span class="line">        CODE39(<span class="string">&quot;39&quot;</span>),</span><br><span class="line">        CODE39C(<span class="string">&quot;39C&quot;</span>),</span><br><span class="line">        CODE39S(<span class="string">&quot;39S&quot;</span>),</span><br><span class="line">        CODE93(<span class="string">&quot;93&quot;</span>),</span><br><span class="line">        EAN13(<span class="string">&quot;EAN13&quot;</span>),</span><br><span class="line">        EAN13_2(<span class="string">&quot;EAN13+2&quot;</span>),</span><br><span class="line">        EAN13_5(<span class="string">&quot;EAN13+5&quot;</span>),</span><br><span class="line">        EAN8(<span class="string">&quot;EAN8&quot;</span>),</span><br><span class="line">        EAN8_2(<span class="string">&quot;EAN8+2&quot;</span>),</span><br><span class="line">        EAN8_5(<span class="string">&quot;EAN8+5&quot;</span>),</span><br><span class="line">        CODABAR(<span class="string">&quot;CODA&quot;</span>),</span><br><span class="line">        POST(<span class="string">&quot;POST&quot;</span>),</span><br><span class="line">        UPCA(<span class="string">&quot;UPCA&quot;</span>),</span><br><span class="line">        UPCA_2(<span class="string">&quot;UPCA+2&quot;</span>),</span><br><span class="line">        UPCA_5(<span class="string">&quot;UPCA+5&quot;</span>),</span><br><span class="line">        UPCE(<span class="string">&quot;UPCE13&quot;</span>),</span><br><span class="line">        UPCE_2(<span class="string">&quot;UPCE13+2&quot;</span>),</span><br><span class="line">        UPCE_5(<span class="string">&quot;UPCE13+5&quot;</span>),</span><br><span class="line">        CPOST(<span class="string">&quot;CPOST&quot;</span>),</span><br><span class="line">        MSI(<span class="string">&quot;MSI&quot;</span>),</span><br><span class="line">        MSIC(<span class="string">&quot;MSIC&quot;</span>),</span><br><span class="line">        PLESSEY(<span class="string">&quot;PLESSEY&quot;</span>),</span><br><span class="line">        ITF14(<span class="string">&quot;ITF14&quot;</span>),</span><br><span class="line">        EAN14(<span class="string">&quot;EAN14&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">BARCODETYPE</span><span class="params">(String value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">EEC</span> &#123;</span><br><span class="line">        LEVEL_L(<span class="string">&quot;L&quot;</span>),</span><br><span class="line">        LEVEL_M(<span class="string">&quot;M&quot;</span>),</span><br><span class="line">        LEVEL_Q(<span class="string">&quot;Q&quot;</span>),</span><br><span class="line">        LEVEL_H(<span class="string">&quot;H&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">EEC</span><span class="params">(String value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">ROTATION</span> &#123;</span><br><span class="line">        ROTATION_0(<span class="number">0</span>),</span><br><span class="line">        ROTATION_90(<span class="number">90</span>),</span><br><span class="line">        ROTATION_180(<span class="number">180</span>),</span><br><span class="line">        ROTATION_270(<span class="number">270</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">ROTATION</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">FONTTYPE</span> &#123;</span><br><span class="line">        FONT_1(<span class="string">&quot;1&quot;</span>),</span><br><span class="line">        FONT_2(<span class="string">&quot;2&quot;</span>),</span><br><span class="line">        FONT_3(<span class="string">&quot;3&quot;</span>),</span><br><span class="line">        FONT_4(<span class="string">&quot;4&quot;</span>),</span><br><span class="line">        FONT_5(<span class="string">&quot;5&quot;</span>),</span><br><span class="line">        FONT_6(<span class="string">&quot;6&quot;</span>),</span><br><span class="line">        FONT_7(<span class="string">&quot;7&quot;</span>),</span><br><span class="line">        FONT_8(<span class="string">&quot;8&quot;</span>),</span><br><span class="line">        FONT_9(<span class="string">&quot;9&quot;</span>),</span><br><span class="line">        FONT_10(<span class="string">&quot;10&quot;</span>),</span><br><span class="line">        SIMPLIFIED_CHINESE(<span class="string">&quot;TSS24.BF2&quot;</span>),</span><br><span class="line">        TRADITIONAL_CHINESE(<span class="string">&quot;TST24.BF2&quot;</span>),</span><br><span class="line">        KOREAN(<span class="string">&quot;K&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">FONTTYPE</span><span class="params">(String value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">FONTMUL</span> &#123;</span><br><span class="line">        MUL_1(<span class="number">1</span>),</span><br><span class="line">        MUL_2(<span class="number">2</span>),</span><br><span class="line">        MUL_3(<span class="number">3</span>),</span><br><span class="line">        MUL_4(<span class="number">4</span>),</span><br><span class="line">        MUL_5(<span class="number">5</span>),</span><br><span class="line">        MUL_6(<span class="number">6</span>),</span><br><span class="line">        MUL_7(<span class="number">7</span>),</span><br><span class="line">        MUL_8(<span class="number">8</span>),</span><br><span class="line">        MUL_9(<span class="number">9</span>),</span><br><span class="line">        MUL_10(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">FONTMUL</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">CODEPAGE</span> &#123;</span><br><span class="line">        PC437(<span class="number">437</span>),</span><br><span class="line">        PC850(<span class="number">850</span>),</span><br><span class="line">        PC852(<span class="number">852</span>),</span><br><span class="line">        PC860(<span class="number">860</span>),</span><br><span class="line">        PC863(<span class="number">863</span>),</span><br><span class="line">        PC865(<span class="number">865</span>),</span><br><span class="line">        WPC1250(<span class="number">1250</span>),</span><br><span class="line">        WPC1252(<span class="number">1252</span>),</span><br><span class="line">        WPC1253(<span class="number">1253</span>),</span><br><span class="line">        WPC1254(<span class="number">1254</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">CODEPAGE</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">MIRROR</span> &#123;</span><br><span class="line">        NORMAL(<span class="number">0</span>),</span><br><span class="line">        MIRROR(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">MIRROR</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">DIRECTION</span> &#123;</span><br><span class="line">        FORWARD(<span class="number">0</span>),</span><br><span class="line">        BACKWARD(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">DIRECTION</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">DENSITY</span> &#123;</span><br><span class="line">        DNESITY0(<span class="number">0</span>),</span><br><span class="line">        DNESITY1(<span class="number">1</span>),</span><br><span class="line">        DNESITY2(<span class="number">2</span>),</span><br><span class="line">        DNESITY3(<span class="number">3</span>),</span><br><span class="line">        DNESITY4(<span class="number">4</span>),</span><br><span class="line">        DNESITY5(<span class="number">5</span>),</span><br><span class="line">        DNESITY6(<span class="number">6</span>),</span><br><span class="line">        DNESITY7(<span class="number">7</span>),</span><br><span class="line">        DNESITY8(<span class="number">8</span>),</span><br><span class="line">        DNESITY9(<span class="number">9</span>),</span><br><span class="line">        DNESITY10(<span class="number">10</span>),</span><br><span class="line">        DNESITY11(<span class="number">11</span>),</span><br><span class="line">        DNESITY12(<span class="number">12</span>),</span><br><span class="line">        DNESITY13(<span class="number">13</span>),</span><br><span class="line">        DNESITY14(<span class="number">14</span>),</span><br><span class="line">        DNESITY15(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">DENSITY</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">BITMAP_MODE</span> &#123;</span><br><span class="line">        OVERWRITE(<span class="number">0</span>),</span><br><span class="line">        OR(<span class="number">1</span>),</span><br><span class="line">        XOR(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">BITMAP_MODE</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">READABEL</span> &#123;</span><br><span class="line">        DISABLE(<span class="number">0</span>),</span><br><span class="line">        EANBEL(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">READABEL</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">SPEED</span> &#123;</span><br><span class="line">        SPEED1DIV5(<span class="number">1.5F</span>),</span><br><span class="line">        SPEED2(<span class="number">2.0F</span>),</span><br><span class="line">        SPEED3(<span class="number">3.0F</span>),</span><br><span class="line">        SPEED4(<span class="number">4.0F</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">float</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">SPEED</span><span class="params">(<span class="type">float</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">float</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">FOOT</span> &#123;</span><br><span class="line">        F2(<span class="number">0</span>),</span><br><span class="line">        F5(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="title function_">FOOT</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.value = value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="命令封装工具类"><a href="#命令封装工具类" class="headerlink" title="命令封装工具类"></a>命令封装工具类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by Fernflower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.xx.yy.gpbt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap.CompressFormat;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap.Config;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.ColorMatrix;</span><br><span class="line"><span class="keyword">import</span> android.graphics.ColorMatrixColorFilter;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Matrix;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Paint;</span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"><span class="keyword">import</span> com.masget.rcyltms.gpbt.LabelCommand.BITMAP_MODE;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> java.util.Vector;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GpUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;([a-zA-Z0-9!@#$^&amp;*\\(\\)~\\&#123;\\&#125;:\&quot;,\\.&lt;&gt;/]+)&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] p0 = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">128</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] p1 = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">64</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] p2 = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">32</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] p3 = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">16</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] p4 = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">8</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] p5 = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">4</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] p6 = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">0</span>, <span class="number">2</span>&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[][] Floyd16x16 = <span class="keyword">new</span> <span class="title class_">int</span>[][]&#123;&#123;<span class="number">0</span>, <span class="number">128</span>, <span class="number">32</span>, <span class="number">160</span>, <span class="number">8</span>, <span class="number">136</span>, <span class="number">40</span>, <span class="number">168</span>, <span class="number">2</span>, <span class="number">130</span>, <span class="number">34</span>, <span class="number">162</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">42</span>, <span class="number">170</span>&#125;, &#123;<span class="number">192</span>, <span class="number">64</span>, <span class="number">224</span>, <span class="number">96</span>, <span class="number">200</span>, <span class="number">72</span>, <span class="number">232</span>, <span class="number">104</span>, <span class="number">194</span>, <span class="number">66</span>, <span class="number">226</span>, <span class="number">98</span>, <span class="number">202</span>, <span class="number">74</span>, <span class="number">234</span>, <span class="number">106</span>&#125;, &#123;<span class="number">48</span>, <span class="number">176</span>, <span class="number">16</span>, <span class="number">144</span>, <span class="number">56</span>, <span class="number">184</span>, <span class="number">24</span>, <span class="number">152</span>, <span class="number">50</span>, <span class="number">178</span>, <span class="number">18</span>, <span class="number">146</span>, <span class="number">58</span>, <span class="number">186</span>, <span class="number">26</span>, <span class="number">154</span>&#125;, &#123;<span class="number">240</span>, <span class="number">112</span>, <span class="number">208</span>, <span class="number">80</span>, <span class="number">248</span>, <span class="number">120</span>, <span class="number">216</span>, <span class="number">88</span>, <span class="number">242</span>, <span class="number">114</span>, <span class="number">210</span>, <span class="number">82</span>, <span class="number">250</span>, <span class="number">122</span>, <span class="number">218</span>, <span class="number">90</span>&#125;, &#123;<span class="number">12</span>, <span class="number">140</span>, <span class="number">44</span>, <span class="number">172</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">36</span>, <span class="number">164</span>, <span class="number">14</span>, <span class="number">142</span>, <span class="number">46</span>, <span class="number">174</span>, <span class="number">6</span>, <span class="number">134</span>, <span class="number">38</span>, <span class="number">166</span>&#125;, &#123;<span class="number">204</span>, <span class="number">76</span>, <span class="number">236</span>, <span class="number">108</span>, <span class="number">196</span>, <span class="number">68</span>, <span class="number">228</span>, <span class="number">100</span>, <span class="number">206</span>, <span class="number">78</span>, <span class="number">238</span>, <span class="number">110</span>, <span class="number">198</span>, <span class="number">70</span>, <span class="number">230</span>, <span class="number">102</span>&#125;, &#123;<span class="number">60</span>, <span class="number">188</span>, <span class="number">28</span>, <span class="number">156</span>, <span class="number">52</span>, <span class="number">180</span>, <span class="number">20</span>, <span class="number">148</span>, <span class="number">62</span>, <span class="number">190</span>, <span class="number">30</span>, <span class="number">158</span>, <span class="number">54</span>, <span class="number">182</span>, <span class="number">22</span>, <span class="number">150</span>&#125;, &#123;<span class="number">252</span>, <span class="number">124</span>, <span class="number">220</span>, <span class="number">92</span>, <span class="number">244</span>, <span class="number">116</span>, <span class="number">212</span>, <span class="number">84</span>, <span class="number">254</span>, <span class="number">126</span>, <span class="number">222</span>, <span class="number">94</span>, <span class="number">246</span>, <span class="number">118</span>, <span class="number">214</span>, <span class="number">86</span>&#125;, &#123;<span class="number">3</span>, <span class="number">131</span>, <span class="number">35</span>, <span class="number">163</span>, <span class="number">11</span>, <span class="number">139</span>, <span class="number">43</span>, <span class="number">171</span>, <span class="number">1</span>, <span class="number">129</span>, <span class="number">33</span>, <span class="number">161</span>, <span class="number">9</span>, <span class="number">137</span>, <span class="number">41</span>, <span class="number">169</span>&#125;, &#123;<span class="number">195</span>, <span class="number">67</span>, <span class="number">227</span>, <span class="number">99</span>, <span class="number">203</span>, <span class="number">75</span>, <span class="number">235</span>, <span class="number">107</span>, <span class="number">193</span>, <span class="number">65</span>, <span class="number">225</span>, <span class="number">97</span>, <span class="number">201</span>, <span class="number">73</span>, <span class="number">233</span>, <span class="number">105</span>&#125;, &#123;<span class="number">51</span>, <span class="number">179</span>, <span class="number">19</span>, <span class="number">147</span>, <span class="number">59</span>, <span class="number">187</span>, <span class="number">27</span>, <span class="number">155</span>, <span class="number">49</span>, <span class="number">177</span>, <span class="number">17</span>, <span class="number">145</span>, <span class="number">57</span>, <span class="number">185</span>, <span class="number">25</span>, <span class="number">153</span>&#125;, &#123;<span class="number">243</span>, <span class="number">115</span>, <span class="number">211</span>, <span class="number">83</span>, <span class="number">251</span>, <span class="number">123</span>, <span class="number">219</span>, <span class="number">91</span>, <span class="number">241</span>, <span class="number">113</span>, <span class="number">209</span>, <span class="number">81</span>, <span class="number">249</span>, <span class="number">121</span>, <span class="number">217</span>, <span class="number">89</span>&#125;, &#123;<span class="number">15</span>, <span class="number">143</span>, <span class="number">47</span>, <span class="number">175</span>, <span class="number">7</span>, <span class="number">135</span>, <span class="number">39</span>, <span class="number">167</span>, <span class="number">13</span>, <span class="number">141</span>, <span class="number">45</span>, <span class="number">173</span>, <span class="number">5</span>, <span class="number">133</span>, <span class="number">37</span>, <span class="number">165</span>&#125;, &#123;<span class="number">207</span>, <span class="number">79</span>, <span class="number">239</span>, <span class="number">111</span>, <span class="number">199</span>, <span class="number">71</span>, <span class="number">231</span>, <span class="number">103</span>, <span class="number">205</span>, <span class="number">77</span>, <span class="number">237</span>, <span class="number">109</span>, <span class="number">197</span>, <span class="number">69</span>, <span class="number">229</span>, <span class="number">101</span>&#125;, &#123;<span class="number">63</span>, <span class="number">191</span>, <span class="number">31</span>, <span class="number">159</span>, <span class="number">55</span>, <span class="number">183</span>, <span class="number">23</span>, <span class="number">151</span>, <span class="number">61</span>, <span class="number">189</span>, <span class="number">29</span>, <span class="number">157</span>, <span class="number">53</span>, <span class="number">181</span>, <span class="number">21</span>, <span class="number">149</span>&#125;, &#123;<span class="number">254</span>, <span class="number">127</span>, <span class="number">223</span>, <span class="number">95</span>, <span class="number">247</span>, <span class="number">119</span>, <span class="number">215</span>, <span class="number">87</span>, <span class="number">253</span>, <span class="number">125</span>, <span class="number">221</span>, <span class="number">93</span>, <span class="number">245</span>, <span class="number">117</span>, <span class="number">213</span>, <span class="number">85</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[][] Floyd8x8 = <span class="keyword">new</span> <span class="title class_">int</span>[][]&#123;&#123;<span class="number">0</span>, <span class="number">32</span>, <span class="number">8</span>, <span class="number">40</span>, <span class="number">2</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">42</span>&#125;, &#123;<span class="number">48</span>, <span class="number">16</span>, <span class="number">56</span>, <span class="number">24</span>, <span class="number">50</span>, <span class="number">18</span>, <span class="number">58</span>, <span class="number">26</span>&#125;, &#123;<span class="number">12</span>, <span class="number">44</span>, <span class="number">4</span>, <span class="number">36</span>, <span class="number">14</span>, <span class="number">46</span>, <span class="number">6</span>, <span class="number">38</span>&#125;, &#123;<span class="number">60</span>, <span class="number">28</span>, <span class="number">52</span>, <span class="number">20</span>, <span class="number">62</span>, <span class="number">30</span>, <span class="number">54</span>, <span class="number">22</span>&#125;, &#123;<span class="number">3</span>, <span class="number">35</span>, <span class="number">11</span>, <span class="number">43</span>, <span class="number">1</span>, <span class="number">33</span>, <span class="number">9</span>, <span class="number">41</span>&#125;, &#123;<span class="number">51</span>, <span class="number">19</span>, <span class="number">59</span>, <span class="number">27</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">57</span>, <span class="number">25</span>&#125;, &#123;<span class="number">15</span>, <span class="number">47</span>, <span class="number">7</span>, <span class="number">39</span>, <span class="number">13</span>, <span class="number">45</span>, <span class="number">5</span>, <span class="number">37</span>&#125;, &#123;<span class="number">63</span>, <span class="number">31</span>, <span class="number">55</span>, <span class="number">23</span>, <span class="number">61</span>, <span class="number">29</span>, <span class="number">53</span>, <span class="number">21</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PAPER_58_WIDTH</span> <span class="operator">=</span> <span class="number">32</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PAPER_80_WIDTH</span> <span class="operator">=</span> <span class="number">48</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">sPaperWidth</span> <span class="operator">=</span> <span class="number">48</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer[] theSet0 = <span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;Integer.valueOf(<span class="number">1569</span>), Integer.valueOf(<span class="number">1570</span>), Integer.valueOf(<span class="number">1571</span>), Integer.valueOf(<span class="number">1572</span>), Integer.valueOf(<span class="number">1573</span>), Integer.valueOf(<span class="number">1574</span>), Integer.valueOf(<span class="number">1575</span>), Integer.valueOf(<span class="number">1576</span>), Integer.valueOf(<span class="number">1577</span>), Integer.valueOf(<span class="number">1578</span>), Integer.valueOf(<span class="number">1579</span>), Integer.valueOf(<span class="number">1580</span>), Integer.valueOf(<span class="number">1581</span>), Integer.valueOf(<span class="number">1582</span>), Integer.valueOf(<span class="number">1583</span>), Integer.valueOf(<span class="number">1584</span>), Integer.valueOf(<span class="number">1585</span>), Integer.valueOf(<span class="number">1586</span>), Integer.valueOf(<span class="number">1587</span>), Integer.valueOf(<span class="number">1588</span>), Integer.valueOf(<span class="number">1589</span>), Integer.valueOf(<span class="number">1590</span>), Integer.valueOf(<span class="number">1591</span>), Integer.valueOf(<span class="number">1592</span>), Integer.valueOf(<span class="number">1593</span>), Integer.valueOf(<span class="number">1594</span>), Integer.valueOf(<span class="number">1601</span>), Integer.valueOf(<span class="number">1602</span>), Integer.valueOf(<span class="number">1603</span>), Integer.valueOf(<span class="number">1604</span>), Integer.valueOf(<span class="number">1605</span>), Integer.valueOf(<span class="number">1606</span>), Integer.valueOf(<span class="number">1607</span>), Integer.valueOf(<span class="number">1608</span>), Integer.valueOf(<span class="number">1609</span>), Integer.valueOf(<span class="number">1610</span>), Integer.valueOf(<span class="number">17442</span>), Integer.valueOf(<span class="number">17443</span>), Integer.valueOf(<span class="number">17445</span>), Integer.valueOf(<span class="number">17447</span>)&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Integer[][] FormatTable = <span class="keyword">new</span> <span class="title class_">Integer</span>[][]&#123;&#123;Integer.valueOf(<span class="string">&#x27;ﺀ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺀ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺀ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺀ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺁ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺂ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺁ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺂ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺃ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺄ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺃ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺄ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺅ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺅ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺅ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺅ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﹽ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﹽ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﹽ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﹽ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺋ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺋ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺋ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺋ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺍ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺎ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺍ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺎ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺏ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺏ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺑ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺑ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺓ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺓ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺓ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺓ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺕ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺕ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺗ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺗ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺙ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺙ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺛ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺛ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺝ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺝ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺟ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺟ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺡ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺡ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺣ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺣ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺥ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺥ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺧ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺧ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺩ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺩ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺩ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺩ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺫ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺫ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺫ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺫ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺭ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺭ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺭ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺭ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺯ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺯ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺯ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺯ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺱ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺱ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺳ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺳ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺵ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺵ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺷ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺷ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺹ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺹ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺻ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺻ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﺽ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺽ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺿ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﺿ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻁ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻁ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻁ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻁ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻅ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻅ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻅ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻅ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻉ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻊ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻋ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻌ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻍ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻎ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻏ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻐ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻑ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻑ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻓ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻓ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻕ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻕ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻗ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻗ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻙ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻙ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻛ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻛ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻝ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻝ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻟ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻟ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻡ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻡ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻣ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻣ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻥ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻥ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻧ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻧ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻩ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻩ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻫ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻫ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻭ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻭ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻭ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻭ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻯ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻰ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻯ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻰ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻱ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻲ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻳ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻳ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻵ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻶ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻵ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻶ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻷ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻸ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻷ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻸ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻹ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻺ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻹ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻺ&#x27;</span>)&#125;, &#123;Integer.valueOf(<span class="string">&#x27;ﻻ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻼ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻻ&#x27;</span>), Integer.valueOf(<span class="string">&#x27;ﻼ&#x27;</span>)&#125;&#125;;</span><br><span class="line">    <span class="keyword">static</span> Integer[] theSet1 = <span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;Integer.valueOf(<span class="number">1574</span>), Integer.valueOf(<span class="number">1576</span>), Integer.valueOf(<span class="number">1578</span>), Integer.valueOf(<span class="number">1579</span>), Integer.valueOf(<span class="number">1580</span>), Integer.valueOf(<span class="number">1581</span>), Integer.valueOf(<span class="number">1582</span>), Integer.valueOf(<span class="number">1587</span>), Integer.valueOf(<span class="number">1588</span>), Integer.valueOf(<span class="number">1589</span>), Integer.valueOf(<span class="number">1590</span>), Integer.valueOf(<span class="number">1591</span>), Integer.valueOf(<span class="number">1592</span>), Integer.valueOf(<span class="number">1593</span>), Integer.valueOf(<span class="number">1594</span>), Integer.valueOf(<span class="number">1600</span>), Integer.valueOf(<span class="number">1601</span>), Integer.valueOf(<span class="number">1602</span>), Integer.valueOf(<span class="number">1603</span>), Integer.valueOf(<span class="number">1604</span>), Integer.valueOf(<span class="number">1605</span>), Integer.valueOf(<span class="number">1606</span>), Integer.valueOf(<span class="number">1607</span>), Integer.valueOf(<span class="number">1610</span>)&#125;;</span><br><span class="line">    <span class="keyword">static</span> Integer[] theSet2 = <span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;Integer.valueOf(<span class="number">1570</span>), Integer.valueOf(<span class="number">1571</span>), Integer.valueOf(<span class="number">1572</span>), Integer.valueOf(<span class="number">1573</span>), Integer.valueOf(<span class="number">1574</span>), Integer.valueOf(<span class="number">1575</span>), Integer.valueOf(<span class="number">1576</span>), Integer.valueOf(<span class="number">1577</span>), Integer.valueOf(<span class="number">1578</span>), Integer.valueOf(<span class="number">1579</span>), Integer.valueOf(<span class="number">1580</span>), Integer.valueOf(<span class="number">1581</span>), Integer.valueOf(<span class="number">1582</span>), Integer.valueOf(<span class="number">1583</span>), Integer.valueOf(<span class="number">1584</span>), Integer.valueOf(<span class="number">1585</span>), Integer.valueOf(<span class="number">1586</span>), Integer.valueOf(<span class="number">1587</span>), Integer.valueOf(<span class="number">1588</span>), Integer.valueOf(<span class="number">1589</span>), Integer.valueOf(<span class="number">1590</span>), Integer.valueOf(<span class="number">1591</span>), Integer.valueOf(<span class="number">1592</span>), Integer.valueOf(<span class="number">1593</span>), Integer.valueOf(<span class="number">1594</span>), Integer.valueOf(<span class="number">1600</span>), Integer.valueOf(<span class="number">1601</span>), Integer.valueOf(<span class="number">1602</span>), Integer.valueOf(<span class="number">1603</span>), Integer.valueOf(<span class="number">1604</span>), Integer.valueOf(<span class="number">1605</span>), Integer.valueOf(<span class="number">1606</span>), Integer.valueOf(<span class="number">1607</span>), Integer.valueOf(<span class="number">1608</span>), Integer.valueOf(<span class="number">1609</span>), Integer.valueOf(<span class="number">1610</span>)&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ALGORITHM_DITHER_16x16</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ALGORITHM_DITHER_8x8</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ALGORITHM_TEXTMODE</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ALGORITHM_GRAYTEXTMODE</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span>[][] COLOR_PALETTE = <span class="keyword">new</span> <span class="title class_">int</span>[][]&#123;&#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;, &#123;<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">method</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FLOYD_STEINBERG_DITHER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">ATKINSON_DITHER</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">GpUtils</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">resizeImage</span><span class="params">(Bitmap bitmap, <span class="type">int</span> w, <span class="type">int</span> h)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> bitmap.getWidth();</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bitmap.getHeight();</span><br><span class="line">        <span class="type">float</span> <span class="variable">scaleWidth</span> <span class="operator">=</span> (<span class="type">float</span>)w / (<span class="type">float</span>)width;</span><br><span class="line">        <span class="type">float</span> <span class="variable">scaleHeight</span> <span class="operator">=</span> (<span class="type">float</span>)h / (<span class="type">float</span>)height;</span><br><span class="line">        <span class="type">Matrix</span> <span class="variable">matrix</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Matrix</span>();</span><br><span class="line">        matrix.postScale(scaleWidth, scaleHeight);</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">resizedBitmap</span> <span class="operator">=</span> Bitmap.createBitmap(bitmap, <span class="number">0</span>, <span class="number">0</span>, width, height, matrix, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> resizedBitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">saveMyBitmap</span><span class="params">(Bitmap mBitmap)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(Environment.getExternalStorageDirectory().getPath(), <span class="string">&quot;Btatotest.jpeg&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            f.createNewFile();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var6) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fOut</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fOut = <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(f);</span><br><span class="line">            mBitmap.compress(CompressFormat.PNG, <span class="number">100</span>, fOut);</span><br><span class="line">            fOut.flush();</span><br><span class="line">            fOut.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException var4) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var5) &#123;</span><br><span class="line">            ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">toGrayscale</span><span class="params">(Bitmap bmpOriginal)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bmpOriginal.getHeight();</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> bmpOriginal.getWidth();</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bmpGrayscale</span> <span class="operator">=</span> Bitmap.createBitmap(width, height, Config.RGB_565);</span><br><span class="line">        <span class="type">Canvas</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Canvas</span>(bmpGrayscale);</span><br><span class="line">        <span class="type">Paint</span> <span class="variable">paint</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">        <span class="type">ColorMatrix</span> <span class="variable">cm</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ColorMatrix</span>();</span><br><span class="line">        cm.setSaturation(<span class="number">0.0F</span>);</span><br><span class="line">        <span class="type">ColorMatrixColorFilter</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ColorMatrixColorFilter</span>(cm);</span><br><span class="line">        paint.setColorFilter(f);</span><br><span class="line">        c.drawBitmap(bmpOriginal, <span class="number">0.0F</span>, <span class="number">0.0F</span>, paint);</span><br><span class="line">        <span class="keyword">return</span> bmpGrayscale;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] pixToEscRastBitImageCmd(<span class="type">byte</span>[] src, <span class="type">int</span> nWidth, <span class="type">int</span> nMode) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">nHeight</span> <span class="operator">=</span> src.length / nWidth;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">8</span> + src.length / <span class="number">8</span>];</span><br><span class="line">        data[<span class="number">0</span>] = <span class="number">29</span>;</span><br><span class="line">        data[<span class="number">1</span>] = <span class="number">118</span>;</span><br><span class="line">        data[<span class="number">2</span>] = <span class="number">48</span>;</span><br><span class="line">        data[<span class="number">3</span>] = (<span class="type">byte</span>)(nMode &amp; <span class="number">1</span>);</span><br><span class="line">        data[<span class="number">4</span>] = (<span class="type">byte</span>)(nWidth / <span class="number">8</span> % <span class="number">256</span>);</span><br><span class="line">        data[<span class="number">5</span>] = (<span class="type">byte</span>)(nWidth / <span class="number">8</span> / <span class="number">256</span>);</span><br><span class="line">        data[<span class="number">6</span>] = (<span class="type">byte</span>)(nHeight % <span class="number">256</span>);</span><br><span class="line">        data[<span class="number">7</span>] = (<span class="type">byte</span>)(nHeight / <span class="number">256</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; data.length; ++i) &#123;</span><br><span class="line">            data[i] = (<span class="type">byte</span>)(p0[src[k]] + p1[src[k + <span class="number">1</span>]] + p2[src[k + <span class="number">2</span>]] + p3[src[k + <span class="number">3</span>]] + p4[src[k + <span class="number">4</span>]] + p5[src[k + <span class="number">5</span>]] + p6[src[k + <span class="number">6</span>]] + src[k + <span class="number">7</span>]);</span><br><span class="line">            k += <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] pixToEscRastBitImageCmd(<span class="type">byte</span>[] src) &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[src.length / <span class="number">8</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; data.length; ++i) &#123;</span><br><span class="line">            data[i] = (<span class="type">byte</span>)(p0[src[k]] + p1[src[k + <span class="number">1</span>]] + p2[src[k + <span class="number">2</span>]] + p3[src[k + <span class="number">3</span>]] + p4[src[k + <span class="number">4</span>]] + p5[src[k + <span class="number">5</span>]] + p6[src[k + <span class="number">6</span>]] + src[k + <span class="number">7</span>]);</span><br><span class="line">            k += <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] pixToEscNvBitImageCmd(<span class="type">byte</span>[] src, <span class="type">int</span> width, <span class="type">int</span> height) &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[src.length / <span class="number">8</span> + <span class="number">4</span>];</span><br><span class="line">        data[<span class="number">0</span>] = (<span class="type">byte</span>)(width / <span class="number">8</span> % <span class="number">256</span>);</span><br><span class="line">        data[<span class="number">1</span>] = (<span class="type">byte</span>)(width / <span class="number">8</span> / <span class="number">256</span>);</span><br><span class="line">        data[<span class="number">2</span>] = (<span class="type">byte</span>)(height / <span class="number">8</span> % <span class="number">256</span>);</span><br><span class="line">        data[<span class="number">3</span>] = (<span class="type">byte</span>)(height / <span class="number">8</span> / <span class="number">256</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; width; ++i) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; height / <span class="number">8</span>; ++j) &#123;</span><br><span class="line">                data[<span class="number">4</span> + j + i * height / <span class="number">8</span>] = (<span class="type">byte</span>)(p0[src[i + k]] + p1[src[i + k + <span class="number">1</span> * width]] + p2[src[i + k + <span class="number">2</span> * width]] + p3[src[i + k + <span class="number">3</span> * width]] + p4[src[i + k + <span class="number">4</span> * width]] + p5[src[i + k + <span class="number">5</span> * width]] + p6[src[i + k + <span class="number">6</span> * width]] + src[i + k + <span class="number">7</span> * width]);</span><br><span class="line">                k += <span class="number">8</span> * width;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] pixToLabelCmd(<span class="type">byte</span>[] src) &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[src.length / <span class="number">8</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; data.length; ++k) &#123;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">temp</span> <span class="operator">=</span> (<span class="type">byte</span>)(p0[src[j]] + p1[src[j + <span class="number">1</span>]] + p2[src[j + <span class="number">2</span>]] + p3[src[j + <span class="number">3</span>]] + p4[src[j + <span class="number">4</span>]] + p5[src[j + <span class="number">5</span>]] + p6[src[j + <span class="number">6</span>]] + src[j + <span class="number">7</span>]);</span><br><span class="line">            data[k] = (<span class="type">byte</span>)(~temp);</span><br><span class="line">            j += <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] pixToTscCmd(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> mode, <span class="type">byte</span>[] src, <span class="type">int</span> nWidth) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> src.length / nWidth;</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> nWidth / <span class="number">8</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BITMAP &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + width + <span class="string">&quot;,&quot;</span> + height + <span class="string">&quot;,&quot;</span> + mode + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] bitmap = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bitmap = str.getBytes(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var13) &#123;</span><br><span class="line">            var13.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="title class_">byte</span>[src.length / <span class="number">8</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; arrayOfByte.length; ++k) &#123;</span><br><span class="line">            <span class="type">byte</span> <span class="variable">temp</span> <span class="operator">=</span> (<span class="type">byte</span>)(p0[src[j]] + p1[src[j + <span class="number">1</span>]] + p2[src[j + <span class="number">2</span>]] + p3[src[j + <span class="number">3</span>]] + p4[src[j + <span class="number">4</span>]] + p5[src[j + <span class="number">5</span>]] + p6[src[j + <span class="number">6</span>]] + src[j + <span class="number">7</span>]);</span><br><span class="line">            arrayOfByte[k] = (<span class="type">byte</span>)(~temp);</span><br><span class="line">            j += <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[bitmap.length + arrayOfByte.length];</span><br><span class="line">        System.arraycopy(bitmap, <span class="number">0</span>, data, <span class="number">0</span>, bitmap.length);</span><br><span class="line">        System.arraycopy(arrayOfByte, <span class="number">0</span>, data, bitmap.length, arrayOfByte.length);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">format_K_dither16x16</span><span class="params">(<span class="type">int</span>[] orgpixels, <span class="type">int</span> xsize, <span class="type">int</span> ysize, <span class="type">byte</span>[] despixels)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; ysize; ++y) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; xsize; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span>((orgpixels[k] &amp; <span class="number">255</span>) &gt; Floyd16x16[x &amp; <span class="number">15</span>][y &amp; <span class="number">15</span>]) &#123;</span><br><span class="line">                    despixels[k] = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    despixels[k] = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ++k;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] bitmapToBWPix(Bitmap mBitmap) &#123;</span><br><span class="line">        <span class="type">int</span>[] pixels = <span class="keyword">new</span> <span class="title class_">int</span>[mBitmap.getWidth() * mBitmap.getHeight()];</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[mBitmap.getWidth() * mBitmap.getHeight()];</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">grayBitmap</span> <span class="operator">=</span> toGrayscale(mBitmap);</span><br><span class="line">        grayBitmap.getPixels(pixels, <span class="number">0</span>, mBitmap.getWidth(), <span class="number">0</span>, <span class="number">0</span>, mBitmap.getWidth(), mBitmap.getHeight());</span><br><span class="line">        format_K_dither16x16(pixels, grayBitmap.getWidth(), grayBitmap.getHeight(), data);</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">format_K_dither16x16_int</span><span class="params">(<span class="type">int</span>[] orgpixels, <span class="type">int</span> xsize, <span class="type">int</span> ysize, <span class="type">int</span>[] despixels)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; ysize; ++y) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; xsize; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span>((orgpixels[k] &amp; <span class="number">255</span>) &gt; Floyd16x16[x &amp; <span class="number">15</span>][y &amp; <span class="number">15</span>]) &#123;</span><br><span class="line">                    despixels[k] = -<span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    despixels[k] = -<span class="number">16777216</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ++k;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">format_K_dither8x8_int</span><span class="params">(<span class="type">int</span>[] orgpixels, <span class="type">int</span> xsize, <span class="type">int</span> ysize, <span class="type">int</span>[] despixels)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; ysize; ++y) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; xsize; ++x) &#123;</span><br><span class="line">                <span class="keyword">if</span>((orgpixels[k] &amp; <span class="number">255</span>) &gt;&gt; <span class="number">2</span> &gt; Floyd8x8[x &amp; <span class="number">7</span>][y &amp; <span class="number">7</span>]) &#123;</span><br><span class="line">                    despixels[k] = -<span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    despixels[k] = -<span class="number">16777216</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ++k;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span>[] bitmapToBWPix_int(Bitmap mBitmap, <span class="type">int</span> algorithm) &#123;</span><br><span class="line">        <span class="type">int</span>[] pixels = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">0</span>];</span><br><span class="line">        Bitmap grayBitmap;</span><br><span class="line">        <span class="keyword">switch</span>(algorithm) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">                grayBitmap = toGrayscale(mBitmap);</span><br><span class="line">                pixels = <span class="keyword">new</span> <span class="title class_">int</span>[grayBitmap.getWidth() * grayBitmap.getHeight()];</span><br><span class="line">                grayBitmap.getPixels(pixels, <span class="number">0</span>, grayBitmap.getWidth(), <span class="number">0</span>, <span class="number">0</span>, grayBitmap.getWidth(), grayBitmap.getHeight());</span><br><span class="line">                format_K_dither8x8_int(pixels, grayBitmap.getWidth(), grayBitmap.getHeight(), pixels);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                grayBitmap = toGrayscale(mBitmap);</span><br><span class="line">                pixels = <span class="keyword">new</span> <span class="title class_">int</span>[grayBitmap.getWidth() * grayBitmap.getHeight()];</span><br><span class="line">                grayBitmap.getPixels(pixels, <span class="number">0</span>, grayBitmap.getWidth(), <span class="number">0</span>, <span class="number">0</span>, grayBitmap.getWidth(), grayBitmap.getHeight());</span><br><span class="line">                format_K_dither16x16_int(pixels, grayBitmap.getWidth(), grayBitmap.getHeight(), pixels);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pixels;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">toBinaryImage</span><span class="params">(Bitmap mBitmap, <span class="type">int</span> nWidth, <span class="type">int</span> algorithm)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> (nWidth + <span class="number">7</span>) / <span class="number">8</span> * <span class="number">8</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> mBitmap.getHeight() * width / mBitmap.getWidth();</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">rszBitmap</span> <span class="operator">=</span> resizeImage(mBitmap, width, height);</span><br><span class="line">        <span class="type">int</span>[] pixels = bitmapToBWPix_int(rszBitmap, algorithm);</span><br><span class="line">        rszBitmap.setPixels(pixels, <span class="number">0</span>, width, <span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">        <span class="keyword">return</span> rszBitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getCloseColor</span><span class="params">(<span class="type">int</span> tr, <span class="type">int</span> tg, <span class="type">int</span> tb)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">minDistanceSquared</span> <span class="operator">=</span> <span class="number">195076</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">bestIndex</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; COLOR_PALETTE.length; ++i) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">rdiff</span> <span class="operator">=</span> tr - COLOR_PALETTE[i][<span class="number">0</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">gdiff</span> <span class="operator">=</span> tg - COLOR_PALETTE[i][<span class="number">1</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">bdiff</span> <span class="operator">=</span> tb - COLOR_PALETTE[i][<span class="number">2</span>];</span><br><span class="line">            <span class="type">int</span> <span class="variable">distanceSquared</span> <span class="operator">=</span> rdiff * rdiff + gdiff * gdiff + bdiff * bdiff;</span><br><span class="line">            <span class="keyword">if</span>(distanceSquared &lt; minDistanceSquared) &#123;</span><br><span class="line">                minDistanceSquared = distanceSquared;</span><br><span class="line">                bestIndex = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bestIndex;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setPixel</span><span class="params">(<span class="type">int</span>[] input, <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> col, <span class="type">int</span> row, <span class="type">int</span>[] p)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(col &lt; <span class="number">0</span> || col &gt;= width) &#123;</span><br><span class="line">            col = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(row &lt; <span class="number">0</span> || row &gt;= height) &#123;</span><br><span class="line">            row = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> row * width + col;</span><br><span class="line">        input[index] = -<span class="number">16777216</span> | clamp(p[<span class="number">0</span>]) &lt;&lt; <span class="number">16</span> | clamp(p[<span class="number">1</span>]) &lt;&lt; <span class="number">8</span> | clamp(p[<span class="number">2</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] getPixel(<span class="type">int</span>[] input, <span class="type">int</span> width, <span class="type">int</span> height, <span class="type">int</span> col, <span class="type">int</span> row, <span class="type">float</span> error, <span class="type">int</span>[] ergb) &#123;</span><br><span class="line">        <span class="keyword">if</span>(col &lt; <span class="number">0</span> || col &gt;= width) &#123;</span><br><span class="line">            col = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(row &lt; <span class="number">0</span> || row &gt;= height) &#123;</span><br><span class="line">            row = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> row * width + col;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tr</span> <span class="operator">=</span> input[index] &gt;&gt; <span class="number">16</span> &amp; <span class="number">255</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tg</span> <span class="operator">=</span> input[index] &gt;&gt; <span class="number">8</span> &amp; <span class="number">255</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">tb</span> <span class="operator">=</span> input[index] &amp; <span class="number">255</span>;</span><br><span class="line">        tr = (<span class="type">int</span>)((<span class="type">float</span>)tr + error * (<span class="type">float</span>)ergb[<span class="number">0</span>]);</span><br><span class="line">        tg = (<span class="type">int</span>)((<span class="type">float</span>)tg + error * (<span class="type">float</span>)ergb[<span class="number">1</span>]);</span><br><span class="line">        tb = (<span class="type">int</span>)((<span class="type">float</span>)tb + error * (<span class="type">float</span>)ergb[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;tr, tg, tb&#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">clamp</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value &gt; <span class="number">255</span>?<span class="number">255</span>:(value &lt; <span class="number">0</span>?<span class="number">0</span>:value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">filter</span><span class="params">(Bitmap nbm, <span class="type">int</span> width, <span class="type">int</span> height)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] inPixels = <span class="keyword">new</span> <span class="title class_">int</span>[width * height];</span><br><span class="line">        nbm.getPixels(inPixels, <span class="number">0</span>, width, <span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line">        <span class="type">int</span>[] outPixels = <span class="keyword">new</span> <span class="title class_">int</span>[inPixels.length];</span><br><span class="line"><span class="comment">//        int index = false;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> <span class="number">0</span>; row &lt; height; ++row) &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">col</span> <span class="operator">=</span> <span class="number">0</span>; col &lt; width; ++col) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> row * width + col;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r1</span> <span class="operator">=</span> inPixels[index] &gt;&gt; <span class="number">16</span> &amp; <span class="number">255</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">g1</span> <span class="operator">=</span> inPixels[index] &gt;&gt; <span class="number">8</span> &amp; <span class="number">255</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">b1</span> <span class="operator">=</span> inPixels[index] &amp; <span class="number">255</span>;</span><br><span class="line">                <span class="type">int</span> <span class="variable">cIndex</span> <span class="operator">=</span> getCloseColor(r1, g1, b1);</span><br><span class="line">                outPixels[index] = -<span class="number">16777216</span> | COLOR_PALETTE[cIndex][<span class="number">0</span>] &lt;&lt; <span class="number">16</span> | COLOR_PALETTE[cIndex][<span class="number">1</span>] &lt;&lt; <span class="number">8</span> | COLOR_PALETTE[cIndex][<span class="number">2</span>];</span><br><span class="line">                <span class="type">int</span>[] ergb = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;r1 - COLOR_PALETTE[cIndex][<span class="number">0</span>], g1 - COLOR_PALETTE[cIndex][<span class="number">1</span>], b1 - COLOR_PALETTE[cIndex][<span class="number">2</span>]&#125;;</span><br><span class="line">                <span class="type">float</span> e1;</span><br><span class="line">                <span class="type">int</span>[] rgb4;</span><br><span class="line">                <span class="type">int</span>[] rgb5;</span><br><span class="line">                <span class="type">int</span>[] rgb6;</span><br><span class="line">                <span class="keyword">if</span>(method == <span class="number">1</span>) &#123;</span><br><span class="line">                    e1 = <span class="number">0.4375F</span>;</span><br><span class="line">                    <span class="type">float</span> <span class="variable">e2</span> <span class="operator">=</span> <span class="number">0.3125F</span>;</span><br><span class="line">                    <span class="type">float</span> <span class="variable">e3</span> <span class="operator">=</span> <span class="number">0.1875F</span>;</span><br><span class="line">                    <span class="type">float</span> <span class="variable">e4</span> <span class="operator">=</span> <span class="number">0.0625F</span>;</span><br><span class="line">                    rgb4 = getPixel(inPixels, width, height, col + <span class="number">1</span>, row, e1, ergb);</span><br><span class="line">                    rgb5 = getPixel(inPixels, width, height, col, row + <span class="number">1</span>, e2, ergb);</span><br><span class="line">                    rgb6 = getPixel(inPixels, width, height, col - <span class="number">1</span>, row + <span class="number">1</span>, e3, ergb);</span><br><span class="line">                    <span class="comment">//int[] rgb4 = getPixel(inPixels, width, height, col + 1, row + 1, e4, ergb);</span></span><br><span class="line">                    rgb4 = getPixel(inPixels, width, height, col + <span class="number">1</span>, row + <span class="number">1</span>, e4, ergb);</span><br><span class="line">                    setPixel(inPixels, width, height, col + <span class="number">1</span>, row, rgb4);</span><br><span class="line">                    setPixel(inPixels, width, height, col, row + <span class="number">1</span>, rgb5);</span><br><span class="line">                    setPixel(inPixels, width, height, col - <span class="number">1</span>, row + <span class="number">1</span>, rgb6);</span><br><span class="line">                    setPixel(inPixels, width, height, col + <span class="number">1</span>, row + <span class="number">1</span>, rgb4);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span>(method != <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Not Supported Dither Mothed!!&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    e1 = <span class="number">0.125F</span>;</span><br><span class="line">                    <span class="type">int</span>[] rgb1 = getPixel(inPixels, width, height, col + <span class="number">1</span>, row, e1, ergb);</span><br><span class="line">                    <span class="type">int</span>[] rgb2 = getPixel(inPixels, width, height, col + <span class="number">2</span>, row, e1, ergb);</span><br><span class="line">                    <span class="type">int</span>[] rgb3 = getPixel(inPixels, width, height, col - <span class="number">1</span>, row + <span class="number">1</span>, e1, ergb);</span><br><span class="line">                    rgb4 = getPixel(inPixels, width, height, col, row + <span class="number">1</span>, e1, ergb);</span><br><span class="line">                    rgb5 = getPixel(inPixels, width, height, col + <span class="number">1</span>, row + <span class="number">1</span>, e1, ergb);</span><br><span class="line">                    rgb6 = getPixel(inPixels, width, height, col, row + <span class="number">2</span>, e1, ergb);</span><br><span class="line">                    setPixel(inPixels, width, height, col + <span class="number">1</span>, row, rgb1);</span><br><span class="line">                    setPixel(inPixels, width, height, col + <span class="number">2</span>, row, rgb2);</span><br><span class="line">                    setPixel(inPixels, width, height, col - <span class="number">1</span>, row + <span class="number">1</span>, rgb3);</span><br><span class="line">                    setPixel(inPixels, width, height, col, row + <span class="number">1</span>, rgb4);</span><br><span class="line">                    setPixel(inPixels, width, height, col + <span class="number">1</span>, row + <span class="number">1</span>, rgb5);</span><br><span class="line">                    setPixel(inPixels, width, height, col, row + <span class="number">2</span>, rgb6);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(outPixels, <span class="number">0</span>, width, width, height, Config.RGB_565);</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] printEscDraw(Bitmap bitmap) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> bitmap.getWidth();</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bitmap.getHeight();</span><br><span class="line">        <span class="type">byte</span>[] bitbuf = <span class="keyword">new</span> <span class="title class_">byte</span>[width / <span class="number">8</span>];</span><br><span class="line">        <span class="type">byte</span>[] imgbuf = <span class="keyword">new</span> <span class="title class_">byte</span>[width / <span class="number">8</span> * height + <span class="number">8</span>];</span><br><span class="line">        imgbuf[<span class="number">0</span>] = <span class="number">29</span>;</span><br><span class="line">        imgbuf[<span class="number">1</span>] = <span class="number">118</span>;</span><br><span class="line">        imgbuf[<span class="number">2</span>] = <span class="number">48</span>;</span><br><span class="line">        imgbuf[<span class="number">3</span>] = <span class="number">0</span>;</span><br><span class="line">        imgbuf[<span class="number">4</span>] = (<span class="type">byte</span>)(width / <span class="number">8</span>);</span><br><span class="line">        imgbuf[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">        imgbuf[<span class="number">6</span>] = (<span class="type">byte</span>)(height % <span class="number">256</span>);</span><br><span class="line">        imgbuf[<span class="number">7</span>] = (<span class="type">byte</span>)(height / <span class="number">256</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; height; ++i) &#123;</span><br><span class="line">            <span class="type">int</span> k;</span><br><span class="line">            <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; width / <span class="number">8</span>; ++k) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">c0</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span>, i);</span><br><span class="line">                <span class="type">byte</span> p0;</span><br><span class="line">                <span class="keyword">if</span>(c0 != -<span class="number">1</span> &amp;&amp; c0 != <span class="number">0</span>) &#123;</span><br><span class="line">                    p0 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p0 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c1</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">1</span>, i);</span><br><span class="line">                <span class="type">byte</span> p1;</span><br><span class="line">                <span class="keyword">if</span>(c1 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p1 = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p1 = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c2</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">2</span>, i);</span><br><span class="line">                <span class="type">byte</span> p2;</span><br><span class="line">                <span class="keyword">if</span>(c2 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p2 = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p2 = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c3</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">3</span>, i);</span><br><span class="line">                <span class="type">byte</span> p3;</span><br><span class="line">                <span class="keyword">if</span>(c3 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p3 = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p3 = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c4</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">4</span>, i);</span><br><span class="line">                <span class="type">byte</span> p4;</span><br><span class="line">                <span class="keyword">if</span>(c4 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p4 = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p4 = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c5</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">5</span>, i);</span><br><span class="line">                <span class="type">byte</span> p5;</span><br><span class="line">                <span class="keyword">if</span>(c5 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p5 = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p5 = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c6</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">6</span>, i);</span><br><span class="line">                <span class="type">byte</span> p6;</span><br><span class="line">                <span class="keyword">if</span>(c6 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p6 = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p6 = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c7</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">7</span>, i);</span><br><span class="line">                <span class="type">byte</span> p7;</span><br><span class="line">                <span class="keyword">if</span>(c7 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p7 = <span class="number">0</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p7 = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> p0 * <span class="number">128</span> + p1 * <span class="number">64</span> + p2 * <span class="number">32</span> + p3 * <span class="number">16</span> + p4 * <span class="number">8</span> + p5 * <span class="number">4</span> + p6 * <span class="number">2</span> + p7;</span><br><span class="line">                bitbuf[k] = (<span class="type">byte</span>)value;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; width / <span class="number">8</span>; ++k) &#123;</span><br><span class="line">                ++s;</span><br><span class="line">                imgbuf[s] = bitbuf[k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> imgbuf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] printTscDraw(<span class="type">int</span> x, <span class="type">int</span> y, BITMAP_MODE mode, Bitmap bitmap) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">width</span> <span class="operator">=</span> bitmap.getWidth();</span><br><span class="line">        <span class="type">int</span> <span class="variable">height</span> <span class="operator">=</span> bitmap.getHeight();</span><br><span class="line">        <span class="type">byte</span>[] bitbuf = <span class="keyword">new</span> <span class="title class_">byte</span>[width / <span class="number">8</span>];</span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> <span class="string">&quot;BITMAP &quot;</span> + x + <span class="string">&quot;,&quot;</span> + y + <span class="string">&quot;,&quot;</span> + width / <span class="number">8</span> + <span class="string">&quot;,&quot;</span> + height + <span class="string">&quot;,&quot;</span> + mode.getValue() + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">        <span class="type">byte</span>[] strPrint = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            strPrint = str.getBytes(<span class="string">&quot;GB2312&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var30) &#123;</span><br><span class="line">            var30.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] imgbuf = <span class="keyword">new</span> <span class="title class_">byte</span>[width / <span class="number">8</span> * height + strPrint.length + <span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> s;</span><br><span class="line">        <span class="keyword">for</span>(s = <span class="number">0</span>; s &lt; strPrint.length; ++s) &#123;</span><br><span class="line">            imgbuf[s] = strPrint[s];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s = strPrint.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; height; ++i) &#123;</span><br><span class="line">            <span class="type">int</span> k;</span><br><span class="line">            <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; width / <span class="number">8</span>; ++k) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">c0</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span>, i);</span><br><span class="line">                <span class="type">byte</span> p0;</span><br><span class="line">                <span class="keyword">if</span>(c0 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p0 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p0 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c1</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">1</span>, i);</span><br><span class="line">                <span class="type">byte</span> p1;</span><br><span class="line">                <span class="keyword">if</span>(c1 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p1 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p1 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c2</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">2</span>, i);</span><br><span class="line">                <span class="type">byte</span> p2;</span><br><span class="line">                <span class="keyword">if</span>(c2 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p2 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p2 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c3</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">3</span>, i);</span><br><span class="line">                <span class="type">byte</span> p3;</span><br><span class="line">                <span class="keyword">if</span>(c3 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p3 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p3 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c4</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">4</span>, i);</span><br><span class="line">                <span class="type">byte</span> p4;</span><br><span class="line">                <span class="keyword">if</span>(c4 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p4 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p4 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c5</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">5</span>, i);</span><br><span class="line">                <span class="type">byte</span> p5;</span><br><span class="line">                <span class="keyword">if</span>(c5 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p5 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p5 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c6</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">6</span>, i);</span><br><span class="line">                <span class="type">byte</span> p6;</span><br><span class="line">                <span class="keyword">if</span>(c6 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p6 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p6 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">c7</span> <span class="operator">=</span> bitmap.getPixel(k * <span class="number">8</span> + <span class="number">7</span>, i);</span><br><span class="line">                <span class="type">byte</span> p7;</span><br><span class="line">                <span class="keyword">if</span>(c7 == -<span class="number">1</span>) &#123;</span><br><span class="line">                    p7 = <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p7 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">value</span> <span class="operator">=</span> p0 * <span class="number">128</span> + p1 * <span class="number">64</span> + p2 * <span class="number">32</span> + p3 * <span class="number">16</span> + p4 * <span class="number">8</span> + p5 * <span class="number">4</span> + p6 * <span class="number">2</span> + p7;</span><br><span class="line">                bitbuf[k] = (<span class="type">byte</span>)value;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(k = <span class="number">0</span>; k &lt; width / <span class="number">8</span>; ++k) &#123;</span><br><span class="line">                ++s;</span><br><span class="line">                imgbuf[s] = bitbuf[k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> imgbuf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">splitArabic</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">256</span>);</span><br><span class="line">        String[] arabics = input.split(<span class="string">&quot;\\n&quot;</span>);</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">int</span> lastArabic;</span><br><span class="line">        <span class="keyword">if</span>(arabics.length == <span class="number">1</span> &amp;&amp; arabics[<span class="number">0</span>].length() &gt; sPaperWidth) &#123;</span><br><span class="line">            i = arabics[<span class="number">0</span>].length() / sPaperWidth;</span><br><span class="line">            lastArabic = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; lastArabic &lt;= i; ++lastArabic) &#123;</span><br><span class="line">                sb.append(arabics[<span class="number">0</span>].substring(j, sPaperWidth * lastArabic));</span><br><span class="line">                j += sPaperWidth;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(sb.length() &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                sb.append(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lastArabic = arabics[<span class="number">0</span>].length() % sPaperWidth;</span><br><span class="line">            sb.append(arabics[<span class="number">0</span>].substring(arabics[<span class="number">0</span>].length() - lastArabic, arabics[<span class="number">0</span>].length()));</span><br><span class="line">            <span class="keyword">return</span> splitArabic(sb.toString());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; arabics.length; ++i) &#123;</span><br><span class="line">                lastArabic = arabics[i].length();</span><br><span class="line">                <span class="keyword">if</span>(lastArabic &gt; sPaperWidth) &#123;</span><br><span class="line">                    sb.append(splitArabic(arabics[i]));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sb.append(addSpaceAfterArabicString(arabics[i], sPaperWidth - lastArabic));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> String <span class="title function_">addSpaceAfterArabicString</span><span class="params">(String arabic, <span class="type">int</span> number)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">65</span>);</span><br><span class="line">        sb.append(arabic);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; number; ++i) &#123;</span><br><span class="line">            sb.append(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sb.append(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">reverseLetterAndNumber</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(input);</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(input);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(matcher.find()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">matcherString</span> <span class="operator">=</span> matcher.group();</span><br><span class="line">            <span class="type">int</span> <span class="variable">matcherStart</span> <span class="operator">=</span> matcher.start();</span><br><span class="line">            <span class="type">int</span> <span class="variable">matcherEnd</span> <span class="operator">=</span> matcher.end();</span><br><span class="line">            sb.replace(matcherStart, matcherEnd, (<span class="keyword">new</span> <span class="title class_">StringBuilder</span>(matcherString)).reverse().toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] string2Cp864(String arabicString) &#123;</span><br><span class="line">        Integer[] originUnicode = <span class="keyword">new</span> <span class="title class_">Integer</span>[arabicString.length()];</span><br><span class="line">        Integer[] outputUnicode = <span class="keyword">new</span> <span class="title class_">Integer</span>[arabicString.length()];</span><br><span class="line">        Integer[] outputChars = <span class="keyword">new</span> <span class="title class_">Integer</span>[originUnicode.length];</span><br><span class="line">        copy(arabicString.toCharArray(), originUnicode, arabicString.length());</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(Arrays.asList(originUnicode));</span><br><span class="line">        List&lt;Integer&gt; list1 = Hyphen(list);</span><br><span class="line">        list = Deformation(list1);</span><br><span class="line">        Collections.reverse(list1);</span><br><span class="line">        list1.toArray(outputUnicode);</span><br><span class="line">        <span class="type">char</span>[] chs = integer2Character(outputUnicode);</span><br><span class="line">        <span class="type">byte</span>[] cp864bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            cp864bytes = (<span class="keyword">new</span> <span class="title class_">String</span>(chs)).getBytes(<span class="string">&quot;cp864&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var8) &#123;</span><br><span class="line">            var8.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cp864bytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">char</span>[] integer2Character(Integer[] integers) &#123;</span><br><span class="line">        <span class="type">char</span>[] chs = <span class="keyword">new</span> <span class="title class_">char</span>[integers.length];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; integers.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span>(integers[i] != <span class="literal">null</span>) &#123;</span><br><span class="line">                chs[i] = (<span class="type">char</span>)integers[i].intValue();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                chs[i] = <span class="number">32</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> chs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">copy</span><span class="params">(<span class="type">char</span>[] array, Integer[] originUnicode, <span class="type">int</span> length)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">            originUnicode[i] = Integer.valueOf(array[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Integer&gt; <span class="title function_">Hyphen</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; list.size(); ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span>(((Integer)list.get(i)).intValue() == <span class="number">1604</span>) &#123;</span><br><span class="line">                <span class="keyword">switch</span>(((Integer)list.get(i + <span class="number">1</span>)).intValue()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1570</span>:</span><br><span class="line">                        list.set(i, Integer.valueOf(<span class="number">17442</span>));</span><br><span class="line">                        list.remove(i + <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1571</span>:</span><br><span class="line">                        list.set(i, Integer.valueOf(<span class="number">17443</span>));</span><br><span class="line">                        list.remove(i + <span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1572</span>:</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1574</span>:</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1573</span>:</span><br><span class="line">                        list.set(i, Integer.valueOf(<span class="number">17445</span>));</span><br><span class="line">                        list.remove(i + <span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="number">1575</span>:</span><br><span class="line">                        list.set(i, Integer.valueOf(<span class="number">17447</span>));</span><br><span class="line">                        list.remove(i + <span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> List&lt;Integer&gt; <span class="title function_">Deformation</span><span class="params">(List&lt;Integer&gt; inputlist)</span> &#123;</span><br><span class="line"><span class="comment">//        int flag = false;</span></span><br><span class="line">        List&lt;Integer&gt; outputlist = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">        Map&lt;Integer, Integer[]&gt; formHashTable = <span class="keyword">new</span> <span class="title class_">HashMap</span>(<span class="number">40</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">40</span>; ++i) &#123;</span><br><span class="line">            formHashTable.put(theSet0[i], FormatTable[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; inputlist.size(); ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span>(compare((Integer)inputlist.get(i), <span class="number">0</span>)) &#123;</span><br><span class="line">                <span class="type">boolean</span> inSet1;</span><br><span class="line">                <span class="type">boolean</span> inSet2;</span><br><span class="line">                <span class="type">int</span> flag;</span><br><span class="line">                <span class="keyword">if</span>(i == <span class="number">0</span>) &#123;</span><br><span class="line">                    inSet1 = <span class="literal">false</span>;</span><br><span class="line">                    inSet2 = compare((Integer)inputlist.get(i + <span class="number">1</span>), <span class="number">2</span>);</span><br><span class="line">                    flag = Flag(inSet1, inSet2);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(i == inputlist.size() - <span class="number">1</span>) &#123;</span><br><span class="line">                    inSet1 = compare((Integer)inputlist.get(i - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">                    inSet2 = <span class="literal">false</span>;</span><br><span class="line">                    flag = Flag(inSet1, inSet2);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    inSet1 = compare((Integer)inputlist.get(i - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">                    inSet2 = compare((Integer)inputlist.get(i + <span class="number">1</span>), <span class="number">2</span>);</span><br><span class="line">                    flag = Flag(inSet1, inSet2);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Integer[] a = (Integer[])formHashTable.get(inputlist.get(i));</span><br><span class="line">                outputlist.add(a[flag]);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outputlist.add(inputlist.get(i));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> outputlist;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">compare</span><span class="params">(Integer input, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">        List&lt;Integer[]&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(<span class="number">3</span>);</span><br><span class="line">        list.add(theSet0);</span><br><span class="line">        list.add(theSet1);</span><br><span class="line">        list.add(theSet2);</span><br><span class="line">        <span class="keyword">return</span> findInArray((Integer[])list.get(i), input.intValue());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">findInArray</span><span class="params">(Integer[] integer, <span class="type">int</span> input)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; integer.length; ++j) &#123;</span><br><span class="line">            <span class="keyword">if</span>(integer[j].intValue() == input) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">Flag</span><span class="params">(<span class="type">boolean</span> set1, <span class="type">boolean</span> set2)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> set1 &amp;&amp; set2?<span class="number">3</span>:(!set1 &amp;&amp; set2?<span class="number">2</span>:(set1 &amp;&amp; !set2?<span class="number">1</span>:<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setPaperWidth</span><span class="params">(<span class="type">int</span> paperWidth)</span> &#123;</span><br><span class="line">        sPaperWidth = paperWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] ByteTo_byte(Vector&lt;Byte&gt; vector) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> vector.size();</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[len];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i) &#123;</span><br><span class="line">            data[i] = ((Byte)vector.get(i)).byteValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> method;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setMethod</span><span class="params">(<span class="type">int</span> method)</span> &#123;</span><br><span class="line">        method = method;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="其他类的一些方法"><a href="#其他类的一些方法" class="headerlink" title="其他类的一些方法"></a>其他类的一些方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xx.yy.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/11/7.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PictureUtils</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base64字符串转位图</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> base64String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">base64StringToBitmap</span><span class="params">(String base64String)</span> &#123;</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Value</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] strArr =base64String.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(strArr.length==<span class="number">1</span>)&#123;</span><br><span class="line">                base64Value = strArr[<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(strArr.length==<span class="number">2</span>)&#123;</span><br><span class="line">                base64Value = strArr[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span>[] bitmapArray = Base64.decode(base64Value, Base64.DEFAULT);</span><br><span class="line">            bitmap = BitmapFactory.decodeByteArray(bitmapArray, <span class="number">0</span>, bitmapArray.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回base64字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bitmap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">bitmaptoBase64String</span><span class="params">(Bitmap bitmap)</span> &#123;</span><br><span class="line">        <span class="comment">//将Bitmap转换成字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        bitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, bStream);</span><br><span class="line">        <span class="type">byte</span>[] bytes = bStream.toByteArray();</span><br><span class="line">        string = Base64.encodeToString(bytes, Base64.DEFAULT);</span><br><span class="line">        <span class="keyword">return</span> string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>以上就是使用<code>ESC</code>和<code>TSC</code>命令做打印的<code>Android</code>源码</p><p>有些打印机只支持<code>ESC</code>，有些只支持<code>TSC</code>,也有两种命令都支持的，两种都支持的可能要在打印机上做模式切换，不然有可能打印不执行，要么就是乱码</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;rn蓝牙打印2&quot;&gt;&lt;a href=&quot;#rn蓝牙打印2&quot; class=&quot;headerlink&quot; title=&quot;rn蓝牙打印2&quot;&gt;&lt;/a&gt;rn蓝牙打印2&lt;/h2&gt;&lt;p&gt;本文是 &lt;strong&gt;rn蓝牙打印&lt;/strong&gt; 的补充&lt;/p&gt;
&lt;p&gt;上一篇文章里面主要说了蓝牙打印用&lt;code&gt;ESC&lt;/code&gt;指令，这一篇补充一下&lt;code&gt;TSC&lt;/code&gt;指令&lt;/p&gt;
&lt;p&gt;以下大部分代码来源于佳博&lt;code&gt;SDK&lt;/code&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="react-native" scheme="https://nightme.github.io/categories/react-native/"/>
    
    
      <category term="react-native" scheme="https://nightme.github.io/tags/react-native/"/>
    
  </entry>
  
  <entry>
    <title>rn蓝牙打印</title>
    <link href="https://nightme.github.io/2018/11/27/rn%E8%93%9D%E7%89%99%E6%89%93%E5%8D%B0/"/>
    <id>https://nightme.github.io/2018/11/27/rn蓝牙打印/</id>
    <published>2018-11-27T02:14:44.000Z</published>
    <updated>2025-09-19T04:25:12.102Z</updated>
    
    <content type="html"><![CDATA[<h2 id="蓝牙4-0"><a href="#蓝牙4-0" class="headerlink" title="蓝牙4.0"></a>蓝牙<code>4.0</code></h2><p>蓝牙<code>4.0</code>标准包含两个蓝牙标准，准确的说，是一个双模的标准</p><p>现在移动设备上使用的蓝牙大多是<code>4.0</code>，而蓝牙 <code>4.0</code> 有两个分支，经典 <code>4.0</code> 和 <code>BLE4.0</code></p><h3 id="经典蓝牙-classic-Bluetooth"><a href="#经典蓝牙-classic-Bluetooth" class="headerlink" title="经典蓝牙(classic Bluetooth)"></a>经典蓝牙(<code>classic Bluetooth</code>)</h3><p>经典蓝牙可以用与数据量比较大的传输，如语音，音乐，较高数据量传输</p><span id="more"></span><h4 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h4><p>经典蓝牙建立连接的方式实际上就是<code>Socket</code>的连接的建立。只不过这里不是直接用<code>Socket</code>，而是<code>BluetoothSocket</code>。</p><p>获取<code>BluetoothSocket</code>的方式也很简单，利用搜索找到的<code>BluetoothDevice</code>，调用其方法<code>createRfcommSocketToServiceRecord(UUID)</code>。</p><p>最后，使用获取到的<code>BluetoothDevice</code>调用其方法<code>connect()</code>就建立了经典蓝牙设备之间的连接通道。</p><h4 id="数据通信"><a href="#数据通信" class="headerlink" title="数据通信"></a>数据通信</h4><p>当建立连接后，就可以直接使用<code>BluetoothSocket</code>的<code>getOutputStream()</code>方法获取输出流写入需要发送的数据。读取发送回来的数据，则是调用<code>BluetoothSocket</code>的<code>getInputStream()</code>方法获取输入流读取</p><h3 id="低功耗蓝牙（Bluetooth-low-energy，简称BLE或者LE）"><a href="#低功耗蓝牙（Bluetooth-low-energy，简称BLE或者LE）" class="headerlink" title="低功耗蓝牙（Bluetooth low energy，简称BLE或者LE）"></a>低功耗蓝牙（Bluetooth low energy，简称BLE或者LE）</h3><p>低功耗蓝牙应用于实时性要求比较高，但是数据速率比较低的产品，如遥控类的，如鼠标，键盘，遥控鼠标(Air Mouse)，传感设备的数据发送，如心跳带，血压计，温度传感器等</p><p>BLE的优点是快速搜索，快速连接，超低功耗保持连接和传输数据，弱点是数据传输速率低</p><h4 id="建立连接-1"><a href="#建立连接-1" class="headerlink" title="建立连接"></a>建立连接</h4><p>硬件条件是，蓝牙得至少是低功耗蓝牙版本，然后安卓系统的话，至少得是<code>Android 4.3</code>以上系统才行</p><h4 id="数据通信-1"><a href="#数据通信-1" class="headerlink" title="数据通信"></a>数据通信</h4><p><code>BLE</code>分为三部分<code>Service</code>（服务）、<code>Characteristic</code>（特征）、<code>Descriptor</code>（描述符），这三部分都由<code>UUID</code>作为唯一标示符。</p><p>一个蓝牙<code>4.0</code>的终端可以包含多个<code>Service</code>;</p><p>一个<code>Service</code>可以包含多个<code>Characteristic</code>;</p><p>一个<code>Characteristic</code>包含一个<code>Value</code>和多个<code>Descriptor</code>;</p><p>一个<code>Descriptor</code>包含一个<code>Value</code> 一般来说;</p><p><code>Characteristic</code>是手机与BLE终端交换数据的关键，<code>Characteristic</code>有跟权限相关的字段，如<code>Property，Property</code>有读写等各种属性，如<code>Notify、Read、Write、WriteWithoutResponse</code></p><p>调用<code>BluetoothGattCharacteristic</code>的方法<code>setValue(value)</code>进行,发送的命令值,其中<code>value</code>一般为<code>byte[]</code>;</p><p>使用<code>BluetoothGatt</code>的写入方法<code>writeCharacteristic(char)</code>完成命令发送</p><h2 id="react-native-ble-plx"><a href="#react-native-ble-plx" class="headerlink" title="react-native-ble-plx"></a>react-native-ble-plx</h2><p>一个支持低功耗的蓝牙类库</p><p>Android (example setup):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save react-native-ble-plx</span><br><span class="line">react-native <span class="built_in">link</span> react-native-ble-plx</span><br><span class="line"><span class="comment">#安装依赖</span></span><br></pre></td></tr></table></figure><p>在app模块的<code>build.gradle</code>中，确保<code>min SDK</code>版本至少为18：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion 18</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>添加权限<code>AndroidManifest.xml</code>：</p><p><strong>注意:</strong> 添加GPS和网络定位权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 允许程序连接到已配对的蓝牙设备--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span>/&gt;</span><br><span class="line">&lt;!-- 允许程序发现和配对蓝牙设备--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span>/&gt;</span><br><span class="line">&lt;!-- GPS权限--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span> /&gt;</span><br><span class="line">&lt;!-- 网络定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span> /&gt;</span><br></pre></td></tr></table></figure><h2 id="热敏打印机指令集"><a href="#热敏打印机指令集" class="headerlink" title="热敏打印机指令集"></a>热敏打印机指令集</h2><p>以下命令是部分命令，具体参考文百度文库<a href="https://wenku.baidu.com/view/187b1ad5690203d8ce2f0066f5335a8102d266a9">热敏打印机指令集文档</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> blePlxCommands = &#123;</span><br><span class="line">    <span class="attr">asciiFont</span>:[<span class="number">0x1b</span>, <span class="number">0x4d</span>, <span class="number">0x00</span>],<span class="comment">//标准ASCII字体</span></span><br><span class="line">    <span class="attr">compressAsciiFont</span>:[<span class="number">0x1b</span>, <span class="number">0x4d</span>, <span class="number">0x01</span>],<span class="comment">// 压缩ASCII字体</span></span><br><span class="line">    <span class="attr">fontWeight</span>:[<span class="number">0x1b</span>, <span class="number">0x45</span>, <span class="number">0x01</span>],<span class="comment">//选择加粗模式</span></span><br><span class="line">    <span class="attr">cancelFontWeight</span>:[<span class="number">0x1b</span>, <span class="number">0x45</span>, <span class="number">0x00</span>],<span class="comment">//取消加粗模式</span></span><br><span class="line">    <span class="attr">alignLeft</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x30</span>],<span class="comment">//左对齐</span></span><br><span class="line">    <span class="attr">alignRight</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x32</span>],<span class="comment">//右对齐</span></span><br><span class="line">    <span class="attr">alignCenter</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x31</span>],<span class="comment">//居中对齐</span></span><br><span class="line">    <span class="attr">cutPaper</span>:[<span class="number">0x1b</span>, <span class="number">0x69</span>],<span class="comment">//全切纸</span></span><br><span class="line">    <span class="attr">cutHalfPaper</span>:[<span class="number">0x1b</span>, <span class="number">0x6d</span>],<span class="comment">//半切纸</span></span><br><span class="line">    <span class="attr">nextOneLinePaper</span>:[<span class="number">0x0a</span>],<span class="comment">//走一行纸</span></span><br><span class="line">    <span class="attr">clockwiseDegree90</span>:[<span class="number">0x1b</span>, <span class="number">0x56</span>, <span class="number">0x01</span>], <span class="comment">//选择顺时针旋转90°</span></span><br><span class="line">    <span class="attr">reverseClockwise90</span>:[<span class="number">0x1b</span>, <span class="number">0x56</span>, <span class="number">0x00</span>],<span class="comment">//取消顺时针旋转90°</span></span><br><span class="line">    <span class="attr">imgBefore</span>:[<span class="number">0x1B</span>, <span class="number">0x33</span>, <span class="number">0x00</span>],<span class="comment">// 发送打印图片设置图片行距为0</span></span><br><span class="line">    <span class="attr">imgAfter</span>:[<span class="number">0x1d</span>, <span class="number">0x4c</span>, <span class="number">0x1f</span>, <span class="number">0x1f</span>],<span class="comment">//发送结束指令(选择左边空白)</span></span><br><span class="line">    <span class="attr">initClear</span>:[<span class="number">0x1b</span>,<span class="number">0x40</span>],<span class="comment">//初始化打印机，复位打印机,清除打印缓冲区</span></span><br><span class="line">    <span class="attr">setZhFontMode</span>:[<span class="number">0x1c</span>,<span class="number">0x26</span>]<span class="comment">//设置中文字符模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="react-native-ble-plx简单使用"><a href="#react-native-ble-plx简单使用" class="headerlink" title="react-native-ble-plx简单使用"></a>react-native-ble-plx简单使用</h2><ul><li>蓝牙热敏打印的使用；</li><li>可以同时可以连接多个设备；</li><li>文档地址：<a href="https://github.com/Polidea/react-native-ble-plx">https://github.com/Polidea/react-native-ble-plx</a></li><li><code>react-native-ble-plx</code>接收的数据格式是<code>base64</code></li></ul><p><a href="https://apkdownloadforandroid.com/com.BlueLoupe.DreamOn.mh/"><code>BlueLoupe.apk</code></a>APP可以检测设备是否支持低功耗蓝牙</p><p>蓝牙服务于特征的获取并与数据的通信</p><h3 id="react-native"><a href="#react-native" class="headerlink" title="react-native"></a><code>react-native</code></h3><p><code>bleplx.js</code>(简要代码):</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Platform</span>,<span class="title class_">Alert</span>,<span class="title class_">NativeModules</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Buffer</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;buffer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BleManager</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-native-ble-plx&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">XToast</span> <span class="keyword">from</span> <span class="string">&#x27;@app/widget/x-toast/&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> lodash <span class="keyword">from</span> <span class="string">&quot;lodash&quot;</span></span><br><span class="line"><span class="keyword">import</span> iconv <span class="keyword">from</span> <span class="string">&quot;iconv-lite&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BlePlxPrint</span> = <span class="title class_">NativeModules</span>.<span class="property">BlePlxPrint</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [bluetoothCommands 蓝牙打印命令]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> &#123;<span class="type">Object</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> blePlxCommands = &#123;</span><br><span class="line">    <span class="attr">asciiFont</span>:[<span class="number">0x1b</span>, <span class="number">0x4d</span>, <span class="number">0x00</span>],<span class="comment">//标准ASCII字体</span></span><br><span class="line">    <span class="attr">compressAsciiFont</span>:[<span class="number">0x1b</span>, <span class="number">0x4d</span>, <span class="number">0x01</span>],<span class="comment">// 压缩ASCII字体</span></span><br><span class="line">    <span class="attr">fontWeight</span>:[<span class="number">0x1b</span>, <span class="number">0x45</span>, <span class="number">0x01</span>],<span class="comment">//选择加粗模式</span></span><br><span class="line">    <span class="attr">cancelFontWeight</span>:[<span class="number">0x1b</span>, <span class="number">0x45</span>, <span class="number">0x00</span>],<span class="comment">//取消加粗模式</span></span><br><span class="line">    <span class="attr">alignLeft</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x30</span>],<span class="comment">//左对齐</span></span><br><span class="line">    <span class="attr">alignRight</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x32</span>],<span class="comment">//右对齐</span></span><br><span class="line">    <span class="attr">alignCenter</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x31</span>],<span class="comment">//居中对齐</span></span><br><span class="line">    <span class="attr">cutPaper</span>:[<span class="number">0x1b</span>, <span class="number">0x69</span>],<span class="comment">//全切纸</span></span><br><span class="line">    <span class="attr">cutHalfPaper</span>:[<span class="number">0x1b</span>, <span class="number">0x6d</span>],<span class="comment">//半切纸</span></span><br><span class="line">    <span class="attr">nextOneLinePaper</span>:[<span class="number">0x0a</span>],<span class="comment">//走一行纸</span></span><br><span class="line">    <span class="attr">clockwiseDegree90</span>:[<span class="number">0x1b</span>, <span class="number">0x56</span>, <span class="number">0x01</span>], <span class="comment">//选择顺时针旋转90°</span></span><br><span class="line">    <span class="attr">reverseClockwise90</span>:[<span class="number">0x1b</span>, <span class="number">0x56</span>, <span class="number">0x00</span>],<span class="comment">//取消顺时针旋转90°</span></span><br><span class="line">    <span class="attr">imgBefore</span>:[<span class="number">0x1B</span>, <span class="number">0x33</span>, <span class="number">0x00</span>],<span class="comment">// 发送打印图片设置图片行距为0</span></span><br><span class="line">    <span class="attr">imgAfter</span>:[<span class="number">0x1d</span>, <span class="number">0x4c</span>, <span class="number">0x1f</span>, <span class="number">0x1f</span>],<span class="comment">//发送结束指令(选择左边空白)</span></span><br><span class="line">    <span class="attr">initClear</span>:[<span class="number">0x1b</span>,<span class="number">0x40</span>],<span class="comment">//初始化打印机，复位打印机,清除打印缓冲区</span></span><br><span class="line">    <span class="attr">setZhFontMode</span>:[<span class="number">0x1c</span>,<span class="number">0x26</span>]<span class="comment">//设置中文字符模式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [_cacheConnectDeviceMap 缓存已连接的设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> &#123;<span class="type">Map</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//缓存所有连接过的设备</span></span><br><span class="line"><span class="keyword">let</span> _cacheConnectDeviceMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="comment">//缓存设备的UUID</span></span><br><span class="line"><span class="keyword">let</span> _cacheConnectDeviceUUIDMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************ConnectDevice**************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 已连接成功的设备</span></span><br><span class="line"><span class="comment"> * [updateCacheConnectDevice 新增并更新缓存设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; connectDevice [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;               [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateCacheConnectDevice</span>(<span class="params">connectDevice</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!connectDevice || !connectDevice.<span class="property">id</span>)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _cacheConnectDeviceMap.<span class="title function_">set</span>(connectDevice.<span class="property">id</span>,connectDevice); <span class="comment">//使用Map类型保存搜索到的蓝牙设备，确保列表不显示重复的设备</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getCacheConnectDeviceById 获取指定连接设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; id [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;    [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCacheConnectDeviceById</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_cacheConnectDeviceMap.<span class="title function_">has</span>(id))&#123;</span><br><span class="line">        <span class="keyword">return</span> _cacheConnectDeviceMap.<span class="title function_">get</span>(id);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 已连接成功的设备</span></span><br><span class="line"><span class="comment"> * [removeCacheConnectDevice 移除缓存设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; connectDevice [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[Object]</span>&#125;               [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeCacheConnectDevice</span>(<span class="params">connectDevice</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!connectDevice || !connectDevice.<span class="property">id</span>)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_cacheConnectDeviceMap.<span class="title function_">has</span>(connectDevice.<span class="property">id</span>))&#123;</span><br><span class="line">        _cacheConnectDeviceMap.<span class="title function_">delete</span>(connectDevice.<span class="property">id</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************UUID**************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [removeCacheConnectDeviceUUIDMap 移除缓存设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; connectDevice [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;               [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeCacheConnectDeviceUUID</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_cacheConnectDeviceUUIDMap.<span class="title function_">has</span>(id))&#123;</span><br><span class="line">        _cacheConnectDeviceUUIDMap.<span class="title function_">delete</span>(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getCacheConnectDeviceUUIDById 返回设备UUID]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; id [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[Object]</span>&#125;    [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCacheConnectDeviceUUIDById</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_cacheConnectDeviceUUIDMap.<span class="title function_">has</span>(id))&#123;</span><br><span class="line">        <span class="keyword">return</span> _cacheConnectDeviceUUIDMap.<span class="title function_">get</span>(id);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [updateCacheConnectDeviceUUID 更新设备的UUID]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; id   [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; data [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;      [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateCacheConnectDeviceUUID</span>(<span class="params">id,data</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id || !data)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备[id]与 [data]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _cacheConnectDeviceUUIDMap.<span class="title function_">set</span>(id,data); <span class="comment">//使用Map类型保存搜索到的蓝牙设备，的UUID</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [fetchServicesAndCharacteristicsForDevice 获取设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125;  device [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Promise</span>&#125;        [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchServicesAndCharacteristicsForDevice</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;[id]不存在无法获取服务&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> device = <span class="title function_">getCacheConnectDeviceById</span>(id);</span><br><span class="line">    <span class="keyword">if</span>(!device)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备不存在无法获取服务&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> servicesMap = &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> characteristicsMap = &#123;&#125;;</span><br><span class="line">    <span class="comment">//获取所有服务</span></span><br><span class="line">    <span class="keyword">let</span> services = <span class="keyword">await</span> device.<span class="title function_">services</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> service <span class="keyword">of</span> services) &#123;</span><br><span class="line">        characteristicsMap = &#123;&#125;</span><br><span class="line">        <span class="comment">//获取该服务的所有特征</span></span><br><span class="line">        <span class="keyword">let</span> characteristics = <span class="keyword">await</span> service.<span class="title function_">characteristics</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> characteristic <span class="keyword">of</span> characteristics) &#123;</span><br><span class="line">            characteristicsMap[characteristic.<span class="property">uuid</span>] = &#123;</span><br><span class="line">                <span class="attr">uuid</span>: characteristic.<span class="property">uuid</span>,</span><br><span class="line">                <span class="attr">isReadable</span>: characteristic.<span class="property">isReadable</span>,</span><br><span class="line">                <span class="attr">isWritableWithResponse</span>: characteristic.<span class="property">isWritableWithResponse</span>,</span><br><span class="line">                <span class="attr">isWritableWithoutResponse</span>: characteristic.<span class="property">isWritableWithoutResponse</span>,</span><br><span class="line">                <span class="attr">isNotifiable</span>: characteristic.<span class="property">isNotifiable</span>,</span><br><span class="line">                <span class="attr">isNotifying</span>: characteristic.<span class="property">isNotifying</span>,</span><br><span class="line">                <span class="attr">value</span>: characteristic.<span class="property">value</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        servicesMap[service.<span class="property">uuid</span>] = &#123;</span><br><span class="line">            <span class="attr">uuid</span>: service.<span class="property">uuid</span>,</span><br><span class="line">            <span class="attr">isPrimary</span>: service.<span class="property">isPrimary</span>,</span><br><span class="line">            <span class="attr">characteristicsCount</span>: characteristics.<span class="property">length</span>,<span class="comment">//特征数量</span></span><br><span class="line">            <span class="attr">characteristics</span>: characteristicsMap</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> servicesMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getBlePlxUUID 获取蓝牙UUID]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBlePlxUUID</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> services = <span class="keyword">await</span> <span class="title function_">fetchServicesAndCharacteristicsForDevice</span>(id);</span><br><span class="line">    <span class="keyword">if</span>(!services)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;服务不存在，无法获取[UUID]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> result = &#123;</span><br><span class="line">        <span class="attr">readServiceUUID</span>:[],</span><br><span class="line">        <span class="attr">readCharacteristicUUID</span>:[],</span><br><span class="line"></span><br><span class="line">        <span class="attr">writeWithResponseServiceUUID</span>:[],</span><br><span class="line">        <span class="attr">writeWithResponseCharacteristicUUID</span>:[],</span><br><span class="line"></span><br><span class="line">        <span class="attr">writeWithoutResponseServiceUUID</span>:[],</span><br><span class="line">        <span class="attr">writeWithoutResponseCharacteristicUUID</span>:[],</span><br><span class="line"></span><br><span class="line">        <span class="attr">nofityServiceUUID</span>:[],</span><br><span class="line">        <span class="attr">nofityCharacteristicUUID</span>:[],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> services)&#123;</span><br><span class="line">        <span class="keyword">let</span> charchteristic = services[i].<span class="property">characteristics</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> j <span class="keyword">in</span> charchteristic)&#123;</span><br><span class="line">            <span class="comment">//读</span></span><br><span class="line">            <span class="keyword">if</span>(charchteristic[j].<span class="property">isReadable</span>)&#123;</span><br><span class="line">               result.<span class="property">readServiceUUID</span>.<span class="title function_">push</span>(services[i].<span class="property">uuid</span>);</span><br><span class="line">               result.<span class="property">readCharacteristicUUID</span>.<span class="title function_">push</span>(charchteristic[j].<span class="property">uuid</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//写并响应</span></span><br><span class="line">            <span class="keyword">if</span>(charchteristic[j].<span class="property">isWritableWithResponse</span>)&#123;</span><br><span class="line">               result.<span class="property">writeWithResponseServiceUUID</span>.<span class="title function_">push</span>(services[i].<span class="property">uuid</span>);</span><br><span class="line">               result.<span class="property">writeWithResponseCharacteristicUUID</span>.<span class="title function_">push</span>(charchteristic[j].<span class="property">uuid</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//写无响应</span></span><br><span class="line">            <span class="keyword">if</span>(charchteristic[j].<span class="property">isWritableWithoutResponse</span>)&#123;</span><br><span class="line">               result.<span class="property">writeWithoutResponseServiceUUID</span>.<span class="title function_">push</span>(services[i].<span class="property">uuid</span>);</span><br><span class="line">               result.<span class="property">writeWithoutResponseCharacteristicUUID</span>.<span class="title function_">push</span>(charchteristic[j].<span class="property">uuid</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//通知</span></span><br><span class="line">            <span class="keyword">if</span>(charchteristic[j].<span class="property">isNotifiable</span>)&#123;</span><br><span class="line">               result.<span class="property">nofityServiceUUID</span>.<span class="title function_">push</span>(services[i].<span class="property">uuid</span>);</span><br><span class="line">               result.<span class="property">nofityCharacteristicUUID</span>.<span class="title function_">push</span>(charchteristic[j].<span class="property">uuid</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.info(&quot;@getBlePlxUUID&quot;,result);</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [initBleplx 初始化蓝牙]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initBleplx</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//确保全局只有一个BleManager实例，BleModule类保存着蓝牙的连接信息</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable language_">global</span>.<span class="property">BLEPlxMag</span>)&#123;</span><br><span class="line">        <span class="variable language_">global</span>.<span class="property">BLEPlxMag</span> = <span class="keyword">new</span> <span class="title class_">BleManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [blePlxWrite 写数据]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">blePlxWrite</span>(<span class="params">id,value</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;[id]不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> uuidObj = <span class="title function_">getCacheConnectDeviceUUIDById</span>(id);</span><br><span class="line">    <span class="keyword">if</span>(!uuidObj)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取[UUID service Obejct]失败,请重新连接&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!uuidObj.<span class="property">writeWithResponseServiceUUID</span>[<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取[UUID service]失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!uuidObj.<span class="property">writeWithResponseCharacteristicUUID</span>[<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取[UUID characteristic]失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> deviceId = id;</span><br><span class="line">    <span class="keyword">let</span> serviceUUID = uuidObj.<span class="property">writeWithResponseServiceUUID</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> characteristicUUID = uuidObj.<span class="property">writeWithResponseCharacteristicUUID</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> base64Value = value;</span><br><span class="line">    <span class="keyword">let</span> transactionId = <span class="string">&#x27;write&#x27;</span>;</span><br><span class="line">    <span class="comment">// console.log(&quot;@deviceId,serviceUUID,characteristicUUID,base64Value&quot;,deviceId,serviceUUID,characteristicUUID,base64Value,&quot;参数结束&quot;);</span></span><br><span class="line">    <span class="keyword">let</span> pse = <span class="title class_">BLEPlxMag</span>.<span class="title function_">writeCharacteristicWithResponseForDevice</span>(deviceId,serviceUUID,characteristicUUID,base64Value)</span><br><span class="line">    <span class="keyword">return</span> pse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getDeviceIdByTpltypeid 根据模板Id获取指定的打印设备Id]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; deviceList [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; tpltypeid  [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;            [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getDeviceIdByTpltypeid</span>(<span class="params">deviceList,tpltypeid</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!deviceList || !deviceList.<span class="property">length</span>)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;设备列表不存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> findDevice = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> device <span class="keyword">of</span> deviceList)&#123;</span><br><span class="line">        <span class="keyword">if</span>(device.<span class="property">tpltypeid</span> == tpltypeid)&#123;</span><br><span class="line">            findDevice = device;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!findDevice)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;未找到设置的打印设备无法打印&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> findDevice.<span class="property">id</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [bleplxPrintTaskDeal 打印任务处理]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; printArr [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;          [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bleplxPrintTaskDeal</span>(<span class="params">id,printArr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> writePromises = []</span><br><span class="line">    <span class="keyword">let</span> toWrite;</span><br><span class="line">    <span class="keyword">let</span> base64Value;</span><br><span class="line">    <span class="keyword">let</span> packetSize = <span class="number">512</span>;<span class="comment">//分包 此数值根据具体设备进行测试</span></span><br><span class="line">    <span class="keyword">let</span> packetCount;</span><br><span class="line">    <span class="keyword">let</span> packet;</span><br><span class="line">    <span class="keyword">let</span> byteArr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(lodash.<span class="title function_">isArray</span>(printArr))&#123;</span><br><span class="line">        printArr.<span class="title function_">forEach</span>( <span class="function">(<span class="params">item</span>) =&gt;</span>&#123;</span><br><span class="line">            <span class="comment">//执行命令</span></span><br><span class="line">            <span class="keyword">if</span>(item.<span class="property">type</span> == <span class="number">1</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">values</span>);</span><br><span class="line">                base64Value = toWrite.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value));</span><br><span class="line">            <span class="comment">//执行字符串</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span>==<span class="number">2</span>)&#123;</span><br><span class="line">                toWrite = iconv.<span class="title function_">encode</span>(item.<span class="property">values</span>, <span class="string">&#x27;GBK&#x27;</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">//生成二维码</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span>==<span class="number">3</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">byte</span>);</span><br><span class="line">                base64Value = toWrite.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">//打印图片</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span>==<span class="number">4</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">byte</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span> == <span class="number">5</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">byte</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span> == <span class="number">6</span> &amp;&amp; item.<span class="property">byte</span> &amp;&amp; item.<span class="property">byte</span>.<span class="property">length</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">byte</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(lodash.<span class="title function_">isString</span>(printArr))&#123;</span><br><span class="line">        toWrite = iconv.<span class="title function_">encode</span>(item.<span class="property">values</span>, <span class="string">&#x27;GBK&#x27;</span>);</span><br><span class="line">        packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">            packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">            toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">            base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">            writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// console.log(&quot;writePromises&quot;,writePromises)</span></span><br><span class="line">    <span class="keyword">return</span> writePromises;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [ConvertPrintImage description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Promise</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">convertPrintImage</span>(<span class="params">rows</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!rows || !rows.<span class="property">length</span>)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;数据不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> <span class="title class_">BlePlxPrint</span>.<span class="title function_">getSingleConvertData</span>(rows);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    initBleplx,</span><br><span class="line">    updateCacheConnectDevice,</span><br><span class="line">    removeCacheConnectDevice,</span><br><span class="line">    getCacheConnectDeviceById,</span><br><span class="line"></span><br><span class="line">    getCacheConnectDeviceUUIDById,</span><br><span class="line">    removeCacheConnectDeviceUUID,</span><br><span class="line">    updateCacheConnectDeviceUUID,</span><br><span class="line"></span><br><span class="line">    fetchServicesAndCharacteristicsForDevice,</span><br><span class="line">    getBlePlxUUID,</span><br><span class="line">    blePlxWrite,</span><br><span class="line">    bleplxPrintTaskDeal,</span><br><span class="line">    blePlxCommands,</span><br><span class="line">    convertPrintImage,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>blecp.js</code>(简要代码)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Buffer</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;buffer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">&quot;moment&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    initBleplx,</span><br><span class="line">    updateCacheConnectDevice,</span><br><span class="line">    removeCacheConnectDevice,</span><br><span class="line">    getCacheConnectDeviceById,</span><br><span class="line">    getCacheConnectDeviceUUIDById,</span><br><span class="line">    removeCacheConnectDeviceUUID,</span><br><span class="line">    updateCacheConnectDeviceUUID,</span><br><span class="line"></span><br><span class="line">    fetchServicesAndCharacteristicsForDevice,</span><br><span class="line">    getBlePlxUUID,</span><br><span class="line">    bleplxPrintTaskDeal,</span><br><span class="line">    blePlxWrite,</span><br><span class="line">    blePlxCommands,</span><br><span class="line"></span><br><span class="line">    convertPrintImage,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./bleplx.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Blecp</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">scaning</span>:<span class="literal">false</span>, <span class="comment">//是否扫描附近蓝牙</span></span><br><span class="line">            <span class="attr">isConnecting</span>:<span class="literal">false</span>,<span class="comment">//是否连接设备中</span></span><br><span class="line">            <span class="attr">writing</span>:<span class="literal">false</span>, <span class="comment">//正在写数据</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deviceMap</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        <span class="title function_">initBleplx</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">componentWillMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 监听蓝牙开关</span></span><br><span class="line">        <span class="title class_">BLEPlxMag</span>.<span class="title function_">onStateChange</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(state == <span class="string">&#x27;PoweredOn&#x27;</span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">scan</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描设备 记得检查权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    scan = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">scaning</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">deviceMap</span>.<span class="title function_">clear</span>();</span><br><span class="line">            <span class="title class_">BLEPlxMag</span>.<span class="title function_">startDeviceScan</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="function">(<span class="params">error, device</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(error.<span class="property">errorCode</span> == <span class="number">102</span>)&#123;</span><br><span class="line">                        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;请打开手机蓝牙后再搜索&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">// console.log(device.id,device.name);</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">deviceMap</span>.<span class="title function_">set</span>(device.<span class="property">id</span>,device); <span class="comment">//使用Map类型保存搜索到的蓝牙设备，确保列表不显示重复的设备</span></span><br><span class="line">                    <span class="keyword">let</span> arr = [...<span class="variable language_">this</span>.<span class="property">deviceMap</span>.<span class="title function_">values</span>()];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">scanTimer</span> &amp;&amp; <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">scanTimer</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">scanTimer</span> = <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">scaning</span>)&#123;</span><br><span class="line">                   <span class="title class_">BLEPlxMag</span>.<span class="title function_">stopDeviceScan</span>();</span><br><span class="line">                   <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">6000</span>)  <span class="comment">//6秒后停止搜索</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title class_">BLEPlxMag</span>.<span class="title function_">stopDeviceScan</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开始连接设备</span></span><br><span class="line">    connect = <span class="function">(<span class="params">item,index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">scaning</span>)&#123;  <span class="comment">//连接的时候正在扫描，先停止扫描</span></span><br><span class="line">            <span class="title class_">BLEPlxMag</span>.<span class="title function_">stopDeviceScan</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isConnecting</span>)&#123;</span><br><span class="line">            <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;正在连接中...&quot;</span>);</span><br><span class="line">            <span class="comment">// console.log(&#x27;当前蓝牙正在连接时不能打开另一个连接进程&#x27;);</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(item.<span class="property">isConnecting</span>)&#123;</span><br><span class="line">            <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;该蓝牙正在连接中...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">isConnecting</span>:<span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title class_">BLEPlxMag</span>.<span class="title function_">connectToDevice</span>(item.<span class="property">id</span>)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">device</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="comment">//发现所需要的服务和特点是只执行一次。 另外 它可以是一个漫长的过程取决于数量的特点和可用的服务。</span></span><br><span class="line">                <span class="keyword">return</span> device.<span class="title function_">discoverAllServicesAndCharacteristics</span>();</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">then</span>( <span class="title function_">async</span>(device) =&gt; &#123;</span><br><span class="line">                <span class="title function_">updateCacheConnectDevice</span>(device);</span><br><span class="line">                <span class="keyword">let</span> objUUID = <span class="keyword">await</span> <span class="title function_">getBlePlxUUID</span>(item.<span class="property">id</span>);</span><br><span class="line">                <span class="keyword">if</span>(objUUID &amp;&amp; device.<span class="property">id</span>)&#123;</span><br><span class="line">                    <span class="title function_">updateCacheConnectDevice</span>(device);</span><br><span class="line">                    <span class="title function_">updateCacheConnectDeviceUUID</span>(device.<span class="property">id</span>,objUUID);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                        <span class="attr">isConnecting</span>:<span class="literal">false</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                    item.<span class="property">isConnected</span> = <span class="literal">true</span>;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">onDisconnect</span>(item);</span><br><span class="line">                    <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;设备连接成功&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                        <span class="attr">isConnecting</span>:<span class="literal">false</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    item.<span class="property">isConnected</span> = <span class="literal">false</span>;</span><br><span class="line">                    <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;设备连接失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">isConnecting</span>:<span class="literal">false</span>&#125;)</span><br><span class="line">                <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;设备连接失败&quot;</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听蓝牙断开</span></span><br><span class="line">    onDisconnect = <span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;btconnectStore&#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">        <span class="title class_">BLEPlxMag</span>.<span class="title function_">onDeviceDisconnected</span>(item.<span class="property">id</span>,<span class="function">(<span class="params">error,device</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(error)&#123;</span><br><span class="line">                <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;蓝牙遇到错误自动断开&quot;</span>);</span><br><span class="line">                <span class="comment">//蓝牙遇到错误自动断开</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;蓝牙已断开&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(device)&#123;</span><br><span class="line">                <span class="title function_">removeCacheConnectDevice</span>(device);</span><br><span class="line">                <span class="title function_">removeCacheConnectDeviceUUID</span>(item.<span class="property">id</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//断开蓝牙设备</span></span><br><span class="line">    _disconnect = <span class="function">(<span class="params">item,index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">BLEPlxMag</span>.<span class="title function_">cancelDeviceConnection</span>(item.<span class="property">id</span>).<span class="title function_">then</span>(<span class="function"><span class="params">device</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="comment">// console.log(&#x27;disconnect success&#x27;,device);</span></span><br><span class="line">           <span class="title function_">removeCacheConnectDevice</span>(device);</span><br><span class="line">           <span class="title function_">removeCacheConnectDeviceUUID</span>(item.<span class="property">id</span>);</span><br><span class="line">           <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;断开连接设备成功&quot;</span>);</span><br><span class="line">       &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;断开连接异常&quot;</span>);</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入数据</span></span><br><span class="line">    _write = <span class="function">(<span class="params">item,index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">writing</span>)&#123;</span><br><span class="line">            <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;正在写数据中，请稍后再操作...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">writing</span>:<span class="literal">true</span></span><br><span class="line">        &#125;,<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> printArr = [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">initClear</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">2</span>,</span><br><span class="line">                    <span class="attr">values</span>:<span class="string">`静女其姝，俟我于城隅。爱而不见，搔首踟蹰。静女其娈，贻我彤管。彤管有炜，说怿女美。自牧归荑，洵美且异...`</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">//打印二维码</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">imgBefore</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">3</span>,</span><br><span class="line">                    <span class="attr">values</span>:&#123;</span><br><span class="line">                        <span class="attr">content</span>:<span class="string">&quot;我是二维码&quot;</span>,</span><br><span class="line">                        <span class="attr">size</span>:<span class="number">280</span>,</span><br><span class="line">                        <span class="attr">logo</span>:<span class="string">&quot;&quot;</span><span class="comment">//可选</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">initClear</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">imgBefore</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">4</span>,</span><br><span class="line">                    <span class="attr">values</span>:&#123;</span><br><span class="line">                        <span class="attr">base64Str</span>:<span class="string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJUAAACACAYAAAACuStnAAAQGElEQVR4Xu1de5QcVZn/fVU9M0nIzHT1giDCkky6mlUWFYHFx1EDuonIKkd5qFFmCQEzUz3JIZHIIq/wFNlg1EzXJJDwyAH2nCAicJBVUBf1nM3ReHRxF3a7esIrG0ggXT15kHl017enOpnZSTIzfav7Vk9P+taf09/3u9/3q99U3773q+8SxrqYKdqT+QIx5hPhHAbPJlBsTFv1x3pjYCczPeiRt67PSmwdK3k6/I/Gmt7TSS+sB+jv6o0tla84AwwwMT+xX+Ol+ztP/d/RnoeIyuju/Txp3uMAponDK8u6ZoCxg0mf51ptLw7zMCKq1pRzsUbYRMART6+6Jk0lX5oB5u2DmnbG3s74Tt+4KKBoj3MGMf5AgF4aQVkoBo5kgBlPu0nziyOiMlLOs0T4nCJLMVAJAx7hI7lO8080Y83rJ07TBw6ZaFUCrHzrmAHGhmzSvJIM20kS0F3HVKjUZTHA2JFNmidQLOWsB2GRLFyFU98MZPV4I8Vs518BzK9vKlT2shjINhVayEilXyCiT8kCVTj1zQDrWlSJqr41ID17JSrplCpAJSqlAekMKFFJp1QBKlEpDUhnQIlKOqUKUIlKaUA6A0pU0ilVgEpUSgPSGVCikk6pAlSiUhqQzoASlXRKFaASldKAdAaUqKRTqgCVqJQGpDOgRCWdUgUYuqiY+c9E5IBpOwMDAL8P4FNA9DH1OtjRKcCQRMVvMqibKfJornP2q2NR12q/ZugYvIgZS4lw+tFJb31mJVtU/Qxc4+rxe7GYhkQpjdrOFzXGvSAcL+qj7GqXAYmi4jc9ogv8FwnLSbfVTrfpwG8Ael85/sqndhiQJap380wf2p2MZypJLdq99RTS8lsIdGwlOMp3chmQIyoPX8l2mZtkpNK6tvcsveD9BoTpMvAURvUZqFxUzE9kk4kvyww9ZjvLAdwjE1NhVY+BikTF4CHoetxdPOd1qSGv4wYjn3mJCHGpuAqsKgxUJCoAj2Ut89IwIo32pJdqTD8MA1thhstARaJi5gVuMvEvYYQ4Y92r751WGNoeBrbCDJeBikQ10KCfsO+qth1hhRiznTQAMyx8hRsOA2WLipnzbjLREE5YB1CNlPMrIpwb5hgKWz4DZYsKjG3ZpHmy/JD+H9FIpR8loq+FOYbCls9A2aJi8DuulThOfkijRGU7TxJQ7CGprqnDQAWiArudcR1EHFa6sVT69yA6Oyz8auEy8AYxdoBwVrXGnMxxyhaVH3Sh0NDWt2TWK6EksIl1453MLgJaQ8GvHqjTX2ia++6uk9+KHucs0YA7QHRM9Yav/kgViYrBna6VWBtG2NEeZ67G+HUY2NXCZPCLeW/GeXu6Tto1PGbsR85JHOG1BLqgWnFUe5yKRAXm57LJxLwwgjbsTA+BO8LArhLmH5HHedml5u6xxmvtSV+kM9YA9N4qxVO1YSoTFYDhvtkyIz5YreAQKNQlC5kxj8Zi8G/dmS3no/2EfRONEfuR08IR3AWg42g6ZaNiUQHYnO2Mf1zmhN1IpZ8hos+HddPDxGXgWTePL2GpOSA6Tsx2Pgrm+0H0flGfWraTISoweJVrJVbISNRIORYRUjKwJgHjsezO+AKspHzgsf1N9EJmBRg3EaEpsH8NOUgRlZ+PjEl7tDv9KdLw/JT82mPcn7XiV1b6xPYrYDWm9VN5J0GaqIrCYlriJuNlnRwRtdMLiXEvEUVq6J9ONJQfZC1zmaixiF3UzvwjgVcTYIjY15KNVFEVE2N+sOA13iq6ftXa3fsZjbzrp/B/5q1Zy7w5jJvavO5/jo3ktXuI0B4GfliY8kVV1BU8AE+D8GPK46lDflZ//43pRtPgmYB3AQiXEDAnrOTCxvWAZTnL/IHIOMUyaa9wYdZK3ChiP9ommsqcS+StJ1BbUN/JsA9FVKMTKR6JCrzNzNsB8s8SPI0I2mQkK2tMPycmXJnrNO8XwTz46+75gyvpDoD2rGVuFvEdsXnglWnG/vyNYP52rU8RQhdVIOKmgLFf8kNEC7KW+ZhIuP7Xu06e/9Q+5EUOZl7nTvNWYNHf7BHBGbaZmUq/vxG0sZb3EZWoAtxRZgyA6EuuFX9WxM2wM+cT+Gfj2jJv9zStK9cZf0IEb8SGmYy1mQ5i/h5AzYF8q2CsRCVKMmM/kz7ftdp+K+ISs51LAAi9tsbgZwb0xqveXTzrTRHsYZsDJdeD/lbPRUH8wrZVohJhmLEbhPmi86Boj3OFxtggAj1sw0AfmK91k4l1Qfx8W8PuvYDYWwvCSUF9w7CvKVEx4z4CzwLR34eRbDmYzLwLFDnPtdpeFPE3epxOYtgituPYbM5rWvvujjn+hF78Su2cGcPu25l46WTvI9aEqJjxGki/zP9q8TdZofPmmtgHY96e1/W5ojfYSGWuJ+LbxZUwvqXHfFMumbgtKJa/dKF53gME/G1QX1n2kyoqfz2LQGuyA03XYfnJ+4eTOlhz9KfJ7KnAzK8gos8VfVE2ZjurAVwt68YUcZhfLuh6e1/HnC2BcDexHnu7dxnAt05G+4DJFJVT0LQF4xE2yT0VXhokOndvZ3ynyM00bMcmoFPEthwbZnS7zc3/VKqU5nBsv4RIo4LfoimUmrfxcqm6qPx1HoBWuccN3oxLTxuciGSjJ/0PYHqqmnMEv1qTBxo+nVs2OyciACPlPEyEr4vYVmTD2MakdbjWnGeC4hg9ma8Ss/+293uC+pZjX1VRMfCfKGgL3CVz/iIarGGnVxDoblH7Cu02I4/541VrHo4dsx1/ycBfOqjaxYxNQxotEX2KDgfmdy4kDN6tAVeGHWxVRMXgQQZuyx1rfheXUiFoUjHb8bdDFgb1C2TP/MvswPQvjJ7bTfgUtZ2fEXB+oDEkGTPgMuEa0W2i0cMa9tZPEgr+ckdob36HLyrGlryuLRD9BTUm7wferPklAZ+WdF8OgWHGk24kfolQS8nvvzE91rT/aRB9JoxYgmD6ZcsecHmfldgaxA+b/qsxtqvxOmb+DoEaA/kKGIcnKsZ+EG7IdsZXV1q45ucR1lIDMx5x3463YyX5lRUTXsUYIvg5gI+Wsq3i5/3MuMVNmn6te6CrZW2vqXuFDQT6ZCDHEsZhiWqz5+lfzXW1vSYzWOlLDQGqNaOrX4lS09ALBPqgzJxkYTHjLwxuzyUTfw6EyUyxnswiBlbJesdSsqh4DxNd63bE1wZ9OvkdinOW+VQpQiQuNQhXa87sybynwWO/WchppeKb7M89xj25gWk3is4Nh+M95r6txzcO5lfL6F0hTVTM+DUV0J5dam4LQuyMNa+f2KQPrPcnvaIvUFS61MBMN7jJ+B0icRbj0/p/R0SzRexrwcbfofCAb/YlzV8Ejac15czT4Jd145SgvsP2FYuq+EsEtCxnxR8KGkQslbkK4FUgtAz7euArclbigVJY5Sw1+MV1ICTdTrOnFL7/eeuaV2dr+tC/EfDXIva1ZuPPF/MR7+o9i099J1Bs67bPMAp7VwK0vJxTOSoSlV+yMUTaFUHXTGKpzMlMvJGAuWMl6wFzc5b5Qikigiw1HCxxbneT5iOlcP3P/UlsxPN+V60FQ5GYyrHxN8QZ2vJcMr4xqL+xpvd0aIWNRPThIL7lisrfvugSrX4cHZCRynQRvLsmbFLB2J3XtbNKLkMILjX4q/jMdHGuy3xShBzD3vpBcP5XRPRXIvZTwcafnjDrCwP/eFrJWvR4p0vzcKdoY5HAomLgYQ+NS/usU9wgZLakMnGd+EECPiHix+BXPTR9pNQ4pZYaglZrHqgnx89HfyWLxDtFbN4F083ZZHxV0HiDNBYJICp+s8B0eTmTv1gq8y2Abwu6Y86Mf3eT5sdLETDuUgPzPqbI+aLVmsXVZi74gjqqDwbwTzaDp7cH2S4bvgcijUWEROUXz7nTCt8KWqTfbG89tYHzD4HonFLCGO9zBh51LbPkhu3hSw3MyHlEn+2z4n8UGbtkPbkIyBSzYaa73YGmlUGXH4qNRXR8F4TOsTb7JxTV6OK5oHwZtvMd8ht8Sbg88I05K1Gy+G3UUsPb0HButsN8SWT4aLdzoabhpyK2R5uNf48ZtDCXjAfuBTZeY5ExRTVe8ZwIobFu5zTW+BECfUjEXtSmQHxxX2fi8VL2MTvzzUIh8pzoG9JGyvk6ER4uhXvUf+6/WU5Ny0vNYY/g4UBjkWvAuHm4schYopqweG4icmO2cwuAm8K6AQVNOztwFeQEwZTzgkJYudUI7k5mvrqcAxdGNxYZERUAv8fUP7vHDq4sVTx3OAGtduZMjfmhsLcx/I7IlKczgq7aj3XDorZztQb4JcDqOpwBxi9QwKJyeI72OJfljmn+CRm2042Ctq6cXwOG7dxFwLVVuzPML2ebW84OWlo7Or5YKnMriAP3NKhajrUwEPNeD7ghl0yUdT4QlZNDS3f6nIiGhwA6tRz/inwq6DUadj15RXnVojNjyyC4fW8y8XKQ8IKJqlik1n8HCFL7MQUJ2LdloMe1TCuIXyzlbADhiiA+yvYAAwzc6Vrm9aJ8CIvK6Ml8Auw9TKBZouBh2gVpsjYZ9eRh5j4Z2AzeCkQuF1lMLi2qjW8dY+zZczcRAj0ZqpF4QeN5fR2J5yYay0g5PyXChdWIpx7G8BfDEdFWuIvn9I2X74SiarV7P6vBu5+AUA83KvtmMO8bBM4e7zs/lkr7faEmvZ687Pxq1ZHxVgFY0pc0fzxWiGOLasN/N8f69dUgLKrVvEbiYmwbinhnHFI35D9d9+5+Vnb9dc1zUeUAx+tYc4Soivtg7K0H0YlVjrH84RhbskmzeDiSX0+uNeWfB3Bm+YDKU5gBxm4GrnOT5khjkhFRtax/I6YP9v+QgG8IA9aUIT8+pHNHQ0HzC/w+UFOh1UcwIx1riqKKpnq/rJHnl9lW5dXosDj2qxOIEA0LX+GWZiA7s3kmhdKxpPTYyuJoZSCPVn+bxi/uD+Xt36OVN5XXBAwoUSl5SGdAiUo6pQpQiUppQDoDSlTSKVWASlRKA9IZUKKSTqkCVKJSGpDOgBKVdEoVoBKV0oB0BpSopFOqAJWolAakM6BEJZ1SBahEpTQgnQElKumUKkAlKqUB6QwoUUmnVAEqUSkNSGdAiUo6pQpQiUppQDoDSlTSKVWASlRKA9IZUKKSTqkCVKJSGpDOgBKVdEoVoBKV0oB0BpSopFOqAJWolAakM+CLKpZy/EN+5kkHV4B1yUCx64thO/6BjpfVJQMqaekMZC2TfFFdR8Cd0tEVYN0xwOD/cK3Eh+ng0a7pumNAJSydgeFDz4ud9NS8Sjq/9QjYP9Cgz9p3VduOoqiKhzB63h/qkQmVsywG+PaslSie+TPSSFbmwY+ywlQ4U4UB/n3WSoycQHtIy2sj5awhQtdUSUXFWQMMMLYM8fTP7ek6addwNEf2UU+lFxPoFhCOr4GQVQi1y0A/g+9zpzd8Gwtn948Oc9xjRAzb+QYYFhE+Vrt5qciqzgBjGwOpfMRbf8gpG6MC+T9XMACZS/5RSwAAAABJRU5ErkJggg==&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">nextOneLinePaper</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">cutHalfPaper</span></span><br><span class="line">                &#125;</span><br><span class="line">            ];</span><br><span class="line">            <span class="title function_">convertPrintImage</span>(printArr).<span class="title function_">then</span>(<span class="function">(<span class="params">rows</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> writePromises = <span class="title function_">bleplxPrintTaskDeal</span>(item.<span class="property">id</span>,rows);</span><br><span class="line">                <span class="title class_">Promise</span>.<span class="title function_">all</span>(writePromises).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">writing</span>:<span class="literal">false</span>&#125;)</span><br><span class="line">                    <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;打印完成&quot;</span>)</span><br><span class="line">                &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">writing</span>:<span class="literal">false</span>&#125;)</span><br><span class="line">                    <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;打印任务失败&quot;</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Android部分代码"><a href="#Android部分代码" class="headerlink" title="Android部分代码"></a><code>Android</code>部分代码</h3><p>对打印图片的数据进行处理</p><p>Android原生代码<code>BlePlxPrint.java</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xx.yy.print;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.Arguments;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.Promise;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReactApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReactContext;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReactContextBaseJavaModule;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReactMethod;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReadableArray;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReadableMap;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReadableType;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.WritableArray;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.WritableMap;</span><br><span class="line"><span class="keyword">import</span> com.xx.yy.utils.BaseUtil;</span><br><span class="line"><span class="keyword">import</span> com.xx.yy.utils.PictureUtils;</span><br><span class="line"><span class="keyword">import</span> com.xx.yy.utils.QRCodeUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/11/19.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlePlxPrint</span> <span class="keyword">extends</span> <span class="title class_">ReactContextBaseJavaModule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ReactContext reactContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlePlxPrint</span><span class="params">(ReactApplicationContext reactContext)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(reactContext);</span><br><span class="line">        <span class="built_in">this</span>.reactContext = reactContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * return string 这个名字在JavaScript端标记这个模块</span></span><br><span class="line"><span class="comment">     * 这样就可以在JavaScript中通过React.NativeModules.ToastForAndroid访问到这个模块</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;BlePlxPrint&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canOverrideExistingModule</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回打印图片的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type=3=qrcode type=4=img type=5=barcode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> WritableArray <span class="title function_">ConvertPrintToImage</span><span class="params">(<span class="type">int</span> type ,ReadableMap map)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] imgByte = &#123;&#125;;</span><br><span class="line">        <span class="type">WritableArray</span> <span class="variable">jsArr</span> <span class="operator">=</span> Arguments.createArray();</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (type)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    <span class="type">String</span> <span class="variable">qrCodeContent</span> <span class="operator">=</span> map.getString(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">qrCodeSize</span> <span class="operator">=</span> map.getInt(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span>( map.hasKey(<span class="string">&quot;logo&quot;</span>) &amp;&amp; !TextUtils.isEmpty(map.getString(<span class="string">&quot;logo&quot;</span>)))&#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">logo</span> <span class="operator">=</span> map.getString(<span class="string">&quot;logo&quot;</span>);</span><br><span class="line">                        <span class="type">Bitmap</span> <span class="variable">bitmapLogo</span> <span class="operator">=</span> PictureUtils.base64StringToBitmap(logo);</span><br><span class="line">                        bitmap = QRCodeUtil.createQRCodeBitmap(qrCodeContent,qrCodeSize,bitmapLogo,<span class="number">0.2f</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        bitmap = QRCodeUtil.createQRCodeBitmap(qrCodeContent,qrCodeSize);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    <span class="type">String</span> <span class="variable">base64Str</span> <span class="operator">=</span> map.getString(<span class="string">&quot;base64Str&quot;</span>);</span><br><span class="line">                    bitmap = PictureUtils.base64StringToBitmap(base64Str);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    <span class="type">String</span> <span class="variable">barCodeContent</span> <span class="operator">=</span> map.getString(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">barCodeWidth</span> <span class="operator">=</span> map.getInt(<span class="string">&quot;width&quot;</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">barCodeHeight</span> <span class="operator">=</span> map.getInt(<span class="string">&quot;height&quot;</span>);</span><br><span class="line">                    bitmap = QRCodeUtil.createBarCodeBitmap(barCodeContent,barCodeWidth,barCodeHeight);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    <span class="type">String</span> <span class="variable">base64Value</span> <span class="operator">=</span> map.getString(<span class="string">&quot;base64Str&quot;</span>);</span><br><span class="line">                    imgByte = Base64.decode(base64Value, Base64.DEFAULT);</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(bitmap != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//拼接字节数组</span></span><br><span class="line">                <span class="type">byte</span>[] draw2PxPoint = PictureUtils.draw2PxPoint(bitmap);</span><br><span class="line">                imgByte = BaseUtil.byteMergerAll(draw2PxPoint);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;i&lt;imgByte.length;i++)&#123;</span><br><span class="line">                    jsArr.pushInt(imgByte[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(type == <span class="number">6</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;i&lt;imgByte.length;i++)&#123;</span><br><span class="line">                    jsArr.pushInt(imgByte[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsArr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换打印数据处理其中的图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rows</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> WritableArray <span class="title function_">getConvertData</span><span class="params">(ReadableArray rows)</span>&#123;</span><br><span class="line">        <span class="type">WritableArray</span> <span class="variable">writeArray</span> <span class="operator">=</span>  Arguments.createArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;rows.size() ;i++)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">ReadableMap</span> <span class="variable">readMap</span> <span class="operator">=</span> rows.getMap(i);</span><br><span class="line">            <span class="type">Bundle</span> <span class="variable">bundle</span> <span class="operator">=</span> Arguments.toBundle(readMap);</span><br><span class="line">            <span class="type">WritableMap</span> <span class="variable">writeMap</span> <span class="operator">=</span> Arguments.fromBundle(bundle);</span><br><span class="line">            <span class="type">WritableArray</span> <span class="variable">jsArr</span> <span class="operator">=</span> Arguments.createArray();</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">type</span> <span class="operator">=</span> readMap.getInt(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">            <span class="type">ReadableType</span> <span class="variable">valuesType</span> <span class="operator">=</span> readMap.getType(<span class="string">&quot;values&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (valuesType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Null:</span><br><span class="line">                <span class="keyword">case</span> Boolean:</span><br><span class="line">                <span class="keyword">case</span> String:</span><br><span class="line">                <span class="keyword">case</span> Array:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> Map:</span><br><span class="line">                    <span class="type">ReadableMap</span> <span class="variable">values</span> <span class="operator">=</span> readMap.getMap(<span class="string">&quot;values&quot;</span>);</span><br><span class="line">                    jsArr = ConvertPrintToImage(type,values);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Could not convert object in Map.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            writeMap.putArray(<span class="string">&quot;byte&quot;</span>,jsArr);</span><br><span class="line">            writeArray.pushMap(writeMap);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> writeArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回打印图片的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type=3=qrcode type=4=img type=barcode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> promise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ReactMethod</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPrintImageByte</span><span class="params">(<span class="type">int</span> type, ReadableMap map, Promise promise)</span>&#123;</span><br><span class="line">        <span class="type">WritableArray</span> <span class="variable">jsArr</span> <span class="operator">=</span> ConvertPrintToImage(type,map);</span><br><span class="line">        promise.resolve(jsArr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换数据到新字段，并加入新字段</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rows</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> promise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ReactMethod</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSingleConvertData</span><span class="params">(ReadableArray rows,Promise promise)</span>&#123;</span><br><span class="line">        <span class="type">WritableArray</span> <span class="variable">writeArray</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(rows != <span class="literal">null</span>)&#123;</span><br><span class="line">            writeArray = getConvertData(rows);</span><br><span class="line">        &#125;</span><br><span class="line">        promise.resolve(writeArray);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>图片工具:</p><p><code>PictureUtils.java:</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xx.yy.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/11/7.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PictureUtils</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把一张Bitmap图片转化为打印机可以打印的bit</span></span><br><span class="line"><span class="comment">     * 效率很高（相对于下面）</span></span><br><span class="line"><span class="comment">     * 传进去</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] draw2PxPoint(Bitmap bit) &#123;</span><br><span class="line">        <span class="type">int</span> nL;</span><br><span class="line">        <span class="type">int</span> nH;</span><br><span class="line">        <span class="type">int</span> yRow;</span><br><span class="line">        <span class="type">int</span> byteSum;<span class="comment">//总字节数</span></span><br><span class="line"></span><br><span class="line">        yRow = (<span class="type">int</span>) Math.ceil(bit.getHeight()/<span class="number">24</span>);</span><br><span class="line">        byteSum = yRow*<span class="number">3</span>*bit.getWidth() + <span class="number">5</span>*yRow+yRow;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 分辨率大于256时</span></span><br><span class="line"><span class="comment">         * n1=分辨率/256取余（n1%256）</span></span><br><span class="line"><span class="comment">         * n2=除得的整数</span></span><br><span class="line"><span class="comment">         * 分辨率小于256时</span></span><br><span class="line"><span class="comment">         * n1=自身</span></span><br><span class="line"><span class="comment">         * n2=0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span>(bit.getWidth()&lt;<span class="number">256</span>)&#123;</span><br><span class="line">            nL = bit.getWidth();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nL = bit.getWidth()%<span class="number">256</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(bit.getHeight()&lt;<span class="number">256</span>)&#123;</span><br><span class="line">            nH = <span class="number">0x00</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nH = (<span class="type">int</span>) Math.floor(bit.getHeight()/<span class="number">256</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[byteSum];</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//对于每一行，逐列打印</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; yRow; j++) &#123;</span><br><span class="line">            <span class="comment">//选择位图模式</span></span><br><span class="line">            data[k++] = <span class="number">0x1B</span>;</span><br><span class="line">            data[k++] = <span class="number">0x2A</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *  m=33时，选择24点双密度打印，分辨率达到200DPI。</span></span><br><span class="line"><span class="comment">             *  如果m的值超出了指定的范围，那么nL和之后的数据被当作常规数据处理。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            data[k++] = <span class="number">33</span>; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 位图的点数由 nL和 nH指定</span></span><br><span class="line"><span class="comment">             * nL和 nH表示水平方向上位图中的点数。通过nL+ nH´ 256计算出点数。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            data[k++] = (<span class="type">byte</span>) nL;</span><br><span class="line">            data[k++] = (<span class="type">byte</span>) nH;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * d表示位图数据。设置相应的位为 1去打印某点，或设置为 0以不打印某点。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bit.getWidth(); i++) &#123;</span><br><span class="line">                <span class="comment">//每一列24个像素点，分为3个字节存储</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> <span class="number">0</span>; m &lt; <span class="number">3</span>; m++) &#123;</span><br><span class="line">                    <span class="comment">//每个字节表示8个像素点，0表示白色，1表示黑色</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>; n &lt; <span class="number">8</span>; n++) &#123;</span><br><span class="line">                        <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> px2Byte(i, j * <span class="number">24</span> + m * <span class="number">8</span> + n, bit);</span><br><span class="line">                        data[k] += data[k] + b;</span><br><span class="line">                    &#125;</span><br><span class="line">                    k++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//换行</span></span><br><span class="line">            data[k++] = <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片二值化，黑色是1，白色是0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x  横坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> y     纵坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bit 位图</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span> <span class="title function_">px2Byte</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, Bitmap bit)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> b;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pixel</span> <span class="operator">=</span> bit.getPixel(x, y);</span><br><span class="line">        <span class="type">int</span> <span class="variable">red</span> <span class="operator">=</span> (pixel &amp; <span class="number">0x00ff0000</span>) &gt;&gt; <span class="number">16</span>; <span class="comment">// 取高两位</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">green</span> <span class="operator">=</span> (pixel &amp; <span class="number">0x0000ff00</span>) &gt;&gt; <span class="number">8</span>; <span class="comment">// 取中两位</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">blue</span> <span class="operator">=</span> pixel &amp; <span class="number">0x000000ff</span>; <span class="comment">// 取低两位</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">gray</span> <span class="operator">=</span> RGB2Gray(red, green, blue);</span><br><span class="line">        <span class="keyword">if</span> ( gray &lt; <span class="number">128</span> )&#123;</span><br><span class="line">            b = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            b = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片灰度的转化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> g</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> b</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">RGB2Gray</span><span class="params">(<span class="type">int</span> r, <span class="type">int</span> g, <span class="type">int</span> b)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">gray</span> <span class="operator">=</span> (<span class="type">int</span>) (<span class="number">0.29900</span> * r + <span class="number">0.58700</span> * g + <span class="number">0.11400</span> * b);  <span class="comment">//灰度转化公式</span></span><br><span class="line">        <span class="keyword">return</span>  gray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base64字符串转位图</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> base64String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">base64StringToBitmap</span><span class="params">(String base64String)</span> &#123;</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Value</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] strArr =base64String.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(strArr.length==<span class="number">1</span>)&#123;</span><br><span class="line">                base64Value = strArr[<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(strArr.length==<span class="number">2</span>)&#123;</span><br><span class="line">                base64Value = strArr[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span>[] bitmapArray = Base64.decode(base64Value, Base64.DEFAULT);</span><br><span class="line">            bitmap = BitmapFactory.decodeByteArray(bitmapArray, <span class="number">0</span>, bitmapArray.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回base64字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bitmap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">bitmaptoBase64String</span><span class="params">(Bitmap bitmap)</span> &#123;</span><br><span class="line">        <span class="comment">//将Bitmap转换成字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        bitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, bStream);</span><br><span class="line">        <span class="type">byte</span>[] bytes = bStream.toByteArray();</span><br><span class="line">        string = Base64.encodeToString(bytes, Base64.DEFAULT);</span><br><span class="line">        <span class="keyword">return</span> string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成二维码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xx.yy.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.ColorInt;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.zxing.BarcodeFormat;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.EncodeHintType;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.MultiFormatWriter;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.WriterException;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.common.BitMatrix;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.qrcode.QRCodeWriter;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: QRCodeUtil</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 二维码工具类</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/11/7.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QRCodeUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建条形码位图</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> width</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> height</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createBarCodeBitmap</span><span class="params">(<span class="meta">@Nullable</span> String content, <span class="type">int</span> width, <span class="type">int</span> height)</span>&#123;</span><br><span class="line">        <span class="comment">//配置参数</span></span><br><span class="line">        Map&lt;EncodeHintType,Object&gt; hints = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 容错级别 这里选择最高H级别</span></span><br><span class="line">        hints.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.H);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiFormatWriter</span>().encode(content,BarcodeFormat.CODE_128, width, height, hints);</span><br><span class="line">            <span class="comment">/** 1.根据BitMatrix(位矩阵)对象为数组元素赋颜色值 */</span></span><br><span class="line">            <span class="type">int</span>[] pixels = <span class="keyword">new</span> <span class="title class_">int</span>[width * height];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; height; y++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; width; x++)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(bitMatrix.get(x, y))&#123; <span class="comment">// 黑色色块像素设置</span></span><br><span class="line">                        pixels[y * width + x] = Color.BLACK;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 白色色块像素设置</span></span><br><span class="line">                        pixels[y * width + x] = Color.WHITE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 4.创建Bitmap对象,根据像素数组设置Bitmap每个像素点的颜色值,之后返回Bitmap对象 */</span></span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</span><br><span class="line">            bitmap.setPixels(pixels, <span class="number">0</span>, width, <span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bitmap;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(<span class="meta">@Nullable</span> String content, <span class="type">int</span> size)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createQRCodeBitmap(content, size, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;4&quot;</span>, Color.BLACK, Color.WHITE, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0F</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图 (自定义黑、白色块颜色)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color_black 黑色色块的自定义颜色值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color_white 白色色块的自定义颜色值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(<span class="meta">@Nullable</span> String content, <span class="type">int</span> size, <span class="meta">@ColorInt</span> <span class="type">int</span> color_black, <span class="meta">@ColorInt</span> <span class="type">int</span> color_white)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createQRCodeBitmap(content, size, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;4&quot;</span>, color_black, color_white, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0F</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图 (带Logo小图片)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoBitmap logo图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoPercent logo小图片在二维码图片中的占比大小,范围[0F,1F]。超出范围-&gt;默认使用0.2F</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(String content, <span class="type">int</span> size, <span class="meta">@Nullable</span> Bitmap logoBitmap, <span class="type">float</span> logoPercent)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createQRCodeBitmap(content, size, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;4&quot;</span>, Color.BLACK, Color.WHITE, <span class="literal">null</span>, logoBitmap, logoPercent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图 (Bitmap颜色代替黑色) 注意!!!注意!!!注意!!! 选用的Bitmap图片一定不能有白色色块,否则会识别不出来!!!</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetBitmap 目标图片 (如果targetBitmap != null, 黑色色块将会被该图片像素色值替代)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(String content, <span class="type">int</span> size, Bitmap targetBitmap)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createQRCodeBitmap(content, size, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;4&quot;</span>, Color.BLACK, Color.WHITE, targetBitmap, <span class="literal">null</span>, <span class="number">0F</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图 (支持自定义配置和自定义样式)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> character_set 字符集/字符转码格式 (支持格式:&#123;<span class="doctag">@link</span> CharacterSetECI &#125;)。传null时,zxing源码默认使用 &quot;ISO-8859-1&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> error_correction 容错级别 (支持级别:&#123;<span class="doctag">@link</span> ErrorCorrectionLevel &#125;)。传null时,zxing源码默认使用 &quot;L&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> margin 空白边距 (可修改,要求:整型且&gt;=0), 传null时,zxing源码默认使用&quot;4&quot;。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color_black 黑色色块的自定义颜色值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color_white 白色色块的自定义颜色值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetBitmap 目标图片 (如果targetBitmap != null, 黑色色块将会被该图片像素色值替代)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoBitmap logo小图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoPercent logo小图片在二维码图片中的占比大小,范围[0F,1F],超出范围-&gt;默认使用0.2F。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(<span class="meta">@Nullable</span> String content, <span class="type">int</span> size,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@Nullable</span> String character_set, <span class="meta">@Nullable</span> String error_correction, <span class="meta">@Nullable</span> String margin,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@ColorInt</span> <span class="type">int</span> color_black, <span class="meta">@ColorInt</span> <span class="type">int</span> color_white, <span class="meta">@Nullable</span> Bitmap targetBitmap,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@Nullable</span> Bitmap logoBitmap, <span class="type">float</span> logoPercent)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 1.参数合法性判断 */</span></span><br><span class="line">        <span class="keyword">if</span>(TextUtils.isEmpty(content))&#123; <span class="comment">// 字符串内容判空</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(size &lt;= <span class="number">0</span>)&#123; <span class="comment">// 宽&amp;高都需要&gt;0</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/** 2.设置二维码相关配置,生成BitMatrix(位矩阵)对象 */</span></span><br><span class="line">            Hashtable&lt;EncodeHintType, String&gt; hints = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!TextUtils.isEmpty(character_set)) &#123;</span><br><span class="line">                hints.put(EncodeHintType.CHARACTER_SET, character_set); <span class="comment">// 字符转码格式设置</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!TextUtils.isEmpty(error_correction))&#123;</span><br><span class="line">                hints.put(EncodeHintType.ERROR_CORRECTION, error_correction); <span class="comment">// 容错级别设置</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!TextUtils.isEmpty(margin))&#123;</span><br><span class="line">                hints.put(EncodeHintType.MARGIN, margin); <span class="comment">// 空白边距设置</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeWriter</span>().encode(content, BarcodeFormat.QR_CODE, size, size, hints);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 3.根据BitMatrix(位矩阵)对象为数组元素赋颜色值 */</span></span><br><span class="line">            <span class="keyword">if</span>(targetBitmap != <span class="literal">null</span>)&#123;</span><br><span class="line">                targetBitmap = Bitmap.createScaledBitmap(targetBitmap, size, size, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span>[] pixels = <span class="keyword">new</span> <span class="title class_">int</span>[size * size];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; size; y++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; size; x++)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(bitMatrix.get(x, y))&#123; <span class="comment">// 黑色色块像素设置</span></span><br><span class="line">                        <span class="keyword">if</span>(targetBitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">                            pixels[y * size + x] = targetBitmap.getPixel(x, y);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            pixels[y * size + x] = color_black;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 白色色块像素设置</span></span><br><span class="line">                        pixels[y * size + x] = color_white;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 4.创建Bitmap对象,根据像素数组设置Bitmap每个像素点的颜色值,之后返回Bitmap对象 */</span></span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(size, size, Bitmap.Config.ARGB_8888);</span><br><span class="line">            bitmap.setPixels(pixels, <span class="number">0</span>, size, <span class="number">0</span>, <span class="number">0</span>, size, size);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 5.为二维码添加logo小图标 */</span></span><br><span class="line">            <span class="keyword">if</span>(logoBitmap != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> addLogo(bitmap, logoBitmap, logoPercent);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bitmap;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WriterException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向一张图片中间添加logo小图片(图片合成)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> srcBitmap 原图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoBitmap logo图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoPercent 百分比 (用于调整logo图片在原图片中的显示大小, 取值范围[0,1], 传值不合法时使用0.2F)</span></span><br><span class="line"><span class="comment">     *                    原图片是二维码时,建议使用0.2F,百分比过大可能导致二维码扫描失败。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Bitmap <span class="title function_">addLogo</span><span class="params">(<span class="meta">@Nullable</span> Bitmap srcBitmap, <span class="meta">@Nullable</span> Bitmap logoBitmap, <span class="type">float</span> logoPercent)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 1. 参数合法性判断 */</span></span><br><span class="line">        <span class="keyword">if</span>(srcBitmap == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(logoBitmap == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> srcBitmap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(logoPercent &lt; <span class="number">0F</span> || logoPercent &gt; <span class="number">1F</span>)&#123;</span><br><span class="line">            logoPercent = <span class="number">0.2F</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 2. 获取原图片和Logo图片各自的宽、高值 */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">srcWidth</span> <span class="operator">=</span> srcBitmap.getWidth();</span><br><span class="line">        <span class="type">int</span> <span class="variable">srcHeight</span> <span class="operator">=</span> srcBitmap.getHeight();</span><br><span class="line">        <span class="type">int</span> <span class="variable">logoWidth</span> <span class="operator">=</span> logoBitmap.getWidth();</span><br><span class="line">        <span class="type">int</span> <span class="variable">logoHeight</span> <span class="operator">=</span> logoBitmap.getHeight();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 3. 计算画布缩放的宽高比 */</span></span><br><span class="line">        <span class="type">float</span> <span class="variable">scaleWidth</span> <span class="operator">=</span> srcWidth * logoPercent / logoWidth;</span><br><span class="line">        <span class="type">float</span> <span class="variable">scaleHeight</span> <span class="operator">=</span> srcHeight * logoPercent / logoHeight;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 4. 使用Canvas绘制,合成图片 */</span></span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(srcWidth, srcHeight, Bitmap.Config.ARGB_8888);</span><br><span class="line">        <span class="type">Canvas</span> <span class="variable">canvas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Canvas</span>(bitmap);</span><br><span class="line">        canvas.drawBitmap(srcBitmap, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">        canvas.scale(scaleWidth, scaleHeight, srcWidth/<span class="number">2</span>, srcHeight/<span class="number">2</span>);</span><br><span class="line">        canvas.drawBitmap(logoBitmap, srcWidth/<span class="number">2</span> - logoWidth/<span class="number">2</span>, srcHeight/<span class="number">2</span> - logoHeight/<span class="number">2</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用注意"><a href="#使用注意" class="headerlink" title="使用注意"></a>使用注意</h3><ul><li><p>有些设备使用蓝牙连接的时候木有出现 <strong>配对</strong> 这个过程，而且连接成功了，这个是正确的。</p></li><li><p>官方的此方法只接受<code>base64</code>格式的值</p>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">BLEPlxMag</span>.<span class="title function_">writeCharacteristicWithResponseForDevice</span>(deviceId,serviceUUID,characteristicUUID,base64Value)</span><br></pre></td></tr></table></figure></li><li><p>分包，数据如果过多必须进行分包处理、分包大小取决设备</p>  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">toWrite = iconv.<span class="title function_">encode</span>(item.<span class="property">values</span>, <span class="string">&#x27;GBK&#x27;</span>);</span><br><span class="line">packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="使用过程"><a href="#使用过程" class="headerlink" title="使用过程"></a>使用过程</h2><p>低功耗蓝牙通信数据慢、过程比较繁琐</p><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://github.com/Polidea/react-native-ble-plx">react-native-ble-plx</a></li><li><a href="https://wenku.baidu.com/view/187b1ad5690203d8ce2f0066f5335a8102d266a9">热敏打印机指令集</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;蓝牙4-0&quot;&gt;&lt;a href=&quot;#蓝牙4-0&quot; class=&quot;headerlink&quot; title=&quot;蓝牙4.0&quot;&gt;&lt;/a&gt;蓝牙&lt;code&gt;4.0&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;蓝牙&lt;code&gt;4.0&lt;/code&gt;标准包含两个蓝牙标准，准确的说，是一个双模的标准&lt;/p&gt;
&lt;p&gt;现在移动设备上使用的蓝牙大多是&lt;code&gt;4.0&lt;/code&gt;，而蓝牙 &lt;code&gt;4.0&lt;/code&gt; 有两个分支，经典 &lt;code&gt;4.0&lt;/code&gt; 和 &lt;code&gt;BLE4.0&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;经典蓝牙-classic-Bluetooth&quot;&gt;&lt;a href=&quot;#经典蓝牙-classic-Bluetooth&quot; class=&quot;headerlink&quot; title=&quot;经典蓝牙(classic Bluetooth)&quot;&gt;&lt;/a&gt;经典蓝牙(&lt;code&gt;classic Bluetooth&lt;/code&gt;)&lt;/h3&gt;&lt;p&gt;经典蓝牙可以用与数据量比较大的传输，如语音，音乐，较高数据量传输&lt;/p&gt;
    
    </summary>
    
      <category term="react-native" scheme="https://nightme.github.io/categories/react-native/"/>
    
    
      <category term="react-native" scheme="https://nightme.github.io/tags/react-native/"/>
    
  </entry>
  
  <entry>
    <title>事件循环</title>
    <link href="https://nightme.github.io/2018/10/07/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/"/>
    <id>https://nightme.github.io/2018/10/07/事件循环/</id>
    <published>2018-10-07T05:07:35.000Z</published>
    <updated>2025-09-19T04:25:12.110Z</updated>
    
    <content type="html"><![CDATA[<h2 id="事件循环"><a href="#事件循环" class="headerlink" title="事件循环"></a>事件循环</h2><p><code>Event Loop</code> 是一种运行机制。</p><p>宏任务<code>macrotask</code>和微任务<code>microtask</code>两个概念，这表示任务的两种分类。</p><p>在挂起任务时，<code>JS</code> 引擎会将所有任务按照类别分到这两个队列中，首先在 <code>macrotask</code> 的队列（这个队列也被叫做 <code>task queue</code>）中取出第一个任务，执行完毕后取出 <code>microtask</code> 队列中的所有任务顺序执行；</p><p>之后再取 <code>macrotask</code> 任务，周而复始，直至两个队列的任务都取完。</p><span id="more"></span><h3 id="V8引擎"><a href="#V8引擎" class="headerlink" title="V8引擎"></a><code>V8</code>引擎</h3><p><code>V8</code>引擎基本概念关系图 (根据 <code>Google V8</code> 官方文档)</p><p><a href="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/201809281123.jpg">http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/201809281123.jpg</a></p><h4 id="handle"><a href="#handle" class="headerlink" title="handle"></a><code>handle</code></h4><p><code>handle </code>是指向对象的指针，在 <code>V8</code> 中，所有的对象都通过 <code>handle</code> 来引用，<code>handle</code> 主要用于 <code>V8</code>的垃圾回收机制。</p><h4 id="上下文-context"><a href="#上下文-context" class="headerlink" title="上下文(context)"></a>上下文(<code>context</code>)</h4><p><code>context</code> 是一个执行器环境，使用 <code>context</code> 可以将相互分离的 <code>JavaScript</code> 脚本在同一个 <code>V8</code> 实例中运行，而互不干涉。在运行 <code>JavaScript</code> 脚本是，需要显式的指定 <code>context</code> 对象。</p><h3 id="运行时概念"><a href="#运行时概念" class="headerlink" title="运行时概念"></a>运行时概念</h3><h4 id="可视化描述"><a href="#可视化描述" class="headerlink" title="可视化描述"></a>可视化描述</h4><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/201809281133.png" alt="image"></p><h4 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h4><p>函数调用形成了一个栈帧。</p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/201809281418.gif" alt="image"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">b</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> a = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">return</span> a + b + <span class="number">11</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bar</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> y = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">foo</span>(x * y);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">bar</span>(<span class="number">7</span>));</span><br></pre></td></tr></table></figure><p>当调用<code>bar</code>时，创建了第一个帧 ，帧中包含了<code>bar</code>的参数和局部变量。</p><p>当<code>bar</code>调用<code>foo</code>时，第二个帧就被创建，并被压到第一个帧之上，帧中包含了<code>foo</code>的参数和局部变量。当<code>foo</code>返回时，最上层的帧就被弹出栈（剩下<code>bar</code>函数的调用帧 ）。</p><p>当<code>bar</code>返回的时候，栈就空了。</p><h4 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h4><p>对象被分配在一个堆中，即用以表示一个大部分非结构化的内存区域。</p><h4 id="队列"><a href="#队列" class="headerlink" title="队列"></a>队列</h4><p>一个 <code>JavaScript</code> 运行时包含了一个待处理的消息队列。每一个消息都有一个为了处理这个消息相关联的函数。</p><p>在事件循环期间的某个时刻，运行时总是从最先进入队列的一个消息开始处理队列中的消息。正因如此，这个消息就会被移出队列，并将其作为输入参数调用与之关联的函数。为了使用这个函数，调用一个函数总是会为其创造一个新的栈帧，一如既往。</p><p>函数的处理会一直进行直到执行栈再次为空；然后事件循环将会处理队列中的下一个消息（如果还有的话）。</p><h2 id="浏览器事件循环"><a href="#浏览器事件循环" class="headerlink" title="浏览器事件循环"></a>浏览器事件循环</h2><h3 id="事件循环-WHATWG规范"><a href="#事件循环-WHATWG规范" class="headerlink" title="事件循环(WHATWG规范)"></a>事件循环(WHATWG规范)</h3><p>要协调事件<code>(event)</code>，用户交互<code>(user interaction)</code>，脚本<code>(script)</code>，渲染<code>(rendering)</code>，网络<code>(networking)</code>等，用户代理<code>(user agent)</code>就需要使用事件循环<code>(event loops)</code>。</p><p>有两种事件循环：</p><ol><li>用于浏览器上下(<code>browsing context</code>)文的事件循环</li><li>用于<code>workers</code>的事件循环</li></ol><h3 id="事件循环机制"><a href="#事件循环机制" class="headerlink" title="事件循环机制"></a>事件循环机制</h3><ul><li><p>一个事件循环有一个或多个任务队列(<code>task queues</code>),一个任务队列是有序列表的任务,这些算法负责以下工作：<br>事件(<code>Events</code>)，解析(<code>Parsing</code>) ，回调(<code>Callbacks</code>)，使用资源(<code>Using a resource</code>)，对DOM操作做出反应(<code>Reacting to DOM manipulation</code>)</p></li><li><p>每个任务都定义为来自特定任务源<code>task source</code>。必须始终添加来自一个特定任务源并发往特定事件循环的所有任务(例如，由<code>Document</code>的计时器生成的回调，针对该<code>Document</code>的鼠标移动而触发的事件，排队等待该<code>Document</code>的解析器的任务)到同一任务队列，但来自不同任务源的任务可以放在不同的任务队列中。</p></li><li><p>例如，用户代理可以为鼠标和键事件(用户交互任务源)创建一个任务队列，为其他所有事件设置另一个任务队列。然后，用户代理可以在四分之三的时间内为其他任务提供键盘和鼠标事件首选项，保持界面响应但不会使其他任务队列处于饥饿状态，并且永远不会无序地处理来自任何一个任务源的事件。</p></li><li><p>每个事件循环都有一个当前运行的任务。最初，这是null。它用于处理重入。每个事件循环还具有执行微任务检查点标志(<code>microtask checkpoint flag</code>)，该标志最初必须为假(<code>false</code>)。它用于防止执行微任务检查点算法的重入调用。</p></li></ul><h3 id="事件循环处理模型"><a href="#事件循环处理模型" class="headerlink" title="事件循环处理模型"></a>事件循环处理模型</h3><p>一个事件循环存在，将连续执行以下步骤：</p><ol><li>选择最先进入事件循环任务队列的一个任务(<code>oldestTask</code>)， 如果队列中没有任务，则直接跳到第6步的<code>microtask</code></li><li>将事件循环的当前运行任务设置为上一步所选择的任务(<code>oldestTask</code>)</li><li>运行所选任务(<code>oldestTask</code>)</li><li>将事件循环的当前运行任务设置为<code>null</code> 。</li><li>从其任务队列中移除<code>oldestTask</code>。</li><li>微任务(<code>microtask</code>):执行微任务检查点</li><li>更新渲染(<code>update the rendering</code>)</li><li>如果这是一个<code>worker</code>事件循环（即一个为<code>WorkerGlobalScope</code>运行的循环）</li><li>跳到第一步</li></ol><h3 id="微任务-microtask"><a href="#微任务-microtask" class="headerlink" title="微任务(microtask)"></a>微任务(<code>microtask</code>)</h3><p>每个事件循环都有一个微任务队列。微任务是最初要在微任务队列上排队的任务，而不是任务队列上排队的任务</p><p>当算法需要对微任务进行排队时，必须将其附加到相关事件循环的微任务队列中;这种微任务的任务源是微任务任务源</p><p>当用户代理要 <strong>执行微任务检查点</strong> 时，如果执行微任务检查点标志为<code>false</code>，则用户代理必须运行以下步骤：</p><ol><li>将执行微任务检查点标志(<code>flag</code>)设置为<code>true</code>。</li><li>而事件循环的微任务队列不为空:<ol><li>让<code>oldestMicrotask</code>成为事件循环的微任务队列中最老的微任务(<code>oldest microtask </code>)</li><li>将事件循环的当前运行任务设置为<code>oldestMicrotask</code></li><li>运行<code>oldestMicrotask</code></li><li>将事件循环的当前运行任务设置为<code>null</code>。</li><li>从微任务队列中删除<code>oldestMicrotask</code>。</li></ol></li><li>对于其负责事件循环是此事件循环的每个环境设置对象，请通知该环境设置对象上被拒绝的承诺。</li><li>清理索引数据库事务。</li><li>将执行微任务检查点标志设置为<code>false</code>。</li></ol><p>微任务的实现：</p><ul><li><code>process.nextTick</code>:事件循环的下一次循环中调用 <code>callback</code> 回调函数</li><li><code>Promises</code>:<code>Promise</code> 对象用于表示一个异步操作的最终状态（完成或失败），以及其返回的值。</li><li><code>Object.observe</code>:<code>Object.observe()</code> 方法用于异步地监视一个对象的修改</li><li><code>MutationObserver</code>:(<code>Mutation Observer API</code> 用来监视 <code>DOM</code> 变动)</li></ul><h3 id="宏任务-macrotask"><a href="#宏任务-macrotask" class="headerlink" title="宏任务(macrotask)"></a>宏任务(<code>macrotask</code>)</h3><p>宏任务的实现：</p><ol><li><code>script</code>（整体代码）</li><li><code>setTimeout</code></li><li><code>setInterval</code></li><li><code>setImmediate</code>:该方法用来把一些需要长时间运行的操作放在一个回调函数里,在浏览器完成后面的其他语句后,就立刻执行这个回调函数,</li><li><code>I/O</code></li><li><code>UI rendering</code></li></ol><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;script start&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;setTimeout&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise1&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;promise2&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;script end&quot;</span>);</span><br></pre></td></tr></table></figure><p><code>chrome</code>执行顺序：</p><p><code>script start</code>、<code>script end</code>、<code>promise1</code>、<code>promise2</code>、<code>setTimeout</code></p><h2 id="nodejs事件循环"><a href="#nodejs事件循环" class="headerlink" title="nodejs事件循环"></a>nodejs事件循环</h2><p><code>nodejs</code>的<code>event</code>是基于<code>libuv</code></p><p>事件循环允许<code>Node.js</code>执行非阻塞<code>I/O</code>操作</p><p>尽管<code>JavaScript</code>是单线程的,通过尽可能将操作卸载到系统内核。</p><p>由于大多数现代内核都是多线程的，因此它们可以处理在后台执行的多个操作。 当其中一个操作完成时，内核会告诉<code>Node.js</code>，以便可以将相应的回调添加到轮询队列中以最终执行。</p><h3 id="事件循环-1"><a href="#事件循环-1" class="headerlink" title="事件循环"></a>事件循环</h3><p>当<code>Node.js</code>启动时，它初始化事件循环，处理提供的输入脚本（或放入交互式解释器(<code>REPL</code>)），这可能会进行异步<code>API</code>调用，调度计时器或调用<code>process.nextTick</code>， 然后开始处理事件循环。</p><h3 id="事件循环操作顺序"><a href="#事件循环操作顺序" class="headerlink" title="事件循环操作顺序:"></a>事件循环操作顺序:</h3><p><strong>注意：</strong> 以下每个框都将被称为事件循环的“阶段”</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">   ┌───────────────────────────┐</span><br><span class="line">┌─&gt;│           timers          │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">│  │     pending callbacks     │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">│  │       idle, prepare       │</span><br><span class="line">│  └─────────────┬─────────────┘      ┌───────────────┐</span><br><span class="line">│  ┌─────────────┴─────────────┐      │   incoming:   │</span><br><span class="line">│  │           poll            │&lt;─────┤  connections, │</span><br><span class="line">│  └─────────────┬─────────────┘      │   data, etc.  │</span><br><span class="line">│  ┌─────────────┴─────────────┐      └───────────────┘</span><br><span class="line">│  │           check           │</span><br><span class="line">│  └─────────────┬─────────────┘</span><br><span class="line">│  ┌─────────────┴─────────────┐</span><br><span class="line">└──┤      close callbacks      │</span><br><span class="line">   └───────────────────────────┘</span><br></pre></td></tr></table></figure><p>每个阶段都有一个要执行的回调先入先出(<code>First Input First Output</code>)队列。虽然每个阶段都有自己的特殊之处，但通常，当事件循环进入给定阶段时，它将执行特定于该阶段的任何操作，然后在该阶段的队列中执行回调，直到队列耗尽或执行的回调的最大数量为止。当队列耗尽或达到回调限制时，事件循环将移至下一阶段，依此类推。</p><p>由于这些操作中的任何一个可以调度更多操作,并且在轮询阶段中处理的新事件由内核排队，因此轮询事件可以在处理轮询事件时排队。因此，长时间运行的回调可以允许轮询阶段运行的时间比计时器的阈值长得多</p><p><strong>注意</strong>：<code>Windows</code>和<code>Unix/Linux</code>实现之间存在轻微差异，但这对于此演示并不重要。最重要的部分在这里。实际上有七到八个步骤，而我们关心的是 - <code>Node.js</code>实际使用的那些 - 是上面那些。</p><h3 id="阶段概述"><a href="#阶段概述" class="headerlink" title="阶段概述"></a>阶段概述</h3><p><code>nodejs</code>的事件循环分为6个阶段</p><ol><li>计时器(<code>timers</code>):此阶段执行<code>setTimeout()</code>和<code>setInterval()</code>调度的回调。</li><li>等待回调(<code>pending callbacks</code>):执行延迟到下一个循环迭代的<code>I/O</code>回调</li><li>空闲,准备(<code>idle, prepare</code>):仅在内部使用</li><li>轮询(<code>poll</code>):检索新的<code>I/O</code>事件;执行与<code>I/O</code>相关的回调（几乎所有回调都是关闭回调，定时器和<code>setImmediate()</code>调度的回调）;<code>node</code>将在适当的时候阻止</li><li><code>check</code>:<code>setImmediate()</code>在这里调用回调</li><li>关闭回调(<code>close callbacks</code>):一些关闭回调,例如<code>socket.on</code>（’close’，…）</li></ol><p>在事件循环的每次运行之间，<code>Node.js</code>检查它是否在等待任何异步的<code>I/O</code>或定时器，如果没有，则关闭。</p><p>代码片段：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setTimeout&quot;</span>,<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;setImmediate&quot;</span>,<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line">process.<span class="title function_">nextTick</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;process.nextTick&quot;</span>,<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Promise&quot;</span>,<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">;(<span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">5</span>))()</span><br><span class="line"></span><br><span class="line"><span class="comment">//执行结果</span></span><br><span class="line">$ node index.<span class="property">js</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line">process.<span class="property">nextTick</span> <span class="number">3</span></span><br><span class="line"><span class="title class_">Promise</span> <span class="number">4</span></span><br><span class="line"><span class="built_in">setTimeout</span> <span class="number">1</span></span><br><span class="line">setImmediate <span class="number">2</span></span><br></pre></td></tr></table></figure><h3 id="循环阶段详情"><a href="#循环阶段详情" class="headerlink" title="循环阶段详情"></a>循环阶段详情</h3><h4 id="计时器-timers"><a href="#计时器-timers" class="headerlink" title="计时器(timers)"></a>计时器(<code>timers</code>)</h4><p>计时器指定阈值，在该阈值之后可以执行提供的回调而不是人们希望它执行的确切时间。 定时器回调将在指定的时间过去后尽早安排; 但是，操作系统调度或其他回调的运行可能会延迟它们。</p><p>注意：从技术上讲，轮询阶段控制何时执行定时器。</p><p>例如，假设您计划在<code>100</code>毫秒阈值后执行超时，那么您的脚本将异步读取一个耗时<code>95</code>毫秒的文件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//一些异步操作</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">someAsyncOperation</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="comment">//假设这需要95ms才能完成</span></span><br><span class="line">    fs.<span class="title function_">readFile</span>(<span class="string">&#x27;d:/all.txt&#x27;</span>, callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> timeoutScheduled = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> delay = <span class="title class_">Date</span>.<span class="title function_">now</span>() - timeoutScheduled;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`已经过去了<span class="subst">$&#123;delay&#125;</span>ms`</span>);</span><br><span class="line">&#125;, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 做一些需要95毫秒完成的异步操作</span></span><br><span class="line"><span class="title function_">someAsyncOperation</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> startCallback = <span class="title class_">Date</span>.<span class="title function_">now</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;while开始&quot;</span>);</span><br><span class="line">    <span class="comment">//做一些需要10ms的事情....</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="title class_">Date</span>.<span class="title function_">now</span>() - startCallback &lt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="comment">//todo</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;while结束&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>当事件循环进入轮询阶段时，它有一个空队列（<code>fs.readFile（）</code>尚未完成），因此它将等待<code>剩余的ms</code>数，直到达到最快的计时器阈值。 当它等待<code>95</code>毫秒传递时，<code>fs.readFile（）</code>完成读取文件，并且其完成需要<code>10</code>毫秒的回调被添加到轮询队列并执行。 当回调结束时，队列中不再有回调，因此事件循环将看到已达到最快定时器的阈值，然后回绕到定时器阶段以执行定时器的回调。 在此示例中，您将看到正在调度的计时器与正在执行的回调之间的总延迟将为<code>105</code>毫秒。</p><p>注意：为了防止轮询阶段使事件循环挨饿，<code>libuv</code>(实现<code>Node.js</code>事件循环的<code>C</code>库和平台的所有异步行为）在停止轮询更多的事件之前具有硬性最大值（取决于系统）。</p><h4 id="等待回调-pending-callbacks"><a href="#等待回调-pending-callbacks" class="headerlink" title="等待回调(pending callbacks)"></a>等待回调(<code>pending callbacks</code>)</h4><p>此阶段执行某些系统操作（例如<code>TCP</code>错误类型）的回调。 例如，如果<code>TCP</code>套接字在尝试连接时收到拒绝<code>ECONNREFUSED</code>，则某些<code>*nix</code>系统希望等待报告错误。 这将排队等待在挂起的回调阶段执行。</p><h4 id="轮询-poll"><a href="#轮询-poll" class="headerlink" title="轮询(poll)"></a>轮询(<code>poll</code>)</h4><p>轮询阶段有两个主要功能:</p><ol><li>计算它应该阻止和轮询<code>I/O</code>的时间,然后</li><li>处理轮询队列中的事件。</li></ol><p>当事件循环进入轮询阶段并且没有计划定时器时，将发生以下两种情况之一:</p><ol><li>如果轮询队列不为空，则事件循环将遍历其同步执行它们的回调队列，直到队列已用尽或者达到系统相关的硬性限制。</li><li>如果轮询队列为空，则会发生以下两种情况之一：<ul><li>如果<code>setImmediate()</code>已调度脚本，则事件循环将结束轮询阶段并继续执行检查阶段以执行这些调度脚本。</li><li>如果<code>setImmediate()</code>尚未调度脚本，则事件循环将等待将回调添加到队列，然后立即执行它们。</li></ul></li></ol><p>轮询队列为空后，事件循环将检查已达到时间阈值的计时器。 如果一个或多个计时器准备就绪，事件循环将回绕到计时器阶段以执行那些计时器的回调。</p><h4 id="check"><a href="#check" class="headerlink" title="check"></a><code>check</code></h4><p>此阶段允许人员在轮询阶段完成后立即执行回调。 如果轮询阶段变为空闲并且脚本已使用<code>setImmediate()</code>排队，则事件循环可以继续到检查阶段而不是等待。</p><p><code>setImmediate()</code>实际上是一个特殊的计时器，它在事件循环的一个单独阶段运行。 它使用<code>libuv API</code>来调度,在轮询阶段完成后执行的回调。</p><p>通常，在执行代码时，事件循环最终会到达轮询阶段，它将等待传入连接，请求等。但是，如果已使用<code>setImmediate()</code>调度回调并且轮询阶段变为空闲，则将结束并继续检查阶段，而不是等待轮询事件。</p><h4 id="关闭回调close-callbacks"><a href="#关闭回调close-callbacks" class="headerlink" title="关闭回调close callbacks"></a>关闭回调<code>close callbacks</code></h4><p>如果套接字或句柄突然关闭（例如<code>socket.destroy()</code>），则在此阶段将发出<code>close</code>事件。 否则它将通过<code>process.nextTick()</code>发出。</p><h3 id="setImmediate-与-setTimeout"><a href="#setImmediate-与-setTimeout" class="headerlink" title="setImmediate() 与 setTimeout()"></a><code>setImmediate()</code> 与 <code>setTimeout()</code></h3><p><code>setImmediate</code>和<code>setTimeout()</code>类似，但根据它们的调用时间以不同的方式运行。</p><ol><li><code>setImmediate()</code>用于在当前轮询阶段完成后执行脚本,即check阶段。</li><li><code>setTimeout()</code>计划在经过最小阈值（以<code>ms</code>为单位）后运行的脚本。</li></ol><p>执行定时器的顺序将根据调用它们的上下文而有所不同。 如果从主模块中调用两者，则时间将受到进程性能的限制（可能受到计算机上运行的其他应用程序的影响）。</p><p>例如，如果我们运行不在<code>I/O</code>周期内的以下脚本（即主模块），则执行两个定时器的顺序是不确定的，因为它受进程性能的约束：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timeout_vs_immediate.js</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> <span class="title function_">timeout</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout&#x27;</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">setImmediate</span>(<span class="keyword">function</span> <span class="title function_">immediate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>输出的顺序不确定：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ node timeout_vs_immediate.js</span><br><span class="line"><span class="built_in">timeout</span></span><br><span class="line">immediate</span><br><span class="line"></span><br><span class="line">$ node timeout_vs_immediate.js</span><br><span class="line">immediate</span><br><span class="line"><span class="built_in">timeout</span></span><br></pre></td></tr></table></figure><p>但是，如果在<code>I/O</code>周期内移动两个调用，则始终首先执行立即回调：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line">fs.<span class="title function_">readFile</span>(<span class="string">&quot;d:/all.txt&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;timeout&#x27;</span>);</span><br><span class="line">    &#125;, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_">setImmediate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;immediate&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>始终首先执行立即回调<code>immediate</code>,再执行<code>setTimeout</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ node timeout_vs_immediate.js</span><br><span class="line">immediate</span><br><span class="line"><span class="built_in">timeout</span></span><br><span class="line"></span><br><span class="line">$ node timeout_vs_immediate.js</span><br><span class="line">immediate</span><br><span class="line"><span class="built_in">timeout</span></span><br></pre></td></tr></table></figure><p>使用<code>setImmediate()</code>而不是<code>setTimeout()</code>的主要优点是<code>setImmediate()</code>将始终在任何定时器之前执行（如果在<code>I/O</code>周期内调度），与存在多少定时器无关。</p><h3 id="process-nextTick"><a href="#process-nextTick" class="headerlink" title="process.nextTick()"></a><code>process.nextTick()</code></h3><h4 id="了解process-nextTick"><a href="#了解process-nextTick" class="headerlink" title="了解process.nextTick()"></a>了解<code>process.nextTick()</code></h4><p>您可能已经注意到<code>process.nextTick()</code>没有显示在图中，即使它是异步API的一部分。 这是因为<code>process.nextTick</code>在技术上不是事件循环的一部分。 相反，<code>nextTickQueue</code>将在当前操作完成后处理，而不管事件循环的当前阶段如何。</p><p>回顾一下上面的图表，无论何时在给定阶段调用<code>process.nextTick()</code>，传递给<code>process.nextTick()</code>的所有回调都将在事件循环继续之前得到解决。 这可能会产生一些不好的情况，因为它允许您通过进行递归的<code>process.nextTick()</code>调用来饿死(<code>starve</code>)您的<code>I/O</code>，这会阻止事件循环到达轮询阶段。</p><h4 id="为什么会被允许"><a href="#为什么会被允许" class="headerlink" title="为什么会被允许"></a>为什么会被允许</h4><p>为什么这样的东西会被包含在<code>Node.js</code>中? 其中一部分是一种设计理念，其中<code>API</code>应该始终是异步的，即使它不是必须的。 以下面代码段为例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">apiCall</span>(<span class="params">arg, callback</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> arg !== <span class="string">&#x27;string&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> process.<span class="title function_">nextTick</span>(callback,<span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;参数应该是字符串&#x27;</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码片段进行参数检查，如果不正确，它会将错误传递给回调。这个API最近更新了，允许将参数传递给<code>process.nextTick()</code>，允许它将回调后传递的任何参数作为参数传播到回调，因此您不必嵌套函数。</p><p>我们正在做的是将错误传回给用户，但只有在我们允许其余的用户代码执行之后。 通过使用<code>process.nextTick</code>，我们保证<code>apiCall()</code>始终在用户代码的其余部分之后和允许事件循环继续之前运行其回调。 为了实现这一点，允许<code>JS</code>调用堆栈展开然后立即执行提供的回调，这允许一个人对<code>process.nextTick()</code>进行递归调用而不会达到<code>RangeError</code>：超出<code>v8</code>的最大调用堆栈大小。</p><p>这种理念可能会导致一些潜在的问题,以以下片段为例:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bar;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这有一个异步签名，但同步调用回调</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">someAsyncApiCall</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="title function_">callback</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在`someAsyncApiCall`完成之前调用回调。</span></span><br><span class="line"><span class="title function_">someAsyncApiCall</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 由于someAsyncApiCall已完成，因此bar未分配任何值</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;bar&#x27;</span>, bar); <span class="comment">// undefined</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">bar = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>用户将<code>someAsyncApiCall()</code>定义为具有异步签名，但它实际上是同步操作的。 调用它时，在事件循环的同一阶段调用提供给<code>someAsyncApiCall()</code>的回调，因为<code>someAsyncApiCall()</code>实际上不会异步执行任何操作。 因此,回调尝试引用<code>bar</code>，即使它在范围内可能没有该变量，因为该脚本无法运行完成。</p><p>通过将回调放在<code>process.nextTick()</code>中，脚本仍然能够运行完成，允许在调用回调之前初始化所有变量，函数等。 它还具有不允许事件循环继续的优点。 在允许事件循环继续之前，向用户警告错误可能是有用的。</p><p>以下是使用<code>process.nextTick()</code>的前一个示例：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> bar;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">someAsyncApiCall</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    process.<span class="title function_">nextTick</span>(callback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">someAsyncApiCall</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;bar&#x27;</span>, bar); <span class="comment">// 1</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">bar = <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p>这是另一个例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&quot;net&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">8080</span>);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;listening&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(server.<span class="title function_">address</span>());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>仅传递端口时，端口立即绑定。 因此可以立即调用<code>listen</code>回调。 问题是那时候不会设置<code>.on（&#39;listen&#39;）</code>。</p><p>为了解决这个问题，<code>listening</code>事件在<code>nextTick</code>中排队，以允许脚本运行完成。 这允许用户设置他们想要的任何事件处理程序。</p><h3 id="process-nextTick-vs-setImmediate"><a href="#process-nextTick-vs-setImmediate" class="headerlink" title="process.nextTick() vs setImmediate()"></a><code>process.nextTick()</code> vs <code>setImmediate()</code></h3><p>就用户而言，我们有两个类似的调用，但它们的名称令人困惑。</p><ul><li><code>process.nextTick()</code>在同一阶段立即触发</li><li><code>setImmediate()</code>触发事件循环的后续迭代或<code>tick</code></li></ul><p>本质上，这些名字应该被交换。与<code>setimmediation()</code>相比，<code>process.nextTick()</code>更快速地触发，但这是过去的产物，不太可能改变。这样做会破坏npm上的大部分包。每天都有更多的新模块被添加，这意味着我们每天都在等待，更多的潜在故障发生。虽然它们令人困惑，但名称本身不会改变。</p><p>建议开发人员在所有情况下都使用<code>setimmediation()</code>，因为这样做更容易理解(而且会导致代码与更广泛的环境兼容，比如浏览器<code>JS</code>)。</p><h3 id="为什么使用process-nextTick"><a href="#为什么使用process-nextTick" class="headerlink" title="为什么使用process.nextTick()"></a>为什么使用<code>process.nextTick()</code></h3><p>主要有两个原因：</p><ol><li>允许用户处理错误，清除任何不需要的资源，或者在事件循环继续之前再次尝试请求。</li><li>有时需要允许回调在调用堆栈展开之后但在事件循环继续之前运行。</li></ol><p>一个例子简单的例子:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">&quot;net&quot;</span>)</span><br><span class="line"><span class="keyword">const</span> server = net.<span class="title function_">createServer</span>();</span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;connection&#x27;</span>, <span class="keyword">function</span>(<span class="params">conn</span>) &#123;&#125;);</span><br><span class="line"></span><br><span class="line">server.<span class="title function_">listen</span>(<span class="number">8080</span>);</span><br><span class="line">server.<span class="title function_">on</span>(<span class="string">&#x27;listening&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(server.<span class="title function_">address</span>());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>假设<code>listen()</code>在事件循环的开头运行，但是侦听回调被放置在<code>setimmediation()</code>中。现在，除非将主机名传递给端口，否则绑定将立即发生。现在，为了让事件循环继续进行，它必须到达轮询阶段，这意味着有一个非零的机会，连接可能已经收到，允许连接事件在侦听事件之前被触发。</p><p>另一个例子是运行一个函数构造函数，比如继承自<code>EventEmitter</code>，它想在构造函数中调用一个事件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyEmitter</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">EventEmitter</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;event&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">util.<span class="title function_">inherits</span>(<span class="title class_">MyEmitter</span>, <span class="title class_">EventEmitter</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myEmitter = <span class="keyword">new</span> <span class="title class_">MyEmitter</span>();</span><br><span class="line">myEmitter.<span class="title function_">on</span>(<span class="string">&#x27;event&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;发生了一件事！&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>您无法立即从构造函数中发出事件，因为脚本将不会处理到用户为该事件分配回调的位置。 因此，在构造函数本身中，您可以使用<code>process.nextTick()</code>来设置回调以在构造函数完成后发出事件，从而提供预期的结果：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">EventEmitter</span> = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">MyEmitter</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">EventEmitter</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//分配处理程序后，使用nextTick发出事件</span></span><br><span class="line">    process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;event&#x27;</span>);</span><br><span class="line">    &#125;.<span class="title function_">bind</span>(<span class="variable language_">this</span>));</span><br><span class="line">&#125;</span><br><span class="line">util.<span class="title function_">inherits</span>(<span class="title class_">MyEmitter</span>, <span class="title class_">EventEmitter</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myEmitter = <span class="keyword">new</span> <span class="title class_">MyEmitter</span>();</span><br><span class="line">myEmitter.<span class="title function_">on</span>(<span class="string">&#x27;event&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;发生了一件事！&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="libuv"><a href="#libuv" class="headerlink" title="libuv"></a>libuv</h2><p><code>libuv</code>是最初为<code>NodeJS</code>编写的跨平台支持库。 它是围绕事件驱动的异步<code>I/O</code>模型设计的。</p><h3 id="I-x2F-O-或事件-循环"><a href="#I-x2F-O-或事件-循环" class="headerlink" title="I&#x2F;O(或事件)循环"></a>I&#x2F;O(或事件)循环</h3><p><code>I/O</code>(或事件)循环是<code>libuv</code>的中心部分。它为所有<code>I/O</code>操作建立内容，并且它被绑定到一个线程。只要在不同的线程中运行，就可以运行多个事件循环。<code>libuv</code>事件循环(或任何其他涉及循环或句柄的<code>API</code>)不是线程安全的，除非另有说明。</p><p>为了更好地理解事件循环的运行方式，下图说明了循环迭代的所有阶段：</p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/201809281054.png" alt="image"></p><p><strong>重要：</strong> 虽然 <code>libuv</code> 的异步文件 <code>I/O</code>操作是通过线程池实现的，但是网络 <code>I/O</code> 总是在单线程中执行的。</p><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://en.wikipedia.org/wiki/Event_loop">事件循环Event loop</a></li><li><a href="https://html.spec.whatwg.org/multipage/webappapis.html#event-loops">WHATWG规范对Event loop</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop">并发模型与事件循环</a></li><li><a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/">任务，微任务，队列和日程安排</a></li><li><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/"><code>The Node.js Event Loop, Timers, and process.nextTick()</code></a></li><li><a href="https://cnodejs.org/topic/5a9108d78d6e16e56bb80882">不要混淆nodejs和浏览器中的event loop</a></li><li><a href="https://github.com/libuv/libuv">跨平台异步I&#x2F;O. libuv</a></li><li><a href="http://acemood.github.io/2016/02/01/event-loop-in-javascript/">Event loop in JavaScript</a></li><li><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-v8engine/">使用 Google V8 引擎开发可定制的应用程序</a></li><li><a href="https://github.com/yjhjstz/deep-into-node">深入理解Nodejs核心思想与源码分析基于node v6.0.0</a></li><li><a href="https://github.com/xtx1130/blog">node源码粗读系列文章</a></li><li><a href="http://nodejs.cn/api/process.html#process_process_nexttick_callback_args">process.nextTick(callback[, …args])</a></li><li><a href="http://docs.libuv.org/en/v1.x/design.html">libuv 设计概述</a></li><li><a href="https://github.com/latentflip/loupe">在运行时可视化<code>javascript</code>运行时</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;事件循环&quot;&gt;&lt;a href=&quot;#事件循环&quot; class=&quot;headerlink&quot; title=&quot;事件循环&quot;&gt;&lt;/a&gt;事件循环&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Event Loop&lt;/code&gt; 是一种运行机制。&lt;/p&gt;
&lt;p&gt;宏任务&lt;code&gt;macrotask&lt;/code&gt;和微任务&lt;code&gt;microtask&lt;/code&gt;两个概念，这表示任务的两种分类。&lt;/p&gt;
&lt;p&gt;在挂起任务时，&lt;code&gt;JS&lt;/code&gt; 引擎会将所有任务按照类别分到这两个队列中，首先在 &lt;code&gt;macrotask&lt;/code&gt; 的队列（这个队列也被叫做 &lt;code&gt;task queue&lt;/code&gt;）中取出第一个任务，执行完毕后取出 &lt;code&gt;microtask&lt;/code&gt; 队列中的所有任务顺序执行；&lt;/p&gt;
&lt;p&gt;之后再取 &lt;code&gt;macrotask&lt;/code&gt; 任务，周而复始，直至两个队列的任务都取完。&lt;/p&gt;
    
    </summary>
    
      <category term="前端" scheme="https://nightme.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="前端" scheme="https://nightme.github.io/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>承诺Promises</title>
    <link href="https://nightme.github.io/2018/08/17/%E6%89%BF%E8%AF%BAPromises/"/>
    <id>https://nightme.github.io/2018/08/17/承诺Promises/</id>
    <published>2018-08-17T12:18:14.000Z</published>
    <updated>2025-09-19T04:25:12.111Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Promises"><a href="#Promises" class="headerlink" title="Promises"></a>Promises</h2><p><code>Promise </code>表示一个异步操作的最终结果，与之进行交互的方式主要是 then 方法，该方法注册了两个回调函数，用于接收 promise 的终值或本 promise 不能执行的原因。</p><p>一个 Promise有以下几种状态:</p><ul><li><code>pending:</code> 初始状态，既不是成功，也不是失败状态。</li><li><code>fulfilled:</code> 意味着操作成功完成。</li><li><code>rejected:</code> 意味着操作失败。</li></ul><ol><li><code>Promise</code> 本质是一个状态机。每个 <code>promise</code> 只能是 3 种状态中的一种：<code>pending、fulfilled</code> 或 <code>rejected</code>。状态转变只能是 <code>pending -&gt; fulfilled</code> 或者 <code>pending -&gt; rejected</code>。状态转变不可逆。</li><li><code>then</code> 方法可以被同一个 <code>promise</code> 调用多次。</li><li><code>then</code> 方法必须返回一个 <code>promise</code> 。规范里没有明确说明返回一个新的 promise 还是复用老的 <code>promise</code>（即 return this），大多数实现都是返回一个新的 <code>promise</code> ，而且复用老的 <code>promise</code> 可能改变内部状态，这与规范也是相违背的。</li><li>值穿透(上一个<code>promise</code>传递过来的值，经由这个<code>then</code>方法的时候不做任何处理，而是交给再下个<code>then</code>方法去处理)。</li></ol><span id="more"></span><p><strong>注意：</strong> 如果一个<code>promise</code>对象处在<code>fulfilled</code>或<code>rejected</code>状态而不是<code>pending</code>状态，那么它也可以被称为<code>settled</code>状态。你可能也会听到一个术语<code>resolved </code>，它表示<code>promise</code>对象处于<code>fulfilled</code>状态。</p><h3 id="术语集"><a href="#术语集" class="headerlink" title="术语集"></a>术语集</h3><ol><li><code>Promises</code>:<code>Promise</code>规范自身</li><li><code>promise</code>对象:<code>promise</code>对象指的是 <code>Promise</code> 实例对象</li><li><code>ES6 Promises</code>:如果想明确表示使用 <code>ECMAScript 6th Edition</code> 的话，可以使用<code>ES6</code>作为前缀（<code>prefix</code>）</li><li><code>Promises/A+</code>:这是<code>ES6 Promises</code>的前身，是一个社区规范，它和 <code>ES6 Promises</code> 有很多共通的内容。</li><li><code>Thenable</code>:类<code>Promise</code>对象。 拥有名为<code>.then</code>方法的对象。</li><li><code>promise chain</code>:指使用 <code>then</code> 或者 <code>catch</code> 方法将<code>promise</code>对象连接起来的行为。 此用语只是在本书中的说法，而不是在 <code>ES6 Promises</code> 中定义的官方用语。</li></ol><h3 id="Promise的实现类库"><a href="#Promise的实现类库" class="headerlink" title="Promise的实现类库"></a><code>Promise</code>的实现类库</h3><p>如果说一个类库兼容 <code>Promises/A+</code> 的话，那么就是说它除了具有标准的 <code>then</code> 方法之外，很多情况下也说明此类库还支持 <code>Promise.all</code> 和 <code>catch</code> 等功能。</p><p>但是 <code>Promises/A+</code> 实际上只是定义了关于 <code>Promise#then</code> 的规范，所以有些类库可能实现了其它诸如 <code>all</code> 或 <code>catch</code> 等功能，但是可能名字却不一样。</p><p>如果我们说一个类库具有 <code>then</code> 兼容性的话，实际上指的是 <code>Thenable</code> ，它通过使用 <code>Promise.resolve</code> 基于<code>ES6 Promise</code>的规定，进行<code>promise</code>对象的变换。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new Promise( <span class="keyword">function</span>(resolve, reject) &#123;...&#125; /* executor */  );</span><br></pre></td></tr></table></figure><p><code>Promise</code> 带有 <code>resolve</code> 和 <code>reject</code> 两个参数的函数;</p><p><code>resolve</code> 和 <code>reject</code> 函数被调用时，分别将 <code>promise</code> 的状态改为<code>fulfilled</code>（完成）或 <code>rejected</code>（失败）</p><h3 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h3><ul><li><code>Promise.length</code>:<code>length</code>属性，其值总是为 1 (构造器参数的数目).</li><li><code>Promise.prototype</code>:表示 <code>Promise</code> 构造器的原型.</li></ul><h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><ul><li><p><code>Promise.all(iterable)</code>:这个方法返回一个新的<code>promise</code>对象，该<code>promise</code>对象在<code>iterable</code>参数对象里所有的<code>promise</code>对象都成功的时候才会触发成功，一旦有任何一个<code>iterable</code>里面的<code>promise</code>对象失败则立即触发该<code>promise</code>对象的失败。</p><p>  这个新的<code>promise</code>对象在触发成功状态以后，会把一个包含<code>iterable</code>里所有<code>promise</code>返回值的数组作为成功回调的返回值，顺序跟<code>iterable</code>的顺序保持一致；</p><p>  如果这个新的<code>promise</code>对象触发了失败状态，它会把<code>iterable</code>里第一个触发失败的<code>promise</code>对象的错误信息作为它的失败错误信息</p><p>  <code>Promise.all</code>方法常被用于处理多个<code>promise</code>对象的状态集合</p></li><li><p><code>Promise.race(iterable)</code>:当<code>iterable</code>参数里的任意一个子<code>promise</code>被成功或失败后，父<code>promise</code>马上也会用子<code>promise</code>的成功返回值或失败详情作为参数调用父<code>promise</code>绑定的相应句柄，并返回该<code>promise</code>对象</p></li><li><p><code>Promise.reject(reason)</code>:返回一个状态为失败的<code>Promise</code>对象，并将给定的失败信息传递给对应的处理方法</p></li><li><p><code>Promise.resolve(value)</code>:返回一个状态由给定<code>value</code>决定的<code>Promise</code>对象</p><p>  如果该值是一个<code>Promise</code>对象，则直接返回该对象；</p><p>  如果该值是<code>thenable</code>(即，带有<code>then</code>方法的对象)，返回的<code>Promise</code>对象的最终状态由<code>then</code>方法执行决定；</p><p>  否则的话(该<code>value</code>为空，基本类型或者不带<code>then</code>方法的对象),返回的<code>Promise</code>对象状态为<code>fulfilled</code>，并且将该<code>value</code>传递给对应的<code>then</code>方法</p><p>  如果你不知道一个值是否是<code>Promise</code>对象，使用<code>Promise.resolve(value)</code> 来返回一个<code>Promise</code>对象,这样就能将该<code>value</code>以<code>Promise</code>对象形式使用。</p></li></ul><h3 id="Promise-原型"><a href="#Promise-原型" class="headerlink" title="Promise 原型"></a><code>Promise</code> 原型</h3><h4 id="Promise-prototype-constructor"><a href="#Promise-prototype-constructor" class="headerlink" title="Promise.prototype.constructor"></a><code>Promise.prototype.constructor</code></h4><p>返回被创建的实例函数.  默认为 <code>Promise</code> 函数.</p><h4 id="Promise-prototype-catch-onRejected"><a href="#Promise-prototype-catch-onRejected" class="headerlink" title="Promise.prototype.catch(onRejected)"></a><code>Promise.prototype.catch(onRejected)</code></h4><p>添加一个拒绝(<code>rejection</code>) 回调到当前 <code>promise</code>, 返回一个新的 <code>promise</code></p><p>当这个回调函数被调用，新<code> promise</code> 将以它的返回值来<code>resolve</code>;</p><p>否则如果当前<code>promise</code> 进入<code>fulfilled</code>状态，则以当前<code>promise</code>的完成结果作为新<code>promise</code>的完成结果.</p><h4 id="Promise-prototype-then-onFulfilled-onRejected"><a href="#Promise-prototype-then-onFulfilled-onRejected" class="headerlink" title="Promise.prototype.then(onFulfilled, onRejected)"></a><code>Promise.prototype.then(onFulfilled, onRejected)</code></h4><p>添加解决(<code>fulfillment</code>)和拒绝(<code>rejection</code>)回调到当前 <code>promise</code>, 返回一个新的 <code>promise</code>, 将以回调的返回值来 <code>resolve</code>.</p><h4 id="Promise-prototype-finally-onFinally"><a href="#Promise-prototype-finally-onFinally" class="headerlink" title="Promise.prototype.finally(onFinally)"></a><code>Promise.prototype.finally(onFinally)</code></h4><p>添加一个事件处理回调于当前<code>promise</code>对象，并且在原<code>promise</code>对象解析完毕后，返回一个新的<code>promise</code>对象</p><p>回调会在当前<code>promise</code>运行完毕后被调用，无论当前<code>promise</code>的状态是完成(<code>fulfilled</code>)还是失败(<code>rejected</code>)</p><h3 id="承诺源码"><a href="#承诺源码" class="headerlink" title="承诺源码"></a>承诺源码</h3><ol><li><a href="https://github.com/calvinmetcalf/lie">一个基础并高性能的承诺实现。</a></li><li><a href="https://github.com/calvinmetcalf/immediate#readme">immediate.js</a></li></ol><h3 id="代码片段1"><a href="#代码片段1" class="headerlink" title="代码片段1"></a>代码片段1</h3><p>此处的<code>PromiseA</code>等同于<code>Promise</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">PromiseA</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span>&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;开始测试&quot;</span>)</span><br><span class="line">        <span class="title function_">resolve</span>(<span class="string">&quot;1.小明&quot;</span>)</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">dir</span>(promise, &#123; <span class="attr">depth</span>: <span class="number">10</span> &#125;)</span><br><span class="line">promise.<span class="title function_">then</span>(<span class="function">(<span class="params">aVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> aVal+<span class="string">&quot;,&quot;</span>+<span class="string">&quot;2.小刚&quot;</span>;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">bVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> bVal+<span class="string">&quot;,&quot;</span>+<span class="string">&quot;3.小吃&quot;</span>;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">cVal</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(cVal)</span><br><span class="line">&#125;).<span class="title function_">finally</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;结束测试&quot;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>结果：<br><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180817190156.png" alt="image"></p><p><code>then</code> 方法可以被同一个 <code>promise</code> 调用多次</p><h3 id="代码片段-all与-race"><a href="#代码片段-all与-race" class="headerlink" title="代码片段 all与 race"></a>代码片段 <code>all</code>与 <code>race</code></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="title class_">PromiseA</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(resolve, <span class="number">500</span>, <span class="string">&#x27;大哥&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> p2= <span class="keyword">new</span> <span class="title class_">PromiseA</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(resolve, <span class="number">100</span>, <span class="string">&#x27;小弟&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> p3= <span class="title class_">PromiseA</span>.<span class="title function_">resolve</span>(<span class="string">&quot;大爷&quot;</span>);</span><br><span class="line"><span class="title class_">PromiseA</span>.<span class="title function_">all</span>([p1,p2,p3]).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">pArr</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;all&quot;</span>,pArr)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="title class_">PromiseA</span>.<span class="title function_">race</span>([p1,p2,p3]).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">p</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;race&quot;</span>,p)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>结果：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">race 大爷</span><br><span class="line">all [<span class="string">&quot;大哥&quot;</span>, <span class="string">&quot;小弟&quot;</span>, <span class="string">&quot;大爷&quot;</span>]0: <span class="string">&quot;大哥&quot;</span>1: <span class="string">&quot;小弟&quot;</span>2: <span class="string">&quot;大爷&quot;</span>]</span><br></pre></td></tr></table></figure><h3 id="源码代码"><a href="#源码代码" class="headerlink" title="源码代码"></a><a href="https://github.com/calvinmetcalf/lie">源码代码</a></h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * immediate是一个微任务库，来自NobleJS的 setImmediate，延迟执行</span></span><br><span class="line"><span class="comment"> * 把一些需要长时间运行的操作放在一个回调函数里、延迟执行</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> immediate = <span class="built_in">require</span>(<span class="string">&#x27;immediate&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代码覆盖率工具 Istanbul,</span></span><br><span class="line"><span class="comment"> * istanbul 提供注释语法，允许某些代码不计入覆盖率。</span></span><br><span class="line"><span class="comment"> * 忽略覆盖 、空函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* istanbul ignore next */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">INTERNAL</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 空对象 */</span></span><br><span class="line"><span class="keyword">var</span> handlers = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 定义 3 种状态</span></span><br><span class="line"><span class="comment"> * [REJECTED 操作失败]</span></span><br><span class="line"><span class="comment"> * [FULFILLED 操作成功]</span></span><br><span class="line"><span class="comment"> * [PENDING 初始状态，既不是成功，也不是失败状态]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">REJECTED</span> = [<span class="string">&#x27;REJECTED&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">FULFILLED</span> = [<span class="string">&#x27;FULFILLED&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">PENDING</span> = [<span class="string">&#x27;PENDING&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 忽略else路径 */</span></span><br><span class="line"><span class="comment">/* istanbul ignore else */</span></span><br><span class="line"><span class="keyword">if</span> (!process.<span class="property">browser</span>) &#123;</span><br><span class="line">    <span class="comment">// in which we actually take advantage of JS scoping</span></span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">UNHANDLED</span> = [<span class="string">&#x27;UNHANDLED&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">Promise</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [Promise构造函数]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">[Function]</span>&#125; resolver [函数]</span></span><br><span class="line"><span class="comment"> * new Promise(function resolver(resolve, reject) &#123;</span></span><br><span class="line"><span class="comment"> *      setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="comment"> *          resolve(&#x27;haha&#x27;)</span></span><br><span class="line"><span class="comment"> *      &#125;, 1000)</span></span><br><span class="line"><span class="comment"> * &#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Promise</span>(<span class="params">resolver</span>) &#123;</span><br><span class="line">    <span class="comment">/* resolver必须是一个函数 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> resolver !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;resolver must be a function&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = <span class="variable constant_">PENDING</span>;<span class="comment">//初始状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">queue</span> = [];<span class="comment">// promise 内部的回调队列</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">outcome</span> = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* 忽略if路径 */</span></span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (!process.<span class="property">browser</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">handled</span> = <span class="variable constant_">UNHANDLED</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Promise 构造函数传入了一个 INTERNAL 即空函数，因为这个新产生的 promise可以认为是内部的 promise；</span></span><br><span class="line"><span class="comment">     * 需要根据外部的 promise 的状态和值产生自身的状态和值，不需要传入回调函数，</span></span><br><span class="line"><span class="comment">     * 而外部Promise 需要传入回调函数决定它的状态和值。所以之前 Promise 的构造函数里做了判断区分外部</span></span><br><span class="line"><span class="comment">     * 调用还是内部调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (resolver !== <span class="variable constant_">INTERNAL</span>) &#123;</span><br><span class="line">        <span class="comment">/* 安全的执行 then 函数 */</span></span><br><span class="line">        <span class="title function_">safelyResolveThenable</span>(<span class="variable language_">this</span>, resolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * finally() 方法返回一个Promise，在执行then()和catch()后，都会执行finally指定的回调函数。避免同样的语句需要在then()和catch()中各写一次的情况。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">Function</span>&#125; callback [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;            [返回一个Promise]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">finally</span> = <span class="keyword">function</span>(<span class="params">callback</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback !== <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> p = <span class="variable language_">this</span>.<span class="property">constructor</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(resolve, reject);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">yes</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p.<span class="title function_">resolve</span>(<span class="title function_">callback</span>()).<span class="title function_">then</span>(yes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params">reason</span>) &#123;</span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">no</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> reason;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p.<span class="title function_">resolve</span>(<span class="title function_">callback</span>()).<span class="title function_">then</span>(no);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * catch() 方法返回一个Promise，并且处理拒绝的情况</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; onRejected [失败操作]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;            [返回一个Promise]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">catch</span> = <span class="keyword">function</span>(<span class="params">onRejected</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">then</span>(<span class="literal">null</span>, onRejected);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [then 原型方法]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; onFulfilled [then的 成功回调]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; onRejected  [then的 失败回调]</span></span><br><span class="line"><span class="comment"> * 生成了一个新的 promise 然后返回，符合规范要求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">then</span> = <span class="keyword">function</span>(<span class="params">onFulfilled, onRejected</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled !== <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">FULFILLED</span> ||</span><br><span class="line">        <span class="keyword">typeof</span> onRejected !== <span class="string">&#x27;function&#x27;</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">REJECTED</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>;<span class="comment">//实现了值穿透</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Promise 构造函数传入了一个 INTERNAL 即空函数，因为这个新产生的 promise 可以认为是内部的</span></span><br><span class="line"><span class="comment">     * promise;需要根据外部的 promise 的状态和值产生自身的状态和值，不需要传入回调函数，</span></span><br><span class="line"><span class="comment">     * 而外部Promise 需要传入回调函数决定它的状态和值;所以之前 Promise 的构造函数里做了判断区分外部</span></span><br><span class="line"><span class="comment">     * 调用还是内部调用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="variable language_">this</span>.<span class="title function_">constructor</span>(<span class="params">INTERNAL</span>);</span><br><span class="line">    <span class="comment">/* 覆盖测试忽略else路径 */</span></span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (!process.<span class="property">browser</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">handled</span> === <span class="variable constant_">UNHANDLED</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">handled</span> = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span> !== <span class="variable constant_">PENDING</span>) &#123;</span><br><span class="line">        <span class="comment">//state状态改变、根据状态返回成功或失败回调、则调用 unwrap</span></span><br><span class="line">        <span class="keyword">var</span> resolver = <span class="variable language_">this</span>.<span class="property">state</span> === <span class="variable constant_">FULFILLED</span> ? onFulfilled : onRejected;</span><br><span class="line">        <span class="comment">//传入内部承诺、</span></span><br><span class="line">        <span class="title function_">unwrap</span>(promise, resolver, <span class="variable language_">this</span>.<span class="property">outcome</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//将生成的 promise 加入到当前 promise 的队列 queue 里</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">queue</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">QueueItem</span>(promise, onFulfilled, onRejected));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [QueueItem 承诺队列]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">[type]</span>&#125; promise     [promise 为 then 生成的新 promise/子承诺]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">[type]</span>&#125; onFulfilled [then 参数中的 onFulfilled]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type">[type]</span>&#125; onRejected  [then 参数中的 onRejected]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">QueueItem</span>(<span class="params">promise, onFulfilled, onRejected</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">promise</span> = promise;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> onFulfilled === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onFulfilled</span> = onFulfilled;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callFulfilled</span> = <span class="variable language_">this</span>.<span class="property">otherCallFulfilled</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> onRejected === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">onRejected</span> = onRejected;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">callRejected</span> = <span class="variable language_">this</span>.<span class="property">otherCallRejected</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//承诺成功调用</span></span><br><span class="line"><span class="title class_">QueueItem</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">callFulfilled</span> = <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    handlers.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">promise</span>, value);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//用 otherCallFulfilled 调用 unwrap 进行解包最终得出子 promise 的状态和值</span></span><br><span class="line"><span class="title class_">QueueItem</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">otherCallFulfilled</span> = <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="title function_">unwrap</span>(<span class="variable language_">this</span>.<span class="property">promise</span>, <span class="variable language_">this</span>.<span class="property">onFulfilled</span>, value);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//承诺失败调用</span></span><br><span class="line"><span class="title class_">QueueItem</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">callRejected</span> = <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    handlers.<span class="title function_">reject</span>(<span class="variable language_">this</span>.<span class="property">promise</span>, value);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//用 otherCallRejected 调用 unwrap 进行解包最终得出子 promise 的状态和值</span></span><br><span class="line"><span class="title class_">QueueItem</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">otherCallRejected</span> = <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="title function_">unwrap</span>(<span class="variable language_">this</span>.<span class="property">promise</span>, <span class="variable language_">this</span>.<span class="property">onRejected</span>, value);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [unwrap 解包函数(即执行函数)、]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; promise [子 promise/内部承诺]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; func    [父 promise 的 then 的回调（onFulfilled/onRejected）]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; value   [父 promise 的值（正常值/错误）]</span></span><br><span class="line"><span class="comment"> * immediate 是 立即激活回调，然后等待后续事件在一定时间内触发。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">unwrap</span>(<span class="params">promise, func, value</span>) &#123;</span><br><span class="line">    <span class="comment">//把一些需要长时间运行的操作放在一个回调函数里、延迟执行、将代码装换成异步代码</span></span><br><span class="line">    <span class="title function_">immediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> returnValue;</span><br><span class="line">        <span class="comment">//捕获 then/catch 内抛出的异常，并调用 handlers.reject</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//执行父 promise 的 then 的回调（onFulfilled/onRejected），并传入父 promise 的值（正常值/错误）</span></span><br><span class="line">            returnValue = <span class="title function_">func</span>(value);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="keyword">return</span> handlers.<span class="title function_">reject</span>(promise, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//返回的值不能是 内部promise 本身，否则会造成死循环</span></span><br><span class="line">        <span class="keyword">if</span> (returnValue === promise) &#123;</span><br><span class="line">            <span class="comment">//调用拒绝</span></span><br><span class="line">            handlers.<span class="title function_">reject</span>(promise, <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;Cannot resolve promise with itself&#x27;</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//调用拒成功</span></span><br><span class="line">            handlers.<span class="title function_">resolve</span>(promise, returnValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [resolve description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; self  [promise]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; value [父承诺的值]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;       [返回自身]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">handlers.<span class="property">resolve</span> = <span class="keyword">function</span>(<span class="params">self, value</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="title function_">tryCatch</span>(getThen, value);</span><br><span class="line">    <span class="comment">//有错误则执行 handlers.reject</span></span><br><span class="line">    <span class="keyword">if</span> (result.<span class="property">status</span> === <span class="string">&#x27;error&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> handlers.<span class="title function_">reject</span>(self, result.<span class="property">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> thenable = result.<span class="property">value</span>;</span><br><span class="line">    <span class="comment">//如果返回值存在</span></span><br><span class="line">    <span class="keyword">if</span> (thenable) &#123;</span><br><span class="line">        <span class="comment">/* 安全的执行 then 函数 */</span></span><br><span class="line">        <span class="title function_">safelyResolveThenable</span>(self, thenable);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        self.<span class="property">state</span> = <span class="variable constant_">FULFILLED</span>;</span><br><span class="line">        self.<span class="property">outcome</span> = value;</span><br><span class="line">        <span class="keyword">var</span> i = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">var</span> len = self.<span class="property">queue</span>.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">while</span> (++i &lt; len) &#123;</span><br><span class="line">            self.<span class="property">queue</span>[i].<span class="title function_">callFulfilled</span>(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//操作失败</span></span><br><span class="line">handlers.<span class="property">reject</span> = <span class="keyword">function</span>(<span class="params">self, error</span>) &#123;</span><br><span class="line">    self.<span class="property">state</span> = <span class="variable constant_">REJECTED</span>;</span><br><span class="line">    self.<span class="property">outcome</span> = error;</span><br><span class="line">    <span class="comment">/* 覆盖测试忽略else路径 */</span></span><br><span class="line">    <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">    <span class="keyword">if</span> (!process.<span class="property">browser</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (self.<span class="property">handled</span> === <span class="variable constant_">UNHANDLED</span>) &#123;</span><br><span class="line">            <span class="title function_">immediate</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (self.<span class="property">handled</span> === <span class="variable constant_">UNHANDLED</span>) &#123;</span><br><span class="line">                    process.<span class="title function_">emit</span>(<span class="string">&#x27;unhandledRejection&#x27;</span>, error, self);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> i = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> len = self.<span class="property">queue</span>.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">while</span> (++i &lt; len) &#123;</span><br><span class="line">        self.<span class="property">queue</span>[i].<span class="title function_">callRejected</span>(error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> self;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getThen 辅助函数 getThen]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; obj [值或承诺]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;     [description]</span></span><br><span class="line"><span class="comment"> * 规范中规定：如果 then 是函数，这里是 obj作为函数的 this 调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getThen</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="comment">// Make sure we only access the accessor once as required by the spec</span></span><br><span class="line">    <span class="keyword">var</span> then = obj &amp;&amp; obj.<span class="property">then</span>;</span><br><span class="line">    <span class="comment">//只有obj是一个对象或函数并且含有的属性then是函数，如obj是一个承诺</span></span><br><span class="line">    <span class="keyword">if</span> (obj &amp;&amp; (<span class="keyword">typeof</span> obj === <span class="string">&#x27;object&#x27;</span> || <span class="keyword">typeof</span> obj === <span class="string">&#x27;function&#x27;</span>) &amp;&amp; <span class="keyword">typeof</span> then === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">        <span class="comment">//返回解包函数类似tryToUnwrap</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">appyThen</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="comment">//执行then方法，这里 obj 作为函数的 this 调用。</span></span><br><span class="line">            then.<span class="title function_">apply</span>(obj, <span class="variable language_">arguments</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [safelyResolveThenable 安全的执行 then 函数]</span></span><br><span class="line"><span class="comment"> * 构造函数的参数resolver，即这里的 thenable</span></span><br><span class="line"><span class="comment"> * new Promise(function resolver(resolve, reject) &#123;</span></span><br><span class="line"><span class="comment"> *      setTimeout(() =&gt; &#123;</span></span><br><span class="line"><span class="comment"> *          resolve(&#x27;haha&#x27;)</span></span><br><span class="line"><span class="comment"> *      &#125;, 1000)</span></span><br><span class="line"><span class="comment"> * &#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">safelyResolveThenable</span>(<span class="params">self, thenable</span>) &#123;</span><br><span class="line">    <span class="comment">// Either fulfill, reject or reject with error</span></span><br><span class="line">    <span class="keyword">var</span> called = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 失败调用 */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">onError</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (called) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        called = <span class="literal">true</span>;</span><br><span class="line">        handlers.<span class="title function_">reject</span>(self, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 成功调用 */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">onSuccess</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (called) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        called = <span class="literal">true</span>;</span><br><span class="line">        handlers.<span class="title function_">resolve</span>(self, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//捕获并解包函数</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">tryToUnwrap</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">//执行传进来的函数</span></span><br><span class="line">        <span class="title function_">thenable</span>(onSuccess, onError);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行并返回结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> result = <span class="title function_">tryCatch</span>(tryToUnwrap);</span><br><span class="line">    <span class="comment">//如果抛出异常、则调用onError里的handlers.reject</span></span><br><span class="line">    <span class="keyword">if</span> (result.<span class="property">status</span> === <span class="string">&#x27;error&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">onError</span>(result.<span class="property">value</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [tryCatch 捕获抛出的异常]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[Function]</span>&#125; func  [then函数]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; value [父函数then返回的值]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[Object]</span>&#125;       [返回执行结果]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tryCatch</span>(<span class="params">func, value</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> out = &#123;&#125;;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//执行then函数,传入父then返回的值</span></span><br><span class="line">        out.<span class="property">value</span> = <span class="title function_">func</span>(value);</span><br><span class="line">        out.<span class="property">status</span> = <span class="string">&#x27;success&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        out.<span class="property">status</span> = <span class="string">&#x27;error&#x27;</span>;</span><br><span class="line">        out.<span class="property">value</span> = e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态方法成功</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="property">resolve</span> = resolve;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="comment">//Promise.resolve 参数是一个 promise 时，直接返回该值</span></span><br><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> <span class="variable language_">this</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//传入新的承诺</span></span><br><span class="line">    <span class="keyword">return</span> handlers.<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title function_">this</span>(<span class="variable constant_">INTERNAL</span>), value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态方法失败</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="property">reject</span> = reject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params">reason</span>) &#123;</span><br><span class="line">    <span class="comment">//传入新的承诺</span></span><br><span class="line">    <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title function_">this</span>(<span class="variable constant_">INTERNAL</span>);</span><br><span class="line">    <span class="keyword">return</span> handlers.<span class="title function_">reject</span>(promise, reason);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="property">all</span> = all;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [此实例在 iterable 参数内所有的 promise 都“完成（resolved）”或参数中不包含 promise 时回调完成（resolve）；如果参数中  promise 有一个失败（rejected），此实例回调失败（reject），失败原因的是第一个失败 promise 的结果。]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[Array]</span>&#125; iterable [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;          [返回一个 Promise 实例]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">all</span>(<span class="params">iterable</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(iterable) !== <span class="string">&#x27;[object Array]&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;must be an array&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> len = iterable.<span class="property">length</span>;</span><br><span class="line">    <span class="comment">//called 用来控制即使有多个 promise reject 也只有第一个生效</span></span><br><span class="line">    <span class="keyword">var</span> called = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">resolve</span>([]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//values 用来存储结果</span></span><br><span class="line">    <span class="keyword">var</span> values = <span class="keyword">new</span> <span class="title class_">Array</span>(len);</span><br><span class="line">    <span class="keyword">var</span> resolved = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> i = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">//生成新承诺</span></span><br><span class="line">    <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title function_">this</span>(<span class="variable constant_">INTERNAL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//循环处理所有的</span></span><br><span class="line">    <span class="keyword">while</span> (++i &lt; len) &#123;</span><br><span class="line">        <span class="title function_">allResolver</span>(iterable[i], i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">allResolver</span>(<span class="params">value, i</span>) &#123;</span><br><span class="line">        self.<span class="title function_">resolve</span>(value).<span class="title function_">then</span>(resolveFromAll, <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!called) &#123;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line">                handlers.<span class="title function_">reject</span>(promise, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">function</span> <span class="title function_">resolveFromAll</span>(<span class="params">outValue</span>) &#123;</span><br><span class="line">            values[i] = outValue;</span><br><span class="line">            <span class="keyword">if</span> (++resolved === len &amp;&amp; !called) &#123;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line">                handlers.<span class="title function_">resolve</span>(promise, values);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="property">race</span> = race;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Promise.race(iterable) 方法返回一个 promise，一旦迭代器中的某个promise解决或拒绝，返回的 promise就会解决或拒绝。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[Array]</span>&#125; iterable [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;          [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">race</span>(<span class="params">iterable</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> self = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(iterable) !== <span class="string">&#x27;[object Array]&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&#x27;must be an array&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> len = iterable.<span class="property">length</span>;</span><br><span class="line">    <span class="comment">/* called 控制只要有任何一个 promise onFulfilled/onRejected 立即去设置 promise 的状态和值。*/</span></span><br><span class="line">    <span class="keyword">var</span> called = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!len) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">resolve</span>([]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> i = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">//生成一个新的承诺</span></span><br><span class="line">    <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title function_">this</span>(<span class="variable constant_">INTERNAL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (++i &lt; len) &#123;</span><br><span class="line">        <span class="title function_">resolver</span>(iterable[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">resolver</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        self.<span class="title function_">resolve</span>(value).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">response</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!called) &#123;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line">                handlers.<span class="title function_">resolve</span>(promise, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!called) &#123;</span><br><span class="line">                called = <span class="literal">true</span>;</span><br><span class="line">                handlers.<span class="title function_">reject</span>(promise, error);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考注释"><a href="#参考注释" class="headerlink" title="参考注释"></a>参考注释</h2><ul><li>平台代码指的是引擎、环境以及 <code>promise</code> 的实施代码。实践中要确保 <code>onFulfilled</code> 和 <code>onRejected</code> 方法异步执行，且应该在 <code>then</code> 方法被调用的那一轮事件循环之后的新执行栈中执行。这个事件队列可以采用“宏任务（<code>macro-task</code>）”机制或者“微任务（<code>micro-task</code>）”机制来实现。由于 <code>promise</code> 的实施代码本身就是平台代码（译者注：即都是 <code>JavaScript</code>），故代码自身在处理在处理程序时可能已经包含一个任务调度队列。</li></ul><p><code>macrotask</code> 和 <code>microtask</code> 两个概念，这表示异步任务的两种分类。在挂起任务时，<code>JS</code> 引擎会将所有任务按照类别分到这两个队列中，首先在 macrotask 的队列（这个队列也被叫做 <code>task queue</code>）中取出第一个任务，执行完毕后取出 <code>microtask</code> 队列中的所有任务顺序执行；之后再取 <code>macrotask</code> 任务，周而复始，直至两个队列的任务都取完。</p><p>两个类别的具体分类如下:</p><ol><li><code>macro-task:</code> script（整体代码）,<code>setTimeout</code>, <code>setInterval</code>, <code>setImmediate</code>,<code>I/O</code>, <code>UI rendering</code></li><li><code>micro-task:</code> <code>process.nextTick</code>, <code>Promises</code>（这里指浏览器实现的原生 <code>Promise</code>）, <code>Object.observe</code>, <code>MutationObserver</code></li></ol><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="http://wiki.commonjs.org/wiki/Promises/A"> Promise&#x2F;A 规范 </a></li><li><a href="https://zhuanlan.zhihu.com/p/25178630">深入 Promise(一)——Promise 实现详解</a></li><li><a href="https://github.com/azu/promises-book">Promises Book</a></li><li><a href="http://www.ituring.com.cn/article/66566">翻译Promises&#x2F;A+规范</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Promises&quot;&gt;&lt;a href=&quot;#Promises&quot; class=&quot;headerlink&quot; title=&quot;Promises&quot;&gt;&lt;/a&gt;Promises&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Promise &lt;/code&gt;表示一个异步操作的最终结果，与之进行交互的方式主要是 then 方法，该方法注册了两个回调函数，用于接收 promise 的终值或本 promise 不能执行的原因。&lt;/p&gt;
&lt;p&gt;一个 Promise有以下几种状态:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;pending:&lt;/code&gt; 初始状态，既不是成功，也不是失败状态。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;fulfilled:&lt;/code&gt; 意味着操作成功完成。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;rejected:&lt;/code&gt; 意味着操作失败。&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;Promise&lt;/code&gt; 本质是一个状态机。每个 &lt;code&gt;promise&lt;/code&gt; 只能是 3 种状态中的一种：&lt;code&gt;pending、fulfilled&lt;/code&gt; 或 &lt;code&gt;rejected&lt;/code&gt;。状态转变只能是 &lt;code&gt;pending -&amp;gt; fulfilled&lt;/code&gt; 或者 &lt;code&gt;pending -&amp;gt; rejected&lt;/code&gt;。状态转变不可逆。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;then&lt;/code&gt; 方法可以被同一个 &lt;code&gt;promise&lt;/code&gt; 调用多次。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;then&lt;/code&gt; 方法必须返回一个 &lt;code&gt;promise&lt;/code&gt; 。规范里没有明确说明返回一个新的 promise 还是复用老的 &lt;code&gt;promise&lt;/code&gt;（即 return this），大多数实现都是返回一个新的 &lt;code&gt;promise&lt;/code&gt; ，而且复用老的 &lt;code&gt;promise&lt;/code&gt; 可能改变内部状态，这与规范也是相违背的。&lt;/li&gt;
&lt;li&gt;值穿透(上一个&lt;code&gt;promise&lt;/code&gt;传递过来的值，经由这个&lt;code&gt;then&lt;/code&gt;方法的时候不做任何处理，而是交给再下个&lt;code&gt;then&lt;/code&gt;方法去处理)。&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="javascript" scheme="https://nightme.github.io/categories/javascript/"/>
    
    
      <category term="javascript" scheme="https://nightme.github.io/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>面向对象-继承</title>
    <link href="https://nightme.github.io/2018/04/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1-%E7%BB%A7%E6%89%BF/"/>
    <id>https://nightme.github.io/2018/04/07/面向对象-继承/</id>
    <published>2018-04-07T15:02:06.000Z</published>
    <updated>2025-09-19T04:25:12.114Z</updated>
    
    <content type="html"><![CDATA[<h2 id="原型链"><a href="#原型链" class="headerlink" title="原型链"></a>原型链</h2><p><code>JavaScript</code>主要通过原型链实现继承。原型链的构建是通过将一个类型的实例赋值给另一个构造函数的原型实现的</p><h3 id="内部指针-proto"><a href="#内部指针-proto" class="headerlink" title="内部指针__proto__"></a>内部指针<code>__proto__</code></h3><ol><li>遵循ECMAScript标准，<code>someObject.[[Prototype]]</code> 符号是用于指向 <code>someObject</code>的原型;</li><li>这个等同于 <code>JavaScript</code> 的非标准但许多浏览器实现的属性 <code>__proto__</code>;</li><li>从 ECMAScript 6 开始，<code>[[Prototype]]</code> 可以通过<code>Object.getPrototypeOf()</code>和<code>Object.setPrototypeOf()</code>访问器来访问;</li><li>但它不应该与构造函数 <code>func</code> 的 <code>prototype</code> 属性相混淆</li><li>被构造函数创建的实例对象的 <code>[[prototype]]</code> 指向 <code>func</code> 的 <code>prototype</code> 属性。</li><li><code>Object.prototype</code> 属性表示<code>Object</code>的原型对象。</li></ol><span id="more"></span><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180402215543.png" alt="image"></p><p>JavaScript 对象有一个私有属性（称之为 <code>[[Prototype]]</code>）,它指向它的 原型对象（<code>prototype</code>）;</p><p>该 <code>prototype</code>对象 又具有一个自己的 <code>prototype</code>,层层向上直到一个对象的原型为 <code>null</code>,</p><p>根据定义，<code>null</code> 没有原型，并作为这个原型链中的最后一个环节</p><h2 id="两种继承方式"><a href="#两种继承方式" class="headerlink" title="两种继承方式"></a>两种继承方式</h2><ul><li>接口继承:只继承方法签名(由于函数没有签名，<code>ECMAScript</code>无法实现此继承)</li><li>实现继承:继承实际方法(ECMAScript只支持实现继承)</li></ul><h3 id="实现继承的方法"><a href="#实现继承的方法" class="headerlink" title="实现继承的方法"></a>实现继承的方法</h3><p>将原型链作为实现继承的方法。</p><p>基本思想：利用原型让一个引用类型继承另一个引用类型的属性和方法</p><h3 id="JavaScript中的类-class-继承"><a href="#JavaScript中的类-class-继承" class="headerlink" title="JavaScript中的类(class)继承"></a>JavaScript中的类(class)继承</h3><ol><li>构造函数内的,这是供实例化对象复制用的</li><li>构造函数外的，直接通过点语法添加的，这是供类使用，实例化对象是访问不到的</li><li>类的原型中，实例化对象可以通过其原型链间接访问到，也是为供所有实例化对象所共用的</li></ol><h2 id="类式继承-子类的原型对象"><a href="#类式继承-子类的原型对象" class="headerlink" title="类式继承(子类的原型对象)"></a>类式继承(子类的原型对象)</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明父类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SuperClass</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">supperValue</span> = <span class="literal">true</span>;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">books</span> = [<span class="string">&quot;大数据&quot;</span>,<span class="string">&quot;人工智能&quot;</span>,<span class="string">&quot;区块链&quot;</span>,<span class="string">&quot;Kubernetes&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为父类添加共有方法</span></span><br><span class="line"><span class="title class_">SuperClass</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getSuperValue</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">supperValue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明子类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SubClass</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">subValue</span> = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//继承父类</span></span><br><span class="line"><span class="title class_">SubClass</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="keyword">new</span> <span class="title class_">SuperClass</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//为子类添加共有方法</span></span><br><span class="line"><span class="title class_">SubClass</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getSubValue</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">subValue</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************测试代码****************************************/</span></span><br><span class="line"><span class="keyword">var</span> instance1 = <span class="keyword">new</span> <span class="title class_">SubClass</span>();</span><br><span class="line"><span class="keyword">var</span> instance2 = <span class="keyword">new</span> <span class="title class_">SubClass</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance2.<span class="property">books</span>);<span class="comment">//[&quot;大数据,&quot;人工智能&quot;,&quot;区块链&quot;,&quot;Kubernetes&quot;]</span></span><br><span class="line"></span><br><span class="line">instance1.<span class="property">books</span>.<span class="title function_">push</span>(<span class="string">&quot;Docker&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance2.<span class="property">books</span>);<span class="comment">//[&quot;大数据&quot;,&quot;人工智能&quot;,&quot;区块链&quot;,&quot;Kubernetes&quot;,&quot;Docker&quot;]</span></span><br></pre></td></tr></table></figure><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ol><li><code>instance1</code>的修改伤害了<code>instance2</code>的<code>books</code>属性</li><li>创建父类的时候，无法向父类传参数，，也因此无法对父类的构造函数内的属性进行初始化</li></ol><h2 id="构造函数继承"><a href="#构造函数继承" class="headerlink" title="构造函数继承"></a>构造函数继承</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明父类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SuperClass</span>(<span class="params">id</span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">id</span> = id;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">books</span> = [<span class="string">&quot;大数据&quot;</span>,<span class="string">&quot;人工智能&quot;</span>,<span class="string">&quot;区块链&quot;</span>,<span class="string">&quot;Kubernetes&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为父类添加共有方法</span></span><br><span class="line"><span class="title class_">SuperClass</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getBooks</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">books</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明子类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SubClass</span>(<span class="params">id</span>)&#123;</span><br><span class="line">  <span class="comment">//继承父类</span></span><br><span class="line">  <span class="title class_">SuperClass</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>,id)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************测试代码********************************/</span></span><br><span class="line"><span class="keyword">var</span> instance1 = <span class="keyword">new</span> <span class="title class_">SubClass</span>(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">var</span> instance2 = <span class="keyword">new</span> <span class="title class_">SubClass</span>(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">instance1.<span class="property">books</span>.<span class="title function_">push</span>(<span class="string">&quot;Docker&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance1.<span class="property">books</span>);<span class="comment">//[&quot;大数据&quot;,&quot;人工智能&quot;,&quot;区块链&quot;,&quot;Kubernetes&quot;,&quot;Docker&quot;]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance1.<span class="property">id</span>);<span class="comment">//10</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance2.<span class="property">books</span>);<span class="comment">//[&quot;大数据,&quot;人工智能&quot;,&quot;区块链&quot;,&quot;Kubernetes&quot;]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance2.<span class="property">id</span>);<span class="comment">//20</span></span><br><span class="line"></span><br><span class="line">instance1.<span class="title function_">getBooks</span>();<span class="comment">//Uncaught TypeError: instance1.getBooks is not a function</span></span><br></pre></td></tr></table></figure><h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ol><li>这种类型的继承没有涉及原型<code>prototype</code>,所以父类的原型方法不会被继承</li><li>如果想要被子类继承，就必须放在构造函数中，这样创建出来的每个实例都会单独拥有一份，而不能共用。违背了代码复用原则。</li></ol><h2 id="组合继承"><a href="#组合继承" class="headerlink" title="组合继承"></a>组合继承</h2><p>类式继承同构造函数继承组合使用</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//声明父类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SuperClass</span>(<span class="params">name</span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">books</span> = [<span class="string">&quot;大数据&quot;</span>,<span class="string">&quot;人工智能&quot;</span>,<span class="string">&quot;区块链&quot;</span>,<span class="string">&quot;Kubernetes&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//为父类添加共有方法</span></span><br><span class="line"><span class="title class_">SuperClass</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getName</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">   <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//声明子类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SubClass</span>(<span class="params">name,time</span>)&#123;</span><br><span class="line">  <span class="comment">//继承父类</span></span><br><span class="line">  <span class="title class_">SuperClass</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>,name);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">time</span> = time;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//类式继承，子类原型继承父类</span></span><br><span class="line"><span class="title class_">SubClass</span>.<span class="property"><span class="keyword">prototype</span></span> = <span class="keyword">new</span> <span class="title class_">SuperClass</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//为子类添加共有方法</span></span><br><span class="line"><span class="title class_">SubClass</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getTime</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">time</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> instance1 = <span class="keyword">new</span> <span class="title class_">SubClass</span>(<span class="string">&quot;软件工程&quot;</span>,<span class="number">2014</span>);</span><br><span class="line">instance1.<span class="property">books</span>.<span class="title function_">push</span>(<span class="string">&quot;Docker&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance1.<span class="property">books</span>);<span class="comment">//[&quot;大数据&quot;,&quot;人工智能&quot;,&quot;区块链&quot;,&quot;Kubernetes&quot;,&quot;Docker&quot;]</span></span><br><span class="line">instance1.<span class="title function_">getName</span>();<span class="comment">//软件工程</span></span><br><span class="line">instance1.<span class="title function_">getTime</span>();<span class="comment">//2014</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> instance2 = <span class="keyword">new</span> <span class="title class_">SubClass</span>(<span class="string">&quot;计算机与科学技术&quot;</span>,<span class="number">2015</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance2.<span class="property">books</span>);<span class="comment">//[&quot;大数据,&quot;人工智能&quot;,&quot;区块链&quot;,&quot;Kubernetes&quot;]</span></span><br><span class="line">instance2.<span class="title function_">getName</span>();<span class="comment">//计算机与科学技术</span></span><br><span class="line">instance2.<span class="title function_">getTime</span>();<span class="comment">//2015</span></span><br></pre></td></tr></table></figure><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ol><li>子类的实例中更改父类继承下来的引用类型，不会影响其他实例</li><li>子类实例化过程又能将参传递到父类的构造函数</li></ol><h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><ol><li>使用构造函数继承时执行了一遍父类构的造函数，而实现子类原型的类式继承时又调用了一遍父类构造函数。因此构造函数调用了两遍</li></ol><h2 id="原型式继承"><a href="#原型式继承" class="headerlink" title="原型式继承"></a>原型式继承</h2><ol><li><p>要求必须有一个对象可以作为另一个对象的基础</p></li><li><p>本质是对传入的对象执行了一次浅复制</p></li><li><p>是对类式继承的封装，类式继承中的问题在这里也会出现。</p></li><li><p>其中的过度对象就相当于类式继承中的子类，在这里作为一个对象出现</p></li><li><p>目的为了创建要返回的新实例化对象</p></li><li><p><code>ES5</code>的<code>Object.create()</code>的方法规范了化了原型式继承</p></li><li><p>在传入一个参数的情况下与<code>ES5</code>的<code>Object.create()</code>与<code>inheritObject</code>方法行为类似</p></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//原型式继承</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">inheritObject</span>(<span class="params">o</span>)&#123;</span><br><span class="line">  <span class="comment">//声明过度函数对象</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">F</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">  <span class="comment">//过度对象的原型继承父对象</span></span><br><span class="line">  F.<span class="property"><span class="keyword">prototype</span></span> = o;</span><br><span class="line">  <span class="comment">//返回过渡对象的一个实例，该实例的原型继承了父对象</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">F</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> book = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;小明&quot;</span>,</span><br><span class="line">  <span class="attr">alikeBook</span>:[<span class="string">&quot;C语言&quot;</span>,<span class="string">&quot;c++程序设计&quot;</span>,<span class="string">&quot;java程序设计&quot;</span>,<span class="string">&quot;数据结构&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person1 = <span class="title function_">inheritObject</span>(book);</span><br><span class="line">person1.<span class="property">name</span> = <span class="string">&quot;小刚&quot;</span>;</span><br><span class="line">person1.<span class="property">alikeBook</span>.<span class="title function_">push</span>(<span class="string">&quot;sql server数据库&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person2 = <span class="title function_">inheritObject</span>(book);</span><br><span class="line">person2.<span class="property">name</span> = <span class="string">&quot;小花&quot;</span>;</span><br><span class="line">person2.<span class="property">alikeBook</span>.<span class="title function_">push</span>(<span class="string">&quot;Android程序开发&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person1.<span class="property">name</span>);<span class="comment">//小刚</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person1.<span class="property">alikeBook</span>);<span class="comment">//[&quot;C语言&quot;, &quot;c++程序设计&quot;, &quot;java程序设计&quot;, &quot;数据结构&quot;, &quot;sql server数据库&quot;, &quot;Android程序开发&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person2.<span class="property">name</span>);<span class="comment">//小花</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person2.<span class="property">alikeBook</span>);<span class="comment">//[&quot;C语言&quot;, &quot;c++程序设计&quot;, &quot;java程序设计&quot;, &quot;数据结构&quot;, &quot;sql server数据库&quot;, &quot;Android程序开发&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(book.<span class="property">name</span>);<span class="comment">//小明</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(book.<span class="property">alikeBook</span>);<span class="comment">//[&quot;C语言&quot;, &quot;c++程序设计&quot;, &quot;java程序设计&quot;, &quot;数据结构&quot;, &quot;sql server数据库&quot;, &quot;Android程序开发&quot;]</span></span><br></pre></td></tr></table></figure><h3 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h3><ol><li>类式继承中的问题在这里出现，引用类型的属性被共用</li></ol><h2 id="寄生式继承"><a href="#寄生式继承" class="headerlink" title="寄生式继承"></a>寄生式继承</h2><ul><li>寄生式继承是对原型式继承的第二次封装，第二次对继承对象进行拓展</li><li>创建的对象不仅仅有父类的属性和方法，而且还添加新的属性和方法</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原型式继承</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">inheritObject</span>(<span class="params">o</span>)&#123;</span><br><span class="line">  <span class="comment">//声明过度函数对象</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">F</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">  <span class="comment">//过度对象的原型继承父对象</span></span><br><span class="line">  F.<span class="property"><span class="keyword">prototype</span></span> = o;</span><br><span class="line">  <span class="comment">//返回过渡对象的一个实例，该实例的原型继承了父对象</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">F</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//寄生式继承</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createBook</span>(<span class="params">obj</span>)&#123;</span><br><span class="line">    <span class="comment">//通过原型继承方式创建新对象</span></span><br><span class="line">    <span class="keyword">var</span> clone = <span class="title function_">inheritObject</span>(obj);</span><br><span class="line">    clone.<span class="property">getName</span> = <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clone;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> book = &#123;</span><br><span class="line">  <span class="attr">name</span>:<span class="string">&quot;小明&quot;</span>,</span><br><span class="line">  <span class="attr">alikeBook</span>:[<span class="string">&quot;C语言&quot;</span>,<span class="string">&quot;c++程序设计&quot;</span>,<span class="string">&quot;java程序设计&quot;</span>,<span class="string">&quot;数据结构&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person1 = <span class="title function_">createBook</span>(book);</span><br><span class="line"></span><br><span class="line">person1.<span class="property">name</span> = <span class="string">&quot;小刚&quot;</span>;</span><br><span class="line">person1.<span class="property">alikeBook</span>.<span class="title function_">push</span>(<span class="string">&quot;sql server数据库&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person2 = <span class="title function_">createBook</span>(book);</span><br><span class="line">person2.<span class="property">name</span> = <span class="string">&quot;小花&quot;</span>;</span><br><span class="line">person2.<span class="property">alikeBook</span>.<span class="title function_">push</span>(<span class="string">&quot;Android程序开发&quot;</span>);</span><br><span class="line"></span><br><span class="line">person1.<span class="title function_">getName</span>();<span class="comment">//小刚</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person1.<span class="property">alikeBook</span>);<span class="comment">//[&quot;C语言&quot;, &quot;c++程序设计&quot;, &quot;java程序设计&quot;, &quot;数据结构&quot;, &quot;sql server数据库&quot;, &quot;Android程序开发&quot;]</span></span><br><span class="line"></span><br><span class="line">person2.<span class="title function_">getName</span>();<span class="comment">//小花</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(person2.<span class="property">alikeBook</span>);<span class="comment">//[&quot;C语言&quot;, &quot;c++程序设计&quot;, &quot;java程序设计&quot;, &quot;数据结构&quot;, &quot;sql server数据库&quot;, &quot;Android程序开发&quot;]</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(book.<span class="property">name</span>);<span class="comment">//小明</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(book.<span class="property">alikeBook</span>);<span class="comment">//[&quot;C语言&quot;, &quot;c++程序设计&quot;, &quot;java程序设计&quot;, &quot;数据结构&quot;, &quot;sql server数据库&quot;, &quot;Android程序开发&quot;]</span></span><br></pre></td></tr></table></figure><h3 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h3><ol><li>使用寄生式继承来为对象添加函数，会由于不能做到函数复用而降低效率，这一点与构造函数模式类似</li></ol><h2 id="寄生组合式继承"><a href="#寄生组合式继承" class="headerlink" title="寄生组合式继承"></a>寄生组合式继承</h2><p>对子类原型的处理，被赋予了父类原型的一个引用，这是一个对象。</p><p><strong>注意：</strong> 子类再想添加原型方法必须通过<code>prototype.</code>对象，通过点语法的形式一个一个添加方法，否则直接赋予对象就会覆盖掉从父类原型继承的对象</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原型式继承</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">inheritObject</span>(<span class="params">o</span>)&#123;</span><br><span class="line">  <span class="comment">//声明过度函数对象</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">F</span>(<span class="params"></span>)&#123;&#125;</span><br><span class="line">  <span class="comment">//过度对象的原型继承父对象</span></span><br><span class="line">  F.<span class="property"><span class="keyword">prototype</span></span> = o;</span><br><span class="line">  <span class="comment">//返回过渡对象的一个实例，该实例的原型继承了父对象</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title function_">F</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 寄生式继承 继承原型</span></span><br><span class="line"><span class="comment">// 传递参数 subClass 子类</span></span><br><span class="line"><span class="comment">// 传递参数 superClass 父类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">inheritPrototype</span>(<span class="params">subClass,superClass</span>)&#123;</span><br><span class="line">  <span class="comment">//复制父类的原型副本保存在变量中</span></span><br><span class="line">  <span class="keyword">var</span> prototype = <span class="title function_">inheritObject</span>(superClass.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line">  <span class="comment">//修正因为重写子类原型导致子类的constructor属性被修改</span></span><br><span class="line">  prototype.<span class="property">constructor</span> = subClass;</span><br><span class="line">  <span class="comment">//设置子类的原型</span></span><br><span class="line">  subClass.<span class="property"><span class="keyword">prototype</span></span> = prototype;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义父类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SuperClass</span>(<span class="params">name</span>)&#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">books</span> = [<span class="string">&quot;数据结构&quot;</span>,<span class="string">&quot;数据库设计&quot;</span>,<span class="string">&quot;操作系统&quot;</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义父类原型方法</span></span><br><span class="line"><span class="title class_">SuperClass</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getName</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义子类</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SubClass</span>(<span class="params">name,time</span>)&#123;</span><br><span class="line">  <span class="title class_">SuperClass</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>,name);</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">time</span> = time;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//寄生式继承父类原型</span></span><br><span class="line"><span class="title function_">inheritPrototype</span>(<span class="title class_">SubClass</span>,<span class="title class_">SuperClass</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//子类新增原型方法</span></span><br><span class="line"><span class="title class_">SubClass</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getTime</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">time</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> instance1 = <span class="keyword">new</span> <span class="title class_">SubClass</span>(<span class="string">&quot;软件工程&quot;</span>,<span class="number">2015</span>);</span><br><span class="line"><span class="keyword">var</span> instance2 = <span class="keyword">new</span> <span class="title class_">SubClass</span>(<span class="string">&quot;计算机与科学&quot;</span>,<span class="number">2016</span>);</span><br><span class="line"></span><br><span class="line">instance1.<span class="property">books</span>.<span class="title function_">push</span>(<span class="string">&quot;c#程序设计&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance1.<span class="property">books</span>);<span class="comment">//[&quot;数据结构&quot;, &quot;数据库设计&quot;, &quot;操作系统&quot;, &quot;c#程序设计&quot;]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance2.<span class="property">books</span>);<span class="comment">// [&quot;数据结构&quot;, &quot;数据库设计&quot;, &quot;操作系统&quot;]</span></span><br><span class="line">instance2.<span class="title function_">getName</span>();<span class="comment">//计算机与科学</span></span><br><span class="line">instance2.<span class="title function_">getTime</span>();<span class="comment">//2016</span></span><br></pre></td></tr></table></figure><h3 id="继承原理"><a href="#继承原理" class="headerlink" title="继承原理"></a>继承原理</h3><p><img src="https://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180407173905.png" alt="image"></p><h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ol><li>只调用了一次<code>SuperClass</code>构造函数</li><li>并且避免了在<code>SubClass.prototype</code>上面创建不必要的、多余属性。</li><li>与此同时原型链还能保持不变</li></ol><h2 id="Class继承"><a href="#Class继承" class="headerlink" title="Class继承"></a><code>Class</code>继承</h2><p><code>Class</code>通过 <code>extends</code>关键字实现继承</p><p><code>ES6</code>规定通过<code>super</code>调用父类的方法时，<code>super</code>会绑定子类的<code>this</code></p><h3 id="super的作用"><a href="#super的作用" class="headerlink" title="super的作用"></a>super的作用</h3><ol><li><code>super</code>作为函数调用时代表父类的构造函数,<code>ES6</code>要求子类的构造函数必须执行一次<code>super</code>函数</li><li><code>super</code>作为对象用在静态方法之中，这时<code>super</code>将指向父类，而不是父类的原型对象</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义父类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SuperClass</span> &#123;</span><br><span class="line">    <span class="comment">//构造函数</span></span><br><span class="line"><span class="title function_">constructor</span> (xAxis,yAxis,name)&#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">name</span>= name||<span class="string">&quot;SuperClass&quot;</span>;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">xAxis</span> = xAxis;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">yAxis</span> = yAxis;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态方法</span></span><br><span class="line"><span class="keyword">static</span> <span class="title function_">getName</span>(<span class="params">msg</span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`static : <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> =&gt;`</span>+msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//普通方法</span></span><br><span class="line"><span class="title function_">getName</span>(<span class="params">msg</span>)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`instance: <span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span> =&gt;`</span>+msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印坐标</span></span><br><span class="line"><span class="title function_">printCoordinate</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">`当前坐标是：(<span class="subst">$&#123;<span class="variable language_">this</span>.xAxis&#125;</span>,<span class="subst">$&#123;<span class="variable language_">this</span>.yAxis&#125;</span>)`</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">SuperClass</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">getTime</span> = <span class="keyword">function</span>(<span class="params">time</span>)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;当前时间是：&quot;</span>,time);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//定义父类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SubClass</span> <span class="keyword">extends</span> <span class="title class_ inherited__">SuperClass</span>&#123;</span><br><span class="line">    <span class="comment">//构造函数</span></span><br><span class="line"><span class="title function_">constructor</span> (xAxis,yAxis,name,time) &#123;</span><br><span class="line"><span class="comment">//super表示父类的构造函数，用来新建父类的`this`对象</span></span><br><span class="line"><span class="variable language_">super</span>(xAxis, yAxis);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line"><span class="variable language_">super</span>.<span class="title function_">getTime</span>(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//静态方法</span></span><br><span class="line"><span class="keyword">static</span> <span class="title function_">getName</span>(<span class="params">msg</span>) &#123;</span><br><span class="line"><span class="comment">//super指向父类</span></span><br><span class="line"><span class="variable language_">super</span>.<span class="title function_">getName</span>(msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//普通方法</span></span><br><span class="line"><span class="title function_">getName</span>(<span class="params">msg</span>)&#123;</span><br><span class="line"><span class="comment">//super指向父类的原型对象</span></span><br><span class="line"><span class="variable language_">super</span>.<span class="title function_">getName</span>(msg)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//打印信息</span></span><br><span class="line"><span class="title function_">printCoordinate</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="comment">//调用父类的 printCoordinate方法</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>：<span class="subst">$&#123;<span class="variable language_">super</span>.printCoordinate()&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> instance1 = <span class="keyword">new</span> <span class="title class_">SuperClass</span>(<span class="number">10</span>,<span class="number">20</span>);</span><br><span class="line"><span class="keyword">var</span> instance2 = <span class="keyword">new</span> <span class="title class_">SubClass</span>(<span class="number">100</span>,<span class="number">200</span>,<span class="string">&quot;小明&quot;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(instance1.<span class="title function_">printCoordinate</span>());<span class="comment">//当前坐标是：(10,20)</span></span><br><span class="line">instance2.<span class="title function_">printCoordinate</span>();<span class="comment">//小明：当前坐标是：(100,200)</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">SubClass</span>.<span class="title function_">getName</span>(<span class="string">&quot;区块链&quot;</span>);<span class="comment">//static : SubClass =&gt;区块链</span></span><br><span class="line">instance2.<span class="title function_">getName</span>(<span class="string">&quot;持续部署&quot;</span>);<span class="comment">//instance: 小明 =&gt;持续部署</span></span><br></pre></td></tr></table></figure><h3 id="类的prototype属性和-proto-属性"><a href="#类的prototype属性和-proto-属性" class="headerlink" title="类的prototype属性和__proto__属性"></a>类的<code>prototype</code>属性和<code>__proto__</code>属性</h3><p><code>Class</code>作为构造函数的语法糖，同时有<code>prototype</code>属性和<code>__proto__</code>属性，因此同时存在两条继承链</p><ol><li>子类的<code>__proto__</code>属性表示构造函数的继承，总是指向父类</li><li>子类的<code>prototype</code>属性的<code>__proto__</code>属性表示方法的继承，总是指向父类的<code>prototype</code>属性</li></ol><h4 id="Object-setPrototypeOf"><a href="#Object-setPrototypeOf" class="headerlink" title="Object.setPrototypeOf() "></a><code>Object.setPrototypeOf() </code></h4><p><code>Object.setPrototypeOf()</code> 方法设置一个指定的对象的原型 ( 即, 内部<code>[[Prototype]]</code>属性）到另一个对象或  <code>null</code></p><p><code>Object.setPrototypeOf()</code>是<code>ECMAScript 6</code>最新草案中的方法，相对于<code>Object.prototype.__proto__</code>，它被认为是修改对象原型更合适的方法</p><h4 id="继承的实现"><a href="#继承的实现" class="headerlink" title="继承的实现"></a>继承的实现</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="property">setPrototypeOf</span> = <span class="keyword">function</span>(<span class="params">obj,proto</span>)&#123;</span><br><span class="line">    obj.<span class="property">__proto__</span> = proto;</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//定义类A</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;&#125;</span><br><span class="line"><span class="comment">//定义类B</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123;&#125;</span><br><span class="line"><span class="comment">//B的实例继承A的实例</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">setPrototypeOf</span>(B.<span class="property"><span class="keyword">prototype</span></span>,A.<span class="property"><span class="keyword">prototype</span></span>);</span><br><span class="line"><span class="comment">//B的实例继承A的静态属性</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">setPrototypeOf</span>(B,A);</span><br><span class="line"><span class="keyword">const</span> instance1 = <span class="keyword">new</span> <span class="title function_">A</span>();</span><br><span class="line"><span class="keyword">const</span> instance2 = <span class="keyword">new</span> <span class="title function_">B</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*********************测试代码************************/</span></span><br><span class="line">B.<span class="property">__proto__</span> === A <span class="comment">//true 作为一个对象，子类(`B`)的原型(`__proto__`属性)是父类`A`</span></span><br><span class="line">B.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__proto__</span> === A.<span class="property"><span class="keyword">prototype</span></span> <span class="comment">//true 作为一个构造函数，子类(`B`)的原型(`prototype`属性)是父类的实例</span></span><br><span class="line"></span><br><span class="line">instance1.<span class="property">__proto__</span> === instance2.<span class="property">__proto__</span>.<span class="property">__proto__</span> <span class="comment">//true</span></span><br><span class="line"><span class="comment">//子类实例的__proto__属性的__proto__属性指向父类的__proto__属性，也就是子类的原型的原型是父类的原型</span></span><br></pre></td></tr></table></figure><p>可理解为：</p><ol><li>作为一个对象，子类(<code>B</code>)的原型(<code>__proto__</code>属性)是父类<code>A</code></li><li>作为一个构造函数，子类(<code>B</code>)的原型(<code>prototype</code>属性)是父类的实例</li><li>子类实例的<code>__proto__</code>属性的<code>__proto__</code>属性指向父类的<code>__proto__</code>属性，也就是子类的原型的原型是父类的原型</li></ol><h2 id="原生构造函数的继承"><a href="#原生构造函数的继承" class="headerlink" title="原生构造函数的继承"></a>原生构造函数的继承</h2><p>原生构造函数如：<code>Array/Error/Object/...</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">VersionArray</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Array</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>();</span><br><span class="line">        <span class="comment">//储存历史记录</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">history</span> = [ [<span class="number">0</span>,<span class="number">0</span>] ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提交方法</span></span><br><span class="line">    commit () &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">history</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">slice</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//还原</span></span><br><span class="line">    <span class="title function_">revert</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">splice</span>(<span class="number">0</span>,<span class="variable language_">this</span>.<span class="property">length</span>,...<span class="variable language_">this</span>.<span class="property">history</span>[<span class="variable language_">this</span>.<span class="property">history</span>.<span class="property">length</span>-<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> instance1 = <span class="keyword">new</span> <span class="title class_">VersionArray</span>();</span><br><span class="line">instance1.<span class="title function_">push</span>(<span class="number">1</span>);</span><br><span class="line">instance1.<span class="title function_">push</span>(<span class="number">2</span>);</span><br><span class="line">instance1.<span class="property">history</span>; <span class="comment">// [[0,0]]</span></span><br><span class="line"></span><br><span class="line">instance1.<span class="title function_">commit</span>();</span><br><span class="line">instance1.<span class="property">history</span>;<span class="comment">//[[0,0],[1,2]]</span></span><br><span class="line"></span><br><span class="line">instance1.<span class="title function_">push</span>(<span class="number">3</span>);</span><br><span class="line">instance1; <span class="comment">//[1,2,3]</span></span><br><span class="line"></span><br><span class="line">instance1.<span class="title function_">revert</span>()</span><br><span class="line">instance1 <span class="comment">//[[0,0],[1,2]]</span></span><br></pre></td></tr></table></figure><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/proto"><code>__proto__</code> MDN</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;原型链&quot;&gt;&lt;a href=&quot;#原型链&quot; class=&quot;headerlink&quot; title=&quot;原型链&quot;&gt;&lt;/a&gt;原型链&lt;/h2&gt;&lt;p&gt;&lt;code&gt;JavaScript&lt;/code&gt;主要通过原型链实现继承。原型链的构建是通过将一个类型的实例赋值给另一个构造函数的原型实现的&lt;/p&gt;
&lt;h3 id=&quot;内部指针-proto&quot;&gt;&lt;a href=&quot;#内部指针-proto&quot; class=&quot;headerlink&quot; title=&quot;内部指针__proto__&quot;&gt;&lt;/a&gt;内部指针&lt;code&gt;__proto__&lt;/code&gt;&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;遵循ECMAScript标准，&lt;code&gt;someObject.[[Prototype]]&lt;/code&gt; 符号是用于指向 &lt;code&gt;someObject&lt;/code&gt;的原型;&lt;/li&gt;
&lt;li&gt;这个等同于 &lt;code&gt;JavaScript&lt;/code&gt; 的非标准但许多浏览器实现的属性 &lt;code&gt;__proto__&lt;/code&gt;;&lt;/li&gt;
&lt;li&gt;从 ECMAScript 6 开始，&lt;code&gt;[[Prototype]]&lt;/code&gt; 可以通过&lt;code&gt;Object.getPrototypeOf()&lt;/code&gt;和&lt;code&gt;Object.setPrototypeOf()&lt;/code&gt;访问器来访问;&lt;/li&gt;
&lt;li&gt;但它不应该与构造函数 &lt;code&gt;func&lt;/code&gt; 的 &lt;code&gt;prototype&lt;/code&gt; 属性相混淆&lt;/li&gt;
&lt;li&gt;被构造函数创建的实例对象的 &lt;code&gt;[[prototype]]&lt;/code&gt; 指向 &lt;code&gt;func&lt;/code&gt; 的 &lt;code&gt;prototype&lt;/code&gt; 属性。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Object.prototype&lt;/code&gt; 属性表示&lt;code&gt;Object&lt;/code&gt;的原型对象。&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="javascript" scheme="https://nightme.github.io/categories/javascript/"/>
    
    
      <category term="javascript" scheme="https://nightme.github.io/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>vue2.0双向绑定</title>
    <link href="https://nightme.github.io/2018/03/13/vue2-0%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A/"/>
    <id>https://nightme.github.io/2018/03/13/vue2-0双向绑定/</id>
    <published>2018-03-13T10:45:05.000Z</published>
    <updated>2025-09-19T04:25:12.109Z</updated>
    
    <content type="html"><![CDATA[<h2 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h2><p>MVVM是Model-View-ViewModel 的简写,是MVC的改进版.</p><p>在双向绑定中,Model和View之间没有耦合,通过操作Model，利用ViewModel提供的机制，自动实现ViewModel的更新。</p><span id="more"></span><h2 id="Object-defineProperty"><a href="#Object-defineProperty" class="headerlink" title="Object.defineProperty"></a>Object.defineProperty</h2><p>Object.defineProperty() 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object.defineProperty(obj, prop, descriptor)</span><br></pre></td></tr></table></figure><ul><li><code>obj</code>:要在其上定义属性的对象</li><li><code>prop</code>:要定义或修改的属性的名称</li><li><code>descriptor</code>:将被定义或修改的属性描述符。</li></ul><ol><li><code>get</code>: 一个给属性提供 getter 的方法，如果没有 getter 则为 undefined。该方法返回值被用作属性值。默认为 <code>undefined</code></li><li><code>set</code>: 一个给属性提供 setter 的方法，如果没有 setter 则为 undefined。该方法将接受唯一参数，并将该参数的新值分配给该属性。默认为 <code>undefined</code>。</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Log</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> val = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> arr = [];</span><br><span class="line">    <span class="keyword">var</span> id = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">this</span>, <span class="string">&#x27;name&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">set</span>: <span class="keyword">function</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">          arr.<span class="title function_">push</span>(&#123;<span class="attr">id</span>:id++,<span class="attr">oldVal</span>:val,<span class="attr">newVal</span>:newVal&#125;);</span><br><span class="line">          val = newVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">getLog</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> arr; &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> lg = <span class="keyword">new</span> <span class="title class_">Log</span>();</span><br><span class="line">lg.<span class="property">name</span>=<span class="string">&quot;小明&quot;</span>;</span><br><span class="line">lg.<span class="property">name</span>=<span class="string">&quot;小华&quot;</span>;</span><br><span class="line">lg.<span class="property">name</span>=<span class="string">&quot;小刚&quot;</span>;</span><br><span class="line">lg.<span class="title function_">getLog</span>();</span><br></pre></td></tr></table></figure><h2 id="发布-x2F-订阅者模式"><a href="#发布-x2F-订阅者模式" class="headerlink" title="发布&#x2F;订阅者模式"></a>发布&#x2F;订阅者模式</h2><p>订阅者把自己想订阅的事件注册到调度中心，</p><p>当该事件触发时候，发布者发布该事件到调度中心（顺带上下文），由调度中心统一调度订阅者注册到调度中心的处理代码。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">            发布                  订阅</span><br><span class="line">发布者       -&gt;      调度中心       &lt;-      订阅者(多个)</span><br></pre></td></tr></table></figure><p>vue双向绑定的实现<code>Dep、Observer、Watcher:</code></p><ul><li><code>Dep</code>(调度中心):存放收集<code>Watcher</code>,Watcher的实例就是订阅者。</li><li><code>Observer</code>(发布者):是一个类(class),每个<code>Observer</code>都附有被观察的对象，观察的对象，一旦连接，观察者就转换目标对象的属性键成为<code>getter/setters</code>,收集依赖关系并发送更新</li><li><code>Watcher</code>(订阅者):观察者分析表达式，收集依赖关系，并在表达式值更改时触发回调。</li></ul><h3 id="Watcher-订阅者"><a href="#Watcher-订阅者" class="headerlink" title="Watcher(订阅者)"></a>Watcher(订阅者)</h3><p>解析对象路径函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [解析对象路径 obj = &#123;a:b:&#123;c:1&#125;&#125;]</span></span><br><span class="line"><span class="comment"> * a.b.c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parsePath</span> (path) &#123;</span><br><span class="line">    <span class="keyword">var</span> bailRE = <span class="regexp">/[^\w.$]/</span>;</span><br><span class="line">    <span class="keyword">if</span> (bailRE.<span class="title function_">test</span>(path)) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> segments = path.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">obj</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; segments.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!obj) &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">            obj = obj[segments[i]];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [订阅者]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Watcher</span> = <span class="keyword">function</span> <span class="title function_">Watcher</span>(<span class="params">vm,expOrFn,cb</span>)&#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">vm</span> = vm;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cb</span> = cb;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">expression</span> = expOrFn;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">getter</span> = <span class="title function_">parsePath</span>(expOrFn);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">value</span> = <span class="variable language_">this</span>.<span class="title function_">get</span>()<span class="comment">//更新前的值</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取表达式的值</span></span><br><span class="line"><span class="title class_">Watcher</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">get</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="title class_">Dep</span>.<span class="property">target</span> = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">var</span> data = <span class="variable language_">this</span>.<span class="property">vm</span>.<span class="property">data</span>;</span><br><span class="line">    <span class="keyword">var</span> value = <span class="variable language_">this</span>.<span class="property">getter</span>.<span class="title function_">call</span>(data, data);</span><br><span class="line">    <span class="comment">//表明是watcher调用了getter</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//订阅者的更新方法</span></span><br><span class="line"><span class="title class_">Watcher</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">update</span> = <span class="keyword">function</span> (<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//获取更新后的值</span></span><br><span class="line">    <span class="keyword">var</span> value = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">    <span class="keyword">var</span> oldVal = <span class="variable language_">this</span>.<span class="property">value</span>;</span><br><span class="line">    <span class="keyword">if</span>(value!==oldVal)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> = value <span class="comment">//更新新值</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cb</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">vm</span>,value,oldVal);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加订阅者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Watcher</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">addDep</span> = <span class="keyword">function</span> <span class="title function_">addDep</span> (dep) &#123;</span><br><span class="line">    dep.<span class="title function_">addSub</span>(<span class="variable language_">this</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Dep-调度中心"><a href="#Dep-调度中心" class="headerlink" title="Dep(调度中心)"></a>Dep(调度中心)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [调度中心]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Dep</span> = <span class="keyword">function</span> <span class="title function_">Dep</span> () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span> = []<span class="comment">//订阅者队列</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定义一个全局变量，用来判断是否是watcher调用了getter</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property">target</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [添加订阅者]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">addSub</span> = <span class="keyword">function</span> <span class="title function_">addSub</span> (sub) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(sub);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [移除订阅者]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">removeSub</span> = <span class="keyword">function</span> <span class="title function_">removeSub</span> (sub) &#123;</span><br><span class="line">    <span class="title function_">remove</span>(<span class="variable language_">this</span>.<span class="property">subs</span>, sub);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [订阅者，注册事件到事件中心]</span></span><br><span class="line"><span class="comment"> * set触发notify,并触发相应的update方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">notify</span> = <span class="keyword">function</span> <span class="title function_">notify</span> () &#123;</span><br><span class="line">    <span class="comment">// 复制一个新的订阅者数组</span></span><br><span class="line">    <span class="keyword">var</span> subs = <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">slice</span>();</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;notify&#x27;</span>,subs)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, l = subs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="comment">//调度中心统一调度订阅者注册到调度中心的处理代码</span></span><br><span class="line">        subs[i].<span class="title function_">update</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [增加订阅者watcher到对象Dep]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Dep</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">depend</span> = <span class="keyword">function</span> <span class="title function_">depend</span> () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">addDep</span>(<span class="variable language_">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="Observer-发布者"><a href="#Observer-发布者" class="headerlink" title="Observer(发布者)"></a>Observer(发布者)</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [发布者 Observer 对data做监听]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Observer</span> = <span class="keyword">function</span> <span class="title function_">Observer</span> (data) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">data</span> = data;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Dep</span>();</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">walk</span>(data);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 遍历对象所有属性，包括子属性,使其拥有getter/setter方法</span></span><br><span class="line"><span class="comment"> * 仅限值类型是对象，这个方法才能被调用</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Observer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">walk</span> = <span class="keyword">function</span> <span class="title function_">walk</span> (obj) &#123;</span><br><span class="line">    <span class="keyword">var</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(obj);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">defineReactive</span>(obj, keys[i], obj[keys[i]]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [在对象上定义一个响应式属性]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title class_">Observer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">defineReactive</span> = <span class="keyword">function</span>(<span class="params"> obj, key,val</span>)&#123;</span><br><span class="line">    <span class="comment">//实例化一个Dep</span></span><br><span class="line">    <span class="keyword">var</span> _this = <span class="variable language_">this</span>;</span><br><span class="line">    <span class="keyword">var</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>();</span><br><span class="line">    <span class="title function_">observe</span>(val);</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(obj, key, &#123;</span><br><span class="line">        <span class="attr">enumerable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">configurable</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span> () &#123;</span><br><span class="line">            <span class="comment">//Dep.target指针指向watcher，增加订阅者watcher到对象Dep</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="title class_">Dep</span>.<span class="property">target</span>)&#123;</span><br><span class="line">                <span class="comment">//console.log(&#x27;Dep.target&#x27;)</span></span><br><span class="line">                <span class="comment">// dep.depend();</span></span><br><span class="line">                dep.<span class="title function_">addSub</span>(<span class="title class_">Dep</span>.<span class="property">target</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> val;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">reactiveSetter</span> (newVal) &#123;</span><br><span class="line">            <span class="comment">// 如果新设置的值和原来相等,则不重新赋值</span></span><br><span class="line">            <span class="comment">// console.log(&#x27;set之前&#x27;,val,newVal)</span></span><br><span class="line">            <span class="keyword">if</span> (newVal === val) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            val = newVal;</span><br><span class="line">            <span class="title function_">observe</span>(newVal);</span><br><span class="line">            <span class="comment">//调度中心发出通知</span></span><br><span class="line">            dep.<span class="title function_">notify</span>();</span><br><span class="line">            <span class="comment">// console.log(&#x27;set之后&#x27;,val,newVal)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Observer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$watcher</span> = <span class="keyword">function</span>(<span class="params">expOrFn,cb</span>)&#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Watcher</span>(<span class="variable language_">this</span>,expOrFn,cb);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//如果是对象，则再实例化一个Observer</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">observe</span> (val,vm)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(val) ===<span class="string">&quot;[object Object]&quot;</span>)&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Observer</span>(val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Observer</span>;</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;<span class="attr">name</span>:<span class="string">&#x27;小明&#x27;</span>,<span class="attr">other</span>:<span class="number">20</span>,<span class="attr">power</span>:&#123;</span><br><span class="line">        <span class="attr">p1</span>:<span class="string">&#x27;有钱&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> <span class="title class_">Observer</span>(obj);</span><br><span class="line">app.$watcher(<span class="string">&#x27;name&#x27;</span>, <span class="keyword">function</span>(<span class="params">newVal,oldVal</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;打印name&#x27;</span>,newVal,oldVal)</span><br><span class="line">&#125;);</span><br><span class="line">app.$watcher(<span class="string">&#x27;power.p1&#x27;</span>, <span class="keyword">function</span>(<span class="params">newVal,oldVal</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;power.p1&#x27;</span>,newVal,oldVal)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    obj.<span class="property">name</span> = <span class="string">&quot;小刚&quot;</span>;</span><br><span class="line">    obj.<span class="property">power</span>.<span class="property">p1</span> = <span class="string">&#x27;会打王者&#x27;</span>;</span><br><span class="line">&#125;,<span class="number">1500</span>);</span><br></pre></td></tr></table></figure><h2 id="抽象语法树AST-abstract-syntax-tree"><a href="#抽象语法树AST-abstract-syntax-tree" class="headerlink" title="抽象语法树AST(abstract syntax tree)"></a>抽象语法树AST(abstract syntax tree)</h2><p>AST是指抽象语法树（abstract syntax tree或者缩写为AST），或者语法树（syntax tree），是源代码的抽象语法结构的树状表现形式。</p><p><code>Vue.js v2.5.13</code></p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180313094253.png" alt="image"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * `createCompilerCreator`允许创建使用替代的编译器</span></span><br><span class="line"><span class="comment"> * 解析器/优化器/ codegen，例如SSR优化编译器。</span></span><br><span class="line"><span class="comment"> * 这里我们只使用默认的部分导出一个默认的编译器。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">var</span> createCompiler = <span class="title function_">createCompilerCreator</span>(<span class="keyword">function</span> <span class="title function_">baseCompile</span> (</span><br><span class="line">  template,</span><br><span class="line">  options</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">var</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options);</span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">optimize</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_">optimize</span>(ast, options);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> code = <span class="title function_">generate</span>(ast, options);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">ast</span>: ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将HTML字符串转换为AST</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parse</span> (</span><br><span class="line">  template,</span><br><span class="line">  options</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">var</span> root;</span><br><span class="line">    <span class="comment">/*todo....*/</span></span><br><span class="line">    <span class="title function_">parseHTML</span>(template, &#123;</span><br><span class="line">        <span class="attr">warn</span>: warn$2,</span><br><span class="line">        <span class="comment">/*...*/</span></span><br><span class="line">        <span class="attr">start</span>: <span class="keyword">function</span> <span class="title function_">start</span> (tag, attrs, unary) &#123;&#125;</span><br><span class="line">        <span class="attr">end</span>: <span class="keyword">function</span> <span class="title function_">end</span> () &#123;<span class="comment">/*...*/</span>&#125;,</span><br><span class="line">        <span class="attr">chars</span>: <span class="keyword">function</span> <span class="title function_">chars</span> (text) &#123;<span class="comment">/*...*/</span>&#125;,</span><br><span class="line">        <span class="attr">comment</span>: <span class="keyword">function</span> <span class="title function_">comment</span> (text)&#123;<span class="comment">/*...*/</span>&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> root</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>vue</code>将模板字符串给<code>parse</code>函数，最终返回一个抽象语法树(AST)</p><p><code>parse</code>函数内部会调用一个<code>parseHTML</code>,来完成对模板字符串解析，最终返回个js语法的树形结构。</p><p>执行<code>generate</code>函数返回<code>code</code>中有个<code>render</code>函数和<code>staticRenderFns</code>函数</p><h2 id="虚拟DOM-VNode"><a href="#虚拟DOM-VNode" class="headerlink" title="虚拟DOM(VNode)"></a>虚拟DOM(VNode)</h2><p>文档对象模型（Document Object Model，简称DOM）。用<code>jquery</code>在网页中直接操作dom结构,相对于原生API无疑方便了很多。</p><p>为了追求性能、和更方便的对DOM维护，于是就引入了虚拟DOM。</p><p>用JS表示DOM结构,操作DOM慢，而javascript很快，用javascript对象可以很容易地表示DOM节点。DOM节点包括标签、属性和子节点.</p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180313142540.png" alt="image"></p><p><code>Vue.js v2.5.13</code>(VNode.js):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">/* @flow */</span><br><span class="line"><span class="built_in">export</span> default class VNode &#123;</span><br><span class="line">  tag: string | void;/* 标签类型 */</span><br><span class="line">  data: VNodeData | void; /* 节点上的class,attribute,style 事件 */</span><br><span class="line">  children: ?Array&lt;VNode&gt;;/* 存放的是子虚拟节点 */</span><br><span class="line">  text: string | void;/* 表明文本节点内容 */</span><br><span class="line">  elm: Node | void;/* 虚拟节点对应的真实DOM节点 */</span><br><span class="line">  ns: string | void;/* html命名空间 */</span><br><span class="line">  context: Component | void; /* 在此组件的作用域 */</span><br><span class="line">  key: string | number | void; /* 是vnode的标记 */</span><br><span class="line">  componentOptions: VNodeComponentOptions | void;/* 组件参数 */</span><br><span class="line">  componentInstance: Component | void; /* 组件实例 */</span><br><span class="line">  parent: VNode | void; /*  */</span><br><span class="line"></span><br><span class="line">  /*  严格内部 */</span><br><span class="line">  raw: boolean; /* 包含原始HTML？ （仅限服务器） */</span><br><span class="line">  isStatic: boolean; /* 悬挂静态节点 */</span><br><span class="line">  isRootInsert: boolean; /* 进入转换检查所必需的 */</span><br><span class="line">  isComment: boolean; /* 空注释占位符? */</span><br><span class="line">  isCloned: boolean; /*是否是一个克隆节点?  */</span><br><span class="line">  isOnce: boolean; /* 是否是一次性节点? */</span><br><span class="line">  asyncFactory: Function | void; /* 异步组件 factory <span class="keyword">function</span> */</span><br><span class="line">  asyncMeta: Object | void;</span><br><span class="line">  isAsyncPlaceholder: boolean;</span><br><span class="line">  ssrContext: Object | void;</span><br><span class="line">  fnContext: Component | void; /* 真实的上下文虚拟功能节点 */</span><br><span class="line">  fnOptions: ?ComponentOptions; /* 用于SSR缓存 */</span><br><span class="line">  fnScopeId: ?string; /*  功能范围<span class="built_in">id</span>支持 */</span><br><span class="line"></span><br><span class="line">  constructor (</span><br><span class="line">    tag?: string,</span><br><span class="line">    data?: VNodeData,</span><br><span class="line">    children?: ?Array&lt;VNode&gt;,</span><br><span class="line">    text?: string,</span><br><span class="line">    elm?: Node,</span><br><span class="line">    context?: Component,</span><br><span class="line">    componentOptions?: VNodeComponentOptions,</span><br><span class="line">    asyncFactory?: Function</span><br><span class="line">  ) &#123;</span><br><span class="line">    this.tag = tag</span><br><span class="line">    this.data = data</span><br><span class="line">    this.children = children</span><br><span class="line">    this.text = text</span><br><span class="line">    this.elm = elm</span><br><span class="line">    this.ns = undefined</span><br><span class="line">    this.context = context</span><br><span class="line">    this.fnContext = undefined</span><br><span class="line">    this.fnOptions = undefined</span><br><span class="line">    this.fnScopeId = undefined</span><br><span class="line">    this.key = data &amp;&amp; data.key</span><br><span class="line">    this.componentOptions = componentOptions</span><br><span class="line">    this.componentInstance = undefined</span><br><span class="line">    this.parent = undefined</span><br><span class="line">    this.raw = <span class="literal">false</span></span><br><span class="line">    this.isStatic = <span class="literal">false</span></span><br><span class="line">    this.isRootInsert = <span class="literal">true</span></span><br><span class="line">    this.isComment = <span class="literal">false</span></span><br><span class="line">    this.isCloned = <span class="literal">false</span></span><br><span class="line">    this.isOnce = <span class="literal">false</span></span><br><span class="line">    this.asyncFactory = asyncFactory</span><br><span class="line">    this.asyncMeta = undefined</span><br><span class="line">    this.isAsyncPlaceholder = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  /**</span><br><span class="line">   * 弃用: 别名 为组件实例 向后兼容.</span><br><span class="line">   * istanbul ignore next</span><br><span class="line">   */</span><br><span class="line">  get child (): Component | void &#123;</span><br><span class="line">    <span class="built_in">return</span> this.componentInstance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 创建一个空的vnode实例 */</span><br><span class="line"><span class="built_in">export</span> const createEmptyVNode = (text: string = <span class="string">&#x27;&#x27;</span>) =&gt; &#123;</span><br><span class="line">  const node = new VNode()</span><br><span class="line">  node.text = text</span><br><span class="line">  node.isComment = <span class="literal">true</span></span><br><span class="line">  <span class="built_in">return</span> node</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/* 创建一个文本vnode */</span><br><span class="line"><span class="built_in">export</span> <span class="keyword">function</span> createTextVNode (val: string | number) &#123;</span><br><span class="line">  <span class="built_in">return</span> new VNode(undefined, undefined, undefined, String(val))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 优化的浅层克隆</span><br><span class="line"> * 用于静态节点和插槽节点，因为它们可能会被重复使用</span><br><span class="line"> * 多重渲染，克隆它们可以避免DOM操作依赖时的错误</span><br><span class="line"> * 克隆一个vnode</span><br><span class="line"> */</span><br><span class="line"><span class="built_in">export</span> <span class="keyword">function</span> cloneVNode (vnode: VNode): VNode &#123;</span><br><span class="line">  const cloned = new VNode(</span><br><span class="line">    vnode.tag,</span><br><span class="line">    vnode.data,</span><br><span class="line">    vnode.children,</span><br><span class="line">    vnode.text,</span><br><span class="line">    vnode.elm,</span><br><span class="line">    vnode.context,</span><br><span class="line">    vnode.componentOptions,</span><br><span class="line">    vnode.asyncFactory</span><br><span class="line">  )</span><br><span class="line">  cloned.ns = vnode.ns</span><br><span class="line">  cloned.isStatic = vnode.isStatic</span><br><span class="line">  cloned.key = vnode.key</span><br><span class="line">  cloned.isComment = vnode.isComment</span><br><span class="line">  cloned.fnContext = vnode.fnContext</span><br><span class="line">  cloned.fnOptions = vnode.fnOptions</span><br><span class="line">  cloned.fnScopeId = vnode.fnScopeId</span><br><span class="line">  cloned.isCloned = <span class="literal">true</span></span><br><span class="line">  <span class="built_in">return</span> cloned</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountComponent</span> ( vm, el, hydrating) &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el;</span><br><span class="line">  <span class="keyword">if</span> (!vm.<span class="property">$options</span>.<span class="property">render</span>) &#123;</span><br><span class="line">    vm.<span class="property">$options</span>.<span class="property">render</span> = createEmptyVNode;</span><br><span class="line">    <span class="comment">/* .... */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeMount&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> updateComponent;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;development&quot;</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating);</span><br><span class="line">      <span class="comment">/* .... */</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//我们在观察者的构造函数中将其设置为vm._watcher</span></span><br><span class="line">  <span class="comment">//因为观察者的初始补丁可能会调用$ forceUpdate（例如在子内部）</span></span><br><span class="line">  <span class="comment">//组件的挂载钩子），这依赖于已经定义的vm._watcher</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, <span class="literal">null</span>, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>);</span><br><span class="line">  hydrating = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">/* .... */</span></span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在初始化的时候执行<code>mountComponent</code>函数方法，其中的<code>vm._render()</code>函数返回虚拟Dom(在模板编译后生成的render方法挂载了实例上)</p><p>其中的<code>updateComponent</code>传给了<code>Watcher</code>,而<code>updateComponent</code>中有<code>vm._update(vnode, hydrating)</code>方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_update</span> = <span class="keyword">function</span> (<span class="params">vnode, hydrating</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> vm = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">_isMounted</span>) &#123;</span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeUpdate&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> prevEl = vm.<span class="property">$el</span>;</span><br><span class="line">  <span class="keyword">var</span> prevVnode = vm.<span class="property">_vnode</span>;</span><br><span class="line">  <span class="keyword">var</span> prevActiveInstance = activeInstance;</span><br><span class="line">  activeInstance = vm;</span><br><span class="line">  vm.<span class="property">_vnode</span> = vnode;</span><br><span class="line">  <span class="comment">// Vue.prototype.__patch__方法已经在入口点注入</span></span><br><span class="line">  <span class="comment">// based on the rendering backend used.</span></span><br><span class="line">  <span class="keyword">if</span> (!prevVnode) &#123;</span><br><span class="line">    <span class="comment">// 初始渲染</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(</span><br><span class="line">      vm.<span class="property">$el</span>, vnode, hydrating, <span class="literal">false</span> <span class="comment">/* removeOnly */</span>,</span><br><span class="line">      vm.<span class="property">$options</span>.<span class="property">_parentElm</span>,</span><br><span class="line">      vm.<span class="property">$options</span>.<span class="property">_refElm</span></span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//在初始补丁之后不需要ref节点</span></span><br><span class="line">    <span class="comment">// 这可以防止在内存中保留分离的DOM树（＃5851）</span></span><br><span class="line">    vm.<span class="property">$options</span>.<span class="property">_parentElm</span> = vm.<span class="property">$options</span>.<span class="property">_refElm</span> = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 更新</span></span><br><span class="line">    vm.<span class="property">$el</span> = vm.<span class="title function_">__patch__</span>(prevVnode, vnode);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* ... */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>传入新的<code>vnode</code>与老的<code>vnode</code>进行diff,来进行dom更新操作,其中的<code>vm.__patch__</code>方法在入口处已经注入</p><p>定义<code>patch</code>补丁函数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> patch = <span class="title function_">createPatchFunction</span>(&#123; <span class="attr">nodeOps</span>: nodeOps, <span class="attr">modules</span>: modules &#125;);</span><br></pre></td></tr></table></figure><p><code>注入</code>patch<code>方法</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 安装平台补丁功能</span></span><br><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">__patch__</span> = inBrowser ? patch : noop;</span><br></pre></td></tr></table></figure><p>函数<code>createPatchFunction</code>返回patch方法，其中的patch方法之后来完成<code>vnode</code>的diff过程和打补丁<code>pacth</code>过程,</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* sameVnode会对传入的2个vnode进行基本属性的比较 */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sameVnode</span> (a, b) &#123;</span><br><span class="line">    <span class="comment">/* .... */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createPatchFunction</span> (backend) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">emptyNodeAt</span> (elm) &#123;<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">VNode</span>(nodeOps.<span class="title function_">tagName</span>(elm).<span class="title function_">toLowerCase</span>(), &#123;&#125;, [], <span class="literal">undefined</span>, elm)&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">createRmCb</span> (childElm, listeners)&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">removeNode</span> (el) &#123;&#125;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">patchVnode</span> (oldVnode, vnode, insertedVnodeQueue, removeOnly)&#123;&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">updateChildren</span> (parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) &#123;&#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">invokeInsertHook</span> (vnode, queue, initial) &#123;&#125;</span><br><span class="line">    <span class="comment">/* ... */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">patch</span> (oldVnode, vnode, hydrating, removeOnly, parentElm, refElm) &#123;</span><br><span class="line">        <span class="comment">//销毁钩子</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isUndef</span>(vnode)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="title function_">isDef</span>(oldVnode)) &#123; <span class="title function_">invokeDestroyHook</span>(oldVnode); &#125;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* ...  */</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isUndef</span>(oldVnode)) &#123;</span><br><span class="line">            <span class="comment">// oldVnode不存在,创建一个root节点</span></span><br><span class="line">            isInitialPatch = <span class="literal">true</span>;</span><br><span class="line">            <span class="title function_">createElm</span>(vnode, insertedVnodeQueue, parentElm, refElm);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> isRealElement = <span class="title function_">isDef</span>(oldVnode.<span class="property">nodeType</span>);</span><br><span class="line">            <span class="keyword">if</span> (!isRealElement &amp;&amp; <span class="title function_">sameVnode</span>(oldVnode, vnode)) &#123;</span><br><span class="line">                <span class="comment">// 是同一个节点的时候直接修改现有的节点</span></span><br><span class="line">                <span class="title function_">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, removeOnly);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">/* .... */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*调用insert钩子*/</span></span><br><span class="line">        <span class="title function_">invokeInsertHook</span>(vnode, insertedVnodeQueue, isInitialPatch);</span><br><span class="line">        <span class="keyword">return</span> vnode.<span class="property">elm</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="vue生命周期"><a href="#vue生命周期" class="headerlink" title="vue生命周期"></a>vue生命周期</h2><p>生命周期钩子(<code>Vue.js v2.5.13</code>)</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="variable constant_">LIFECYCLE_HOOKS</span> = [</span><br><span class="line">  <span class="string">&#x27;beforeCreate&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;created&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;beforeMount&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;mounted&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;beforeUpdate&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;updated&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;beforeDestroy&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;destroyed&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;activated&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;deactivated&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;errorCaptured&#x27;</span></span><br><span class="line">];</span><br></pre></td></tr></table></figure><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/201803121750.png" alt="image"></p><p>版本：Vue.js v2.5.13</p><ol><li><code>beforeCreate</code>:在实例初始化之后，数据观测 (data observer) 和 event&#x2F;watcher 事件配置之前被调用。</li><li><code>created</code>:在实例创建完成后被立即调用。在这一步，实例已完成以下的配置：数据观测 (<code>data observer</code>)，属性和方法的运算，<code>watch/event</code> 事件回调。然而，挂载阶段还没开始，<code>$el</code> 属性目前不可见。</li><li><code>beforeMount</code>：在挂载开始之前被调用：相关的 render 函数首次被调用。(该钩子在服务器端渲染期间不被调用)</li><li><code>mounted</code>:<code>el</code> 被新创建的 <code>vm.$el</code> 替换，并挂载到实例上去之后调用该钩子。如果 <code>root</code> 实例挂载了一个文档内元素，当 <code>mounted</code> 被调用时 <code>vm.$el</code> 也在文档内。(该钩子在服务器端渲染期间不被调用。)<ul><li>注意 <code>mounted</code> 不会承诺所有的子组件也都一起被挂载。如果你希望等到整个视图都渲染完毕，可以用 <code>vm.$nextTick</code> 替换掉 <code>mounted</code></li></ul></li><li><code>beforeUpdate</code>:数据更新时调用，发生在虚拟 DOM 打补丁之前。这里适合在更新之前访问现有的 DOM，比如手动移除已添加的事件监听器。(该钩子在服务器端渲染期间不被调用，因为只有初次渲染会在服务端进行。)</li><li><code>updated</code>:由于数据更改导致的虚拟 DOM 重新渲染和打补丁，在这之后会调用该钩子(该钩子在服务器端渲染期间不被调用)</li><li><code>activated</code>:<code>keep-alive</code> 组件激活时调用(该钩子在服务器端渲染期间不被调用)</li><li><code>deactivated</code>:<code>keep-alive</code> 组件停用时调用(该钩子在服务器端渲染期间不被调用)</li><li><code>beforeDestroy</code>:实例销毁之前调用。在这一步，实例仍然完全可用。</li><li><code>destroyed</code>:Vue 实例销毁后调用。调用后，Vue 实例指示的所有东西都会解绑定，所有的事件监听器会被移除，所有的子实例也会被销毁(该钩子在服务器端渲染期间不被调用)</li><li><code>errorCaptured</code>:当捕获一个来自子孙组件的错误时被调用。此钩子会收到三个参数：错误对象、发生错误的组件实例以及一个包含错误来源信息的字符串。此钩子可以返回 false 以阻止该错误继续向上传播。</li></ol><p><code>new Vue()</code>调用构造函数,执行<code>this._init(options)</code></p><p>构造函数<code>Vue$3</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Vue$3</span> (options) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;development&quot;</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp;</span><br><span class="line">    !(<span class="variable language_">this</span> <span class="keyword">instanceof</span> <span class="title class_">Vue</span>$3)</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="title function_">warn</span>(<span class="string">`Vue是一个构造函数，应该用new关键字`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_init</span>(options);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="title class_">Vue</span>$3;</span><br></pre></td></tr></table></figure><p>原型对象上的<code>_init</code>方法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_init</span> = <span class="keyword">function</span> (<span class="params">options</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> vm = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="comment">/* todo... */</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="title function_">initProxy</span>(vm);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*初始化生命周期*/</span></span><br><span class="line">  <span class="title function_">initLifecycle</span>(vm);</span><br><span class="line">  <span class="comment">/* 初始化事件 */</span></span><br><span class="line">  <span class="title function_">initEvents</span>(vm);</span><br><span class="line">  <span class="title function_">initRender</span>(vm);</span><br><span class="line">  <span class="comment">/*调用beforeCreate钩子函数并且触发beforeCreate钩子事件*/</span></span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeCreate&#x27;</span>);</span><br><span class="line">  <span class="title function_">initInjections</span>(vm); <span class="comment">// 在data/props之前初始化注入</span></span><br><span class="line">  <span class="comment">/*初始化props、methods、data、computed、watch */</span></span><br><span class="line">  <span class="title function_">initState</span>(vm);</span><br><span class="line">  <span class="title function_">initProvide</span>(vm); <span class="comment">// resolve provide after data/props</span></span><br><span class="line">  <span class="comment">/*调用created钩子函数并且触发created钩子事件*/</span></span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&#x27;created&#x27;</span>);</span><br><span class="line">  <span class="comment">/* todo... */</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$options</span>.<span class="property">el</span>) &#123;</span><br><span class="line">    <span class="comment">/*挂载组件*/</span></span><br><span class="line">    vm.$mount(vm.<span class="property">$options</span>.<span class="property">el</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化<code>props、methods、data、computed、watch</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initState</span> (vm) &#123;</span><br><span class="line">  vm.<span class="property">_watchers</span> = [];</span><br><span class="line">  <span class="keyword">var</span> opts = vm.<span class="property">$options</span>;</span><br><span class="line">  <span class="comment">/*初始化props*/</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">props</span>) &#123; <span class="title function_">initProps</span>(vm, opts.<span class="property">props</span>); &#125;</span><br><span class="line">  <span class="comment">/*初始化方法*/</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">methods</span>) &#123; <span class="title function_">initMethods</span>(vm, opts.<span class="property">methods</span>); &#125;</span><br><span class="line">  <span class="comment">/*初始化data*/</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">data</span>) &#123;</span><br><span class="line">    <span class="title function_">initData</span>(vm);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/*该组件没有data的时候绑定一个空对象*/</span></span><br><span class="line">    <span class="title function_">observe</span>(vm.<span class="property">_data</span> = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/*初始化computed*/</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">computed</span>) &#123; <span class="title function_">initComputed</span>(vm, opts.<span class="property">computed</span>); &#125;</span><br><span class="line">  <span class="comment">/*初始化watchers*/</span></span><br><span class="line">  <span class="keyword">if</span> (opts.<span class="property">watch</span> &amp;&amp; opts.<span class="property">watch</span> !== nativeWatch) &#123;</span><br><span class="line">    <span class="title function_">initWatch</span>(vm, opts.<span class="property">watch</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>初始化数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">initData</span> (vm) &#123;</span><br><span class="line">  <span class="keyword">var</span> data = vm.<span class="property">$options</span>.<span class="property">data</span>;</span><br><span class="line">  data = vm.<span class="property">_data</span> = <span class="keyword">typeof</span> data === <span class="string">&#x27;function&#x27;</span>? <span class="title function_">getData</span>(data, vm): data || &#123;&#125;;</span><br><span class="line">  <span class="comment">/* todo.... */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(data);</span><br><span class="line">  <span class="keyword">var</span> i = keys.<span class="property">length</span>;</span><br><span class="line">  <span class="comment">/* todo... */</span></span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">var</span> key = keys[i];</span><br><span class="line">    <span class="comment">/* todo... */</span></span><br><span class="line">    <span class="comment">//代理数据到实例上</span></span><br><span class="line">    <span class="title function_">proxy</span>(vm, <span class="string">&quot;_data&quot;</span>, key);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 开始观察数据，递归进行数据绑定</span></span><br><span class="line">  <span class="title function_">observe</span>(data, <span class="literal">true</span> <span class="comment">/* 作为根数据 */</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代理数据到实例上:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">proxy</span> (target, sourceKey, key) &#123;</span><br><span class="line">  sharedPropertyDefinition.<span class="property">get</span> = <span class="keyword">function</span> <span class="title function_">proxyGetter</span> () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>[sourceKey][key]</span><br><span class="line">  &#125;;</span><br><span class="line">  sharedPropertyDefinition.<span class="property">set</span> = <span class="keyword">function</span> <span class="title function_">proxySetter</span> (val) &#123;</span><br><span class="line">    <span class="variable language_">this</span>[sourceKey][key] = val;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(target, key, sharedPropertyDefinition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>尝试创建一个<code>Observer</code>实例，如果成功创建<code>Observer</code>实例则返回新的<code>Observer</code>实例，如果已有<code>Observer</code>实例则返回现有的<code>Observer</code>实例。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">observe</span> (value, asRootData) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isObject</span>(value) || value <span class="keyword">instanceof</span> <span class="title class_">VNode</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> ob;</span><br><span class="line">  <span class="comment">/* todo... */</span></span><br><span class="line">  ob = <span class="keyword">new</span> <span class="title class_">Observer</span>(value);</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>挂载组件，并编译模板：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> createCompiler = <span class="title function_">createCompilerCreator</span>(<span class="keyword">function</span> <span class="title function_">baseCompile</span> (</span><br><span class="line">  template,</span><br><span class="line">  options</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">var</span> ast = <span class="title function_">parse</span>(template.<span class="title function_">trim</span>(), options);</span><br><span class="line">  <span class="keyword">if</span> (options.<span class="property">optimize</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_">optimize</span>(ast, options);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> code = <span class="title function_">generate</span>(ast, options);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">ast</span>: ast,</span><br><span class="line">    <span class="attr">render</span>: code.<span class="property">render</span>,</span><br><span class="line">    <span class="attr">staticRenderFns</span>: code.<span class="property">staticRenderFns</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">var</span> ref$1 = <span class="title function_">createCompiler</span>(baseOptions);</span><br><span class="line"><span class="keyword">var</span> compileToFunctions = ref$1.<span class="property">compileToFunctions</span>;</span><br><span class="line"><span class="comment">/*将$mount方法保存下来,此时没编译模板，在最后边调用。*/</span></span><br><span class="line"><span class="keyword">var</span> mount = <span class="title class_">Vue</span>$3.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Vue</span>$3.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el,</span></span><br><span class="line"><span class="params">  hydrating</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  el = el &amp;&amp; <span class="title function_">query</span>(el);</span><br><span class="line">  <span class="comment">/* todo... */</span></span><br><span class="line">  <span class="keyword">var</span> options = <span class="variable language_">this</span>.<span class="property">$options</span>;</span><br><span class="line">  <span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line">  <span class="comment">// 处理模板templete，编译成render函数，render不存在的时候编译template,否则使用render</span></span><br><span class="line">  <span class="keyword">if</span> (!options.<span class="property">render</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> template = options.<span class="property">template</span>;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">/* todo... */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">      <span class="comment">/*获取el的outerHTML*/</span></span><br><span class="line">      template = <span class="title function_">getOuterHTML</span>(el);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (template) &#123;</span><br><span class="line">      <span class="comment">/* todo... */</span></span><br><span class="line">      <span class="comment">/* 编译模板，最后返回两个函数render和staticRenderFns */</span></span><br><span class="line">      <span class="keyword">var</span> ref = <span class="title function_">compileToFunctions</span>(template, &#123;</span><br><span class="line">        <span class="attr">shouldDecodeNewlines</span>: shouldDecodeNewlines,</span><br><span class="line">        <span class="attr">shouldDecodeNewlinesForHref</span>: shouldDecodeNewlinesForHref,</span><br><span class="line">        <span class="attr">delimiters</span>: options.<span class="property">delimiters</span>,</span><br><span class="line">        <span class="attr">comments</span>: options.<span class="property">comments</span></span><br><span class="line">      &#125;, <span class="variable language_">this</span>);</span><br><span class="line">      <span class="keyword">var</span> render = ref.<span class="property">render</span>;</span><br><span class="line">      <span class="keyword">var</span> staticRenderFns = ref.<span class="property">staticRenderFns</span>;</span><br><span class="line">      options.<span class="property">render</span> = render;</span><br><span class="line">      options.<span class="property">staticRenderFns</span> = staticRenderFns;</span><br><span class="line">      <span class="comment">/* todo... */</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//调用保存下来的mount方法</span></span><br><span class="line">  <span class="keyword">return</span> mount.<span class="title function_">call</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>当模板编译了之后调用公共挂载方法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 公共挂载方法</span></span><br><span class="line"><span class="title class_">Vue</span>$3.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$mount</span> = <span class="keyword">function</span> (<span class="params"></span></span><br><span class="line"><span class="params">  el,</span></span><br><span class="line"><span class="params">  hydrating</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? <span class="title function_">query</span>(el) : <span class="literal">undefined</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">mountComponent</span>(<span class="variable language_">this</span>, el, hydrating)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>挂载组件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">mountComponent</span> (</span><br><span class="line">  vm,</span><br><span class="line">  el,</span><br><span class="line">  hydrating</span><br><span class="line">) &#123;</span><br><span class="line">  vm.<span class="property">$el</span> = el;</span><br><span class="line">  <span class="keyword">if</span> (!vm.<span class="property">$options</span>.<span class="property">render</span>) &#123;</span><br><span class="line">    vm.<span class="property">$options</span>.<span class="property">render</span> = createEmptyVNode;</span><br><span class="line">    <span class="comment">/* todo */</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">callHook</span>(vm, <span class="string">&#x27;beforeMount&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> updateComponent;</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">&quot;development&quot;</span> !== <span class="string">&#x27;production&#x27;</span> &amp;&amp; config.<span class="property">performance</span> &amp;&amp; mark) &#123;</span><br><span class="line">    updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">/* todo... */</span></span><br><span class="line">      vm.<span class="title function_">_update</span>(vnode, hydrating);</span><br><span class="line">      <span class="comment">/* todo... */</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    updateComponent = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">      vm.<span class="title function_">_update</span>(vm.<span class="title function_">_render</span>(), hydrating);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 我们在观察者的构造函数中将其设置为vm._watcher</span></span><br><span class="line"><span class="comment">   * 因为观察者的初始补丁可能会调用$forceUpdate（例如在子内部组件的挂载钩子），</span></span><br><span class="line"><span class="comment">   * 这依赖于已经定义的vm._watcher</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">new</span> <span class="title class_">Watcher</span>(vm, updateComponent, noop, <span class="literal">null</span>, <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span>);</span><br><span class="line">  hydrating = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 手动挂载实例，调用自己挂载</span></span><br><span class="line"><span class="comment">   * 在其插入的钩子中调用渲染创建的子组件</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">$vnode</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">    vm.<span class="property">_isMounted</span> = <span class="literal">true</span>;</span><br><span class="line">    <span class="title function_">callHook</span>(vm, <span class="string">&#x27;mounted&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>强制更新：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">$forceUpdate</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> vm = <span class="variable language_">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (vm.<span class="property">_watcher</span>) &#123;</span><br><span class="line">    vm.<span class="property">_watcher</span>.<span class="title function_">update</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;MVVM&quot;&gt;&lt;a href=&quot;#MVVM&quot; class=&quot;headerlink&quot; title=&quot;MVVM&quot;&gt;&lt;/a&gt;MVVM&lt;/h2&gt;&lt;p&gt;MVVM是Model-View-ViewModel 的简写,是MVC的改进版.&lt;/p&gt;
&lt;p&gt;在双向绑定中,Model和View之间没有耦合,通过操作Model，利用ViewModel提供的机制，自动实现ViewModel的更新。&lt;/p&gt;
    
    </summary>
    
      <category term="javascript" scheme="https://nightme.github.io/categories/javascript/"/>
    
    
      <category term="vue" scheme="https://nightme.github.io/tags/vue/"/>
    
  </entry>
  
  <entry>
    <title>水平垂直居中</title>
    <link href="https://nightme.github.io/2018/01/10/%E6%B0%B4%E5%B9%B3%E5%9E%82%E7%9B%B4%E5%B1%85%E4%B8%AD/"/>
    <id>https://nightme.github.io/2018/01/10/水平垂直居中/</id>
    <published>2018-01-10T08:45:29.000Z</published>
    <updated>2025-09-19T04:25:12.111Z</updated>
    
    <content type="html"><![CDATA[<h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一:"></a>方案一:</h2><p>使用<code>inline-block</code>与伪类</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-wrap</span>&#123;<span class="attribute">display</span>:block;<span class="attribute">position</span>:fixed;<span class="attribute">top</span>:<span class="number">0</span>;<span class="attribute">left</span>:<span class="number">0</span>;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">height</span>:<span class="number">100%</span>;<span class="attribute">z-index</span>:<span class="number">1501</span>;<span class="attribute">text-align</span>: center;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-box</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#ddd</span>;<span class="attribute">background-color</span>:<span class="number">#fff</span>;<span class="attribute">display</span>:inline-block;<span class="attribute">vertical-align</span>:middle;<span class="attribute">text-align</span><span class="selector-pseudo">:left</span>;<span class="attribute">color</span>:<span class="number">#333</span>;<span class="attribute">position</span>:relative;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-wrap</span><span class="selector-pseudo">:after</span>&#123;<span class="attribute">content</span>: <span class="string">&quot; &quot;</span>;<span class="attribute">width</span>: <span class="number">0</span>;<span class="attribute">height</span>: <span class="number">100%</span>;<span class="attribute">display</span>: inline-block;<span class="attribute">vertical-align</span>: middle;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-popup-wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-popup-box&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">style</span>=<span class="string">&quot;text-align: center;padding:30px 100px;&quot;</span>&gt;</span>测试数据<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二:"></a>方案二:</h2><p>使用table-cell与vertical-align</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-wrap</span>&#123;<span class="attribute">display</span>: table;<span class="attribute">position</span>:fixed;<span class="attribute">top</span>:<span class="number">0</span>;<span class="attribute">left</span>:<span class="number">0</span>;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.box</span>&#123;<span class="attribute">display</span>: table-cell;<span class="attribute">vertical-align</span>: middle;<span class="attribute">text-align</span>: center;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-popup-wrap&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;border:1px solid blue;display:inline-block;&quot;</span>&gt;</span>行内块元素不定宽高<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;border:1px solid red; width:300px;margin:auto;&quot;</span>&gt;</span>块元素定宽<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;border:1px solid #ff00ff;&quot;</span>&gt;</span>行内素元素<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="方案三"><a href="#方案三" class="headerlink" title="方案三:"></a>方案三:</h2><p>fixed&#x2F;absolute定位定宽定高</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-wrap</span>&#123;<span class="attribute">position</span>:absolute;<span class="attribute">top</span>:<span class="number">0</span>;<span class="attribute">right</span>:<span class="number">0</span>;<span class="attribute">bottom</span>:<span class="number">0</span>;<span class="attribute">left</span>:<span class="number">0</span>;<span class="attribute">margin</span>:auto;<span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">height</span>:<span class="number">200px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#ddd</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-popup-wrap&quot;</span>&gt;</span></span><br><span class="line">    fixed/absolute定位定宽定高</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="方案四"><a href="#方案四" class="headerlink" title="方案四"></a>方案四</h2><p>定位于<code>transform</code>不定宽不定高</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-wrap</span>&#123;<span class="attribute">position</span>: fixed;<span class="attribute">top</span>:<span class="number">50%</span>;<span class="attribute">left</span>:<span class="number">50%</span>;<span class="attribute">transform</span>:<span class="built_in">translate</span>(-<span class="number">50%</span>,-<span class="number">50%</span>);<span class="attribute">text-align</span>: center;<span class="attribute">border</span>:<span class="number">1px</span> solid red;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-popup-wrap&quot;</span>&gt;</span></span><br><span class="line">    (fixed/absolute)与transform不定宽不定高</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="方案五"><a href="#方案五" class="headerlink" title="方案五"></a>方案五</h2><p>使用<code>flex</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-wrap</span>&#123;<span class="attribute">display</span>:flex;<span class="attribute">align-items</span>: center;<span class="attribute">justify-content</span>: center;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">height</span>:<span class="number">100%</span>;<span class="attribute">position</span>:fixed;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.box</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid red;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-popup-wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span>不定宽不定高<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="方案六"><a href="#方案六" class="headerlink" title="方案六"></a>方案六</h2><p>宽高取一半负值</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-wrap</span>&#123;<span class="attribute">position</span>:fixed;<span class="attribute">top</span>:<span class="number">50%</span>;<span class="attribute">left</span>:<span class="number">50%</span>;<span class="attribute">width</span>:<span class="number">100px</span>;<span class="attribute">height</span>:<span class="number">100px</span>;<span class="attribute">margin-left</span>:-<span class="number">50px</span>;<span class="attribute">margin-top</span>:-<span class="number">50px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid red;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-popup-wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>定宽定高<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="方案七"><a href="#方案七" class="headerlink" title="方案七"></a>方案七</h2><p>使用grid</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    可以使用grid-column-start:1;和grid-column-end:-1;（或者简写grid-column: 1 / -1;）；</span></span><br><span class="line"><span class="comment">    从第一列网格线到第二列网格线创建一个网格标签（创建一个跨列网格）。使用比-1更小的值也是可以的</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.g-popup-wrap</span>&#123;<span class="attribute">display</span>: grid;<span class="attribute">position</span>:fixed;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">height</span>:<span class="number">100%</span>;<span class="attribute">grid-template-columns</span>: <span class="built_in">repeat</span>(<span class="number">3</span>, <span class="number">1</span>fr);<span class="attribute">grid-template-rows</span>: <span class="built_in">repeat</span>(<span class="number">3</span>, <span class="number">1</span>fr);&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.box</span>&#123;<span class="attribute">grid-column</span>: <span class="number">2</span> / <span class="number">2</span>;<span class="attribute">grid-row</span>: <span class="number">2</span> / <span class="number">2</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid red;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;g-popup-wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span>宽高依赖父级grid<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;方案一&quot;&gt;&lt;a href=&quot;#方案一&quot; class=&quot;headerlink&quot; title=&quot;方案一:&quot;&gt;&lt;/a&gt;方案一:&lt;/h2&gt;&lt;p&gt;使用&lt;code&gt;inline-block&lt;/code&gt;与伪类&lt;/p&gt;
&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;language-css&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    *&amp;#123;&lt;span class=&quot;attribute&quot;&gt;margin&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;padding&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    &lt;span class=&quot;selector-class&quot;&gt;.g-popup-wrap&lt;/span&gt;&amp;#123;&lt;span class=&quot;attribute&quot;&gt;display&lt;/span&gt;:block;&lt;span class=&quot;attribute&quot;&gt;position&lt;/span&gt;:fixed;&lt;span class=&quot;attribute&quot;&gt;top&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;left&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;width&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;height&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;z-index&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;1501&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;text-align&lt;/span&gt;: center;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    &lt;span class=&quot;selector-class&quot;&gt;.g-popup-box&lt;/span&gt;&amp;#123;&lt;span class=&quot;attribute&quot;&gt;border&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;1px&lt;/span&gt; solid &lt;span class=&quot;number&quot;&gt;#ddd&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;background-color&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;#fff&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;display&lt;/span&gt;:inline-block;&lt;span class=&quot;attribute&quot;&gt;vertical-align&lt;/span&gt;:middle;&lt;span class=&quot;attribute&quot;&gt;text-align&lt;/span&gt;&lt;span class=&quot;selector-pseudo&quot;&gt;:left&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;color&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;#333&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;position&lt;/span&gt;:relative;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    &lt;span class=&quot;selector-class&quot;&gt;.g-popup-wrap&lt;/span&gt;&lt;span class=&quot;selector-pseudo&quot;&gt;:after&lt;/span&gt;&amp;#123;&lt;span class=&quot;attribute&quot;&gt;content&lt;/span&gt;: &lt;span class=&quot;string&quot;&gt;&amp;quot; &amp;quot;&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;width&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;height&lt;/span&gt;: &lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;display&lt;/span&gt;: inline-block;&lt;span class=&quot;attribute&quot;&gt;vertical-align&lt;/span&gt;: middle;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;&lt;/span&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;div&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;g-popup-wrap&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;div&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;g-popup-box&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;p&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;style&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;text-align: center;padding:30px 100px;&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;测试数据&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="css" scheme="https://nightme.github.io/categories/css/"/>
    
    
      <category term="css" scheme="https://nightme.github.io/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>页面布局</title>
    <link href="https://nightme.github.io/2018/01/01/%E9%A1%B5%E9%9D%A2%E5%B8%83%E5%B1%80/"/>
    <id>https://nightme.github.io/2018/01/01/页面布局/</id>
    <published>2017-12-31T17:45:29.000Z</published>
    <updated>2025-09-19T04:25:12.114Z</updated>
    
    <content type="html"><![CDATA[<h2 id="两列左侧定宽，右侧自适应"><a href="#两列左侧定宽，右侧自适应" class="headerlink" title="两列左侧定宽，右侧自适应"></a>两列左侧定宽，右侧自适应</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.aside</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;<span class="attribute">height</span>:<span class="number">100%</span>;<span class="attribute">position</span>:relative;<span class="attribute">margin-right</span>:-<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:right</span>;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main-container</span>&#123;<span class="attribute">margin-left</span>:<span class="number">210px</span>;<span class="attribute">height</span>:<span class="number">100%</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid red;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;aside&quot;</span>&gt;</span></span><br><span class="line">        aside</span><br><span class="line">    <span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">&quot;main-container&quot;</span>&gt;</span>main<span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="两列右侧定宽，左侧自适应"><a href="#两列右侧定宽，左侧自适应" class="headerlink" title="两列右侧定宽，左侧自适应"></a>两列右侧定宽，左侧自适应</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.aside</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:right</span>;<span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;<span class="attribute">height</span>:<span class="number">100%</span>;<span class="attribute">position</span>:relative;<span class="attribute">margin-left</span>:-<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main-container</span>&#123;<span class="attribute">margin-right</span>:<span class="number">210px</span>;<span class="attribute">height</span>:<span class="number">100%</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid red;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">&quot;main-container&quot;</span>&gt;</span>main<span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;aside&quot;</span>&gt;</span></span><br><span class="line">        aside</span><br><span class="line">    <span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="三列右侧自适应布局"><a href="#三列右侧自适应布局" class="headerlink" title="三列右侧自适应布局"></a>三列右侧自适应布局</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidebar</span>,<span class="selector-class">.sidenav</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">position</span>:relative;<span class="attribute">box-sizing</span>: border-box;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidebar</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid red;<span class="attribute">width</span>:<span class="number">60px</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidenav</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;<span class="attribute">width</span>:<span class="number">200px</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:right</span>;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">margin-left</span>:-<span class="number">260px</span>;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main-container</span>&#123;<span class="attribute">margin-left</span>:<span class="number">270px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid green;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sidebar --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;sidebar&quot;</span>&gt;</span></span><br><span class="line">        sidebar</span><br><span class="line">    <span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sidenav --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;sidenav&quot;</span>&gt;</span></span><br><span class="line">        sidenav</span><br><span class="line">    <span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">&quot;main-container&quot;</span>&gt;</span>main<span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="三列左侧自适应布局"><a href="#三列左侧自适应布局" class="headerlink" title="三列左侧自适应布局"></a>三列左侧自适应布局</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidebar</span>,<span class="selector-class">.sidenav</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:right</span>;<span class="attribute">position</span>:relative;<span class="attribute">box-sizing</span>: border-box;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidebar</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid red;<span class="attribute">width</span>:<span class="number">60px</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidenav</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;<span class="attribute">width</span>:<span class="number">200px</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:right</span>;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">margin-right</span>:-<span class="number">260px</span>;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main-container</span>&#123;<span class="attribute">margin-right</span>:<span class="number">270px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid green;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sidebar --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;sidebar&quot;</span>&gt;</span></span><br><span class="line">        sidebar</span><br><span class="line">    <span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sidenav --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;sidenav&quot;</span>&gt;</span></span><br><span class="line">        sidenav</span><br><span class="line">    <span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">&quot;main-container&quot;</span>&gt;</span>main<span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="三列中间自适应布局"><a href="#三列中间自适应布局" class="headerlink" title="三列中间自适应布局"></a>三列中间自适应布局</h2><h3 id="margin负值法"><a href="#margin负值法" class="headerlink" title="margin负值法"></a>margin负值法</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidebar</span>,<span class="selector-class">.sidenav</span>&#123;<span class="attribute">position</span>:relative;<span class="attribute">box-sizing</span>: border-box;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidebar</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid red;<span class="attribute">width</span>:<span class="number">60px</span>;<span class="attribute">margin-right</span>:-<span class="number">100%</span>&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sidenav</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:right</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;<span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">margin-left</span>:-<span class="number">100%</span>&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main-container</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid green;<span class="attribute">height</span>:<span class="number">100%</span>;<span class="attribute">margin-left</span>:<span class="number">60px</span>;<span class="attribute">margin-right</span>:<span class="number">200px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- sidebar --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;sidebar&quot;</span>&gt;</span></span><br><span class="line">        sidebar</span><br><span class="line">    <span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">&quot;main-container&quot;</span>&gt;</span>main<span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- sidenav --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aside</span> <span class="attr">class</span>=<span class="string">&quot;sidenav&quot;</span>&gt;</span></span><br><span class="line">        sidenav</span><br><span class="line">    <span class="tag">&lt;/<span class="name">aside</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="圣杯布局"><a href="#圣杯布局" class="headerlink" title="圣杯布局"></a>圣杯布局</h3><p>三列中间自适应布局</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.left</span>,<span class="selector-class">.middle</span>,<span class="selector-class">.right</span>&#123;<span class="attribute">position</span>: relative;<span class="attribute">float</span>: left;<span class="attribute">box-sizing</span>:border-box;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.middle</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid red;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">padding-left</span>:<span class="number">100px</span>;<span class="attribute">padding-right</span>:<span class="number">200px</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.left</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;<span class="attribute">width</span>:<span class="number">100px</span>;<span class="attribute">margin-left</span>:-<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.right</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid green;<span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">margin-left</span>:-<span class="number">200px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;middle&quot;</span>&gt;</span>middle<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span>left<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span>&gt;</span>right<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="双飞翼布局"><a href="#双飞翼布局" class="headerlink" title="双飞翼布局"></a>双飞翼布局</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>,<span class="selector-class">.sub</span>,<span class="selector-class">.extra</span>&#123;<span class="attribute">float</span>: left;<span class="attribute">box-sizing</span>:border-box;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">width</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main-inner</span>&#123;<span class="attribute">margin-left</span>:<span class="number">100px</span>;<span class="attribute">margin-right</span>:<span class="number">200px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid red;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sub</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;<span class="attribute">width</span>:<span class="number">100px</span>;<span class="attribute">margin-left</span>:-<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.extra</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid green;<span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">margin-left</span>:-<span class="number">200px</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-inner&quot;</span>&gt;</span>main<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sub&quot;</span>&gt;</span>sub<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;extra&quot;</span>&gt;</span>extra<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="浮动布局"><a href="#浮动布局" class="headerlink" title="浮动布局"></a>浮动布局</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>,<span class="selector-class">.sub</span>,<span class="selector-class">.extra</span>&#123;<span class="attribute">box-sizing</span>:border-box;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">margin-left</span>: <span class="number">100px</span>;<span class="attribute">margin-right</span>:<span class="number">200px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid red;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sub</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">width</span>:<span class="number">100px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.extra</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:right</span>;<span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid green;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sub&quot;</span>&gt;</span>sub<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;extra&quot;</span>&gt;</span>extra<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span>main<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="定位布局"><a href="#定位布局" class="headerlink" title="定位布局"></a>定位布局</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sub</span>,<span class="selector-class">.extra</span>&#123;<span class="attribute">position</span>:absolute;<span class="attribute">top</span>:<span class="number">0</span>; <span class="attribute">box-sizing</span>:border-box;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.sub</span>&#123;<span class="attribute">left</span>:<span class="number">0</span>;<span class="attribute">width</span>:<span class="number">100px</span>; <span class="attribute">border</span>:<span class="number">1px</span> solid blue;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.extra</span>&#123;<span class="attribute">right</span>:<span class="number">0</span>;<span class="attribute">width</span>:<span class="number">200px</span>; <span class="attribute">border</span>:<span class="number">1px</span> solid green;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">margin-left</span>: <span class="number">100px</span>;<span class="attribute">margin-right</span>:<span class="number">200px</span>; <span class="attribute">border</span>:<span class="number">1px</span> solid red;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;sub&quot;</span>&gt;</span>sub<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;extra&quot;</span>&gt;</span>extra<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span>main<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="margin与padding互冲等高"><a href="#margin与padding互冲等高" class="headerlink" title="margin与padding互冲等高"></a>margin与padding互冲等高</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">border</span>:<span class="number">1px</span> solid black;&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.left</span>,<span class="selector-class">.main</span>,<span class="selector-class">.right</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">padding-bottom</span>:<span class="number">99999px</span>;<span class="attribute">margin-bottom</span>:-<span class="number">99999px</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.left</span> &#123;<span class="attribute">width</span>: <span class="number">100px</span>;<span class="attribute">background-color</span>:<span class="number">#ddd</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">width</span>:<span class="number">300px</span>;<span class="attribute">background-color</span>:blue;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.right</span>&#123;<span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">background-color</span>:red;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">&quot;wrap&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span> left<span class="tag">&lt;<span class="name">br</span>/&gt;</span> left<span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span>main<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span>&gt;</span>right<span class="tag">&lt;<span class="name">br</span>/&gt;</span>right<span class="tag">&lt;<span class="name">br</span>/&gt;</span>  <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="边界等高"><a href="#边界等高" class="headerlink" title="边界等高"></a>边界等高</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">border</span>:<span class="number">1px</span> solid black;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">background-color</span>:blue;<span class="attribute">width</span>:<span class="number">500px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-left</span>:<span class="number">100px</span> solid <span class="number">#0f0</span>; <span class="comment">/* 边框大小等于左边栏宽度，颜色和左边栏背景色一致*/</span></span></span><br><span class="line"><span class="language-css">        <span class="attribute">border-right</span>:<span class="number">200px</span> solid <span class="number">#f00</span>;<span class="comment">/* 边框大小等于右边栏宽度，颜色和右边栏背景色一致*/</span></span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.left</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>;<span class="attribute">width</span>:<span class="number">100px</span>; <span class="attribute">margin-left</span>:-<span class="number">100px</span>&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.content</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:left</span>; <span class="attribute">width</span>:<span class="number">500px</span>; <span class="attribute">margin-right</span>:-<span class="number">500px</span>; &#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.right</span>&#123;<span class="attribute">float</span><span class="selector-pseudo">:right</span>; <span class="attribute">width</span>:<span class="number">200px</span>; <span class="attribute">margin-right</span>:-<span class="number">200px</span>; &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span>main<span class="tag">&lt;<span class="name">br</span>/&gt;</span>main<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span>left<span class="tag">&lt;<span class="name">br</span>/&gt;</span> left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span>&gt;</span>right<span class="tag">&lt;<span class="name">br</span>/&gt;</span> <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="表格等高"><a href="#表格等高" class="headerlink" title="表格等高"></a>表格等高</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*&#123;margin:0;padding:0;&#125;</span><br><span class="line">html,body&#123;height:100%;&#125;</span><br><span class="line">.wrap&#123;overflow:hidden;border:1px solid black;&#125;</span><br><span class="line">.main&#123;display:table;&#125;</span><br><span class="line">.left,.content,.right&#123;display:table-cell;&#125;</span><br><span class="line">.left&#123;width:100px;border:1px solid blue;&#125;</span><br><span class="line">.content&#123;width:500px;border:1px solid red;&#125;</span><br><span class="line">.right&#123; width:200px;border:1px solid green;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span>main<span class="tag">&lt;<span class="name">br</span>/&gt;</span>main<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span>left<span class="tag">&lt;<span class="name">br</span>/&gt;</span> left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span>&gt;</span>right<span class="tag">&lt;<span class="name">br</span>/&gt;</span> <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="flex-等高"><a href="#flex-等高" class="headerlink" title="flex 等高"></a>flex 等高</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    *&#123;<span class="attribute">margin</span>:<span class="number">0</span>;<span class="attribute">padding</span>:<span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">html</span>,<span class="selector-tag">body</span>&#123;<span class="attribute">height</span>:<span class="number">100%</span>;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.wrap</span>&#123;<span class="attribute">overflow</span>:hidden;<span class="attribute">border</span>:<span class="number">1px</span> solid black;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.main</span>&#123;<span class="attribute">display</span>:flex;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.left</span>&#123;<span class="attribute">width</span>:<span class="number">100px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid blue;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.content</span>&#123;<span class="attribute">width</span>:<span class="number">500px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid red;&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.right</span>&#123; <span class="attribute">width</span>:<span class="number">200px</span>;<span class="attribute">border</span>:<span class="number">1px</span> solid green;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">main</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span>main<span class="tag">&lt;<span class="name">br</span>/&gt;</span>main<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span>left<span class="tag">&lt;<span class="name">br</span>/&gt;</span> left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span>left <span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span>&gt;</span>right<span class="tag">&lt;<span class="name">br</span>/&gt;</span> <span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">main</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;两列左侧定宽，右侧自适应&quot;&gt;&lt;a href=&quot;#两列左侧定宽，右侧自适应&quot; class=&quot;headerlink&quot; title=&quot;两列左侧定宽，右侧自适应&quot;&gt;&lt;/a&gt;两列左侧定宽，右侧自适应&lt;/h2&gt;&lt;figure class=&quot;highlight html&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&quot;language-css&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    *&amp;#123;&lt;span class=&quot;attribute&quot;&gt;margin&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;padding&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    &lt;span class=&quot;selector-tag&quot;&gt;html&lt;/span&gt;,&lt;span class=&quot;selector-tag&quot;&gt;body&lt;/span&gt;&amp;#123;&lt;span class=&quot;attribute&quot;&gt;height&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    &lt;span class=&quot;selector-class&quot;&gt;.wrap&lt;/span&gt;&amp;#123;&lt;span class=&quot;attribute&quot;&gt;overflow&lt;/span&gt;:hidden;&lt;span class=&quot;attribute&quot;&gt;height&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    &lt;span class=&quot;selector-class&quot;&gt;.aside&lt;/span&gt;&amp;#123;&lt;span class=&quot;attribute&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;selector-pseudo&quot;&gt;:left&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;width&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;200px&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;border&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;1px&lt;/span&gt; solid blue;&lt;span class=&quot;attribute&quot;&gt;height&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;position&lt;/span&gt;:relative;&lt;span class=&quot;attribute&quot;&gt;margin-right&lt;/span&gt;:-&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    &lt;span class=&quot;selector-class&quot;&gt;.main&lt;/span&gt;&amp;#123;&lt;span class=&quot;attribute&quot;&gt;float&lt;/span&gt;&lt;span class=&quot;selector-pseudo&quot;&gt;:right&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;width&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;height&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;    &lt;span class=&quot;selector-class&quot;&gt;.main-container&lt;/span&gt;&amp;#123;&lt;span class=&quot;attribute&quot;&gt;margin-left&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;210px&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;height&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;100%&lt;/span&gt;;&lt;span class=&quot;attribute&quot;&gt;border&lt;/span&gt;:&lt;span class=&quot;number&quot;&gt;1px&lt;/span&gt; solid red;&amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;language-css&quot;&gt;&lt;/span&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;style&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;div&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;wrap&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;aside&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;aside&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        aside&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;aside&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;section&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;main&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;tag&quot;&gt;&amp;lt;&lt;span class=&quot;name&quot;&gt;article&lt;/span&gt; &lt;span class=&quot;attr&quot;&gt;class&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&amp;quot;main-container&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;main&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;article&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;section&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;tag&quot;&gt;&amp;lt;/&lt;span class=&quot;name&quot;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="css" scheme="https://nightme.github.io/categories/css/"/>
    
    
      <category term="css" scheme="https://nightme.github.io/tags/css/"/>
    
  </entry>
  
  <entry>
    <title>OSI七层模型</title>
    <link href="https://nightme.github.io/2017/12/08/OSI%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B/"/>
    <id>https://nightme.github.io/2017/12/08/OSI七层模型/</id>
    <published>2017-12-08T02:14:44.000Z</published>
    <updated>2025-09-19T04:25:12.070Z</updated>
    
    <content type="html"><![CDATA[<h2 id="OSI"><a href="#OSI" class="headerlink" title="OSI"></a>OSI</h2><p>OSI（Open System Interconnection）参考模型是国际标准化组织（ISO）制定的一个用于计算机或通信系统间互联的标准体系，一般称为OSI参考模型或七层模型。</p><p>为开放式互连信息系统提供了一种功能结构的框架。它从高到低分别是：应用层、表示层、会话层、传输层、网络层、数链路层、物理层</p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/201801180940.jpg" alt="image"></p><span id="more"></span><h3 id="应用层（Application-Layer）"><a href="#应用层（Application-Layer）" class="headerlink" title="应用层（Application Layer）"></a>应用层（Application Layer）</h3><p>应用层是OSI参考模型中最最高层，是通信用户之间的窗口，为用户提供网络管理、文件传输、事务处理等服务.</p><p>应用层为操作系统或网络应用程序提供访问网络服务的接口。</p><p>典型协议：HTTP、POP3、SMTP、IMAP、DNS、DHCP、FTP、Telnet、SSH、NNTP、XMPP、SIP、RPC、RTCP、SDP、MMS、SOAP、SSDP等。</p><p>典型设备：终端设备（PC、手机、平板等）</p><h3 id="表示层-Presentation-Layer"><a href="#表示层-Presentation-Layer" class="headerlink" title="表示层(Presentation Layer)"></a>表示层(Presentation Layer)</h3><p>表示层向上对应用层提供服务，向下接收来自会话层的服务。</p><p>表示层要完成某些特定的功能，主要有不同数据编码格式的转换，提供数据压缩、解压缩服务，对数据进行加密、解密。</p><p>例如：图像格式的显示，就是由位于表示层的协议来支持</p><p>表示层没有协议，应用层的HTTP、FTP、Telnet等协议有类似的功能，传输层的TLS&#x2F;SSL也有类似功能。</p><h3 id="会话层（Session-Layer）"><a href="#会话层（Session-Layer）" class="headerlink" title="会话层（Session Layer）"></a>会话层（Session Layer）</h3><p>会话层也可以称为会晤层或对话层，在会话层及以上的高层次中，数据传送的单位不再另外命名，统称为报文。</p><p>会话层不参与具体的传输，它提供包括访问验证和会话管理在内的建立和维护应用之间通信的机制，如服务器验证用户登录便是由会话层完成的。</p><h3 id="传输层（Transport-Layer）"><a href="#传输层（Transport-Layer）" class="headerlink" title="传输层（Transport Layer）"></a>传输层（Transport Layer）</h3><p>传输层也称为运输层。</p><p>传输层建立在网络层和会话层之间，实质上它是网络体系结构中高低层之间衔接的一个接口层。用一个寻址机制来标识一个特定的应用程序（端口号）。</p><p>传输层的主要功能是从会话层接收数据，根据需要把数据切成较小的数据片，并把数据传送给网络层，确保数据片正确到达网络层，从而实现两层数据的透明传送。</p><p>传输层的数据单元是由数据组织成的数据段（segment）这个层负责获取全部信息，因此，它必须跟踪数据单元碎片、乱序到达的数据包和其它在传输过程中可能发生的危险。</p><p>传输层的典型协议包括：TCP、UDP、SPX、PPTP、TLS&#x2F;SSL、SCTP、DCCP等。</p><h3 id="网络层（Network-Layer）"><a href="#网络层（Network-Layer）" class="headerlink" title="网络层（Network Layer）"></a>网络层（Network Layer）</h3><p>网络层也称通信子网层，是高层协议之间的界面层，用于控制通信子网的操作，是通信子网与资源子网的接口。</p><p>网络层的任务就是选择合适的网间路由和交换结点，确保数据及时传送。网络层将解封装数据链路层收到的帧，提取数据包，包中封装有网络层包头，其中含有逻辑地址信息源站点和目的站点地址的网络地址。</p><p>网络层主要功能是基于网络层地址（IP地址）进行不同网络系统间的路径选择。</p><p>网络层的典型协议包括：IP、IPX、IPsec、RIP、OSPF、BGP、IGMP等。</p><p>网络层典型设备：网关、路由器</p><h3 id="数据链路层（Data-Link-Layer）"><a href="#数据链路层（Data-Link-Layer）" class="headerlink" title="数据链路层（Data Link Layer）"></a>数据链路层（Data Link Layer）</h3><p>在物理层提供比特流服务的基础上，将比特信息封装成数据帧Frame，起到在物理层上建立、撤销、标识逻辑链接和链路复用以及差错校验等功能。</p><p>该层的作用包括：物理地址寻址、数据的成帧、流量控制、数据的检错、重发等,在这一层，数据的单位称为帧（frame）。</p><p>数据链路层典型协议包括：IEEE 802.11、PPP、L2TP、STP、ATM、SDLC、HDLC Ethernet、GPRS、HSPA、PPPoE帧中继等。</p><p>数据链路层的典型设备：二层交换机、网桥、网卡</p><h3 id="物理层（Physical-Layer）"><a href="#物理层（Physical-Layer）" class="headerlink" title="物理层（Physical Layer）"></a>物理层（Physical Layer）</h3><p>物理层是OSI分层结构体系中最重要、最基础的一层，它建立在传输媒介基础上，起建立、维护和取消物理连接作用，实现设备之间的物理接口。物理层之接收和发送一串比特(bit)流，不考虑信息的意义和信息结构。</p><p>属于物理层定义的典型规范代表包括：EIA&#x2F;TIARS-232、EIA&#x2F;TIARS-449、V.35、RJ-45等。</p><p>物理层的典型设备：光纤、同轴电缆、双绞线、中继器和集线器</p><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B">OSI模型-维基百科</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;OSI&quot;&gt;&lt;a href=&quot;#OSI&quot; class=&quot;headerlink&quot; title=&quot;OSI&quot;&gt;&lt;/a&gt;OSI&lt;/h2&gt;&lt;p&gt;OSI（Open System Interconnection）参考模型是国际标准化组织（ISO）制定的一个用于计算机或通信系统间互联的标准体系，一般称为OSI参考模型或七层模型。&lt;/p&gt;
&lt;p&gt;为开放式互连信息系统提供了一种功能结构的框架。它从高到低分别是：应用层、表示层、会话层、传输层、网络层、数链路层、物理层&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/201801180940.jpg&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="前端" scheme="https://nightme.github.io/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="前端" scheme="https://nightme.github.io/tags/%E5%89%8D%E7%AB%AF/"/>
    
  </entry>
  
  <entry>
    <title>ngrok安装使用</title>
    <link href="https://nightme.github.io/2017/11/08/ngrok%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/"/>
    <id>https://nightme.github.io/2017/11/08/ngrok安装使用/</id>
    <published>2017-11-08T15:14:44.000Z</published>
    <updated>2025-09-19T04:25:12.095Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ngrok安装使用"><a href="#ngrok安装使用" class="headerlink" title="ngrok安装使用"></a>ngrok安装使用</h2><h2 id="ngrok内网穿透"><a href="#ngrok内网穿透" class="headerlink" title="ngrok内网穿透"></a>ngrok内网穿透</h2><ol><li><p>注册账号，并且登陆</p></li><li><p>开通隧道，选择免费的<br> <img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202175011.png" alt="image"></p></li></ol><span id="more"></span><ol start="3"><li><p>填写信息<br> <a href="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202175733.png">http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202175733.png</a></p></li><li><p>隧道管理 查看自己开通的隧道，可以修改并删除</p><p> <img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202180128.png" alt="image"></p></li><li><p>去首页下载适合自己系统的客户端，并且解压有以下文件,点击<code>.bat</code>文件启动</p><p> <img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202180623.png" alt="image"></p></li><li><p>在隧道管理页面里面复制 <code>隧道id</code> ,粘贴到启动到的客户端界面中，如下：</p><p> <img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202180939.png" alt="image"></p></li><li><p>回车如下，可以到信息</p><p> <img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202181217.png" alt="image"></p></li><li><p>访问外网地址，如下：</p><p> <img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202181612.png" alt="image"></p></li><li><p>访问<code>http://127.0.0.1:4040</code>则可以看到请求记录</p></li></ol><h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><ul><li>开通隧道时选择的 域名类型 选择前置域名，访问时直接访问前置域名皆可以了</li></ul><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://www.ngrok.cc/">ngrok-中文官网</a></li><li><a href="https://ngrok.com/">ngrok-英文官网</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ngrok安装使用&quot;&gt;&lt;a href=&quot;#ngrok安装使用&quot; class=&quot;headerlink&quot; title=&quot;ngrok安装使用&quot;&gt;&lt;/a&gt;ngrok安装使用&lt;/h2&gt;&lt;h2 id=&quot;ngrok内网穿透&quot;&gt;&lt;a href=&quot;#ngrok内网穿透&quot; class=&quot;headerlink&quot; title=&quot;ngrok内网穿透&quot;&gt;&lt;/a&gt;ngrok内网穿透&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;注册账号，并且登陆&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;开通隧道，选择免费的&lt;br&gt; &lt;img src=&quot;http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20180202175011.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
      <category term="工具" scheme="https://nightme.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="工具" scheme="https://nightme.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>函数apply-call-bind</title>
    <link href="https://nightme.github.io/2017/06/18/%E5%87%BD%E6%95%B0apply-call-bind/"/>
    <id>https://nightme.github.io/2017/06/18/函数apply-call-bind/</id>
    <published>2017-06-17T16:50:28.000Z</published>
    <updated>2025-09-19T04:25:12.110Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Function-prototype-apply"><a href="#Function-prototype-apply" class="headerlink" title="Function.prototype.apply()"></a>Function.prototype.apply()</h2><p><code>apply()</code> 方法调用一个函数, 其具有一个指定的this值，以及作为一个数组（或类似数组的对象）提供的参数。</p><h3 id="语法："><a href="#语法：" class="headerlink" title="语法："></a>语法：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun.<span class="title function_">apply</span>(thisArg, [argsArray])</span><br></pre></td></tr></table></figure><span id="more"></span><ul><li><p><code>thisArg</code>: 在 <code>fun</code> 函数运行时指定的 <code>this</code> 值。需要注意的是，指定的 <code>this</code> 值并不一定是该函数执行时真正的 <code>this</code> 值，如果这个函数处于非严格模式下，则指定为 <code>null</code> 或 <code>undefined</code> 时会自动指向全局对象（浏览器中就是<code>window</code>对象）,同时值为原始值（数字，字符串，布尔值）的 <code>this</code> 会指向该原始值的自动包装对象。</p></li><li><p><code>argsArray</code>: 一个数组或者类数组对象，其中的数组元素将作为单独的参数传给 fun 函数。如果该参数的值为null 或 undefined，则表示不需要传入任何参数。从ECMAScript 5 开始可以使用类数组对象。</p></li></ul><p>从 <code>ECMAScript</code> 第5版开始，可以使用任何种类的类数组对象，就是说只要有一个 <code>length</code> 属性和<code>[0...length)</code> 范围的整数属性。例如现在可以使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/NodeList"><code>NodeList</code></a> 或一个自己定义的类似 <code>&#123;&#39;length&#39;: 2, &#39;0&#39;: &#39;eat&#39;, &#39;1&#39;: &#39;bananas&#39;&#125;</code> 形式的对象。</p><p><strong>注意：Chrome 14 以及 <code>Internet Explorer 9</code> 仍然不接受类数组对象。如果传入类数组对象，它们会抛出异常。</strong></p><h3 id="例子："><a href="#例子：" class="headerlink" title="例子："></a>例子：</h3><h4 id="例1"><a href="#例1" class="headerlink" title="例1"></a>例1</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> numbers = [<span class="number">5</span>, <span class="number">6</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">7</span>,+<span class="title class_">Infinity</span>,-<span class="title class_">Infinity</span>];</span><br><span class="line">max = <span class="title class_">Math</span>.<span class="property">max</span>.<span class="title function_">apply</span>(<span class="literal">null</span>, numbers); <span class="comment">//Infinity</span></span><br><span class="line">min = <span class="title class_">Math</span>.<span class="property">min</span>.<span class="title function_">apply</span>(<span class="literal">null</span>, numbers); <span class="comment">//-Infinity</span></span><br></pre></td></tr></table></figure><h4 id="例2"><a href="#例2" class="headerlink" title="例2"></a>例2</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cbj = &#123;</span><br><span class="line">    <span class="attr">lang</span>:<span class="string">&quot;汉语&quot;</span>,</span><br><span class="line">    <span class="attr">speak</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">lang</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ebj = &#123;</span><br><span class="line">    <span class="attr">lang</span>:<span class="string">&quot;英语&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">cbj.<span class="property">speak</span>.<span class="title function_">apply</span>(ebj)<span class="comment">//英语</span></span><br></pre></td></tr></table></figure><h4 id="例3"><a href="#例3" class="headerlink" title="例3"></a>例3</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Person</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">lang</span> = <span class="string">&quot;谁知道你讲什么&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">Person</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">speak</span>  = <span class="keyword">function</span>(<span class="params">args1,args2</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;speak &quot;</span> + <span class="variable language_">this</span>.<span class="property">lang</span>,args1,args2);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> pe = <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">pe.<span class="title function_">speak</span>();<span class="comment">//speak 谁知道你讲什么 undefined undefined</span></span><br><span class="line">pe.<span class="property">speak</span>.<span class="title function_">apply</span>(&#123;<span class="attr">lang</span>:<span class="string">&#x27;汉语&#x27;</span>&#125;,[<span class="number">1</span>,<span class="number">2</span>]);<span class="comment">//speak 汉语 1 2</span></span><br></pre></td></tr></table></figure><p><strong>当心</strong>：如果用上面的方式调用 <code>apply</code>, 你很可能会遇到方法参数个数越界的问题. 当你对一个方法传入非常多的参数 (比如超过1W多个参数) 时, 就非常有可能会导致越界问题, 这个临界值是根据不同的 <code>JavaScript</code> 引擎而定的.</p><h2 id="Function-prototype-call"><a href="#Function-prototype-call" class="headerlink" title="Function.prototype.call()"></a>Function.prototype.call()</h2><p><code>call()</code> 方法调用一个函数, 其具有一个指定的this值和分别地提供的参数(参数的列表)。</p><h3 id="语法：-1"><a href="#语法：-1" class="headerlink" title="语法："></a>语法：</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun.<span class="title function_">call</span>(thisArg[, arg1[, arg2[, ...]]])</span><br></pre></td></tr></table></figure><ul><li><code>thisArg</code>:在<code>fun</code>函数运行时指定的<code>this</code>值。需要注意的是，指定的<code>this</code>值并不一定是该函数执行时真正的<code>this</code>值，如果这个函数处于非严格模式下，则指定为<code>null</code>和<code>undefined</code>的<code>this</code>值会自动指向全局对象(浏览器中就是<code>window</code>对象)，同时值为原始值(数字，字符串，布尔值)的<code>this</code>会指向该原始值的自动包装对象。</li><li><code>arg1, arg2, ...</code>:指定的参数列表。</li></ul><p>可以让<code>call()</code>中的对象调用当前对象所拥有的<code>function</code>。你可以使用<code>call()</code>来实现继承：写一个方法，然后让另外一个新的对象来继承它（而不是在新对象中再写一次这个方法）</p><h3 id="例子：-1"><a href="#例子：-1" class="headerlink" title="例子："></a>例子：</h3><h4 id="使用-call-方法调用函数并且指定上下文的this"><a href="#使用-call-方法调用函数并且指定上下文的this" class="headerlink" title="使用 call 方法调用函数并且指定上下文的this"></a>使用 <code>call</code> 方法调用函数并且指定上下文的<code>this</code></h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cbj = &#123;</span><br><span class="line">    <span class="attr">lang</span>:<span class="string">&quot;汉语&quot;</span>,</span><br><span class="line">    <span class="attr">speak</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">lang</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> ebj = &#123;</span><br><span class="line">    <span class="attr">lang</span>:<span class="string">&quot;英语&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">cbj.<span class="property">speak</span>.<span class="title function_">call</span>(ebj)<span class="comment">//英语</span></span><br></pre></td></tr></table></figure><h4 id="使用call方法调用父构造函数"><a href="#使用call方法调用父构造函数" class="headerlink" title="使用call方法调用父构造函数"></a>使用call方法调用父构造函数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Product</span>(<span class="params">name, price</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">price</span> = price;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">getInfo</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>+<span class="variable language_">this</span>.<span class="property">price</span>+<span class="string">&quot;块&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Fruits</span>(<span class="params">name, price</span>) &#123;</span><br><span class="line"><span class="title class_">Product</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, name, price);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">category</span> = <span class="string">&#x27;水果&#x27;</span>;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">getFruitsInfo</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">category</span>+<span class="string">&quot;:&quot;</span>+<span class="variable language_">this</span>.<span class="property">name</span>+<span class="variable language_">this</span>.<span class="property">price</span>+<span class="string">&quot;块&quot;</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Vegetables</span>(<span class="params">name, price</span>) &#123;</span><br><span class="line"><span class="title class_">Product</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, name, price);</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">category</span> = <span class="string">&#x27;蔬菜&#x27;</span>;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">getVegetablesInfo</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">category</span>+<span class="string">&quot;:&quot;</span>+<span class="variable language_">this</span>.<span class="property">name</span>+<span class="variable language_">this</span>.<span class="property">price</span>+<span class="string">&quot;块&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pro = <span class="keyword">new</span> <span class="title class_">Product</span>(<span class="string">&#x27;红烧西瓜茄子&#x27;</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">var</span> fru = <span class="keyword">new</span> <span class="title class_">Fruits</span>(<span class="string">&#x27;西瓜&#x27;</span>, <span class="number">20</span>);</span><br><span class="line"><span class="keyword">var</span> veg = <span class="keyword">new</span> <span class="title class_">Vegetables</span>(<span class="string">&#x27;茄子&#x27;</span>, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">pro.<span class="title function_">getInfo</span>();<span class="comment">//红烧西瓜茄子10块</span></span><br><span class="line"></span><br><span class="line">fru.<span class="title function_">getInfo</span>();<span class="comment">//西瓜20块</span></span><br><span class="line">fru.<span class="title function_">getFruitsInfo</span>();<span class="comment">//水果:西瓜20块</span></span><br><span class="line"></span><br><span class="line">veg.<span class="title function_">getInfo</span>();<span class="comment">//茄子30块</span></span><br><span class="line">veg.<span class="title function_">getVegetablesInfo</span>();<span class="comment">//蔬菜:茄子30块</span></span><br></pre></td></tr></table></figure><h4 id="使用call方法调用匿名函数"><a href="#使用call方法调用匿名函数" class="headerlink" title="使用call方法调用匿名函数"></a>使用<code>call</code>方法调用匿名函数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> animals = [</span><br><span class="line">&#123;<span class="attr">color</span>: <span class="string">&#x27;白色&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;猴子&#x27;</span>&#125;,</span><br><span class="line">&#123;<span class="attr">color</span>: <span class="string">&#x27;黑色&#x27;</span>, <span class="attr">name</span>: <span class="string">&#x27;老虎&#x27;</span>&#125;</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; animals.<span class="property">length</span>; i++) &#123;</span><br><span class="line">(<span class="keyword">function</span> (<span class="params">i</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">print</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;#&#x27;</span> + i  + <span class="string">&#x27; &#x27;</span> + <span class="variable language_">this</span>.<span class="property">color</span> + <span class="string">&#x27;: &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">print</span>();</span><br><span class="line">&#125;).<span class="title function_">call</span>(animals[i], i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//#0 白色: 猴子</span></span><br><span class="line"><span class="comment">//#1 黑色: 老虎</span></span><br></pre></td></tr></table></figure><h2 id="Function-prototype-bind"><a href="#Function-prototype-bind" class="headerlink" title="Function.prototype.bind()"></a>Function.prototype.bind()</h2><p><code>bind()</code>方法创建一个新的函数, 当被调用时，将其<code>this</code>关键字设置为提供的值，在调用新函数时，在任何提供之前提供一个给定的参数序列。</p><h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fun.<span class="title function_">bind</span>(thisArg[, arg1[, arg2[, ...]]])</span><br></pre></td></tr></table></figure><ul><li><code>thisArg</code>:当绑定函数被调用时，该参数会作为原函数运行时的 <code>this</code> 指向。当使用<code>new</code> 操作符调用绑定函数时，该参数无效。</li><li><code>arg1, arg2, ...</code>:当绑定函数被调用时，这些参数将置于实参之前传递给被绑定的方法。</li></ul><p><code>bind()</code> 函数会创建一个新函数（称为绑定函数），新函数与被调函数（绑定函数的目标函数）具有相同的函数体（在 <code>ECMAScript 5</code> 规范中内置的<code>call</code>属性）。当新函数被调用时 <code>this</code> 值绑定到 <code>bind() </code>的第一个参数，该参数不能被重写。绑定函数被调用时，bind() 也接受预设的参数提供给原函数。一个绑定函数也能使用<code>new</code>操作符创建对象：这种行为就像把原函数当成构造器。提供的 <code>this</code> 值被忽略，同时调用时的参数被提供给模拟函数。</p><h3 id="例子：-2"><a href="#例子：-2" class="headerlink" title="例子："></a>例子：</h3><h4 id="创建绑定函数"><a href="#创建绑定函数" class="headerlink" title="创建绑定函数"></a>创建绑定函数</h4><p><code>bind()</code> 最简单的用法是创建一个函数，使这个函数不论怎么调用都有同样的 <code>this</code> 值。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">x</span> = <span class="number">9</span>;</span><br><span class="line"><span class="keyword">var</span> obj = &#123;</span><br><span class="line">  <span class="attr">x</span>: <span class="number">81</span>,</span><br><span class="line">  <span class="attr">getX</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">x</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">obj.<span class="title function_">getX</span>(); <span class="comment">// 返回 81</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> retrieveX = obj.<span class="property">getX</span>;</span><br><span class="line"><span class="title function_">retrieveX</span>(); <span class="comment">// 返回 9, 在这种情况下，&quot;this&quot;指向全局作用域</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个新函数，将&quot;this&quot;绑定到obj对象</span></span><br><span class="line"><span class="keyword">var</span> boundGetX = retrieveX.<span class="title function_">bind</span>(obj);</span><br><span class="line"><span class="title function_">boundGetX</span>(); <span class="comment">// 返回 81</span></span><br></pre></td></tr></table></figure><h4 id="用预设的初始参数创建函数"><a href="#用预设的初始参数创建函数" class="headerlink" title="用预设的初始参数创建函数"></a>用预设的初始参数创建函数</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">List</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用预设的初始参数创建函数</span></span><br><span class="line"><span class="keyword">var</span> clist = <span class="title class_">List</span>.<span class="title function_">bind</span>(<span class="literal">undefined</span>, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">clist</span>(); <span class="comment">//[100]</span></span><br><span class="line"><span class="title function_">clist</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);<span class="comment">//[100,1,2,3]</span></span><br></pre></td></tr></table></figure><h4 id="作为构造函数使用的绑定函数"><a href="#作为构造函数使用的绑定函数" class="headerlink" title="作为构造函数使用的绑定函数"></a>作为构造函数使用的绑定函数</h4><p>绑定函数适用于用<code>new</code>操作符 <code>new</code> 去构造一个由目标函数创建的新的实例。</p><p>当一个绑定函数是用来构建一个值的，原来提供的 <code>this</code> 就会被忽略。</p><p>然而, 原先提供的那些参数仍然会被前置到构造函数调用的前面。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Point</span>(<span class="params">x, y</span>) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">x</span> = x;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">y</span> = y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">Point</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">print</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">x</span> + <span class="string">&#x27;,&#x27;</span> + <span class="variable language_">this</span>.<span class="property">y</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">PointA</span>= <span class="title class_">Point</span>.<span class="title function_">bind</span>(obj, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">var</span> pa = <span class="keyword">new</span> <span class="title class_">PointA</span>(<span class="number">5</span>);</span><br><span class="line"><span class="title class_">PointA</span>(<span class="number">5</span>);<span class="comment">//undefined</span></span><br><span class="line">pa.<span class="title function_">print</span>();<span class="comment">//0,5</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj);<span class="comment">//Object &#123;x: 0, y: 5&#125;</span></span><br></pre></td></tr></table></figure><h4 id="创建捷径"><a href="#创建捷径" class="headerlink" title="创建捷径"></a>创建捷径</h4><p>将一个类似于数组的对象<code>（array-like object）</code>转换成一个真正的数组</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123;<span class="string">&#x27;1&#x27;</span>:<span class="string">&#x27;小明&#x27;</span>,<span class="string">&#x27;2&#x27;</span>:<span class="string">&#x27;小黑&#x27;</span>,<span class="string">&#x27;4&#x27;</span>:<span class="string">&#x27;小刚&#x27;</span>,<span class="attr">length</span>:<span class="number">6</span>&#125;;</span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">apply</span>(a);</span><br><span class="line"><span class="comment">//[undefined × 1, &quot;小明&quot;, &quot;小黑&quot;, undefined × 1, &quot;小刚&quot;, undefined × 1]</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(a);</span><br><span class="line"><span class="comment">// [undefined × 1, &quot;小明&quot;, &quot;小黑&quot;, undefined × 1, &quot;小刚&quot;, undefined × 1]</span></span><br></pre></td></tr></table></figure><p>用 <code>bind() </code>可以使这个过程变得简单</p><p><code>slice</code> 是 <code>Function.prototype</code> 的 <code>call()</code> 方法的绑定函数.</p><p>并且将 <code>Array.prototype</code> 的 <code>slice()</code> 方法作为 <code>this</code> 的值</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = &#123;<span class="string">&#x27;1&#x27;</span>:<span class="string">&#x27;小明&#x27;</span>,<span class="string">&#x27;2&#x27;</span>:<span class="string">&#x27;小黑&#x27;</span>,<span class="string">&#x27;4&#x27;</span>:<span class="string">&#x27;小刚&#x27;</span>,<span class="attr">length</span>:<span class="number">6</span>&#125;;</span><br><span class="line"><span class="keyword">var</span> slice = <span class="title class_">Function</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">call</span>.<span class="title function_">bind</span>(<span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>);</span><br><span class="line"><span class="title function_">slice</span>(a);</span><br><span class="line"><span class="comment">// [undefined × 1, &quot;小明&quot;, &quot;小黑&quot;, undefined × 1, &quot;小刚&quot;, undefined × 1]</span></span><br></pre></td></tr></table></figure><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><ul><li><code>call()</code>方法第二个参数是若干个参数的列表；而<code>apply()</code>方法的第二个参数是一个包含多个参数的数组；<code>bind()</code>方法第二个参数是若干个参数的列表，是创建函数的预设的初始参数 。</li><li><code>apply 、 call 、bind</code>三个方法的第一个参数都是this要指向的对象，可以改变函数的this对象的指向。</li><li><code>bind</code>方法 返回对应的创建函数，便于后续调用；<code>apply 、call</code> 则是立即执行 。</li></ul><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="https://bugs.webkit.org/show_bug.cgi?id=80797">apply参数个数限制在65536)</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Function-prototype-apply&quot;&gt;&lt;a href=&quot;#Function-prototype-apply&quot; class=&quot;headerlink&quot; title=&quot;Function.prototype.apply()&quot;&gt;&lt;/a&gt;Function.prototype.apply()&lt;/h2&gt;&lt;p&gt;&lt;code&gt;apply()&lt;/code&gt; 方法调用一个函数, 其具有一个指定的this值，以及作为一个数组（或类似数组的对象）提供的参数。&lt;/p&gt;
&lt;h3 id=&quot;语法：&quot;&gt;&lt;a href=&quot;#语法：&quot; class=&quot;headerlink&quot; title=&quot;语法：&quot;&gt;&lt;/a&gt;语法：&lt;/h3&gt;&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;fun.&lt;span class=&quot;title function_&quot;&gt;apply&lt;/span&gt;(thisArg, [argsArray])&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="javascript" scheme="https://nightme.github.io/categories/javascript/"/>
    
    
      <category term="javascript" scheme="https://nightme.github.io/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>angularjs1.x双向绑定</title>
    <link href="https://nightme.github.io/2017/05/06/angularjs%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A/"/>
    <id>https://nightme.github.io/2017/05/06/angularjs双向绑定/</id>
    <published>2017-05-06T12:34:47.000Z</published>
    <updated>2025-09-19T04:25:12.071Z</updated>
    
    <content type="html"><![CDATA[<h2 id="angularjs双向绑定"><a href="#angularjs双向绑定" class="headerlink" title="angularjs双向绑定"></a>angularjs双向绑定</h2><p>双向绑定：界面的操作能实时反映到数据，数据的改变能实时反映界面，如下图：文本框的操作</p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20170803223248.png" alt="image"></p><span id="more"></span><h2 id="双向绑定实现"><a href="#双向绑定实现" class="headerlink" title="双向绑定实现"></a>双向绑定实现</h2><ul><li>脏值检测 例如AngularJS1.x</li><li>Getter&#x2F;Setter：重定义model的getter与setter方法，在数据变动的时候重新渲染页面，例如Vue.js</li></ul><p>使用Getter&#x2F;Setter的时候,数据的每次修改都会激活刷新模版的方法，</p><p>脏值检测，可以在完成所有数值变动后，统一刷新到Dom，当监听元素变多的时候 watcher 列表会变得很长，查询变动的数据元素将耗费更多的资源。</p><h2 id="脏检查"><a href="#脏检查" class="headerlink" title="脏检查"></a>脏检查</h2><p>angular 必须去挨个检查一定作用域上(如 ,<code>$scope</code>)的这些元素对应绑定表达式的值是否有被改变。这就是脏数据检查的由来.</p><ul><li>脏检查是一种模型到视图的数据映射机制，由 $apply 或 $digest 触发。</li><li>脏检查的范围是整个页面，不受区域或组件划分影响</li><li>使用尽量简单的绑定表达式提升脏检查执行速度</li><li>尽量减少页面上绑定表达式的个数（单次绑定和ng-if）</li><li>给 ng-repeat 添加 track by 让 angular 复用已有元素</li></ul><h2 id="构造函数Scope"><a href="#构造函数Scope" class="headerlink" title="构造函数Scope"></a>构造函数Scope</h2><p>在angular框架中，缀$$表示这个变量被当作私有的来考虑，不应当在外部代码中调用</p><p>在写angularjs时到处都能遇到<code>$scope</code>,而<code>$scope</code> 就是 <code>Scope</code> 的实例</p><p>源码：<code>angular@1.5.0</code>:</p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20170803231613.png" alt="image"></p><p>在Scope的原型(Scope.prototype)中共定义了大概14个函数，如下图：</p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20170803232852.png" alt="image"><br><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20170803232946.png" alt="image"></p><p>其中有3个函数起者至关重要的作用域(译的不准)：</p><ul><li><code>$watch</code>(译:监听、监视)</li><li><code>$digest</code>(译:迭代、循环、遍历)</li><li><code>$apply</code>(译：传播、应用)</li></ul><p><code>$watch</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">$watch</span>: <span class="keyword">function</span>(<span class="params">watchExp, listener, objectEquality, prettyPrintExpression</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> get = $parse(watchExp);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (get.<span class="property">$$watchDelegate</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> get.$$watchDelegate(<span class="variable language_">this</span>, listener, objectEquality, get, watchExp);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> scope = <span class="variable language_">this</span>,</span><br><span class="line">      array = scope.<span class="property">$$watchers</span>,</span><br><span class="line">      watcher = &#123;</span><br><span class="line">        <span class="attr">fn</span>: listener,</span><br><span class="line">        <span class="attr">last</span>: initWatchVal,</span><br><span class="line">        <span class="attr">get</span>: get,</span><br><span class="line">        <span class="attr">exp</span>: prettyPrintExpression || watchExp,</span><br><span class="line">        <span class="attr">eq</span>: !!objectEquality</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  lastDirtyWatch = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_">isFunction</span>(listener)) &#123;</span><br><span class="line">    watcher.<span class="property">fn</span> = noop;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!array) &#123;</span><br><span class="line">    array = scope.<span class="property">$$watchers</span> = [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// we use unshift since we use a while loop in $digest for speed.</span></span><br><span class="line">  <span class="comment">// the while loop reads in reverse order.</span></span><br><span class="line">  array.<span class="title function_">unshift</span>(watcher);</span><br><span class="line">  <span class="title function_">incrementWatchersCount</span>(<span class="variable language_">this</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> <span class="title function_">deregisterWatch</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">arrayRemove</span>(array, watcher) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="title function_">incrementWatchersCount</span>(scope, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    lastDirtyWatch = <span class="literal">null</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><code>$digest</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">$digest</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> watch, value, last, fn, get,</span><br><span class="line">      watchers,</span><br><span class="line">      length,</span><br><span class="line">      dirty, ttl = <span class="variable constant_">TTL</span>,</span><br><span class="line">      next, current, target = <span class="variable language_">this</span>,</span><br><span class="line">      watchLog = [],</span><br><span class="line">      logIdx, logMsg, asyncTask;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">beginPhase</span>(<span class="string">&#x27;$digest&#x27;</span>);</span><br><span class="line">  <span class="comment">// Check for changes to browser url that happened in sync before the call to $digest</span></span><br><span class="line">  $browser.$$checkUrlChange();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span> === $rootScope &amp;&amp; applyAsyncId !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// If this is the root scope, and $applyAsync has scheduled a deferred $apply(), then</span></span><br><span class="line">    <span class="comment">// cancel the scheduled $apply and flush the queue of expressions to be evaluated.</span></span><br><span class="line">    $browser.<span class="property">defer</span>.<span class="title function_">cancel</span>(applyAsyncId);</span><br><span class="line">    <span class="title function_">flushApplyAsync</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  lastDirtyWatch = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123; <span class="comment">// &quot;while dirty&quot; loop</span></span><br><span class="line">    dirty = <span class="literal">false</span>;</span><br><span class="line">    current = target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (asyncQueue.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        asyncTask = asyncQueue.<span class="title function_">shift</span>();</span><br><span class="line">        asyncTask.<span class="property">scope</span>.$eval(asyncTask.<span class="property">expression</span>, asyncTask.<span class="property">locals</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        $exceptionHandler(e);</span><br><span class="line">      &#125;</span><br><span class="line">      lastDirtyWatch = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attr">traverseScopesLoop</span>:</span><br><span class="line">    <span class="keyword">do</span> &#123; <span class="comment">// &quot;traverse the scopes&quot; loop</span></span><br><span class="line">      <span class="keyword">if</span> ((watchers = current.<span class="property">$$watchers</span>)) &#123;</span><br><span class="line">        <span class="comment">// process our watches</span></span><br><span class="line">        length = watchers.<span class="property">length</span>;</span><br><span class="line">        <span class="keyword">while</span> (length--) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            watch = watchers[length];</span><br><span class="line">            <span class="comment">// Most common watches are on primitives, in which case we can short</span></span><br><span class="line">            <span class="comment">// circuit it with === operator, only when === fails do we use .equals</span></span><br><span class="line">            <span class="keyword">if</span> (watch) &#123;</span><br><span class="line">              get = watch.<span class="property">get</span>;</span><br><span class="line">              <span class="keyword">if</span> ((value = <span class="title function_">get</span>(current)) !== (last = watch.<span class="property">last</span>) &amp;&amp;</span><br><span class="line">                  !(watch.<span class="property">eq</span></span><br><span class="line">                      ? <span class="title function_">equals</span>(value, last)</span><br><span class="line">                      : (<span class="keyword">typeof</span> value === <span class="string">&#x27;number&#x27;</span> &amp;&amp; <span class="keyword">typeof</span> last === <span class="string">&#x27;number&#x27;</span></span><br><span class="line">                         &amp;&amp; <span class="built_in">isNaN</span>(value) &amp;&amp; <span class="built_in">isNaN</span>(last)))) &#123;</span><br><span class="line">                dirty = <span class="literal">true</span>;</span><br><span class="line">                lastDirtyWatch = watch;</span><br><span class="line">                watch.<span class="property">last</span> = watch.<span class="property">eq</span> ? <span class="title function_">copy</span>(value, <span class="literal">null</span>) : value;</span><br><span class="line">                fn = watch.<span class="property">fn</span>;</span><br><span class="line">                <span class="title function_">fn</span>(value, ((last === initWatchVal) ? value : last), current);</span><br><span class="line">                <span class="keyword">if</span> (ttl &lt; <span class="number">5</span>) &#123;</span><br><span class="line">                  logIdx = <span class="number">4</span> - ttl;</span><br><span class="line">                  <span class="keyword">if</span> (!watchLog[logIdx]) watchLog[logIdx] = [];</span><br><span class="line">                  watchLog[logIdx].<span class="title function_">push</span>(&#123;</span><br><span class="line">                    <span class="attr">msg</span>: <span class="title function_">isFunction</span>(watch.<span class="property">exp</span>) ? <span class="string">&#x27;fn: &#x27;</span> + (watch.<span class="property">exp</span>.<span class="property">name</span> || watch.<span class="property">exp</span>.<span class="title function_">toString</span>()) : watch.<span class="property">exp</span>,</span><br><span class="line">                    <span class="attr">newVal</span>: value,</span><br><span class="line">                    <span class="attr">oldVal</span>: last</span><br><span class="line">                  &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (watch === lastDirtyWatch) &#123;</span><br><span class="line">                <span class="comment">// If the most recently dirty watcher is now clean, short circuit since the remaining watchers</span></span><br><span class="line">                <span class="comment">// have already been tested.</span></span><br><span class="line">                dirty = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">break</span> traverseScopesLoop;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            $exceptionHandler(e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Insanity Warning: scope depth-first traversal</span></span><br><span class="line">      <span class="comment">// yes, this code is a bit crazy, but it works and we have tests to prove it!</span></span><br><span class="line">      <span class="comment">// this piece should be kept in sync with the traversal in $broadcast</span></span><br><span class="line">      <span class="keyword">if</span> (!(next = ((current.<span class="property">$$watchersCount</span> &amp;&amp; current.<span class="property">$$childHead</span>) ||</span><br><span class="line">          (current !== target &amp;&amp; current.<span class="property">$$nextSibling</span>)))) &#123;</span><br><span class="line">        <span class="keyword">while</span> (current !== target &amp;&amp; !(next = current.<span class="property">$$nextSibling</span>)) &#123;</span><br><span class="line">          current = current.<span class="property">$parent</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((current = next));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// `break traverseScopesLoop;` takes us to here</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((dirty || asyncQueue.<span class="property">length</span>) &amp;&amp; !(ttl--)) &#123;</span><br><span class="line">      <span class="title function_">clearPhase</span>();</span><br><span class="line">      <span class="keyword">throw</span> $rootScopeMinErr(<span class="string">&#x27;infdig&#x27;</span>,</span><br><span class="line">          <span class="string">&#x27;&#123;0&#125; $digest() iterations reached. Aborting!\n&#x27;</span> +</span><br><span class="line">          <span class="string">&#x27;Watchers fired in the last 5 iterations: &#123;1&#125;&#x27;</span>,</span><br><span class="line">          <span class="variable constant_">TTL</span>, watchLog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">while</span> (dirty || asyncQueue.<span class="property">length</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">clearPhase</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (postDigestQueue.<span class="property">length</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      postDigestQueue.<span class="title function_">shift</span>()();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      $exceptionHandler(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><code>$apply</code>:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">$apply</span>: <span class="keyword">function</span>(<span class="params">expr</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title function_">beginPhase</span>(<span class="string">&#x27;$apply&#x27;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.$eval(expr);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="title function_">clearPhase</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    $exceptionHandler(e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      $rootScope.$digest();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      $exceptionHandler(e);</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><h2 id="脏检查的触发"><a href="#脏检查的触发" class="headerlink" title="脏检查的触发"></a>脏检查的触发</h2><p>angularjs 会在视图(view)或model(模型)发生变更的时候触发脏检查,即脏检查是<code>$digest</code>或<code>$apply</code>的执行。</p><p>angularjs使用<code>$watch</code>函数为<code>scope</code>添加一个监视器。当这个<code>scope</code>中有变化发生时，监视器便会提醒你。<br>在<code>Scope</code>中有一个对象数组<code>$$watchers</code>，里面保存着我们定义的所有的监视器对象<code>watcher</code>。</p><p>而<code>$apply</code>方法会触发 <code>$digest</code>,它将会在 <code>$rootScope</code>中运行digest循环,然后向下遍历每一个作用域并在每个作用域上运行循环.</p><p>angular中的一些所有方法都 scope.apply()里面，像ng−click http的回调函数等：</p><p><img src="http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20170804011447.png" alt="image"></p><p>在这些情况下，我们不需要自己调用,实际上我们也不能自己调用，否则在apply()方法里面再调用apply()方法会抛出错误,仅当这个新的执行序列不是被angular JS的库的方法创建的，这个时候我们需要将代码用scope.apply()包起来,如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$scope.<span class="property">message</span> =<span class="string">&quot;等2000ms后更新&quot;</span>;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">　　$scope.$apply(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">   　　$scope.<span class="property">message</span> =<span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br></pre></td></tr></table></figure><p>而 <code>$digest</code> 方法的执行即是遍历 <code>scope</code> 上绑定的所有 <code>watcher</code>，并执行相应的 <code>watch</code>（指定想要监控的对象） 和 listener（当数据改变时触发的回调） 方法。<code>$watch</code>这个函数的前两个，它指明了要观察什么(watchExp)，在变化时要发生什么(listener)。第三个参数是否深度监听:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$watch(watchExpression, listener, objectEquality);</span><br></pre></td></tr></table></figure><h2 id="循环进行脏值检查-脏值"><a href="#循环进行脏值检查-脏值" class="headerlink" title="循环进行脏值检查(脏值)"></a>循环进行脏值检查(脏值)</h2><p>当<code>digest</code>循环运行时，它将会遍历所有的监听器然后再次循环，只要这次循环发现了”脏值”，循环就会继续下去。如果watchExp的值和最新的值不相同，那么这次循环就会被认为发现了“脏值”。</p><p>如果两个 <code>watcher</code> 之间互相影响彼此，则会导致无限循环的问题。把digest的运行控制在一个可接受的迭代数量内。如果这么多次之后，作用域还在变更，在这个点上，会抛出一个异常，因为不管作用域的状态变成怎样，它都不太可能是用户想要的结果。<br>迭代的最大值称为TTL（short for Time To Live）。这个值默认是10，可能有点小，但是记住这是一个性能敏感的地方，因为digest经常被执行，而且每个digest运行了所有的监听器。用户也不太可能创建10个以上链状的监听器。</p><h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>脏检查其实它像闪电般快，如果你在一个模版里有2000-3000个watch，它会开始变慢。</p><p>Angular 1.x 的机制下，脏检查的执行范围过大以及频率过频繁</p><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="http://www.morphzhou.cn/?p=367">AngularJS源码分析之</a></li><li><a href="http://teropa.info/build-your-own-angular/build_your_own_angularjs_sample.pdf">Scopes and DirtyChecking</a></li><li><a href="http://www.angularjs.cn/A0a6">理解$watch ，$apply 和 $digest — 理解数据绑定过程</a></li><li><a href="http://www.angularjs.cn/A00q#scope">AngularJS开发指南04：核心概览</a></li><li><a href="http://www.angularjs.cn/A00r">AngularJS开发指南05：指令</a></li><li><a href="http://www.angularjs.cn/A00z">AngularJS开发指南14：依赖注入</a></li><li><a href="https://segmentfault.com/a/1190000010374926">Angular 学习笔记：$digest 实现原理</a></li><li><a href="https://segmentfault.com/a/1190000010433675#articleHeader3">Angular 1 深度解析：脏数据检查与 angular 性能优化</a></li><li><a href="http://www.jb51.net/article/111811.htm">AngularJS的脏检查深入分析</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;angularjs双向绑定&quot;&gt;&lt;a href=&quot;#angularjs双向绑定&quot; class=&quot;headerlink&quot; title=&quot;angularjs双向绑定&quot;&gt;&lt;/a&gt;angularjs双向绑定&lt;/h2&gt;&lt;p&gt;双向绑定：界面的操作能实时反映到数据，数据的改变能实时反映界面，如下图：文本框的操作&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://imagesrc.oss-cn-shenzhen.aliyuncs.com/notes/20170803223248.png&quot; alt=&quot;image&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="angular" scheme="https://nightme.github.io/categories/angular/"/>
    
    
      <category term="angular" scheme="https://nightme.github.io/tags/angular/"/>
    
  </entry>
  
  <entry>
    <title>yarn</title>
    <link href="https://nightme.github.io/2017/04/08/yarn/"/>
    <id>https://nightme.github.io/2017/04/08/yarn/</id>
    <published>2017-04-08T15:14:44.000Z</published>
    <updated>2025-09-19T04:25:12.109Z</updated>
    
    <content type="html"><![CDATA[<h2 id="yarn"><a href="#yarn" class="headerlink" title="yarn"></a>yarn</h2><p>yarn 是由Facebook、Google、Exponent 和 Tilde 联合推出的 JS 包管理工具</p><h2 id="弥补-npm-的一些缺陷"><a href="#弥补-npm-的一些缺陷" class="headerlink" title="弥补 npm 的一些缺陷"></a>弥补 npm 的一些缺陷</h2><ul><li>npm 安装包（packages）的速度不够快，拉取的 packages 可能版本不同</li><li>npm 允许在安装 packages 时执行代码，这就埋下了安全隐患</li></ul><span id="more"></span><h2 id="yarn特点"><a href="#yarn特点" class="headerlink" title="yarn特点"></a>yarn特点</h2><ul><li><strong>极速</strong> Yarn 缓存它下载的每个包，所以无需重复下载。它还并行化操作以最大化资源利用，所以安装时间比以往快。</li><li><strong>超级安全</strong> Yarn 在每个安装包的代码执行前使用校验码验证包的完整性。</li><li><strong>超级可靠</strong> Yarn 使用一个格式详尽但简洁的 lockfile 和一个精确的算法来安装，能够保证在一个系统上的运行的安装过程也会以同样的方式运行在其他系统上。</li></ul><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>以下是windows方式安装，前提安装了nodejs</p><h3 id="安装方式一"><a href="#安装方式一" class="headerlink" title="安装方式一"></a>安装方式一</h3><p>下载安装程序.msi 文件，运行之后将引导你完成 Yarn 的安装</p><h3 id="安装方式二"><a href="#安装方式二" class="headerlink" title="安装方式二"></a>安装方式二</h3><p>通过Chocolatey安装 Chocolatey是Windows平台下的包管理器。 安装好后打开命令行，执行下面的命令： choco install yarn</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">choco install yarn</span><br></pre></td></tr></table></figure><h3 id="安装方式三"><a href="#安装方式三" class="headerlink" title="安装方式三"></a>安装方式三</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install yarn -g</span><br><span class="line"></span><br><span class="line">yarn -v</span><br><span class="line"><span class="comment">#查看安装版本</span></span><br></pre></td></tr></table></figure><h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yarn init <span class="comment">#初始化</span></span><br><span class="line">yarn add jquery <span class="comment">#添加jquery依赖</span></span><br><span class="line">yarn add jquery@1.9.1 <span class="comment">#添加jquery指定版本</span></span><br><span class="line">yarn upgrade jquery <span class="comment">#更新依赖</span></span><br><span class="line">yarn remove jquery <span class="comment">#删除依赖</span></span><br><span class="line">yarn <span class="comment"># 安装所有依赖</span></span><br><span class="line">yarn install <span class="comment">#安装所有依赖</span></span><br></pre></td></tr></table></figure><h2 id="Yarn命令"><a href="#Yarn命令" class="headerlink" title="Yarn命令"></a>Yarn命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">yarn add jquery <span class="comment">#添加依赖包</span></span><br><span class="line">yarn bin <span class="comment">#显示yarn安装目录</span></span><br><span class="line">yarn cache <span class="built_in">ls</span> <span class="comment">#列出缓存包</span></span><br><span class="line">yarn cache <span class="built_in">dir</span> <span class="comment">#打出缓存目录路径</span></span><br><span class="line">yarn cache clean <span class="comment">#清除缓存</span></span><br><span class="line">yarn check <span class="comment">#检查包</span></span><br><span class="line">yarn clean <span class="comment">#清理不需要的依赖文件</span></span><br><span class="line">yarn config list <span class="comment">#显示当前配置。</span></span><br><span class="line">yarn config <span class="built_in">set</span> registry <span class="string">&quot;https://registry.npm.taobao.org&quot;</span> <span class="comment">#设置淘宝源</span></span><br><span class="line">yarn config delete <span class="comment">#删除设置</span></span><br><span class="line">yarn generate-lock-entry <span class="comment">#生成锁定文件</span></span><br><span class="line">yarn global [--prefix] <span class="comment">#全局安装依赖包</span></span><br><span class="line">yarn info <span class="comment">#显示依赖包的信息</span></span><br><span class="line">yarn init <span class="comment">#--yes/-y：以默认值生成package.json文件</span></span><br><span class="line">yarn install <span class="comment">#安装所有依赖包</span></span><br><span class="line">yarn licenses <span class="built_in">ls</span> <span class="comment">#列出已安装依赖包的证书</span></span><br><span class="line">yarn licenses generate-disclaimer <span class="comment">#生成免责声明</span></span><br><span class="line">yarn <span class="built_in">link</span> <span class="comment">#开发时链接依赖包，以便在其他项目中使用</span></span><br><span class="line">yarn login <span class="comment">#保存你的用户名、邮箱</span></span><br><span class="line">yarn <span class="built_in">logout</span> <span class="comment">#删除你的用户名、邮箱</span></span><br><span class="line">yarn list <span class="comment">#列出已安装依赖包</span></span><br><span class="line">yarn outdated <span class="comment">#检查过时的依赖包</span></span><br><span class="line">yarn owner [<span class="built_in">ls</span>/add/remove] <span class="comment">#管理拥有者</span></span><br><span class="line">yarn pack <span class="comment">#创建一个压缩的包依赖 gzip 档案。</span></span><br><span class="line">yarn publish <span class="comment">#将包发布到npm</span></span><br><span class="line">yarn remove jquery<span class="comment">#卸载包，更新package.json和yarn.lock</span></span><br><span class="line">yarn run <span class="comment">#运行package.json中预定义的脚本</span></span><br><span class="line">yarn tag [add/rm/ls] <span class="comment">#显示包的标签</span></span><br><span class="line">yarn team [create/destroy/add/rm/ls] <span class="comment">#管理团队</span></span><br><span class="line">yarn <span class="built_in">test</span>  <span class="comment">#测试</span></span><br><span class="line">yarn <span class="built_in">unlink</span> <span class="comment">#取消链接依赖包</span></span><br><span class="line">yarn upgrade <span class="comment">#升级依赖包</span></span><br><span class="line">yarn version <span class="comment">#管理当前项目的版本号</span></span><br><span class="line">yarn why jquery <span class="comment">#分析为什么需要安装依赖包</span></span><br><span class="line">yarn install --force <span class="comment">#强制所有包都预下载</span></span><br><span class="line">yarn install --flat <span class="comment">#安装依赖包的单版本</span></span><br><span class="line">yarn install --production <span class="comment">#仅安装生产环境依赖包</span></span><br><span class="line">npm install [package] <span class="comment">#安装依赖</span></span><br><span class="line">npm install --save [package] <span class="comment">#添加生产模式依赖到项目</span></span><br><span class="line">npm install --save-dev [package] <span class="comment">#添加开发模式的依赖</span></span><br></pre></td></tr></table></figure><h2 id="yarn其他"><a href="#yarn其他" class="headerlink" title="yarn其他"></a>yarn其他</h2><p>yarn add 命令允许你添加并安装依赖，和我们在 npm 命令中使用 –save 参数一样<br>Yarn 的-dev 则等同于 npm 的 –save-dev</p><p>yarn.lock 文件通过保存哪些依赖版本和你的包一起安装来确保你的包跨平台安装时是一致的</p><p>从npm客户端迁移至Yarn客户端，要在已有目录执行相应的yarn命令</p><h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol><li><a href="http://qianduan.guru/2016/11/09/yarn-vs-npm/">Yarn vs npm：你需要知道的一切</a></li><li><a href="https://yarn.bootcss.com/">yarn 中文网(一)</a></li><li><a href="https://yarnpkg.com/zh-Hans/">yarn 中文网(二)</a></li><li><a href="https://yarnpkg.com/en/">yarn 英文网</a></li><li><a href="http://docs.shellway.cn/learning-yarn/">Yarn学习笔记</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;yarn&quot;&gt;&lt;a href=&quot;#yarn&quot; class=&quot;headerlink&quot; title=&quot;yarn&quot;&gt;&lt;/a&gt;yarn&lt;/h2&gt;&lt;p&gt;yarn 是由Facebook、Google、Exponent 和 Tilde 联合推出的 JS 包管理工具&lt;/p&gt;
&lt;h2 id=&quot;弥补-npm-的一些缺陷&quot;&gt;&lt;a href=&quot;#弥补-npm-的一些缺陷&quot; class=&quot;headerlink&quot; title=&quot;弥补 npm 的一些缺陷&quot;&gt;&lt;/a&gt;弥补 npm 的一些缺陷&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;npm 安装包（packages）的速度不够快，拉取的 packages 可能版本不同&lt;/li&gt;
&lt;li&gt;npm 允许在安装 packages 时执行代码，这就埋下了安全隐患&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="工具" scheme="https://nightme.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="工具" scheme="https://nightme.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
</feed>
