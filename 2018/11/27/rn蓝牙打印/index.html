<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"nightme.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="蓝牙4.0蓝牙4.0标准包含两个蓝牙标准，准确的说，是一个双模的标准 现在移动设备上使用的蓝牙大多是4.0，而蓝牙 4.0 有两个分支，经典 4.0 和 BLE4.0 经典蓝牙(classic Bluetooth)经典蓝牙可以用与数据量比较大的传输，如语音，音乐，较高数据量传输">
<meta property="og:type" content="article">
<meta property="og:title" content="rn蓝牙打印">
<meta property="og:url" content="https://nightme.github.io/2018/11/27/rn%E8%93%9D%E7%89%99%E6%89%93%E5%8D%B0/index.html">
<meta property="og:site_name" content="某人">
<meta property="og:description" content="蓝牙4.0蓝牙4.0标准包含两个蓝牙标准，准确的说，是一个双模的标准 现在移动设备上使用的蓝牙大多是4.0，而蓝牙 4.0 有两个分支，经典 4.0 和 BLE4.0 经典蓝牙(classic Bluetooth)经典蓝牙可以用与数据量比较大的传输，如语音，音乐，较高数据量传输">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-11-27T02:14:44.000Z">
<meta property="article:modified_time" content="2025-09-19T04:25:12.102Z">
<meta property="article:author" content="某人">
<meta property="article:tag" content="react-native">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://nightme.github.io/2018/11/27/rn%E8%93%9D%E7%89%99%E6%89%93%E5%8D%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>rn蓝牙打印 | 某人</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">某人</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">路过，不语，不留</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nightme.github.io/2018/11/27/rn%E8%93%9D%E7%89%99%E6%89%93%E5%8D%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="某人">
      <meta itemprop="description" content="路过，不语，不留">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="某人">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          rn蓝牙打印
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-11-27 10:14:44" itemprop="dateCreated datePublished" datetime="2018-11-27T10:14:44+08:00">2018-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-09-19 12:25:12" itemprop="dateModified" datetime="2025-09-19T12:25:12+08:00">2025-09-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/react-native/" itemprop="url" rel="index"><span itemprop="name">react-native</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="蓝牙4-0"><a href="#蓝牙4-0" class="headerlink" title="蓝牙4.0"></a>蓝牙<code>4.0</code></h2><p>蓝牙<code>4.0</code>标准包含两个蓝牙标准，准确的说，是一个双模的标准</p>
<p>现在移动设备上使用的蓝牙大多是<code>4.0</code>，而蓝牙 <code>4.0</code> 有两个分支，经典 <code>4.0</code> 和 <code>BLE4.0</code></p>
<h3 id="经典蓝牙-classic-Bluetooth"><a href="#经典蓝牙-classic-Bluetooth" class="headerlink" title="经典蓝牙(classic Bluetooth)"></a>经典蓝牙(<code>classic Bluetooth</code>)</h3><p>经典蓝牙可以用与数据量比较大的传输，如语音，音乐，较高数据量传输</p>
<span id="more"></span>

<h4 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h4><p>经典蓝牙建立连接的方式实际上就是<code>Socket</code>的连接的建立。只不过这里不是直接用<code>Socket</code>，而是<code>BluetoothSocket</code>。</p>
<p>获取<code>BluetoothSocket</code>的方式也很简单，利用搜索找到的<code>BluetoothDevice</code>，调用其方法<code>createRfcommSocketToServiceRecord(UUID)</code>。</p>
<p>最后，使用获取到的<code>BluetoothDevice</code>调用其方法<code>connect()</code>就建立了经典蓝牙设备之间的连接通道。</p>
<h4 id="数据通信"><a href="#数据通信" class="headerlink" title="数据通信"></a>数据通信</h4><p>当建立连接后，就可以直接使用<code>BluetoothSocket</code>的<code>getOutputStream()</code>方法获取输出流写入需要发送的数据。读取发送回来的数据，则是调用<code>BluetoothSocket</code>的<code>getInputStream()</code>方法获取输入流读取</p>
<h3 id="低功耗蓝牙（Bluetooth-low-energy，简称BLE或者LE）"><a href="#低功耗蓝牙（Bluetooth-low-energy，简称BLE或者LE）" class="headerlink" title="低功耗蓝牙（Bluetooth low energy，简称BLE或者LE）"></a>低功耗蓝牙（Bluetooth low energy，简称BLE或者LE）</h3><p>低功耗蓝牙应用于实时性要求比较高，但是数据速率比较低的产品，如遥控类的，如鼠标，键盘，遥控鼠标(Air Mouse)，传感设备的数据发送，如心跳带，血压计，温度传感器等</p>
<p>BLE的优点是快速搜索，快速连接，超低功耗保持连接和传输数据，弱点是数据传输速率低</p>
<h4 id="建立连接-1"><a href="#建立连接-1" class="headerlink" title="建立连接"></a>建立连接</h4><p>硬件条件是，蓝牙得至少是低功耗蓝牙版本，然后安卓系统的话，至少得是<code>Android 4.3</code>以上系统才行</p>
<h4 id="数据通信-1"><a href="#数据通信-1" class="headerlink" title="数据通信"></a>数据通信</h4><p><code>BLE</code>分为三部分<code>Service</code>（服务）、<code>Characteristic</code>（特征）、<code>Descriptor</code>（描述符），这三部分都由<code>UUID</code>作为唯一标示符。</p>
<p>一个蓝牙<code>4.0</code>的终端可以包含多个<code>Service</code>;</p>
<p>一个<code>Service</code>可以包含多个<code>Characteristic</code>;</p>
<p>一个<code>Characteristic</code>包含一个<code>Value</code>和多个<code>Descriptor</code>;</p>
<p>一个<code>Descriptor</code>包含一个<code>Value</code> 一般来说;</p>
<p><code>Characteristic</code>是手机与BLE终端交换数据的关键，<code>Characteristic</code>有跟权限相关的字段，如<code>Property，Property</code>有读写等各种属性，如<code>Notify、Read、Write、WriteWithoutResponse</code></p>
<p>调用<code>BluetoothGattCharacteristic</code>的方法<code>setValue(value)</code>进行,发送的命令值,其中<code>value</code>一般为<code>byte[]</code>;</p>
<p>使用<code>BluetoothGatt</code>的写入方法<code>writeCharacteristic(char)</code>完成命令发送</p>
<h2 id="react-native-ble-plx"><a href="#react-native-ble-plx" class="headerlink" title="react-native-ble-plx"></a>react-native-ble-plx</h2><p>一个支持低功耗的蓝牙类库</p>
<p>Android (example setup):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install --save react-native-ble-plx</span><br><span class="line">react-native <span class="built_in">link</span> react-native-ble-plx</span><br><span class="line"><span class="comment">#安装依赖</span></span><br></pre></td></tr></table></figure>

<p>在app模块的<code>build.gradle</code>中，确保<code>min SDK</code>版本至少为18：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdkVersion 18</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加权限<code>AndroidManifest.xml</code>：</p>
<p><strong>注意:</strong> 添加GPS和网络定位权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 允许程序连接到已配对的蓝牙设备--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.BLUETOOTH&quot;</span>/&gt;</span><br><span class="line">&lt;!-- 允许程序发现和配对蓝牙设备--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.BLUETOOTH_ADMIN&quot;</span>/&gt;</span><br><span class="line">&lt;!-- GPS权限--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.ACCESS_FINE_LOCATION&quot;</span> /&gt;</span><br><span class="line">&lt;!-- 网络定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.ACCESS_COARSE_LOCATION&quot;</span> /&gt;</span><br></pre></td></tr></table></figure>

<h2 id="热敏打印机指令集"><a href="#热敏打印机指令集" class="headerlink" title="热敏打印机指令集"></a>热敏打印机指令集</h2><p>以下命令是部分命令，具体参考文百度文库<a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/187b1ad5690203d8ce2f0066f5335a8102d266a9">热敏打印机指令集文档</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> blePlxCommands = &#123;</span><br><span class="line">    <span class="attr">asciiFont</span>:[<span class="number">0x1b</span>, <span class="number">0x4d</span>, <span class="number">0x00</span>],<span class="comment">//标准ASCII字体</span></span><br><span class="line">    <span class="attr">compressAsciiFont</span>:[<span class="number">0x1b</span>, <span class="number">0x4d</span>, <span class="number">0x01</span>],<span class="comment">// 压缩ASCII字体</span></span><br><span class="line">    <span class="attr">fontWeight</span>:[<span class="number">0x1b</span>, <span class="number">0x45</span>, <span class="number">0x01</span>],<span class="comment">//选择加粗模式</span></span><br><span class="line">    <span class="attr">cancelFontWeight</span>:[<span class="number">0x1b</span>, <span class="number">0x45</span>, <span class="number">0x00</span>],<span class="comment">//取消加粗模式</span></span><br><span class="line">    <span class="attr">alignLeft</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x30</span>],<span class="comment">//左对齐</span></span><br><span class="line">    <span class="attr">alignRight</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x32</span>],<span class="comment">//右对齐</span></span><br><span class="line">    <span class="attr">alignCenter</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x31</span>],<span class="comment">//居中对齐</span></span><br><span class="line">    <span class="attr">cutPaper</span>:[<span class="number">0x1b</span>, <span class="number">0x69</span>],<span class="comment">//全切纸</span></span><br><span class="line">    <span class="attr">cutHalfPaper</span>:[<span class="number">0x1b</span>, <span class="number">0x6d</span>],<span class="comment">//半切纸</span></span><br><span class="line">    <span class="attr">nextOneLinePaper</span>:[<span class="number">0x0a</span>],<span class="comment">//走一行纸</span></span><br><span class="line">    <span class="attr">clockwiseDegree90</span>:[<span class="number">0x1b</span>, <span class="number">0x56</span>, <span class="number">0x01</span>], <span class="comment">//选择顺时针旋转90°</span></span><br><span class="line">    <span class="attr">reverseClockwise90</span>:[<span class="number">0x1b</span>, <span class="number">0x56</span>, <span class="number">0x00</span>],<span class="comment">//取消顺时针旋转90°</span></span><br><span class="line">    <span class="attr">imgBefore</span>:[<span class="number">0x1B</span>, <span class="number">0x33</span>, <span class="number">0x00</span>],<span class="comment">// 发送打印图片设置图片行距为0</span></span><br><span class="line">    <span class="attr">imgAfter</span>:[<span class="number">0x1d</span>, <span class="number">0x4c</span>, <span class="number">0x1f</span>, <span class="number">0x1f</span>],<span class="comment">//发送结束指令(选择左边空白)</span></span><br><span class="line">    <span class="attr">initClear</span>:[<span class="number">0x1b</span>,<span class="number">0x40</span>],<span class="comment">//初始化打印机，复位打印机,清除打印缓冲区</span></span><br><span class="line">    <span class="attr">setZhFontMode</span>:[<span class="number">0x1c</span>,<span class="number">0x26</span>]<span class="comment">//设置中文字符模式</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="react-native-ble-plx简单使用"><a href="#react-native-ble-plx简单使用" class="headerlink" title="react-native-ble-plx简单使用"></a>react-native-ble-plx简单使用</h2><ul>
<li>蓝牙热敏打印的使用；</li>
<li>可以同时可以连接多个设备；</li>
<li>文档地址：<a target="_blank" rel="noopener" href="https://github.com/Polidea/react-native-ble-plx">https://github.com/Polidea/react-native-ble-plx</a></li>
<li><code>react-native-ble-plx</code>接收的数据格式是<code>base64</code></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://apkdownloadforandroid.com/com.BlueLoupe.DreamOn.mh/"><code>BlueLoupe.apk</code></a>APP可以检测设备是否支持低功耗蓝牙</p>
<p>蓝牙服务于特征的获取并与数据的通信</p>
<h3 id="react-native"><a href="#react-native" class="headerlink" title="react-native"></a><code>react-native</code></h3><p><code>bleplx.js</code>(简要代码):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Platform</span>,<span class="title class_">Alert</span>,<span class="title class_">NativeModules</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Buffer</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;buffer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">BleManager</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react-native-ble-plx&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">XToast</span> <span class="keyword">from</span> <span class="string">&#x27;@app/widget/x-toast/&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> lodash <span class="keyword">from</span> <span class="string">&quot;lodash&quot;</span></span><br><span class="line"><span class="keyword">import</span> iconv <span class="keyword">from</span> <span class="string">&quot;iconv-lite&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">BlePlxPrint</span> = <span class="title class_">NativeModules</span>.<span class="property">BlePlxPrint</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [bluetoothCommands 蓝牙打印命令]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> &#123;<span class="type">Object</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> blePlxCommands = &#123;</span><br><span class="line">    <span class="attr">asciiFont</span>:[<span class="number">0x1b</span>, <span class="number">0x4d</span>, <span class="number">0x00</span>],<span class="comment">//标准ASCII字体</span></span><br><span class="line">    <span class="attr">compressAsciiFont</span>:[<span class="number">0x1b</span>, <span class="number">0x4d</span>, <span class="number">0x01</span>],<span class="comment">// 压缩ASCII字体</span></span><br><span class="line">    <span class="attr">fontWeight</span>:[<span class="number">0x1b</span>, <span class="number">0x45</span>, <span class="number">0x01</span>],<span class="comment">//选择加粗模式</span></span><br><span class="line">    <span class="attr">cancelFontWeight</span>:[<span class="number">0x1b</span>, <span class="number">0x45</span>, <span class="number">0x00</span>],<span class="comment">//取消加粗模式</span></span><br><span class="line">    <span class="attr">alignLeft</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x30</span>],<span class="comment">//左对齐</span></span><br><span class="line">    <span class="attr">alignRight</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x32</span>],<span class="comment">//右对齐</span></span><br><span class="line">    <span class="attr">alignCenter</span>:[<span class="number">0x1b</span>, <span class="number">0x61</span>, <span class="number">0x31</span>],<span class="comment">//居中对齐</span></span><br><span class="line">    <span class="attr">cutPaper</span>:[<span class="number">0x1b</span>, <span class="number">0x69</span>],<span class="comment">//全切纸</span></span><br><span class="line">    <span class="attr">cutHalfPaper</span>:[<span class="number">0x1b</span>, <span class="number">0x6d</span>],<span class="comment">//半切纸</span></span><br><span class="line">    <span class="attr">nextOneLinePaper</span>:[<span class="number">0x0a</span>],<span class="comment">//走一行纸</span></span><br><span class="line">    <span class="attr">clockwiseDegree90</span>:[<span class="number">0x1b</span>, <span class="number">0x56</span>, <span class="number">0x01</span>], <span class="comment">//选择顺时针旋转90°</span></span><br><span class="line">    <span class="attr">reverseClockwise90</span>:[<span class="number">0x1b</span>, <span class="number">0x56</span>, <span class="number">0x00</span>],<span class="comment">//取消顺时针旋转90°</span></span><br><span class="line">    <span class="attr">imgBefore</span>:[<span class="number">0x1B</span>, <span class="number">0x33</span>, <span class="number">0x00</span>],<span class="comment">// 发送打印图片设置图片行距为0</span></span><br><span class="line">    <span class="attr">imgAfter</span>:[<span class="number">0x1d</span>, <span class="number">0x4c</span>, <span class="number">0x1f</span>, <span class="number">0x1f</span>],<span class="comment">//发送结束指令(选择左边空白)</span></span><br><span class="line">    <span class="attr">initClear</span>:[<span class="number">0x1b</span>,<span class="number">0x40</span>],<span class="comment">//初始化打印机，复位打印机,清除打印缓冲区</span></span><br><span class="line">    <span class="attr">setZhFontMode</span>:[<span class="number">0x1c</span>,<span class="number">0x26</span>]<span class="comment">//设置中文字符模式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [_cacheConnectDeviceMap 缓存已连接的设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@type</span> &#123;<span class="type">Map</span>&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//缓存所有连接过的设备</span></span><br><span class="line"><span class="keyword">let</span> _cacheConnectDeviceMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"><span class="comment">//缓存设备的UUID</span></span><br><span class="line"><span class="keyword">let</span> _cacheConnectDeviceUUIDMap = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*************************************ConnectDevice**************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 已连接成功的设备</span></span><br><span class="line"><span class="comment"> * [updateCacheConnectDevice 新增并更新缓存设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; connectDevice [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;               [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateCacheConnectDevice</span>(<span class="params">connectDevice</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!connectDevice || !connectDevice.<span class="property">id</span>)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _cacheConnectDeviceMap.<span class="title function_">set</span>(connectDevice.<span class="property">id</span>,connectDevice); <span class="comment">//使用Map类型保存搜索到的蓝牙设备，确保列表不显示重复的设备</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getCacheConnectDeviceById 获取指定连接设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; id [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;    [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCacheConnectDeviceById</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_cacheConnectDeviceMap.<span class="title function_">has</span>(id))&#123;</span><br><span class="line">        <span class="keyword">return</span> _cacheConnectDeviceMap.<span class="title function_">get</span>(id);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 已连接成功的设备</span></span><br><span class="line"><span class="comment"> * [removeCacheConnectDevice 移除缓存设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; connectDevice [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[Object]</span>&#125;               [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeCacheConnectDevice</span>(<span class="params">connectDevice</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!connectDevice || !connectDevice.<span class="property">id</span>)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_cacheConnectDeviceMap.<span class="title function_">has</span>(connectDevice.<span class="property">id</span>))&#123;</span><br><span class="line">        _cacheConnectDeviceMap.<span class="title function_">delete</span>(connectDevice.<span class="property">id</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/***************************************UUID**************************************************/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [removeCacheConnectDeviceUUIDMap 移除缓存设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; connectDevice [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;               [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">removeCacheConnectDeviceUUID</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_cacheConnectDeviceUUIDMap.<span class="title function_">has</span>(id))&#123;</span><br><span class="line">        _cacheConnectDeviceUUIDMap.<span class="title function_">delete</span>(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getCacheConnectDeviceUUIDById 返回设备UUID]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; id [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[Object]</span>&#125;    [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getCacheConnectDeviceUUIDById</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取设备[id]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(_cacheConnectDeviceUUIDMap.<span class="title function_">has</span>(id))&#123;</span><br><span class="line">        <span class="keyword">return</span> _cacheConnectDeviceUUIDMap.<span class="title function_">get</span>(id);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [updateCacheConnectDeviceUUID 更新设备的UUID]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; id   [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; data [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;      [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">updateCacheConnectDeviceUUID</span>(<span class="params">id,data</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id || !data)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备[id]与 [data]不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _cacheConnectDeviceUUIDMap.<span class="title function_">set</span>(id,data); <span class="comment">//使用Map类型保存搜索到的蓝牙设备，的UUID</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [fetchServicesAndCharacteristicsForDevice 获取设备]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125;  device [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Promise</span>&#125;        [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchServicesAndCharacteristicsForDevice</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;[id]不存在无法获取服务&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> device = <span class="title function_">getCacheConnectDeviceById</span>(id);</span><br><span class="line">    <span class="keyword">if</span>(!device)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;连接设备不存在无法获取服务&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> servicesMap = &#123;&#125;;</span><br><span class="line">    <span class="keyword">let</span> characteristicsMap = &#123;&#125;;</span><br><span class="line">    <span class="comment">//获取所有服务</span></span><br><span class="line">    <span class="keyword">let</span> services = <span class="keyword">await</span> device.<span class="title function_">services</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> service <span class="keyword">of</span> services) &#123;</span><br><span class="line">        characteristicsMap = &#123;&#125;</span><br><span class="line">        <span class="comment">//获取该服务的所有特征</span></span><br><span class="line">        <span class="keyword">let</span> characteristics = <span class="keyword">await</span> service.<span class="title function_">characteristics</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> characteristic <span class="keyword">of</span> characteristics) &#123;</span><br><span class="line">            characteristicsMap[characteristic.<span class="property">uuid</span>] = &#123;</span><br><span class="line">                <span class="attr">uuid</span>: characteristic.<span class="property">uuid</span>,</span><br><span class="line">                <span class="attr">isReadable</span>: characteristic.<span class="property">isReadable</span>,</span><br><span class="line">                <span class="attr">isWritableWithResponse</span>: characteristic.<span class="property">isWritableWithResponse</span>,</span><br><span class="line">                <span class="attr">isWritableWithoutResponse</span>: characteristic.<span class="property">isWritableWithoutResponse</span>,</span><br><span class="line">                <span class="attr">isNotifiable</span>: characteristic.<span class="property">isNotifiable</span>,</span><br><span class="line">                <span class="attr">isNotifying</span>: characteristic.<span class="property">isNotifying</span>,</span><br><span class="line">                <span class="attr">value</span>: characteristic.<span class="property">value</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        servicesMap[service.<span class="property">uuid</span>] = &#123;</span><br><span class="line">            <span class="attr">uuid</span>: service.<span class="property">uuid</span>,</span><br><span class="line">            <span class="attr">isPrimary</span>: service.<span class="property">isPrimary</span>,</span><br><span class="line">            <span class="attr">characteristicsCount</span>: characteristics.<span class="property">length</span>,<span class="comment">//特征数量</span></span><br><span class="line">            <span class="attr">characteristics</span>: characteristicsMap</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> servicesMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getBlePlxUUID 获取蓝牙UUID]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getBlePlxUUID</span>(<span class="params">id</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> services = <span class="keyword">await</span> <span class="title function_">fetchServicesAndCharacteristicsForDevice</span>(id);</span><br><span class="line">    <span class="keyword">if</span>(!services)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;服务不存在，无法获取[UUID]&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> result = &#123;</span><br><span class="line">        <span class="attr">readServiceUUID</span>:[],</span><br><span class="line">        <span class="attr">readCharacteristicUUID</span>:[],</span><br><span class="line"></span><br><span class="line">        <span class="attr">writeWithResponseServiceUUID</span>:[],</span><br><span class="line">        <span class="attr">writeWithResponseCharacteristicUUID</span>:[],</span><br><span class="line"></span><br><span class="line">        <span class="attr">writeWithoutResponseServiceUUID</span>:[],</span><br><span class="line">        <span class="attr">writeWithoutResponseCharacteristicUUID</span>:[],</span><br><span class="line"></span><br><span class="line">        <span class="attr">nofityServiceUUID</span>:[],</span><br><span class="line">        <span class="attr">nofityCharacteristicUUID</span>:[],</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> services)&#123;</span><br><span class="line">        <span class="keyword">let</span> charchteristic = services[i].<span class="property">characteristics</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> j <span class="keyword">in</span> charchteristic)&#123;</span><br><span class="line">            <span class="comment">//读</span></span><br><span class="line">            <span class="keyword">if</span>(charchteristic[j].<span class="property">isReadable</span>)&#123;</span><br><span class="line">               result.<span class="property">readServiceUUID</span>.<span class="title function_">push</span>(services[i].<span class="property">uuid</span>);</span><br><span class="line">               result.<span class="property">readCharacteristicUUID</span>.<span class="title function_">push</span>(charchteristic[j].<span class="property">uuid</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//写并响应</span></span><br><span class="line">            <span class="keyword">if</span>(charchteristic[j].<span class="property">isWritableWithResponse</span>)&#123;</span><br><span class="line">               result.<span class="property">writeWithResponseServiceUUID</span>.<span class="title function_">push</span>(services[i].<span class="property">uuid</span>);</span><br><span class="line">               result.<span class="property">writeWithResponseCharacteristicUUID</span>.<span class="title function_">push</span>(charchteristic[j].<span class="property">uuid</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//写无响应</span></span><br><span class="line">            <span class="keyword">if</span>(charchteristic[j].<span class="property">isWritableWithoutResponse</span>)&#123;</span><br><span class="line">               result.<span class="property">writeWithoutResponseServiceUUID</span>.<span class="title function_">push</span>(services[i].<span class="property">uuid</span>);</span><br><span class="line">               result.<span class="property">writeWithoutResponseCharacteristicUUID</span>.<span class="title function_">push</span>(charchteristic[j].<span class="property">uuid</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//通知</span></span><br><span class="line">            <span class="keyword">if</span>(charchteristic[j].<span class="property">isNotifiable</span>)&#123;</span><br><span class="line">               result.<span class="property">nofityServiceUUID</span>.<span class="title function_">push</span>(services[i].<span class="property">uuid</span>);</span><br><span class="line">               result.<span class="property">nofityCharacteristicUUID</span>.<span class="title function_">push</span>(charchteristic[j].<span class="property">uuid</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// console.info(&quot;@getBlePlxUUID&quot;,result);</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [initBleplx 初始化蓝牙]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">initBleplx</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="comment">//确保全局只有一个BleManager实例，BleModule类保存着蓝牙的连接信息</span></span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable language_">global</span>.<span class="property">BLEPlxMag</span>)&#123;</span><br><span class="line">        <span class="variable language_">global</span>.<span class="property">BLEPlxMag</span> = <span class="keyword">new</span> <span class="title class_">BleManager</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [blePlxWrite 写数据]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">blePlxWrite</span>(<span class="params">id,value</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!id)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;[id]不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> uuidObj = <span class="title function_">getCacheConnectDeviceUUIDById</span>(id);</span><br><span class="line">    <span class="keyword">if</span>(!uuidObj)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取[UUID service Obejct]失败,请重新连接&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!uuidObj.<span class="property">writeWithResponseServiceUUID</span>[<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取[UUID service]失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!uuidObj.<span class="property">writeWithResponseCharacteristicUUID</span>[<span class="number">0</span>])&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;获取[UUID characteristic]失败&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> deviceId = id;</span><br><span class="line">    <span class="keyword">let</span> serviceUUID = uuidObj.<span class="property">writeWithResponseServiceUUID</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> characteristicUUID = uuidObj.<span class="property">writeWithResponseCharacteristicUUID</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> base64Value = value;</span><br><span class="line">    <span class="keyword">let</span> transactionId = <span class="string">&#x27;write&#x27;</span>;</span><br><span class="line">    <span class="comment">// console.log(&quot;@deviceId,serviceUUID,characteristicUUID,base64Value&quot;,deviceId,serviceUUID,characteristicUUID,base64Value,&quot;参数结束&quot;);</span></span><br><span class="line">    <span class="keyword">let</span> pse = <span class="title class_">BLEPlxMag</span>.<span class="title function_">writeCharacteristicWithResponseForDevice</span>(deviceId,serviceUUID,characteristicUUID,base64Value)</span><br><span class="line">    <span class="keyword">return</span> pse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [getDeviceIdByTpltypeid 根据模板Id获取指定的打印设备Id]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; deviceList [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; tpltypeid  [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;            [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getDeviceIdByTpltypeid</span>(<span class="params">deviceList,tpltypeid</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!deviceList || !deviceList.<span class="property">length</span>)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;设备列表不存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> findDevice = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> device <span class="keyword">of</span> deviceList)&#123;</span><br><span class="line">        <span class="keyword">if</span>(device.<span class="property">tpltypeid</span> == tpltypeid)&#123;</span><br><span class="line">            findDevice = device;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!findDevice)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;未找到设置的打印设备无法打印&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> findDevice.<span class="property">id</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [bleplxPrintTaskDeal 打印任务处理]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  &#123;<span class="type">[type]</span>&#125; printArr [description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">[type]</span>&#125;          [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">bleplxPrintTaskDeal</span>(<span class="params">id,printArr</span>)&#123;</span><br><span class="line">    <span class="keyword">let</span> writePromises = []</span><br><span class="line">    <span class="keyword">let</span> toWrite;</span><br><span class="line">    <span class="keyword">let</span> base64Value;</span><br><span class="line">    <span class="keyword">let</span> packetSize = <span class="number">512</span>;<span class="comment">//分包 此数值根据具体设备进行测试</span></span><br><span class="line">    <span class="keyword">let</span> packetCount;</span><br><span class="line">    <span class="keyword">let</span> packet;</span><br><span class="line">    <span class="keyword">let</span> byteArr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(lodash.<span class="title function_">isArray</span>(printArr))&#123;</span><br><span class="line">        printArr.<span class="title function_">forEach</span>( <span class="function">(<span class="params">item</span>) =&gt;</span>&#123;</span><br><span class="line">            <span class="comment">//执行命令</span></span><br><span class="line">            <span class="keyword">if</span>(item.<span class="property">type</span> == <span class="number">1</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">values</span>);</span><br><span class="line">                base64Value = toWrite.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value));</span><br><span class="line">            <span class="comment">//执行字符串</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span>==<span class="number">2</span>)&#123;</span><br><span class="line">                toWrite = iconv.<span class="title function_">encode</span>(item.<span class="property">values</span>, <span class="string">&#x27;GBK&#x27;</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">//生成二维码</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span>==<span class="number">3</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">byte</span>);</span><br><span class="line">                base64Value = toWrite.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="comment">//打印图片</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span>==<span class="number">4</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">byte</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span> == <span class="number">5</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">byte</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(item.<span class="property">type</span> == <span class="number">6</span> &amp;&amp; item.<span class="property">byte</span> &amp;&amp; item.<span class="property">byte</span>.<span class="property">length</span>)&#123;</span><br><span class="line">                toWrite = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(item.<span class="property">byte</span>);</span><br><span class="line">                packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">                    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">                    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">                    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">                    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(lodash.<span class="title function_">isString</span>(printArr))&#123;</span><br><span class="line">        toWrite = iconv.<span class="title function_">encode</span>(item.<span class="property">values</span>, <span class="string">&#x27;GBK&#x27;</span>);</span><br><span class="line">        packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">            packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">            toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">            base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">            writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// console.log(&quot;writePromises&quot;,writePromises)</span></span><br><span class="line">    <span class="keyword">return</span> writePromises;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * [ConvertPrintImage description]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="type">Promise</span>&#125; [description]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">convertPrintImage</span>(<span class="params">rows</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!rows || !rows.<span class="property">length</span>)&#123;</span><br><span class="line">        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;数据不能为空&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> data = <span class="keyword">await</span> <span class="title class_">BlePlxPrint</span>.<span class="title function_">getSingleConvertData</span>(rows);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">    initBleplx,</span><br><span class="line">    updateCacheConnectDevice,</span><br><span class="line">    removeCacheConnectDevice,</span><br><span class="line">    getCacheConnectDeviceById,</span><br><span class="line"></span><br><span class="line">    getCacheConnectDeviceUUIDById,</span><br><span class="line">    removeCacheConnectDeviceUUID,</span><br><span class="line">    updateCacheConnectDeviceUUID,</span><br><span class="line"></span><br><span class="line">    fetchServicesAndCharacteristicsForDevice,</span><br><span class="line">    getBlePlxUUID,</span><br><span class="line">    blePlxWrite,</span><br><span class="line">    bleplxPrintTaskDeal,</span><br><span class="line">    blePlxCommands,</span><br><span class="line">    convertPrintImage,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>blecp.js</code>(简要代码)</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Buffer</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;buffer&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">&quot;moment&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    initBleplx,</span><br><span class="line">    updateCacheConnectDevice,</span><br><span class="line">    removeCacheConnectDevice,</span><br><span class="line">    getCacheConnectDeviceById,</span><br><span class="line">    getCacheConnectDeviceUUIDById,</span><br><span class="line">    removeCacheConnectDeviceUUID,</span><br><span class="line">    updateCacheConnectDeviceUUID,</span><br><span class="line"></span><br><span class="line">    fetchServicesAndCharacteristicsForDevice,</span><br><span class="line">    getBlePlxUUID,</span><br><span class="line">    bleplxPrintTaskDeal,</span><br><span class="line">    blePlxWrite,</span><br><span class="line">    blePlxCommands,</span><br><span class="line"></span><br><span class="line">    convertPrintImage,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./bleplx.js&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Blecp</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">scaning</span>:<span class="literal">false</span>, <span class="comment">//是否扫描附近蓝牙</span></span><br><span class="line">            <span class="attr">isConnecting</span>:<span class="literal">false</span>,<span class="comment">//是否连接设备中</span></span><br><span class="line">            <span class="attr">writing</span>:<span class="literal">false</span>, <span class="comment">//正在写数据</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">deviceMap</span> = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">        <span class="title function_">initBleplx</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">componentWillMount</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">// 监听蓝牙开关</span></span><br><span class="line">        <span class="title class_">BLEPlxMag</span>.<span class="title function_">onStateChange</span>(<span class="function">(<span class="params">state</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(state == <span class="string">&#x27;PoweredOn&#x27;</span>)&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">scan</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line">    <span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描设备 记得检查权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    scan = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">scaning</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">deviceMap</span>.<span class="title function_">clear</span>();</span><br><span class="line">            <span class="title class_">BLEPlxMag</span>.<span class="title function_">startDeviceScan</span>(<span class="literal">null</span>, <span class="literal">null</span>, <span class="function">(<span class="params">error, device</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (error) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(error.<span class="property">errorCode</span> == <span class="number">102</span>)&#123;</span><br><span class="line">                        <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;请打开手机蓝牙后再搜索&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="comment">// console.log(device.id,device.name);</span></span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">deviceMap</span>.<span class="title function_">set</span>(device.<span class="property">id</span>,device); <span class="comment">//使用Map类型保存搜索到的蓝牙设备，确保列表不显示重复的设备</span></span><br><span class="line">                    <span class="keyword">let</span> arr = [...<span class="variable language_">this</span>.<span class="property">deviceMap</span>.<span class="title function_">values</span>()];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">scanTimer</span> &amp;&amp; <span class="built_in">clearTimeout</span>(<span class="variable language_">this</span>.<span class="property">scanTimer</span>);</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">scanTimer</span> = <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">scaning</span>)&#123;</span><br><span class="line">                   <span class="title class_">BLEPlxMag</span>.<span class="title function_">stopDeviceScan</span>();</span><br><span class="line">                   <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,<span class="number">6000</span>)  <span class="comment">//6秒后停止搜索</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title class_">BLEPlxMag</span>.<span class="title function_">stopDeviceScan</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//开始连接设备</span></span><br><span class="line">    connect = <span class="function">(<span class="params">item,index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">scaning</span>)&#123;  <span class="comment">//连接的时候正在扫描，先停止扫描</span></span><br><span class="line">            <span class="title class_">BLEPlxMag</span>.<span class="title function_">stopDeviceScan</span>();</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">scaning</span>:<span class="literal">false</span>&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isConnecting</span>)&#123;</span><br><span class="line">            <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;正在连接中...&quot;</span>);</span><br><span class="line">            <span class="comment">// console.log(&#x27;当前蓝牙正在连接时不能打开另一个连接进程&#x27;);</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(item.<span class="property">isConnecting</span>)&#123;</span><br><span class="line">            <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;该蓝牙正在连接中...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">isConnecting</span>:<span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="title class_">BLEPlxMag</span>.<span class="title function_">connectToDevice</span>(item.<span class="property">id</span>)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function"><span class="params">device</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="comment">//发现所需要的服务和特点是只执行一次。 另外 它可以是一个漫长的过程取决于数量的特点和可用的服务。</span></span><br><span class="line">                <span class="keyword">return</span> device.<span class="title function_">discoverAllServicesAndCharacteristics</span>();</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">then</span>( <span class="title function_">async</span>(device) =&gt; &#123;</span><br><span class="line">                <span class="title function_">updateCacheConnectDevice</span>(device);</span><br><span class="line">                <span class="keyword">let</span> objUUID = <span class="keyword">await</span> <span class="title function_">getBlePlxUUID</span>(item.<span class="property">id</span>);</span><br><span class="line">                <span class="keyword">if</span>(objUUID &amp;&amp; device.<span class="property">id</span>)&#123;</span><br><span class="line">                    <span class="title function_">updateCacheConnectDevice</span>(device);</span><br><span class="line">                    <span class="title function_">updateCacheConnectDeviceUUID</span>(device.<span class="property">id</span>,objUUID);</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                        <span class="attr">isConnecting</span>:<span class="literal">false</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                    item.<span class="property">isConnected</span> = <span class="literal">true</span>;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">onDisconnect</span>(item);</span><br><span class="line">                    <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;设备连接成功&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                        <span class="attr">isConnecting</span>:<span class="literal">false</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    item.<span class="property">isConnected</span> = <span class="literal">false</span>;</span><br><span class="line">                    <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;设备连接失败&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">isConnecting</span>:<span class="literal">false</span>&#125;)</span><br><span class="line">                <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;设备连接失败&quot;</span>);</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//监听蓝牙断开</span></span><br><span class="line">    onDisconnect = <span class="function">(<span class="params">item</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;btconnectStore&#125; = <span class="variable language_">this</span>.<span class="property">props</span>;</span><br><span class="line">        <span class="title class_">BLEPlxMag</span>.<span class="title function_">onDeviceDisconnected</span>(item.<span class="property">id</span>,<span class="function">(<span class="params">error,device</span>)=&gt;</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(error)&#123;</span><br><span class="line">                <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;蓝牙遇到错误自动断开&quot;</span>);</span><br><span class="line">                <span class="comment">//蓝牙遇到错误自动断开</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;蓝牙已断开&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(device)&#123;</span><br><span class="line">                <span class="title function_">removeCacheConnectDevice</span>(device);</span><br><span class="line">                <span class="title function_">removeCacheConnectDeviceUUID</span>(item.<span class="property">id</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//断开蓝牙设备</span></span><br><span class="line">    _disconnect = <span class="function">(<span class="params">item,index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">BLEPlxMag</span>.<span class="title function_">cancelDeviceConnection</span>(item.<span class="property">id</span>).<span class="title function_">then</span>(<span class="function"><span class="params">device</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="comment">// console.log(&#x27;disconnect success&#x27;,device);</span></span><br><span class="line">           <span class="title function_">removeCacheConnectDevice</span>(device);</span><br><span class="line">           <span class="title function_">removeCacheConnectDeviceUUID</span>(item.<span class="property">id</span>);</span><br><span class="line">           <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;断开连接设备成功&quot;</span>);</span><br><span class="line">       &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;断开连接异常&quot;</span>);</span><br><span class="line">       &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入数据</span></span><br><span class="line">    _write = <span class="function">(<span class="params">item,index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">writing</span>)&#123;</span><br><span class="line">            <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;正在写数据中，请稍后再操作...&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">writing</span>:<span class="literal">true</span></span><br><span class="line">        &#125;,<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> printArr = [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">initClear</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">2</span>,</span><br><span class="line">                    <span class="attr">values</span>:<span class="string">`静女其姝，俟我于城隅。爱而不见，搔首踟蹰。静女其娈，贻我彤管。彤管有炜，说怿女美。自牧归荑，洵美且异...`</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="comment">//打印二维码</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">imgBefore</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">3</span>,</span><br><span class="line">                    <span class="attr">values</span>:&#123;</span><br><span class="line">                        <span class="attr">content</span>:<span class="string">&quot;我是二维码&quot;</span>,</span><br><span class="line">                        <span class="attr">size</span>:<span class="number">280</span>,</span><br><span class="line">                        <span class="attr">logo</span>:<span class="string">&quot;&quot;</span><span class="comment">//可选</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">initClear</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">imgBefore</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">4</span>,</span><br><span class="line">                    <span class="attr">values</span>:&#123;</span><br><span class="line">                        <span class="attr">base64Str</span>:<span class="string">&quot;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJUAAACACAYAAAACuStnAAAQGElEQVR4Xu1de5QcVZn/fVU9M0nIzHT1giDCkky6mlUWFYHFx1EDuonIKkd5qFFmCQEzUz3JIZHIIq/wFNlg1EzXJJDwyAH2nCAicJBVUBf1nM3ReHRxF3a7esIrG0ggXT15kHl017enOpnZSTIzfav7Vk9P+taf09/3u9/3q99U3773q+8SxrqYKdqT+QIx5hPhHAbPJlBsTFv1x3pjYCczPeiRt67PSmwdK3k6/I/Gmt7TSS+sB+jv6o0tla84AwwwMT+xX+Ol+ztP/d/RnoeIyuju/Txp3uMAponDK8u6ZoCxg0mf51ptLw7zMCKq1pRzsUbYRMART6+6Jk0lX5oB5u2DmnbG3s74Tt+4KKBoj3MGMf5AgF4aQVkoBo5kgBlPu0nziyOiMlLOs0T4nCJLMVAJAx7hI7lO8080Y83rJ07TBw6ZaFUCrHzrmAHGhmzSvJIM20kS0F3HVKjUZTHA2JFNmidQLOWsB2GRLFyFU98MZPV4I8Vs518BzK9vKlT2shjINhVayEilXyCiT8kCVTj1zQDrWlSJqr41ID17JSrplCpAJSqlAekMKFFJp1QBKlEpDUhnQIlKOqUKUIlKaUA6A0pU0ilVgEpUSgPSGVCikk6pAlSiUhqQzoASlXRKFaASldKAdAaUqKRTqgCVqJQGpDOgRCWdUgUYuqiY+c9E5IBpOwMDAL8P4FNA9DH1OtjRKcCQRMVvMqibKfJornP2q2NR12q/ZugYvIgZS4lw+tFJb31mJVtU/Qxc4+rxe7GYhkQpjdrOFzXGvSAcL+qj7GqXAYmi4jc9ogv8FwnLSbfVTrfpwG8Ael85/sqndhiQJap380wf2p2MZypJLdq99RTS8lsIdGwlOMp3chmQIyoPX8l2mZtkpNK6tvcsveD9BoTpMvAURvUZqFxUzE9kk4kvyww9ZjvLAdwjE1NhVY+BikTF4CHoetxdPOd1qSGv4wYjn3mJCHGpuAqsKgxUJCoAj2Ut89IwIo32pJdqTD8MA1thhstARaJi5gVuMvEvYYQ4Y92r751WGNoeBrbCDJeBikQ10KCfsO+qth1hhRiznTQAMyx8hRsOA2WLipnzbjLREE5YB1CNlPMrIpwb5hgKWz4DZYsKjG3ZpHmy/JD+H9FIpR8loq+FOYbCls9A2aJi8DuulThOfkijRGU7TxJQ7CGprqnDQAWiArudcR1EHFa6sVT69yA6Oyz8auEy8AYxdoBwVrXGnMxxyhaVH3Sh0NDWt2TWK6EksIl1453MLgJaQ8GvHqjTX2ia++6uk9+KHucs0YA7QHRM9Yav/kgViYrBna6VWBtG2NEeZ67G+HUY2NXCZPCLeW/GeXu6Tto1PGbsR85JHOG1BLqgWnFUe5yKRAXm57LJxLwwgjbsTA+BO8LArhLmH5HHedml5u6xxmvtSV+kM9YA9N4qxVO1YSoTFYDhvtkyIz5YreAQKNQlC5kxj8Zi8G/dmS3no/2EfRONEfuR08IR3AWg42g6ZaNiUQHYnO2Mf1zmhN1IpZ8hos+HddPDxGXgWTePL2GpOSA6Tsx2Pgrm+0H0flGfWraTISoweJVrJVbISNRIORYRUjKwJgHjsezO+AKspHzgsf1N9EJmBRg3EaEpsH8NOUgRlZ+PjEl7tDv9KdLw/JT82mPcn7XiV1b6xPYrYDWm9VN5J0GaqIrCYlriJuNlnRwRtdMLiXEvEUVq6J9ONJQfZC1zmaixiF3UzvwjgVcTYIjY15KNVFEVE2N+sOA13iq6ftXa3fsZjbzrp/B/5q1Zy7w5jJvavO5/jo3ktXuI0B4GfliY8kVV1BU8AE+D8GPK46lDflZ//43pRtPgmYB3AQiXEDAnrOTCxvWAZTnL/IHIOMUyaa9wYdZK3ChiP9ommsqcS+StJ1BbUN/JsA9FVKMTKR6JCrzNzNsB8s8SPI0I2mQkK2tMPycmXJnrNO8XwTz46+75gyvpDoD2rGVuFvEdsXnglWnG/vyNYP52rU8RQhdVIOKmgLFf8kNEC7KW+ZhIuP7Xu06e/9Q+5EUOZl7nTvNWYNHf7BHBGbaZmUq/vxG0sZb3EZWoAtxRZgyA6EuuFX9WxM2wM+cT+Gfj2jJv9zStK9cZf0IEb8SGmYy1mQ5i/h5AzYF8q2CsRCVKMmM/kz7ftdp+K+ISs51LAAi9tsbgZwb0xqveXTzrTRHsYZsDJdeD/lbPRUH8wrZVohJhmLEbhPmi86Boj3OFxtggAj1sw0AfmK91k4l1Qfx8W8PuvYDYWwvCSUF9w7CvKVEx4z4CzwLR34eRbDmYzLwLFDnPtdpeFPE3epxOYtgituPYbM5rWvvujjn+hF78Su2cGcPu25l46WTvI9aEqJjxGki/zP9q8TdZofPmmtgHY96e1/W5ojfYSGWuJ+LbxZUwvqXHfFMumbgtKJa/dKF53gME/G1QX1n2kyoqfz2LQGuyA03XYfnJ+4eTOlhz9KfJ7KnAzK8gos8VfVE2ZjurAVwt68YUcZhfLuh6e1/HnC2BcDexHnu7dxnAt05G+4DJFJVT0LQF4xE2yT0VXhokOndvZ3ynyM00bMcmoFPEthwbZnS7zc3/VKqU5nBsv4RIo4LfoimUmrfxcqm6qPx1HoBWuccN3oxLTxuciGSjJ/0PYHqqmnMEv1qTBxo+nVs2OyciACPlPEyEr4vYVmTD2MakdbjWnGeC4hg9ma8Ss/+293uC+pZjX1VRMfCfKGgL3CVz/iIarGGnVxDoblH7Cu02I4/541VrHo4dsx1/ycBfOqjaxYxNQxotEX2KDgfmdy4kDN6tAVeGHWxVRMXgQQZuyx1rfheXUiFoUjHb8bdDFgb1C2TP/MvswPQvjJ7bTfgUtZ2fEXB+oDEkGTPgMuEa0W2i0cMa9tZPEgr+ckdob36HLyrGlryuLRD9BTUm7wferPklAZ+WdF8OgWHGk24kfolQS8nvvzE91rT/aRB9JoxYgmD6ZcsecHmfldgaxA+b/qsxtqvxOmb+DoEaA/kKGIcnKsZ+EG7IdsZXV1q45ucR1lIDMx5x3463YyX5lRUTXsUYIvg5gI+Wsq3i5/3MuMVNmn6te6CrZW2vqXuFDQT6ZCDHEsZhiWqz5+lfzXW1vSYzWOlLDQGqNaOrX4lS09ALBPqgzJxkYTHjLwxuzyUTfw6EyUyxnswiBlbJesdSsqh4DxNd63bE1wZ9OvkdinOW+VQpQiQuNQhXa87sybynwWO/WchppeKb7M89xj25gWk3is4Nh+M95r6txzcO5lfL6F0hTVTM+DUV0J5dam4LQuyMNa+f2KQPrPcnvaIvUFS61MBMN7jJ+B0icRbj0/p/R0SzRexrwcbfofCAb/YlzV8Ejac15czT4Jd145SgvsP2FYuq+EsEtCxnxR8KGkQslbkK4FUgtAz7euArclbigVJY5Sw1+MV1ICTdTrOnFL7/eeuaV2dr+tC/EfDXIva1ZuPPF/MR7+o9i099J1Bs67bPMAp7VwK0vJxTOSoSlV+yMUTaFUHXTGKpzMlMvJGAuWMl6wFzc5b5Qikigiw1HCxxbneT5iOlcP3P/UlsxPN+V60FQ5GYyrHxN8QZ2vJcMr4xqL+xpvd0aIWNRPThIL7lisrfvugSrX4cHZCRynQRvLsmbFLB2J3XtbNKLkMILjX4q/jMdHGuy3xShBzD3vpBcP5XRPRXIvZTwcafnjDrCwP/eFrJWvR4p0vzcKdoY5HAomLgYQ+NS/usU9wgZLakMnGd+EECPiHix+BXPTR9pNQ4pZYaglZrHqgnx89HfyWLxDtFbN4F083ZZHxV0HiDNBYJICp+s8B0eTmTv1gq8y2Abwu6Y86Mf3eT5sdLETDuUgPzPqbI+aLVmsXVZi74gjqqDwbwTzaDp7cH2S4bvgcijUWEROUXz7nTCt8KWqTfbG89tYHzD4HonFLCGO9zBh51LbPkhu3hSw3MyHlEn+2z4n8UGbtkPbkIyBSzYaa73YGmlUGXH4qNRXR8F4TOsTb7JxTV6OK5oHwZtvMd8ht8Sbg88I05K1Gy+G3UUsPb0HButsN8SWT4aLdzoabhpyK2R5uNf48ZtDCXjAfuBTZeY5ExRTVe8ZwIobFu5zTW+BECfUjEXtSmQHxxX2fi8VL2MTvzzUIh8pzoG9JGyvk6ER4uhXvUf+6/WU5Ny0vNYY/g4UBjkWvAuHm4schYopqweG4icmO2cwuAm8K6AQVNOztwFeQEwZTzgkJYudUI7k5mvrqcAxdGNxYZERUAv8fUP7vHDq4sVTx3OAGtduZMjfmhsLcx/I7IlKczgq7aj3XDorZztQb4JcDqOpwBxi9QwKJyeI72OJfljmn+CRm2042Ctq6cXwOG7dxFwLVVuzPML2ebW84OWlo7Or5YKnMriAP3NKhajrUwEPNeD7ghl0yUdT4QlZNDS3f6nIiGhwA6tRz/inwq6DUadj15RXnVojNjyyC4fW8y8XKQ8IKJqlik1n8HCFL7MQUJ2LdloMe1TCuIXyzlbADhiiA+yvYAAwzc6Vrm9aJ8CIvK6Ml8Auw9TKBZouBh2gVpsjYZ9eRh5j4Z2AzeCkQuF1lMLi2qjW8dY+zZczcRAj0ZqpF4QeN5fR2J5yYay0g5PyXChdWIpx7G8BfDEdFWuIvn9I2X74SiarV7P6vBu5+AUA83KvtmMO8bBM4e7zs/lkr7faEmvZ687Pxq1ZHxVgFY0pc0fzxWiGOLasN/N8f69dUgLKrVvEbiYmwbinhnHFI35D9d9+5+Vnb9dc1zUeUAx+tYc4Soivtg7K0H0YlVjrH84RhbskmzeDiSX0+uNeWfB3Bm+YDKU5gBxm4GrnOT5khjkhFRtax/I6YP9v+QgG8IA9aUIT8+pHNHQ0HzC/w+UFOh1UcwIx1riqKKpnq/rJHnl9lW5dXosDj2qxOIEA0LX+GWZiA7s3kmhdKxpPTYyuJoZSCPVn+bxi/uD+Xt36OVN5XXBAwoUSl5SGdAiUo6pQpQiUppQDoDSlTSKVWASlRKA9IZUKKSTqkCVKJSGpDOgBKVdEoVoBKV0oB0BpSopFOqAJWolAakM6BEJZ1SBahEpTQgnQElKumUKkAlKqUB6QwoUUmnVAEqUSkNSGdAiUo6pQpQiUppQDoDSlTSKVWASlRKA9IZUKKSTqkCVKJSGpDOgBKVdEoVoBKV0oB0BpSopFOqAJWolAakM+CLKpZy/EN+5kkHV4B1yUCx64thO/6BjpfVJQMqaekMZC2TfFFdR8Cd0tEVYN0xwOD/cK3Eh+ng0a7pumNAJSydgeFDz4ud9NS8Sjq/9QjYP9Cgz9p3VduOoqiKhzB63h/qkQmVsywG+PaslSie+TPSSFbmwY+ywlQ4U4UB/n3WSoycQHtIy2sj5awhQtdUSUXFWQMMMLYM8fTP7ek6addwNEf2UU+lFxPoFhCOr4GQVQi1y0A/g+9zpzd8Gwtn948Oc9xjRAzb+QYYFhE+Vrt5qciqzgBjGwOpfMRbf8gpG6MC+T9XMACZS/5RSwAAAABJRU5ErkJggg==&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">nextOneLinePaper</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="number">1</span>,</span><br><span class="line">                    <span class="attr">values</span>:blePlxCommands.<span class="property">cutHalfPaper</span></span><br><span class="line">                &#125;</span><br><span class="line">            ];</span><br><span class="line">            <span class="title function_">convertPrintImage</span>(printArr).<span class="title function_">then</span>(<span class="function">(<span class="params">rows</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> writePromises = <span class="title function_">bleplxPrintTaskDeal</span>(item.<span class="property">id</span>,rows);</span><br><span class="line">                <span class="title class_">Promise</span>.<span class="title function_">all</span>(writePromises).<span class="title function_">then</span>(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">writing</span>:<span class="literal">false</span>&#125;)</span><br><span class="line">                    <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;打印完成&quot;</span>)</span><br><span class="line">                &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">writing</span>:<span class="literal">false</span>&#125;)</span><br><span class="line">                    <span class="title class_">XToast</span>.<span class="title function_">show</span>(<span class="string">&quot;打印任务失败&quot;</span>)</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Android部分代码"><a href="#Android部分代码" class="headerlink" title="Android部分代码"></a><code>Android</code>部分代码</h3><p>对打印图片的数据进行处理</p>
<p>Android原生代码<code>BlePlxPrint.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xx.yy.print;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.Arguments;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.Promise;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReactApplicationContext;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReactContext;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReactContextBaseJavaModule;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReactMethod;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReadableArray;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReadableMap;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.ReadableType;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.WritableArray;</span><br><span class="line"><span class="keyword">import</span> com.facebook.react.bridge.WritableMap;</span><br><span class="line"><span class="keyword">import</span> com.xx.yy.utils.BaseUtil;</span><br><span class="line"><span class="keyword">import</span> com.xx.yy.utils.PictureUtils;</span><br><span class="line"><span class="keyword">import</span> com.xx.yy.utils.QRCodeUtil;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/11/19.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlePlxPrint</span> <span class="keyword">extends</span> <span class="title class_">ReactContextBaseJavaModule</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ReactContext reactContext;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BlePlxPrint</span><span class="params">(ReactApplicationContext reactContext)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(reactContext);</span><br><span class="line">        <span class="built_in">this</span>.reactContext = reactContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * return string 这个名字在JavaScript端标记这个模块</span></span><br><span class="line"><span class="comment">     * 这样就可以在JavaScript中通过React.NativeModules.ToastForAndroid访问到这个模块</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;BlePlxPrint&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">canOverrideExistingModule</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回打印图片的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type=3=qrcode type=4=img type=5=barcode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> WritableArray <span class="title function_">ConvertPrintToImage</span><span class="params">(<span class="type">int</span> type ,ReadableMap map)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] imgByte = &#123;&#125;;</span><br><span class="line">        <span class="type">WritableArray</span> <span class="variable">jsArr</span> <span class="operator">=</span> Arguments.createArray();</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (type)&#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                    <span class="type">String</span> <span class="variable">qrCodeContent</span> <span class="operator">=</span> map.getString(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">qrCodeSize</span> <span class="operator">=</span> map.getInt(<span class="string">&quot;size&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span>( map.hasKey(<span class="string">&quot;logo&quot;</span>) &amp;&amp; !TextUtils.isEmpty(map.getString(<span class="string">&quot;logo&quot;</span>)))&#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">logo</span> <span class="operator">=</span> map.getString(<span class="string">&quot;logo&quot;</span>);</span><br><span class="line">                        <span class="type">Bitmap</span> <span class="variable">bitmapLogo</span> <span class="operator">=</span> PictureUtils.base64StringToBitmap(logo);</span><br><span class="line">                        bitmap = QRCodeUtil.createQRCodeBitmap(qrCodeContent,qrCodeSize,bitmapLogo,<span class="number">0.2f</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        bitmap = QRCodeUtil.createQRCodeBitmap(qrCodeContent,qrCodeSize);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                    <span class="type">String</span> <span class="variable">base64Str</span> <span class="operator">=</span> map.getString(<span class="string">&quot;base64Str&quot;</span>);</span><br><span class="line">                    bitmap = PictureUtils.base64StringToBitmap(base64Str);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                    <span class="type">String</span> <span class="variable">barCodeContent</span> <span class="operator">=</span> map.getString(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">barCodeWidth</span> <span class="operator">=</span> map.getInt(<span class="string">&quot;width&quot;</span>);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">barCodeHeight</span> <span class="operator">=</span> map.getInt(<span class="string">&quot;height&quot;</span>);</span><br><span class="line">                    bitmap = QRCodeUtil.createBarCodeBitmap(barCodeContent,barCodeWidth,barCodeHeight);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                    <span class="type">String</span> <span class="variable">base64Value</span> <span class="operator">=</span> map.getString(<span class="string">&quot;base64Str&quot;</span>);</span><br><span class="line">                    imgByte = Base64.decode(base64Value, Base64.DEFAULT);</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(bitmap != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//拼接字节数组</span></span><br><span class="line">                <span class="type">byte</span>[] draw2PxPoint = PictureUtils.draw2PxPoint(bitmap);</span><br><span class="line">                imgByte = BaseUtil.byteMergerAll(draw2PxPoint);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;i&lt;imgByte.length;i++)&#123;</span><br><span class="line">                    jsArr.pushInt(imgByte[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(type == <span class="number">6</span>)&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span><span class="number">0</span>;i&lt;imgByte.length;i++)&#123;</span><br><span class="line">                    jsArr.pushInt(imgByte[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jsArr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换打印数据处理其中的图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rows</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> WritableArray <span class="title function_">getConvertData</span><span class="params">(ReadableArray rows)</span>&#123;</span><br><span class="line">        <span class="type">WritableArray</span> <span class="variable">writeArray</span> <span class="operator">=</span>  Arguments.createArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;rows.size() ;i++)&#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">ReadableMap</span> <span class="variable">readMap</span> <span class="operator">=</span> rows.getMap(i);</span><br><span class="line">            <span class="type">Bundle</span> <span class="variable">bundle</span> <span class="operator">=</span> Arguments.toBundle(readMap);</span><br><span class="line">            <span class="type">WritableMap</span> <span class="variable">writeMap</span> <span class="operator">=</span> Arguments.fromBundle(bundle);</span><br><span class="line">            <span class="type">WritableArray</span> <span class="variable">jsArr</span> <span class="operator">=</span> Arguments.createArray();</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> <span class="variable">type</span> <span class="operator">=</span> readMap.getInt(<span class="string">&quot;type&quot;</span>);</span><br><span class="line">            <span class="type">ReadableType</span> <span class="variable">valuesType</span> <span class="operator">=</span> readMap.getType(<span class="string">&quot;values&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">switch</span> (valuesType) &#123;</span><br><span class="line">                <span class="keyword">case</span> Null:</span><br><span class="line">                <span class="keyword">case</span> Boolean:</span><br><span class="line">                <span class="keyword">case</span> String:</span><br><span class="line">                <span class="keyword">case</span> Array:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> Map:</span><br><span class="line">                    <span class="type">ReadableMap</span> <span class="variable">values</span> <span class="operator">=</span> readMap.getMap(<span class="string">&quot;values&quot;</span>);</span><br><span class="line">                    jsArr = ConvertPrintToImage(type,values);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Could not convert object in Map.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            writeMap.putArray(<span class="string">&quot;byte&quot;</span>,jsArr);</span><br><span class="line">            writeArray.pushMap(writeMap);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> writeArray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回打印图片的字节数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type=3=qrcode type=4=img type=barcode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> map</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> promise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ReactMethod</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getPrintImageByte</span><span class="params">(<span class="type">int</span> type, ReadableMap map, Promise promise)</span>&#123;</span><br><span class="line">        <span class="type">WritableArray</span> <span class="variable">jsArr</span> <span class="operator">=</span> ConvertPrintToImage(type,map);</span><br><span class="line">        promise.resolve(jsArr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转换数据到新字段，并加入新字段</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rows</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> promise</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@ReactMethod</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getSingleConvertData</span><span class="params">(ReadableArray rows,Promise promise)</span>&#123;</span><br><span class="line">        <span class="type">WritableArray</span> <span class="variable">writeArray</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(rows != <span class="literal">null</span>)&#123;</span><br><span class="line">            writeArray = getConvertData(rows);</span><br><span class="line">        &#125;</span><br><span class="line">        promise.resolve(writeArray);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>图片工具:</p>
<p><code>PictureUtils.java:</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xx.yy.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.util.Base64;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/11/7.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PictureUtils</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把一张Bitmap图片转化为打印机可以打印的bit</span></span><br><span class="line"><span class="comment">     * 效率很高（相对于下面）</span></span><br><span class="line"><span class="comment">     * 传进去</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] draw2PxPoint(Bitmap bit) &#123;</span><br><span class="line">        <span class="type">int</span> nL;</span><br><span class="line">        <span class="type">int</span> nH;</span><br><span class="line">        <span class="type">int</span> yRow;</span><br><span class="line">        <span class="type">int</span> byteSum;<span class="comment">//总字节数</span></span><br><span class="line"></span><br><span class="line">        yRow = (<span class="type">int</span>) Math.ceil(bit.getHeight()/<span class="number">24</span>);</span><br><span class="line">        byteSum = yRow*<span class="number">3</span>*bit.getWidth() + <span class="number">5</span>*yRow+yRow;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 分辨率大于256时</span></span><br><span class="line"><span class="comment">         * n1=分辨率/256取余（n1%256）</span></span><br><span class="line"><span class="comment">         * n2=除得的整数</span></span><br><span class="line"><span class="comment">         * 分辨率小于256时</span></span><br><span class="line"><span class="comment">         * n1=自身</span></span><br><span class="line"><span class="comment">         * n2=0</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span>(bit.getWidth()&lt;<span class="number">256</span>)&#123;</span><br><span class="line">            nL = bit.getWidth();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nL = bit.getWidth()%<span class="number">256</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(bit.getHeight()&lt;<span class="number">256</span>)&#123;</span><br><span class="line">            nH = <span class="number">0x00</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            nH = (<span class="type">int</span>) Math.floor(bit.getHeight()/<span class="number">256</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] data = <span class="keyword">new</span> <span class="title class_">byte</span>[byteSum];</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//对于每一行，逐列打印</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; yRow; j++) &#123;</span><br><span class="line">            <span class="comment">//选择位图模式</span></span><br><span class="line">            data[k++] = <span class="number">0x1B</span>;</span><br><span class="line">            data[k++] = <span class="number">0x2A</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *  m=33时，选择24点双密度打印，分辨率达到200DPI。</span></span><br><span class="line"><span class="comment">             *  如果m的值超出了指定的范围，那么nL和之后的数据被当作常规数据处理。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            data[k++] = <span class="number">33</span>; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 位图的点数由 nL和 nH指定</span></span><br><span class="line"><span class="comment">             * nL和 nH表示水平方向上位图中的点数。通过nL+ nH´ 256计算出点数。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            data[k++] = (<span class="type">byte</span>) nL;</span><br><span class="line">            data[k++] = (<span class="type">byte</span>) nH;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * d表示位图数据。设置相应的位为 1去打印某点，或设置为 0以不打印某点。</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bit.getWidth(); i++) &#123;</span><br><span class="line">                <span class="comment">//每一列24个像素点，分为3个字节存储</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> <span class="number">0</span>; m &lt; <span class="number">3</span>; m++) &#123;</span><br><span class="line">                    <span class="comment">//每个字节表示8个像素点，0表示白色，1表示黑色</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>; n &lt; <span class="number">8</span>; n++) &#123;</span><br><span class="line">                        <span class="type">byte</span> <span class="variable">b</span> <span class="operator">=</span> px2Byte(i, j * <span class="number">24</span> + m * <span class="number">8</span> + n, bit);</span><br><span class="line">                        data[k] += data[k] + b;</span><br><span class="line">                    &#125;</span><br><span class="line">                    k++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//换行</span></span><br><span class="line">            data[k++] = <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片二值化，黑色是1，白色是0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> x  横坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> y     纵坐标</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bit 位图</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span> <span class="title function_">px2Byte</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, Bitmap bit)</span> &#123;</span><br><span class="line">        <span class="type">byte</span> b;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pixel</span> <span class="operator">=</span> bit.getPixel(x, y);</span><br><span class="line">        <span class="type">int</span> <span class="variable">red</span> <span class="operator">=</span> (pixel &amp; <span class="number">0x00ff0000</span>) &gt;&gt; <span class="number">16</span>; <span class="comment">// 取高两位</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">green</span> <span class="operator">=</span> (pixel &amp; <span class="number">0x0000ff00</span>) &gt;&gt; <span class="number">8</span>; <span class="comment">// 取中两位</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">blue</span> <span class="operator">=</span> pixel &amp; <span class="number">0x000000ff</span>; <span class="comment">// 取低两位</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">gray</span> <span class="operator">=</span> RGB2Gray(red, green, blue);</span><br><span class="line">        <span class="keyword">if</span> ( gray &lt; <span class="number">128</span> )&#123;</span><br><span class="line">            b = <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            b = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 图片灰度的转化</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> r</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> g</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> b</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">RGB2Gray</span><span class="params">(<span class="type">int</span> r, <span class="type">int</span> g, <span class="type">int</span> b)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">gray</span> <span class="operator">=</span> (<span class="type">int</span>) (<span class="number">0.29900</span> * r + <span class="number">0.58700</span> * g + <span class="number">0.11400</span> * b);  <span class="comment">//灰度转化公式</span></span><br><span class="line">        <span class="keyword">return</span>  gray;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * base64字符串转位图</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> base64String</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">base64StringToBitmap</span><span class="params">(String base64String)</span> &#123;</span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">base64Value</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String[] strArr =base64String.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(strArr.length==<span class="number">1</span>)&#123;</span><br><span class="line">                base64Value = strArr[<span class="number">0</span>];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(strArr.length==<span class="number">2</span>)&#123;</span><br><span class="line">                base64Value = strArr[<span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span>[] bitmapArray = Base64.decode(base64Value, Base64.DEFAULT);</span><br><span class="line">            bitmap = BitmapFactory.decodeByteArray(bitmapArray, <span class="number">0</span>, bitmapArray.length);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回base64字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> bitmap</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">bitmaptoBase64String</span><span class="params">(Bitmap bitmap)</span> &#123;</span><br><span class="line">        <span class="comment">//将Bitmap转换成字符串</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">string</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        bitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, bStream);</span><br><span class="line">        <span class="type">byte</span>[] bytes = bStream.toByteArray();</span><br><span class="line">        string = Base64.encodeToString(bytes, Base64.DEFAULT);</span><br><span class="line">        <span class="keyword">return</span> string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成二维码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xx.yy.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.ColorInt;</span><br><span class="line"><span class="keyword">import</span> android.support.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.google.zxing.BarcodeFormat;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.EncodeHintType;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.MultiFormatWriter;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.WriterException;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.common.BitMatrix;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.qrcode.QRCodeWriter;</span><br><span class="line"><span class="keyword">import</span> com.google.zxing.qrcode.decoder.ErrorCorrectionLevel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: QRCodeUtil</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Description</span>: 二维码工具类</span></span><br><span class="line"><span class="comment"> * Created by Administrator on 2018/11/7.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QRCodeUtil</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建条形码位图</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> width</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> height</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createBarCodeBitmap</span><span class="params">(<span class="meta">@Nullable</span> String content, <span class="type">int</span> width, <span class="type">int</span> height)</span>&#123;</span><br><span class="line">        <span class="comment">//配置参数</span></span><br><span class="line">        Map&lt;EncodeHintType,Object&gt; hints = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 容错级别 这里选择最高H级别</span></span><br><span class="line">        hints.put(EncodeHintType.ERROR_CORRECTION, ErrorCorrectionLevel.H);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MultiFormatWriter</span>().encode(content,BarcodeFormat.CODE_128, width, height, hints);</span><br><span class="line">            <span class="comment">/** 1.根据BitMatrix(位矩阵)对象为数组元素赋颜色值 */</span></span><br><span class="line">            <span class="type">int</span>[] pixels = <span class="keyword">new</span> <span class="title class_">int</span>[width * height];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; height; y++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; width; x++)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(bitMatrix.get(x, y))&#123; <span class="comment">// 黑色色块像素设置</span></span><br><span class="line">                        pixels[y * width + x] = Color.BLACK;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 白色色块像素设置</span></span><br><span class="line">                        pixels[y * width + x] = Color.WHITE;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 4.创建Bitmap对象,根据像素数组设置Bitmap每个像素点的颜色值,之后返回Bitmap对象 */</span></span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(width, height, Bitmap.Config.ARGB_8888);</span><br><span class="line">            bitmap.setPixels(pixels, <span class="number">0</span>, width, <span class="number">0</span>, <span class="number">0</span>, width, height);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bitmap;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(<span class="meta">@Nullable</span> String content, <span class="type">int</span> size)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createQRCodeBitmap(content, size, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;4&quot;</span>, Color.BLACK, Color.WHITE, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0F</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图 (自定义黑、白色块颜色)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color_black 黑色色块的自定义颜色值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color_white 白色色块的自定义颜色值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(<span class="meta">@Nullable</span> String content, <span class="type">int</span> size, <span class="meta">@ColorInt</span> <span class="type">int</span> color_black, <span class="meta">@ColorInt</span> <span class="type">int</span> color_white)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createQRCodeBitmap(content, size, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;4&quot;</span>, color_black, color_white, <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">0F</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图 (带Logo小图片)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoBitmap logo图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoPercent logo小图片在二维码图片中的占比大小,范围[0F,1F]。超出范围-&gt;默认使用0.2F</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(String content, <span class="type">int</span> size, <span class="meta">@Nullable</span> Bitmap logoBitmap, <span class="type">float</span> logoPercent)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createQRCodeBitmap(content, size, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;4&quot;</span>, Color.BLACK, Color.WHITE, <span class="literal">null</span>, logoBitmap, logoPercent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图 (Bitmap颜色代替黑色) 注意!!!注意!!!注意!!! 选用的Bitmap图片一定不能有白色色块,否则会识别不出来!!!</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetBitmap 目标图片 (如果targetBitmap != null, 黑色色块将会被该图片像素色值替代)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(String content, <span class="type">int</span> size, Bitmap targetBitmap)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createQRCodeBitmap(content, size, <span class="string">&quot;UTF-8&quot;</span>, <span class="string">&quot;H&quot;</span>, <span class="string">&quot;4&quot;</span>, Color.BLACK, Color.WHITE, targetBitmap, <span class="literal">null</span>, <span class="number">0F</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建二维码位图 (支持自定义配置和自定义样式)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content 字符串内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 位图宽&amp;高(单位:px)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> character_set 字符集/字符转码格式 (支持格式:&#123;<span class="doctag">@link</span> CharacterSetECI &#125;)。传null时,zxing源码默认使用 &quot;ISO-8859-1&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> error_correction 容错级别 (支持级别:&#123;<span class="doctag">@link</span> ErrorCorrectionLevel &#125;)。传null时,zxing源码默认使用 &quot;L&quot;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> margin 空白边距 (可修改,要求:整型且&gt;=0), 传null时,zxing源码默认使用&quot;4&quot;。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color_black 黑色色块的自定义颜色值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> color_white 白色色块的自定义颜色值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetBitmap 目标图片 (如果targetBitmap != null, 黑色色块将会被该图片像素色值替代)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoBitmap logo小图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoPercent logo小图片在二维码图片中的占比大小,范围[0F,1F],超出范围-&gt;默认使用0.2F。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title function_">createQRCodeBitmap</span><span class="params">(<span class="meta">@Nullable</span> String content, <span class="type">int</span> size,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@Nullable</span> String character_set, <span class="meta">@Nullable</span> String error_correction, <span class="meta">@Nullable</span> String margin,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@ColorInt</span> <span class="type">int</span> color_black, <span class="meta">@ColorInt</span> <span class="type">int</span> color_white, <span class="meta">@Nullable</span> Bitmap targetBitmap,</span></span><br><span class="line"><span class="params">                                            <span class="meta">@Nullable</span> Bitmap logoBitmap, <span class="type">float</span> logoPercent)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 1.参数合法性判断 */</span></span><br><span class="line">        <span class="keyword">if</span>(TextUtils.isEmpty(content))&#123; <span class="comment">// 字符串内容判空</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(size &lt;= <span class="number">0</span>)&#123; <span class="comment">// 宽&amp;高都需要&gt;0</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/** 2.设置二维码相关配置,生成BitMatrix(位矩阵)对象 */</span></span><br><span class="line">            Hashtable&lt;EncodeHintType, String&gt; hints = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!TextUtils.isEmpty(character_set)) &#123;</span><br><span class="line">                hints.put(EncodeHintType.CHARACTER_SET, character_set); <span class="comment">// 字符转码格式设置</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!TextUtils.isEmpty(error_correction))&#123;</span><br><span class="line">                hints.put(EncodeHintType.ERROR_CORRECTION, error_correction); <span class="comment">// 容错级别设置</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!TextUtils.isEmpty(margin))&#123;</span><br><span class="line">                hints.put(EncodeHintType.MARGIN, margin); <span class="comment">// 空白边距设置</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">BitMatrix</span> <span class="variable">bitMatrix</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QRCodeWriter</span>().encode(content, BarcodeFormat.QR_CODE, size, size, hints);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 3.根据BitMatrix(位矩阵)对象为数组元素赋颜色值 */</span></span><br><span class="line">            <span class="keyword">if</span>(targetBitmap != <span class="literal">null</span>)&#123;</span><br><span class="line">                targetBitmap = Bitmap.createScaledBitmap(targetBitmap, size, size, <span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span>[] pixels = <span class="keyword">new</span> <span class="title class_">int</span>[size * size];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">0</span>; y &lt; size; y++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">0</span>; x &lt; size; x++)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(bitMatrix.get(x, y))&#123; <span class="comment">// 黑色色块像素设置</span></span><br><span class="line">                        <span class="keyword">if</span>(targetBitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">                            pixels[y * size + x] = targetBitmap.getPixel(x, y);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            pixels[y * size + x] = color_black;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 白色色块像素设置</span></span><br><span class="line">                        pixels[y * size + x] = color_white;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 4.创建Bitmap对象,根据像素数组设置Bitmap每个像素点的颜色值,之后返回Bitmap对象 */</span></span><br><span class="line">            <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(size, size, Bitmap.Config.ARGB_8888);</span><br><span class="line">            bitmap.setPixels(pixels, <span class="number">0</span>, size, <span class="number">0</span>, <span class="number">0</span>, size, size);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** 5.为二维码添加logo小图标 */</span></span><br><span class="line">            <span class="keyword">if</span>(logoBitmap != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> addLogo(bitmap, logoBitmap, logoPercent);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> bitmap;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (WriterException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向一张图片中间添加logo小图片(图片合成)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> srcBitmap 原图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoBitmap logo图片</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> logoPercent 百分比 (用于调整logo图片在原图片中的显示大小, 取值范围[0,1], 传值不合法时使用0.2F)</span></span><br><span class="line"><span class="comment">     *                    原图片是二维码时,建议使用0.2F,百分比过大可能导致二维码扫描失败。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Bitmap <span class="title function_">addLogo</span><span class="params">(<span class="meta">@Nullable</span> Bitmap srcBitmap, <span class="meta">@Nullable</span> Bitmap logoBitmap, <span class="type">float</span> logoPercent)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 1. 参数合法性判断 */</span></span><br><span class="line">        <span class="keyword">if</span>(srcBitmap == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(logoBitmap == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> srcBitmap;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(logoPercent &lt; <span class="number">0F</span> || logoPercent &gt; <span class="number">1F</span>)&#123;</span><br><span class="line">            logoPercent = <span class="number">0.2F</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 2. 获取原图片和Logo图片各自的宽、高值 */</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">srcWidth</span> <span class="operator">=</span> srcBitmap.getWidth();</span><br><span class="line">        <span class="type">int</span> <span class="variable">srcHeight</span> <span class="operator">=</span> srcBitmap.getHeight();</span><br><span class="line">        <span class="type">int</span> <span class="variable">logoWidth</span> <span class="operator">=</span> logoBitmap.getWidth();</span><br><span class="line">        <span class="type">int</span> <span class="variable">logoHeight</span> <span class="operator">=</span> logoBitmap.getHeight();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 3. 计算画布缩放的宽高比 */</span></span><br><span class="line">        <span class="type">float</span> <span class="variable">scaleWidth</span> <span class="operator">=</span> srcWidth * logoPercent / logoWidth;</span><br><span class="line">        <span class="type">float</span> <span class="variable">scaleHeight</span> <span class="operator">=</span> srcHeight * logoPercent / logoHeight;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** 4. 使用Canvas绘制,合成图片 */</span></span><br><span class="line">        <span class="type">Bitmap</span> <span class="variable">bitmap</span> <span class="operator">=</span> Bitmap.createBitmap(srcWidth, srcHeight, Bitmap.Config.ARGB_8888);</span><br><span class="line">        <span class="type">Canvas</span> <span class="variable">canvas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Canvas</span>(bitmap);</span><br><span class="line">        canvas.drawBitmap(srcBitmap, <span class="number">0</span>, <span class="number">0</span>, <span class="literal">null</span>);</span><br><span class="line">        canvas.scale(scaleWidth, scaleHeight, srcWidth/<span class="number">2</span>, srcHeight/<span class="number">2</span>);</span><br><span class="line">        canvas.drawBitmap(logoBitmap, srcWidth/<span class="number">2</span> - logoWidth/<span class="number">2</span>, srcHeight/<span class="number">2</span> - logoHeight/<span class="number">2</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用注意"><a href="#使用注意" class="headerlink" title="使用注意"></a>使用注意</h3><ul>
<li><p>有些设备使用蓝牙连接的时候木有出现 <strong>配对</strong> 这个过程，而且连接成功了，这个是正确的。</p>
</li>
<li><p>官方的此方法只接受<code>base64</code>格式的值</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">BLEPlxMag</span>.<span class="title function_">writeCharacteristicWithResponseForDevice</span>(deviceId,serviceUUID,characteristicUUID,base64Value)</span><br></pre></td></tr></table></figure></li>
<li><p>分包，数据如果过多必须进行分包处理、分包大小取决设备</p>
  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">toWrite = iconv.<span class="title function_">encode</span>(item.<span class="property">values</span>, <span class="string">&#x27;GBK&#x27;</span>);</span><br><span class="line">packetCount = <span class="title class_">Math</span>.<span class="title function_">ceil</span>(toWrite.<span class="property">length</span> / packetSize);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; packetCount; i++) &#123;</span><br><span class="line">    packet = <span class="keyword">new</span> <span class="title class_">Buffer</span>(packetSize)</span><br><span class="line">    toWrite.<span class="title function_">copy</span>(packet, <span class="number">0</span>, i * packetSize, (i + <span class="number">1</span>) * packetSize)</span><br><span class="line">    base64Value = packet.<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">    writePromises.<span class="title function_">push</span>(<span class="title function_">blePlxWrite</span>(id,base64Value))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="使用过程"><a href="#使用过程" class="headerlink" title="使用过程"></a>使用过程</h2><p>低功耗蓝牙通信数据慢、过程比较繁琐</p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><ol>
<li><a target="_blank" rel="noopener" href="https://github.com/Polidea/react-native-ble-plx">react-native-ble-plx</a></li>
<li><a target="_blank" rel="noopener" href="https://wenku.baidu.com/view/187b1ad5690203d8ce2f0066f5335a8102d266a9">热敏打印机指令集</a></li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/react-native/" rel="tag"># react-native</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/10/07/%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF/" rel="prev" title="事件循环">
      <i class="fa fa-chevron-left"></i> 事件循环
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/12/27/rn%E8%93%9D%E7%89%99%E6%89%93%E5%8D%B02/" rel="next" title="rn蓝牙打印2">
      rn蓝牙打印2 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%93%9D%E7%89%994-0"><span class="nav-number">1.</span> <span class="nav-text">蓝牙4.0</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%8F%E5%85%B8%E8%93%9D%E7%89%99-classic-Bluetooth"><span class="nav-number">1.1.</span> <span class="nav-text">经典蓝牙(classic Bluetooth)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.1.1.</span> <span class="nav-text">建立连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1"><span class="nav-number">1.1.2.</span> <span class="nav-text">数据通信</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%8E%E5%8A%9F%E8%80%97%E8%93%9D%E7%89%99%EF%BC%88Bluetooth-low-energy%EF%BC%8C%E7%AE%80%E7%A7%B0BLE%E6%88%96%E8%80%85LE%EF%BC%89"><span class="nav-number">1.2.</span> <span class="nav-text">低功耗蓝牙（Bluetooth low energy，简称BLE或者LE）</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">建立连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E9%80%9A%E4%BF%A1-1"><span class="nav-number">1.2.2.</span> <span class="nav-text">数据通信</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#react-native-ble-plx"><span class="nav-number">2.</span> <span class="nav-text">react-native-ble-plx</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%83%AD%E6%95%8F%E6%89%93%E5%8D%B0%E6%9C%BA%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="nav-number">3.</span> <span class="nav-text">热敏打印机指令集</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#react-native-ble-plx%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="nav-number">4.</span> <span class="nav-text">react-native-ble-plx简单使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#react-native"><span class="nav-number">4.1.</span> <span class="nav-text">react-native</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Android%E9%83%A8%E5%88%86%E4%BB%A3%E7%A0%81"><span class="nav-number">4.2.</span> <span class="nav-text">Android部分代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%B3%A8%E6%84%8F"><span class="nav-number">4.3.</span> <span class="nav-text">使用注意</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">5.</span> <span class="nav-text">使用过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="nav-number">6.</span> <span class="nav-text">相关链接</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">某人</p>
  <div class="site-description" itemprop="description">路过，不语，不留</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">55</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">某人</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
